{"version":3,"file":"chat-Wu-U_tWR.js","sources":["../../src/config/supabase.js","../../src/config/convex.js","../../src/components/shared/UserAvatar.jsx","../../convex/_generated/api.js","../../src/hooks/useMediaUpload.js","../../src/hooks/usePresence.js","../../src/components/chat/PresenceIndicator.jsx","../../src/components/chat/ConversationItem.jsx","../../src/components/chat/ChatSidebar.jsx","../../src/components/chat/media/EmojiPicker.jsx","../../src/components/chat/media/GifPicker.jsx","../../src/components/chat/media/VideoRecorder.jsx","../../src/hooks/useTypingIndicator.js","../../src/components/chat/ChatInput.jsx","../../src/components/ui/button.jsx","../../src/components/SeshNxEmbedModal.jsx","../../src/components/chat/message/MessageStatus.jsx","../../src/components/chat/media/AudioWaveform.jsx","../../src/components/chat/message/MessageBubble.jsx","../../src/components/chat/message/ForwardMessageModal.jsx","../../src/hooks/useReadReceipts.js","../../src/utils/linkPreview.js","../../src/components/chat/ChatWindow.jsx","../../src/components/shared/StatCard.jsx","../../src/components/chat/media/MediaGallery.jsx","../../src/components/chat/ChatDetailsPane.jsx"],"sourcesContent":["import { createClient } from '@supabase/supabase-js';\r\n\r\n/**\r\n * Supabase Client Configuration\r\n * \r\n * Optimized for Vercel native integration:\r\n * - Automatically uses environment variables from Vercel\r\n * - Handles storage issues gracefully (tracking prevention)\r\n * - Uses PKCE flow for enhanced security\r\n * - Auto-refreshes tokens to maintain sessions\r\n */\r\n\r\n// Vite requires VITE_ prefix for environment variables\r\n// Vercel native Supabase integration automatically sets these\r\nconst supabaseUrl = import.meta.env.VITE_SUPABASE_URL || import.meta.env.NEXT_PUBLIC_SUPABASE_URL;\r\nconst supabaseAnonKey = import.meta.env.VITE_SUPABASE_ANON_KEY || import.meta.env.NEXT_PUBLIC_SUPABASE_ANON_KEY;\r\n\r\n// Enhanced error reporting (will use Sentry if available)\r\nconst reportSupabaseError = (message, details = {}) => {\r\n  if (import.meta.env.DEV) {\r\n    console.error(`âŒ Supabase: ${message}`, details);\r\n  }\r\n  // Sentry will be initialized in main.jsx and will catch these automatically\r\n};\r\n\r\nif (!supabaseUrl || !supabaseAnonKey) {\r\n  reportSupabaseError('Credentials not found. Authentication will not work.', {\r\n    url: supabaseUrl ? 'âœ“ Set' : 'âœ— Missing',\r\n    key: supabaseAnonKey ? 'âœ“ Set' : 'âœ— Missing',\r\n    hint: 'Set VITE_SUPABASE_URL and VITE_SUPABASE_ANON_KEY in Vercel environment variables, or use Vercel Marketplace Supabase integration'\r\n  });\r\n} else {\r\n  // Validate key format (should start with eyJ for JWT)\r\n  if (!supabaseAnonKey.startsWith('eyJ')) {\r\n    reportSupabaseError('Anon key format looks incorrect. Should start with \"eyJ\" (JWT format).');\r\n  }\r\n  \r\n  if (import.meta.env.DEV) {\r\n    console.log('âœ“ Supabase client initialized:', {\r\n      url: supabaseUrl,\r\n      keyLength: supabaseAnonKey.length,\r\n      keyPrefix: supabaseAnonKey.substring(0, 20) + '...'\r\n    });\r\n  }\r\n}\r\n\r\n/**\r\n * Create Supabase client with optimized configuration\r\n * \r\n * Key improvements:\r\n * - Graceful storage handling (Supabase handles errors internally)\r\n * - PKCE flow for better security\r\n * - Auto token refresh\r\n * - Session detection from URL (OAuth callbacks)\r\n */\r\nexport const supabase = (supabaseUrl && supabaseAnonKey)\r\n  ? createClient(supabaseUrl, supabaseAnonKey, {\r\n      auth: {\r\n        persistSession: true, // Supabase handles storage errors gracefully internally\r\n        autoRefreshToken: true, // Automatically refresh tokens to maintain sessions\r\n        detectSessionInUrl: true, // Detect OAuth callbacks from URL\r\n        flowType: 'pkce', // Use PKCE flow for enhanced security (recommended)\r\n        storage: typeof window !== 'undefined' ? window.localStorage : undefined,\r\n        storageKey: 'sb-auth-token',\r\n        // Enhanced error handling - Supabase will handle storage errors gracefully\r\n        // No need for manual storage availability checks\r\n      },\r\n      // Global error handling\r\n      global: {\r\n        headers: {\r\n          'x-client-info': 'seshnx-webapp@1.0.0'\r\n        }\r\n      }\r\n    })\r\n  : null;\r\n\r\nexport const isSupabaseAvailable = () => !!supabase;\r\n","import { ConvexReactClient } from \"convex/react\";\r\n\r\n/**\r\n * Convex Configuration\r\n * \r\n * Supports both VITE_CONVEX_URL and CONVEX_DEPLOY_KEY environment variables.\r\n * CONVEX_DEPLOY_KEY is used by Vercel's Convex integration.\r\n * \r\n * If no URL is provided, a placeholder client is created to satisfy ConvexProvider requirements.\r\n * Hooks will work but won't connect until a real URL is provided.\r\n */\r\nconst convexUrl = import.meta.env.CONVEX_DEPLOY_KEY || import.meta.env.VITE_CONVEX_URL;\r\n\r\n// Always create a client - use placeholder URL if not configured\r\n// This ensures ConvexProvider always has a client, even if Convex isn't configured\r\n// The placeholder URL won't connect, but satisfies the URL format requirement\r\nconst clientUrl = convexUrl && typeof convexUrl === 'string' && convexUrl.trim() !== ''\r\n  ? convexUrl.trim()\r\n  : 'https://placeholder.convex.cloud';\r\n\r\nexport const convex = new ConvexReactClient(clientUrl);\r\n\r\n/**\r\n * Check if Convex is properly configured with a real URL\r\n * @returns {boolean} True if Convex URL is configured (not placeholder)\r\n */\r\nexport const isConvexAvailable = () => {\r\n  return Boolean(\r\n    convexUrl && \r\n    typeof convexUrl === 'string' && \r\n    convexUrl.trim() !== '' &&\r\n    clientUrl !== 'https://placeholder.convex.cloud'\r\n  );\r\n};\r\n\r\n","import React, { useState } from 'react';\r\nimport { User, Users } from 'lucide-react';\r\nimport { clsx } from 'clsx';\r\nimport { twMerge } from 'tailwind-merge';\r\n\r\n// Helper to generate initials\r\nconst getInitials = (name) => {\r\n    if (!name) return '';\r\n    const parts = name.trim().split(' ').filter(Boolean);\r\n    if (parts.length >= 2) return (parts[0][0] + parts[1][0]).toUpperCase();\r\n    if (parts.length === 1 && parts[0].length >= 2) return parts[0].substring(0, 2).toUpperCase();\r\n    return parts[0]?.[0]?.toUpperCase() || '';\r\n};\r\n\r\n// Generate a consistent color based on the name\r\nconst getAvatarColor = (name) => {\r\n    if (!name) return 'from-brand-blue to-purple-600';\r\n    const colors = [\r\n        'from-brand-blue to-purple-600',\r\n        'from-emerald-500 to-teal-600',\r\n        'from-orange-500 to-red-600',\r\n        'from-pink-500 to-rose-600',\r\n        'from-indigo-500 to-blue-600',\r\n        'from-amber-500 to-orange-600',\r\n        'from-cyan-500 to-blue-600',\r\n        'from-violet-500 to-purple-600',\r\n    ];\r\n    const hash = name.split('').reduce((acc, char) => acc + char.charCodeAt(0), 0);\r\n    return colors[hash % colors.length];\r\n};\r\n\r\nexport default function UserAvatar({ \r\n    src, \r\n    name, \r\n    size = 'md', // sizes: xs, sm, md, lg, xl, 2xl, 3xl\r\n    className, \r\n    onClick,\r\n    status, // 'online', 'offline' (optional)\r\n    isGroup = false,\r\n    square = false \r\n}) {\r\n    const [imgError, setImgError] = useState(false);\r\n    \r\n    const sizeClasses = {\r\n        xs: \"h-6 w-6 text-[10px]\",\r\n        sm: \"h-8 w-8 text-xs\",\r\n        md: \"h-10 w-10 text-sm\",\r\n        lg: \"h-12 w-12 text-base\",\r\n        xl: \"h-14 w-14 text-lg\",\r\n        '2xl': \"h-24 w-24 text-2xl\",\r\n        '3xl': \"h-32 w-32 text-4xl\"\r\n    };\r\n\r\n    const containerClass = twMerge(\r\n        clsx(\r\n            \"relative overflow-hidden flex items-center justify-center shrink-0 bg-gray-200 dark:bg-gray-700 border border-transparent transition-all select-none\",\r\n            square ? \"rounded-xl\" : \"rounded-full\",\r\n            sizeClasses[size],\r\n            onClick && \"cursor-pointer hover:opacity-90\",\r\n            className\r\n        )\r\n    );\r\n\r\n    const showFallback = !src || imgError;\r\n    const initials = getInitials(name);\r\n    const avatarColor = getAvatarColor(name);\r\n\r\n    return (\r\n        <div \r\n            className={containerClass} \r\n            onClick={onClick}\r\n            role={onClick ? \"button\" : undefined}\r\n            tabIndex={onClick ? 0 : undefined}\r\n            aria-label={name ? `${name}'s avatar` : 'User avatar'}\r\n        >\r\n            {!showFallback ? (\r\n                <img \r\n                    src={src} \r\n                    alt={name || \"Avatar\"} \r\n                    className=\"h-full w-full object-cover\" \r\n                    onError={() => setImgError(true)}\r\n                    loading=\"lazy\"\r\n                />\r\n            ) : (\r\n                <div className={`h-full w-full flex items-center justify-center bg-gradient-to-br ${avatarColor} text-white font-bold`}>\r\n                    {isGroup ? (\r\n                        <Users className=\"w-1/2 h-1/2\" aria-hidden=\"true\" />\r\n                    ) : initials ? (\r\n                        <span aria-hidden=\"true\">{initials}</span>\r\n                    ) : (\r\n                        <User className=\"w-1/2 h-1/2\" aria-hidden=\"true\" />\r\n                    )}\r\n                </div>\r\n            )}\r\n            \r\n            {/* Online Status Indicator */}\r\n            {status && (\r\n                <span \r\n                    className={clsx(\r\n                        \"absolute bottom-0 right-0 rounded-full border-2 border-white dark:border-gray-900\",\r\n                        status === 'online' ? \"bg-green-500\" : \"bg-gray-400\",\r\n                        size === 'xs' || size === 'sm' ? \"h-2 w-2\" : \"h-3.5 w-3.5\"\r\n                    )}\r\n                    aria-label={status === 'online' ? 'Online' : 'Offline'}\r\n                />\r\n            )}\r\n        </div>\r\n    );\r\n}\r\n","/* eslint-disable */\r\n/**\r\n * Generated `api` utility.\r\n *\r\n * THIS CODE IS AUTOMATICALLY GENERATED.\r\n *\r\n * To regenerate, run `npx convex dev`.\r\n * @module\r\n */\r\n\r\nimport { anyApi, componentsGeneric } from \"convex/server\";\r\n\r\n/**\r\n * A utility for referencing Convex functions in your app's API.\r\n *\r\n * Usage:\r\n * ```js\r\n * const myFunctionReference = api.myModule.myFunction;\r\n * ```\r\n */\r\nexport const api = anyApi;\r\nexport const internal = anyApi;\r\nexport const components = componentsGeneric();\r\n","// src/hooks/useMediaUpload.js\r\n\r\nimport { useState } from 'react';\r\n// Firebase Storage imports are removed as the upload is handled by the new API/MinIO\r\n\r\n// Define the API endpoint from environment variables\r\n// Replace this with the actual environment variable access method for your framework (e.g., import.meta.env, process.env)\r\nconst API_ENDPOINT = import.meta.env.VITE_API_ENDPOINT || \"http://localhost:3000\";\r\n\r\nexport const useMediaUpload = () => {\r\n  const [uploading, setUploading] = useState(false);\r\n  const [error, setError] = useState(null);\r\n\r\n  /**\r\n   * Uploads media file to the backend API for processing (watermarking, MinIO storage).\r\n   * @param {File} file - The file to upload.\r\n   * @param {string} uploadType - The type of upload (e.g., 'beat', 'post', 'profile').\r\n   * @returns {Promise<object|null>} Object containing media URL/reference and type.\r\n   */\r\n  const uploadMedia = async (file, uploadType = 'general') => {\r\n    if (!file) return null;\r\n    \r\n    setUploading(true);\r\n    setError(null);\r\n    \r\n    try {\r\n      // 1. Prepare data for the API\r\n      const formData = new FormData();\r\n      formData.append('mediaFile', file);\r\n      formData.append('uploadType', uploadType); // Pass context for server-side path logic\r\n\r\n      // 2. Call the new self-hosted backend API\r\n      const response = await fetch(`${API_ENDPOINT}/api/v1/upload-asset`, {\r\n        method: 'POST',\r\n        // The API service running on HP ProDesk handles the MinIO credentials and FFmpeg\r\n        body: formData, \r\n      });\r\n\r\n      // Handle HTTP errors from the API\r\n      if (!response.ok) {\r\n        const errorData = await response.json();\r\n        throw new Error(errorData.message || `Upload failed with status ${response.status}`);\r\n      }\r\n\r\n      // 3. Parse the secure response from the backend\r\n      const result = await response.json();\r\n      \r\n      setUploading(false);\r\n      \r\n      // The API returns the necessary MinIO storage references and URLs\r\n      return {\r\n          url: result.url,\r\n          previewUrl: result.previewUrl, // New: Public URL for streaming from MinIO 'seshnx-previews' bucket\r\n          storageRef: result.storageRef, // New: Private reference to the raw file in MinIO 'seshnx-raw-audio' bucket\r\n          type: file.type.startsWith('video/') ? 'video' : (file.type.startsWith('audio/') ? 'audio' : 'image'),\r\n          name: file.name\r\n      };\r\n    } catch (err) {\r\n      console.error(\"Upload failed:\", err);\r\n      setError(err.message || 'An unknown error occurred during upload.');\r\n      setUploading(false);\r\n      return null;\r\n    }\r\n  };\r\n\r\n  return { uploadMedia, uploading, error };\r\n};\r\n","import { useState, useEffect, useRef, useMemo } from 'react';\r\nimport { useQuery, useMutation } from \"convex/react\";\r\nimport { api } from \"../../convex/_generated/api\";\r\nimport { isConvexAvailable } from '../config/convex';\r\n\r\n/**\r\n * Hook for managing user online/offline presence\r\n * Automatically sets user as online when component mounts, offline when disconnects\r\n * * @param {string} userId - Current user's UID\r\n */\r\nexport function usePresence(userId) { //\r\n    const isOnlineRef = useRef(false);\r\n    // Hook must be called unconditionally (React rules)\r\n    const updatePresenceMutation = useMutation(api.presence.updatePresence);\r\n\r\n    useEffect(() => {\r\n        if (!userId || !isConvexAvailable()) return;\r\n\r\n        // Set user as online\r\n        updatePresenceMutation({\r\n            userId,\r\n            online: true,\r\n            lastSeen: Date.now(),\r\n        }).then(() => {\r\n            isOnlineRef.current = true;\r\n        }).catch((error) => {\r\n            console.error('Presence online error:', error);\r\n        });\r\n\r\n        // Set up interval to update lastSeen periodically\r\n        const interval = setInterval(() => {\r\n            if (isOnlineRef.current) {\r\n                updatePresenceMutation({\r\n                    userId,\r\n                    online: true,\r\n                    lastSeen: Date.now(),\r\n                }).catch(console.error);\r\n            }\r\n        }, 30000); // Update every 30 seconds\r\n\r\n        // Cleanup: Set offline when component unmounts\r\n        return () => {\r\n            clearInterval(interval);\r\n            if (isOnlineRef.current) {\r\n                updatePresenceMutation({\r\n                    userId,\r\n                    online: false,\r\n                    lastSeen: Date.now(),\r\n                }).catch(console.error);\r\n                isOnlineRef.current = false;\r\n            }\r\n        };\r\n    }, [userId]); // Remove updatePresenceMutation from deps - it's stable from useMutation\r\n}\r\n\r\n/**\r\n * Hook to subscribe to another user's presence status\r\n * * @param {string} userId - User ID to monitor\r\n * @returns {object} { online, lastSeen, loading }\r\n */\r\nexport function useUserPresence(userId) { //\r\n    // This removes the potential source of the \"Cannot access 'W' before initialization\" error.\r\n    const convexAvailable = isConvexAvailable(); //\r\n\r\n    const presenceQuery = useMemo(() => {\r\n        return userId && convexAvailable ? { userId } : \"skip\";\r\n    }, [userId, convexAvailable]);\r\n    \r\n    const presenceData = useQuery(\r\n        api.presence.getPresence,\r\n        presenceQuery\r\n    );\r\n\r\n    if (!presenceData) {\r\n        return { online: false, lastSeen: null, loading: !isConvexAvailable() };\r\n    }\r\n\r\n    return {\r\n        online: presenceData.online === true,\r\n        lastSeen: presenceData.lastSeen,\r\n        loading: false,\r\n    };\r\n}\r\n\r\n/**\r\n * Format last seen timestamp to human-readable string\r\n */\r\nexport function formatLastSeen(timestamp) {\r\n    if (!timestamp) return 'Never';\r\n    \r\n    const lastSeenMs = typeof timestamp === 'number' ? timestamp : timestamp;\r\n    const now = Date.now();\r\n    const diffMs = now - lastSeenMs;\r\n    const diffMins = Math.floor(diffMs / 60000);\r\n    const diffHours = Math.floor(diffMins / 60);\r\n    const diffDays = Math.floor(diffHours / 24);\r\n\r\n    if (diffMins < 1) return 'Just now';\r\n    if (diffMins < 60) return `${diffMins}m ago`;\r\n    if (diffHours < 24) return `${diffHours}h ago`;\r\n    if (diffDays < 7) return `${diffDays}d ago`;\r\n    \r\n    return new Date(lastSeenMs).toLocaleDateString();\r\n}\r\n","import React from 'react';\r\nimport { Circle } from 'lucide-react';\r\nimport { formatLastSeen } from '../../hooks/usePresence';\r\n\r\n/**\r\n * Component to show user online status\r\n */\r\nexport default function PresenceIndicator({ \r\n    online, \r\n    lastSeen, \r\n    showText = false,\r\n    size = 'sm' // 'xs' | 'sm' | 'md'\r\n}) {\r\n    const sizeClasses = {\r\n        xs: 'w-1.5 h-1.5',\r\n        sm: 'w-2 h-2',\r\n        md: 'w-2.5 h-2.5'\r\n    };\r\n\r\n    const textSizes = {\r\n        xs: 'text-[10px]',\r\n        sm: 'text-xs',\r\n        md: 'text-sm'\r\n    };\r\n\r\n    return (\r\n        <div className=\"flex items-center gap-1.5\">\r\n            <div className=\"relative\">\r\n                <Circle \r\n                    className={`${sizeClasses[size]} ${\r\n                        online \r\n                            ? 'fill-green-500 text-green-500' \r\n                            : 'fill-gray-400 text-gray-400'\r\n                    }`}\r\n                />\r\n                {online && (\r\n                    <div className=\"absolute inset-0 animate-ping\">\r\n                        <Circle className={`${sizeClasses[size]} fill-green-500 opacity-75`} />\r\n                    </div>\r\n                )}\r\n            </div>\r\n            {showText && (\r\n                <span className={`${textSizes[size]} ${\r\n                    online ? 'text-green-500' : 'text-gray-400'\r\n                } font-medium`}>\r\n                    {online ? 'Online' : formatLastSeen(lastSeen)}\r\n                </span>\r\n            )}\r\n        </div>\r\n    );\r\n}\r\n\r\n/**\r\n * Compact status badge for chat headers\r\n */\r\nexport function StatusBadge({ online, lastSeen, showLastSeen = false }) {\r\n    return (\r\n        <div className=\"flex items-center gap-1.5\">\r\n            <div className={`w-1.5 h-1.5 rounded-full ${online ? 'bg-green-500' : 'bg-gray-400'}`} />\r\n            <span className=\"text-xs text-gray-500\">\r\n                {online \r\n                    ? 'Online' \r\n                    : showLastSeen \r\n                        ? `Last seen ${formatLastSeen(lastSeen)}` \r\n                        : 'Offline'\r\n                }\r\n            </span>\r\n        </div>\r\n    );\r\n}\r\n\r\n","import React from 'react';\r\nimport { Trash2 } from 'lucide-react';\r\nimport UserAvatar from '../shared/UserAvatar';\r\nimport PresenceIndicator from './PresenceIndicator';\r\nimport { useUserPresence } from '../../hooks/usePresence';\r\n\r\n/**\r\n * Individual conversation item in sidebar with presence indicator\r\n */\r\nexport default function ConversationItem({ \r\n    conversation, \r\n    activeChat, \r\n    currentUserId, \r\n    onSelect, \r\n    onDelete \r\n}) {\r\n    // Get other user's UID for direct chats\r\n    const otherUserId = conversation.type === 'direct' \r\n        ? (conversation.uid || (conversation.id.includes('_') \r\n            ? conversation.id.split('_').find(id => id !== currentUserId) \r\n            : null))\r\n        : null;\r\n\r\n    // Get presence for direct chats\r\n    const { online, lastSeen } = useUserPresence(otherUserId || '');\r\n\r\n    return (\r\n        <div \r\n            onClick={() => onSelect(conversation)} \r\n            className={`group relative flex gap-3 p-4 cursor-pointer transition border-b dark:border-gray-800 hover:bg-gray-50 dark:hover:bg-white/5 ${\r\n                activeChat?.id === conversation.id \r\n                    ? 'bg-blue-50 dark:bg-blue-900/10 border-l-4 border-l-brand-blue' \r\n                    : ''\r\n            }`}\r\n        >\r\n            <div className=\"relative shrink-0\">\r\n                <UserAvatar \r\n                    src={conversation.photo} \r\n                    name={conversation.n} \r\n                    size=\"lg\" \r\n                    isGroup={conversation.type === 'group'} \r\n                />\r\n                {/* Online indicator for direct chats */}\r\n                {conversation.type === 'direct' && otherUserId && (\r\n                    <div className=\"absolute -bottom-0.5 -right-0.5\">\r\n                        <PresenceIndicator \r\n                            online={online} \r\n                            lastSeen={lastSeen}\r\n                            size=\"xs\"\r\n                        />\r\n                    </div>\r\n                )}\r\n                {/* Unread count badge */}\r\n                {conversation.uc > 0 && (\r\n                    <div className=\"absolute -top-1 -right-1 h-5 w-5 bg-brand-blue text-white text-[10px] font-bold flex items-center justify-center rounded-full border-2 border-white dark:border-[#2c2e36]\">\r\n                        {conversation.uc > 99 ? '99+' : conversation.uc}\r\n                    </div>\r\n                )}\r\n            </div>\r\n            <div className=\"flex-1 min-w-0\">\r\n                <div className=\"flex justify-between items-baseline mb-1\">\r\n                    <h4 className={`text-sm truncate ${\r\n                        conversation.uc > 0 \r\n                            ? 'font-extrabold text-gray-900 dark:text-white' \r\n                            : 'font-bold text-gray-700 dark:text-gray-300'\r\n                    }`}>\r\n                        {conversation.n}\r\n                    </h4>\r\n                    <span className=\"text-[10px] text-gray-400 shrink-0 ml-2\">\r\n                        {conversation.lmt ? new Date(conversation.lmt).toLocaleDateString() : ''}\r\n                    </span>\r\n                </div>\r\n                <p className={`text-xs truncate ${\r\n                    conversation.uc > 0 \r\n                        ? 'text-gray-800 dark:text-gray-200 font-medium' \r\n                        : 'text-gray-500'\r\n                }`}>\r\n                    {conversation.ls === currentUserId ? 'You: ' : ''}{conversation.lm}\r\n                </p>\r\n            </div>\r\n            <button \r\n                onClick={(e) => {\r\n                    e.stopPropagation();\r\n                    onDelete?.(conversation.id);\r\n                }} \r\n                className=\"absolute right-2 top-1/2 -translate-y-1/2 p-2 bg-white dark:bg-gray-800 shadow-md rounded-full text-gray-400 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-all z-10\"\r\n            >\r\n                <Trash2 size={16} />\r\n            </button>\r\n        </div>\r\n    );\r\n}\r\n\r\n","import React, { useState } from 'react';\r\nimport { Users, Plus, X, Search, Trash2, ArrowLeft, ChevronRight, Loader2 } from 'lucide-react';\r\nimport { supabase } from '../../config/supabase';\r\nimport { useMutation } from \"convex/react\";\r\nimport { api } from \"../../../convex/_generated/api\";\r\nimport { isConvexAvailable } from '../../config/convex';\r\nimport ConversationItem from './ConversationItem';\r\nimport UserAvatar from '../shared/UserAvatar';\r\n\r\nexport default function ChatSidebar({ user, conversations = [], activeChat, onSelectChat }) {\r\n    // ... (State logic unchanged) ...\r\n    const [showSearch, setShowSearch] = useState(false);\r\n    const [showGroupModal, setShowGroupModal] = useState(false);\r\n    const [searchMode, setSearchMode] = useState('direct'); \r\n    const [isCreating, setIsCreating] = useState(false);\r\n\r\n    const [groupName, setGroupName] = useState('');\r\n    const [groupMembers, setGroupMembers] = useState([]);\r\n    const [searchQuery, setSearchQuery] = useState('');\r\n    const [searchResults, setSearchResults] = useState([]);\r\n\r\n    // Convex mutations\r\n    const createGroupChatMutation = useMutation(api.conversations.createGroupChat);\r\n    const deleteConversationMutation = useMutation(api.conversations.deleteConversation);\r\n\r\n    // ... (Search & Group Functions unchanged) ...\r\n    const handleUserSearch = async (term) => {\r\n        setSearchQuery(term);\r\n        const searchTerm = term.trim();\r\n        if(searchTerm.length > 1 && supabase) {\r\n            const userId = user?.id || user?.uid;\r\n            try {\r\n                // Search by first name or last name\r\n                const { data: profiles, error } = await supabase\r\n                    .from('profiles')\r\n                    .select('id, first_name, last_name, avatar_url, active_role')\r\n                    .or(`first_name.ilike.%${searchTerm}%,last_name.ilike.%${searchTerm}%`)\r\n                    .neq('id', userId)\r\n                    .limit(20);\r\n                \r\n                if (error) throw error;\r\n                \r\n                const results = (profiles || []).map(profile => ({\r\n                    id: profile.id,\r\n                    firstName: profile.first_name,\r\n                    lastName: profile.last_name,\r\n                    photoURL: profile.avatar_url,\r\n                    role: profile.active_role\r\n                }));\r\n                \r\n                setSearchResults(results);\r\n            } catch (e) {\r\n                console.error(\"Search error:\", e);\r\n                setSearchResults([]);\r\n            }\r\n        } else {\r\n            setSearchResults([]);\r\n        }\r\n    };\r\n\r\n    const handleSelectSearchResult = (result) => {\r\n        const userId = user?.id || user?.uid;\r\n        if (searchMode === 'direct') {\r\n            const chatId = [userId, result.id].sort().join('_');\r\n            onSelectChat({ id: chatId, uid: result.id, name: `${result.firstName} ${result.lastName}`, type: 'direct' });\r\n            closeSearch();\r\n        } else if (searchMode === 'add_member') {\r\n            if (!groupMembers.find(m => m.id === result.id)) {\r\n                setGroupMembers(prev => [...prev, result]);\r\n            }\r\n            closeSearch(); \r\n        }\r\n    };\r\n\r\n    const closeSearch = () => {\r\n        setShowSearch(false);\r\n        setSearchQuery('');\r\n        setSearchResults([]);\r\n    };\r\n\r\n    const openGroupModal = () => {\r\n        setGroupName('');\r\n        setGroupMembers([]);\r\n        setShowGroupModal(true);\r\n    };\r\n\r\n    const handleAddMemberClick = () => {\r\n        setSearchMode('add_member');\r\n        setShowSearch(true);\r\n    };\r\n\r\n    const handleCreateGroup = async () => {\r\n        if (!groupName || groupMembers.length === 0) return alert(\"Name and members required.\");\r\n        if (!isConvexAvailable()) {\r\n            alert(\"Chat functionality is not available. Convex is not configured.\");\r\n            return;\r\n        }\r\n        setIsCreating(true);\r\n\r\n        try {\r\n            const userId = user?.id || user?.uid;\r\n            const memberIds = groupMembers.map(m => m.id);\r\n            const { chatId: newGroupId } = await createGroupChatMutation({\r\n                creatorId: userId,\r\n                chatName: groupName,\r\n                memberIds,\r\n            });\r\n\r\n            setShowGroupModal(false);\r\n            onSelectChat({ id: newGroupId, name: groupName, type: 'group' });\r\n\r\n        } catch (e) {\r\n            console.error(\"Group creation failed\", e);\r\n            alert(\"Group creation failed: \" + e.message);\r\n        } finally {\r\n            setIsCreating(false);\r\n        }\r\n    };\r\n\r\n    const handleDeleteChat = async (e, chatId) => {\r\n        e.stopPropagation();\r\n        if (!window.confirm(\"Delete this conversation?\")) return;\r\n        if (!isConvexAvailable()) {\r\n            alert(\"Chat functionality is not available. Convex is not configured.\");\r\n            return;\r\n        }\r\n        try {\r\n            const userId = user?.id || user?.uid;\r\n            await deleteConversationMutation({ userId, chatId });\r\n            if (activeChat?.id === chatId) onSelectChat(null);\r\n        } catch (err) { console.error(err); }\r\n    };\r\n\r\n    return (\r\n        <div className=\"flex flex-col h-full relative overflow-hidden bg-white dark:bg-[#1f2128]\">\r\n            <div className=\"p-4 border-b dark:border-gray-700 flex justify-between items-center bg-gray-50 dark:bg-[#23262f] shrink-0\">\r\n                <h2 className=\"font-extrabold text-lg dark:text-white tracking-tight\">Messages</h2>\r\n                <div className=\"flex gap-2\">\r\n                    <button onClick={openGroupModal} className=\"p-2 bg-white dark:bg-gray-700 rounded-full shadow-sm hover:text-brand-blue transition\" title=\"New Group\"><Users size={18}/></button>\r\n                    <button onClick={() => { setSearchMode('direct'); setShowSearch(true); }} className=\"p-2 bg-white dark:bg-gray-700 rounded-full shadow-sm hover:text-brand-blue transition\" title=\"New Chat\"><Plus size={18}/></button>\r\n                </div>\r\n            </div>\r\n\r\n            <div className=\"flex-1 overflow-y-auto\">\r\n                {conversations.map(c => (\r\n                    <ConversationItem\r\n                        key={c.id}\r\n                        conversation={c}\r\n                        activeChat={activeChat}\r\n                        currentUserId={user?.id || user?.uid}\r\n                        onSelect={onSelectChat}\r\n                        onDelete={(chatId) => {\r\n                            if (window.confirm(\"Delete this conversation?\")) {\r\n                                handleDeleteChat({ stopPropagation: () => {} }, chatId);\r\n                            }\r\n                        }}\r\n                    />\r\n                ))}\r\n            </div>\r\n\r\n            {/* ... (Modals remain the same, just showing structure) ... */}\r\n            {showGroupModal && (\r\n                <div className=\"absolute inset-0 bg-white dark:bg-[#1f2128] z-20 flex flex-col animate-in slide-in-from-right-10 duration-200\">\r\n                    <div className=\"p-4 border-b dark:border-gray-700 flex items-center gap-3 bg-gray-50 dark:bg-[#23262f]\">\r\n                        <button onClick={() => setShowGroupModal(false)} className=\"hover:bg-gray-200 dark:hover:bg-gray-700 p-1 rounded-full\"><ArrowLeft size={20}/></button>\r\n                        <h3 className=\"font-bold dark:text-white\">New Group</h3>\r\n                    </div>\r\n                    \r\n                    <div className=\"p-4 flex-1 overflow-y-auto\">\r\n                        <div className=\"mb-6\">\r\n                            <label className=\"text-xs font-bold text-gray-500 uppercase mb-2 block\">1. Group Name</label>\r\n                            <input \r\n                                className=\"w-full p-3 border rounded-xl dark:bg-black/20 dark:border-gray-600 dark:text-white focus:ring-2 focus:ring-brand-blue outline-none\" \r\n                                placeholder=\"Enter group name...\" \r\n                                value={groupName} \r\n                                onChange={e=>setGroupName(e.target.value)} \r\n                                autoFocus\r\n                            />\r\n                        </div>\r\n\r\n                        <div>\r\n                            <div className=\"flex justify-between items-center mb-2\">\r\n                                <label className=\"text-xs font-bold text-gray-500 uppercase\">2. Members ({groupMembers.length})</label>\r\n                                <button onClick={handleAddMemberClick} className=\"text-xs font-bold text-brand-blue flex items-center gap-1 hover:underline\"><Plus size={14}/> Add Member</button>\r\n                            </div>\r\n                            <div className=\"space-y-2\">\r\n                                {groupMembers.length === 0 ? (\r\n                                    <div className=\"text-center py-8 border-2 border-dashed dark:border-gray-700 rounded-xl text-gray-400 text-sm\">No members selected</div>\r\n                                ) : (\r\n                                    groupMembers.map(m => (\r\n                                        <div key={m.id} className=\"flex items-center justify-between p-3 bg-gray-50 dark:bg-white/5 rounded-lg border dark:border-gray-700\">\r\n                                            <div className=\"flex items-center gap-3\">\r\n                                                {/* FIX: UserAvatar for Member List */}\r\n                                                <UserAvatar src={m.photoURL} name={m.firstName} size=\"sm\" />\r\n                                                <span className=\"text-sm font-bold dark:text-white\">{m.firstName} {m.lastName}</span>\r\n                                            </div>\r\n                                            <button onClick={() => setGroupMembers(prev => prev.filter(p => p.id !== m.id))} className=\"text-gray-400 hover:text-red-500\"><X size={16}/></button>\r\n                                        </div>\r\n                                    ))\r\n                                )}\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n\r\n                    <div className=\"p-4 border-t dark:border-gray-700\">\r\n                        <button onClick={handleCreateGroup} disabled={!groupName || groupMembers.length === 0 || isCreating} className=\"w-full bg-brand-blue text-white py-3.5 rounded-xl font-bold hover:bg-blue-600 disabled:opacity-50 disabled:cursor-not-allowed transition shadow-lg flex justify-center items-center gap-2\">\r\n                            {isCreating ? <Loader2 className=\"animate-spin\" size={20}/> : <>Create Group <ChevronRight size={18}/></>}\r\n                        </button>\r\n                    </div>\r\n                </div>\r\n            )}\r\n\r\n            {showSearch && (\r\n                <div className=\"absolute inset-0 bg-white dark:bg-[#1f2128] z-30 flex flex-col animate-in fade-in duration-200\">\r\n                    <div className=\"p-3 border-b dark:border-gray-700 flex items-center gap-2 bg-white dark:bg-[#1f2128]\">\r\n                        <Search size={18} className=\"text-gray-400 ml-2\"/>\r\n                        <input autoFocus className=\"flex-1 p-2 bg-transparent outline-none dark:text-white placeholder-gray-400\" placeholder=\"Search...\" value={searchQuery} onChange={(e) => handleUserSearch(e.target.value)}/>\r\n                        <button onClick={closeSearch} className=\"p-2 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-full\"><X size={20} className=\"text-gray-500\"/></button>\r\n                    </div>\r\n                    <div className=\"flex-1 overflow-y-auto p-2\">\r\n                        {searchResults.length === 0 && searchQuery.length > 1 && <div className=\"text-center py-10 text-gray-400 text-sm\">No users found.</div>}\r\n                        {searchResults.map(res => {\r\n                            const isSelected = searchMode === 'add_member' && groupMembers.find(m => m.id === res.id);\r\n                            return (\r\n                                <div key={res.id} onClick={() => handleSelectSearchResult(res)} className={`flex items-center gap-3 p-3 hover:bg-gray-50 dark:hover:bg-gray-800 rounded-xl cursor-pointer transition mb-1 ${isSelected ? 'opacity-50 pointer-events-none' : ''}`}>\r\n                                    {/* FIX: UserAvatar for Search Results */}\r\n                                    <UserAvatar src={res.photoURL} name={res.firstName} size=\"md\" />\r\n                                    <div className=\"flex-1\">\r\n                                        <div className=\"text-sm font-bold dark:text-white\">{res.firstName} {res.lastName}</div>\r\n                                        <div className=\"text-xs text-gray-500\">{res.role || 'User'}</div>\r\n                                    </div>\r\n                                    {searchMode === 'add_member' && <Plus size={18} className=\"text-brand-blue\"/>}\r\n                                </div>\r\n                            );\r\n                        })}\r\n                    </div>\r\n                </div>\r\n            )}\r\n        </div>\r\n    );\r\n}\r\n","import React, { useState, useMemo, useEffect } from 'react';\r\nimport { Search, X, Clock } from 'lucide-react';\r\nimport { motion, AnimatePresence } from 'framer-motion';\r\n\r\n// Emoji categories with popular emojis\r\nconst EMOJI_CATEGORIES = {\r\n    'Recent': ['ðŸ‘', 'â¤ï¸', 'ðŸ˜‚', 'ðŸ˜®', 'ðŸ˜¢', 'ðŸ”¥', 'ðŸŽ‰', 'ðŸ‘'],\r\n    'Smileys': ['ðŸ˜€', 'ðŸ˜ƒ', 'ðŸ˜„', 'ðŸ˜', 'ðŸ˜†', 'ðŸ˜…', 'ðŸ¤£', 'ðŸ˜‚', 'ðŸ™‚', 'ðŸ™ƒ', 'ðŸ˜‰', 'ðŸ˜Š', 'ðŸ˜‡', 'ðŸ¥°', 'ðŸ˜', 'ðŸ¤©', 'ðŸ˜˜', 'ðŸ˜—', 'ðŸ˜š', 'ðŸ˜™', 'ðŸ˜‹', 'ðŸ˜›', 'ðŸ˜œ', 'ðŸ¤ª', 'ðŸ˜', 'ðŸ¤‘', 'ðŸ¤—', 'ðŸ¤­', 'ðŸ¤«', 'ðŸ¤”', 'ðŸ¤', 'ðŸ¤¨', 'ðŸ˜', 'ðŸ˜‘', 'ðŸ˜¶', 'ðŸ˜', 'ðŸ˜’', 'ðŸ™„', 'ðŸ˜¬', 'ðŸ¤¥', 'ðŸ˜Œ', 'ðŸ˜”', 'ðŸ˜ª', 'ðŸ¤¤', 'ðŸ˜´', 'ðŸ˜·', 'ðŸ¤’', 'ðŸ¤•', 'ðŸ¤¢', 'ðŸ¤®'],\r\n    'Gestures': ['ðŸ‘‹', 'ðŸ¤š', 'ðŸ–ï¸', 'âœ‹', 'ðŸ––', 'ðŸ‘Œ', 'ðŸ¤Œ', 'ðŸ¤', 'âœŒï¸', 'ðŸ¤ž', 'ðŸ¤Ÿ', 'ðŸ¤˜', 'ðŸ¤™', 'ðŸ‘ˆ', 'ðŸ‘‰', 'ðŸ‘†', 'ðŸ–•', 'ðŸ‘‡', 'â˜ï¸', 'ðŸ‘', 'ðŸ‘Ž', 'âœŠ', 'ðŸ‘Š', 'ðŸ¤›', 'ðŸ¤œ', 'ðŸ‘', 'ðŸ™Œ', 'ðŸ‘', 'ðŸ¤²', 'ðŸ¤', 'ðŸ™'],\r\n    'Hearts': ['â¤ï¸', 'ðŸ§¡', 'ðŸ’›', 'ðŸ’š', 'ðŸ’™', 'ðŸ’œ', 'ðŸ–¤', 'ðŸ¤', 'ðŸ¤Ž', 'ðŸ’”', 'â¤ï¸â€ðŸ”¥', 'â¤ï¸â€ðŸ©¹', 'ðŸ’•', 'ðŸ’ž', 'ðŸ’“', 'ðŸ’—', 'ðŸ’–', 'ðŸ’˜', 'ðŸ’', 'ðŸ’Ÿ'],\r\n    'Objects': ['ðŸ’Ž', 'ðŸ””', 'ðŸ”•', 'ðŸŽµ', 'ðŸŽ¶', 'ðŸŽ¤', 'ðŸŽ§', 'ðŸ“»', 'ðŸŽ·', 'ðŸŽº', 'ðŸŽ¸', 'ðŸŽ¹', 'ðŸŽ®', 'ðŸ•¹ï¸', 'ðŸŽ¯', 'ðŸŽ²', 'ðŸŽ³', 'ðŸŽ´', 'ðŸƒ', 'ðŸ€„', 'ðŸŽ°', 'ðŸ“±', 'ðŸ“ž', 'â˜Žï¸', 'ðŸ“Ÿ', 'ðŸ“ ', 'ðŸ’»', 'ðŸ–¥ï¸', 'ðŸ–¨ï¸', 'âŒ¨ï¸', 'ðŸ–±ï¸', 'ðŸ–²ï¸', 'ðŸ•¹ï¸', 'ðŸ—œï¸', 'ðŸ’¾', 'ðŸ’¿', 'ðŸ“€'],\r\n    'Flags': ['ðŸ³ï¸', 'ðŸ´', 'ðŸ', 'ðŸš©', 'ðŸ³ï¸â€ðŸŒˆ', 'ðŸ³ï¸â€âš§ï¸', 'ðŸ‡ºðŸ‡¸', 'ðŸ‡¬ðŸ‡§', 'ðŸ‡¨ðŸ‡¦', 'ðŸ‡¦ðŸ‡º', 'ðŸ‡«ðŸ‡·', 'ðŸ‡©ðŸ‡ª', 'ðŸ‡®ðŸ‡¹', 'ðŸ‡ªðŸ‡¸', 'ðŸ‡¯ðŸ‡µ', 'ðŸ‡°ðŸ‡·', 'ðŸ‡¨ðŸ‡³', 'ðŸ‡®ðŸ‡³', 'ðŸ‡§ðŸ‡·', 'ðŸ‡²ðŸ‡½'],\r\n    'Music': ['ðŸŽµ', 'ðŸŽ¶', 'ðŸŽ¤', 'ðŸŽ§', 'ðŸ“»', 'ðŸŽ·', 'ðŸŽº', 'ðŸŽ¸', 'ðŸŽ¹', 'ðŸ¥', 'ðŸª˜', 'ðŸŽ»', 'ðŸŽª', 'ðŸŽ­', 'ðŸŽ¨', 'ðŸŽ¬', 'ðŸŽ¤', 'ðŸŽ§', 'ðŸŽ¼', 'ðŸŽ¹'],\r\n    'Reactions': ['ðŸ‘', 'ðŸ‘Ž', 'â¤ï¸', 'ðŸ”¥', 'ðŸ˜‚', 'ðŸ˜®', 'ðŸ˜¢', 'ðŸ‘', 'ðŸ™Œ', 'ðŸ¤', 'ðŸ¤—', 'ðŸ¤”', 'ðŸ¤¦', 'ðŸ¤·', 'ðŸ™', 'ðŸ‘€', 'ðŸ’ª', 'ðŸ¤˜', 'âœŒï¸', 'ðŸ¤ž']\r\n};\r\n\r\n// Get all emojis for search\r\nconst ALL_EMOJIS = Object.values(EMOJI_CATEGORIES).flat();\r\n\r\n/**\r\n * Full-featured emoji picker with categories, search, and recent emojis\r\n */\r\nexport default function EmojiPicker({ \r\n    onSelect, \r\n    onClose,\r\n    position = 'bottom' // 'top' | 'bottom'\r\n}) {\r\n    const [activeCategory, setActiveCategory] = useState('Recent');\r\n    const [searchQuery, setSearchQuery] = useState('');\r\n    const [recentEmojis, setRecentEmojis] = useState(() => {\r\n        // Load from localStorage\r\n        const stored = localStorage.getItem('recentEmojis');\r\n        return stored ? JSON.parse(stored) : EMOJI_CATEGORIES['Recent'];\r\n    });\r\n\r\n    // Filter emojis by search\r\n    const filteredEmojis = useMemo(() => {\r\n        if (!searchQuery.trim()) {\r\n            return activeCategory === 'Recent' \r\n                ? recentEmojis \r\n                : EMOJI_CATEGORIES[activeCategory] || [];\r\n        }\r\n        \r\n        // Simple search - in production you'd want emoji keywords\r\n        return ALL_EMOJIS.filter(emoji => \r\n            emoji.includes(searchQuery) || searchQuery.includes(emoji)\r\n        );\r\n    }, [searchQuery, activeCategory, recentEmojis]);\r\n\r\n    const handleEmojiSelect = (emoji) => {\r\n        // Add to recent (max 8)\r\n        const updatedRecent = [emoji, ...recentEmojis.filter(e => e !== emoji)].slice(0, 8);\r\n        setRecentEmojis(updatedRecent);\r\n        localStorage.setItem('recentEmojis', JSON.stringify(updatedRecent));\r\n        \r\n        onSelect(emoji);\r\n        if (onClose) onClose();\r\n    };\r\n\r\n    const categories = Object.keys(EMOJI_CATEGORIES);\r\n\r\n    return (\r\n        <motion.div\r\n            initial={{ opacity: 0, scale: 0.95, y: position === 'bottom' ? -10 : 10 }}\r\n            animate={{ opacity: 1, scale: 1, y: 0 }}\r\n            exit={{ opacity: 0, scale: 0.95 }}\r\n            className={`\r\n                absolute ${position === 'bottom' ? 'bottom-full mb-2' : 'top-full mt-2'} \r\n                left-0\r\n                w-[340px] bg-white dark:bg-gray-800 \r\n                rounded-2xl shadow-2xl border dark:border-gray-700\r\n                z-50 overflow-hidden\r\n            `}\r\n        >\r\n            {/* Header with search */}\r\n            <div className=\"p-3 border-b dark:border-gray-700\">\r\n                <div className=\"relative mb-3\">\r\n                    <Search size={16} className=\"absolute left-3 top-1/2 -translate-y-1/2 text-gray-400\" />\r\n                    <input\r\n                        type=\"text\"\r\n                        placeholder=\"Search emojis...\"\r\n                        value={searchQuery}\r\n                        onChange={(e) => setSearchQuery(e.target.value)}\r\n                        className=\"w-full pl-9 pr-3 py-2 bg-gray-100 dark:bg-gray-700 rounded-lg text-sm outline-none focus:ring-2 focus:ring-brand-blue dark:text-white\"\r\n                    />\r\n                    {searchQuery && (\r\n                        <button\r\n                            onClick={() => setSearchQuery('')}\r\n                            className=\"absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600\"\r\n                        >\r\n                            <X size={16} />\r\n                        </button>\r\n                    )}\r\n                </div>\r\n\r\n                {/* Category tabs */}\r\n                <div className=\"flex gap-1 overflow-x-auto scrollbar-hide\">\r\n                    {categories.map(category => (\r\n                        <button\r\n                            key={category}\r\n                            onClick={() => setActiveCategory(category)}\r\n                            className={`\r\n                                px-3 py-1.5 rounded-lg text-xs font-semibold whitespace-nowrap transition\r\n                                ${activeCategory === category\r\n                                    ? 'bg-brand-blue text-white'\r\n                                    : 'bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600'\r\n                                }\r\n                            `}\r\n                        >\r\n                            {category === 'Recent' ? (\r\n                                <Clock size={12} className=\"inline mr-1\" />\r\n                            ) : null}\r\n                            {category}\r\n                        </button>\r\n                    ))}\r\n                </div>\r\n            </div>\r\n\r\n            {/* Emoji grid */}\r\n            <div className=\"h-[280px] overflow-y-auto custom-scrollbar p-3\">\r\n                {filteredEmojis.length === 0 ? (\r\n                    <div className=\"flex flex-col items-center justify-center h-full text-gray-400\">\r\n                        <p className=\"text-sm\">No emojis found</p>\r\n                    </div>\r\n                ) : (\r\n                    <div className=\"grid grid-cols-8 gap-1\">\r\n                        {filteredEmojis.map((emoji, index) => (\r\n                            <motion.button\r\n                                key={`${emoji}-${index}`}\r\n                                whileHover={{ scale: 1.2 }}\r\n                                whileTap={{ scale: 0.9 }}\r\n                                onClick={() => handleEmojiSelect(emoji)}\r\n                                className=\"w-10 h-10 flex items-center justify-center text-xl rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition\"\r\n                            >\r\n                                {emoji}\r\n                            </motion.button>\r\n                        ))}\r\n                    </div>\r\n                )}\r\n            </div>\r\n        </motion.div>\r\n    );\r\n}\r\n\r\n","import React, { useState, useEffect, useRef } from 'react';\r\nimport { Search, X, Loader2, TrendingUp } from 'lucide-react';\r\nimport { motion, AnimatePresence } from 'framer-motion';\r\n\r\n// Giphy API key - should be in environment variables\r\nconst GIPHY_API_KEY = import.meta.env.VITE_GIPHY_API_KEY || 'demo_key';\r\nconst GIPHY_BASE_URL = 'https://api.giphy.com/v1/gifs';\r\n\r\n/**\r\n * GIF picker component with Giphy integration\r\n */\r\nexport default function GifPicker({ \r\n    onSelect, \r\n    onClose,\r\n    position = 'bottom'\r\n}) {\r\n    const [searchQuery, setSearchQuery] = useState('');\r\n    const [gifs, setGifs] = useState([]);\r\n    const [trendingGifs, setTrendingGifs] = useState([]);\r\n    const [loading, setLoading] = useState(false);\r\n    const [activeTab, setActiveTab] = useState('trending'); // 'trending' | 'search'\r\n    const searchTimeoutRef = useRef(null);\r\n\r\n    // Load trending GIFs on mount\r\n    useEffect(() => {\r\n        loadTrending();\r\n    }, []);\r\n\r\n    // Search with debounce\r\n    useEffect(() => {\r\n        if (searchQuery.trim()) {\r\n            setActiveTab('search');\r\n            if (searchTimeoutRef.current) {\r\n                clearTimeout(searchTimeoutRef.current);\r\n            }\r\n            searchTimeoutRef.current = setTimeout(() => {\r\n                searchGifs(searchQuery);\r\n            }, 500);\r\n        } else {\r\n            setActiveTab('trending');\r\n            setGifs([]);\r\n        }\r\n        return () => {\r\n            if (searchTimeoutRef.current) {\r\n                clearTimeout(searchTimeoutRef.current);\r\n            }\r\n        };\r\n    }, [searchQuery]);\r\n\r\n    const loadTrending = async () => {\r\n        setLoading(true);\r\n        try {\r\n            const response = await fetch(\r\n                `${GIPHY_BASE_URL}/trending?api_key=${GIPHY_API_KEY}&limit=24&rating=g`\r\n            );\r\n            const data = await response.json();\r\n            if (data.data) {\r\n                setTrendingGifs(data.data);\r\n            }\r\n        } catch (error) {\r\n            console.error('Giphy trending error:', error);\r\n        }\r\n        setLoading(false);\r\n    };\r\n\r\n    const searchGifs = async (query) => {\r\n        if (!query.trim()) return;\r\n        \r\n        setLoading(true);\r\n        try {\r\n            const response = await fetch(\r\n                `${GIPHY_BASE_URL}/search?api_key=${GIPHY_API_KEY}&q=${encodeURIComponent(query)}&limit=24&rating=g`\r\n            );\r\n            const data = await response.json();\r\n            if (data.data) {\r\n                setGifs(data.data);\r\n            }\r\n        } catch (error) {\r\n            console.error('Giphy search error:', error);\r\n        }\r\n        setLoading(false);\r\n    };\r\n\r\n    const handleGifSelect = (gif) => {\r\n        onSelect?.({\r\n            url: gif.images.fixed_height.url || gif.images.original.url,\r\n            previewUrl: gif.images.preview_gif.url || gif.images.fixed_height_small.url,\r\n            width: gif.images.fixed_height.width,\r\n            height: gif.images.fixed_height.height,\r\n            title: gif.title || 'GIF'\r\n        });\r\n        if (onClose) onClose();\r\n    };\r\n\r\n    const displayGifs = activeTab === 'trending' ? trendingGifs : gifs;\r\n\r\n    return (\r\n        <motion.div\r\n            initial={{ opacity: 0, scale: 0.95, y: position === 'bottom' ? -10 : 10 }}\r\n            animate={{ opacity: 1, scale: 1, y: 0 }}\r\n            exit={{ opacity: 0, scale: 0.95 }}\r\n            className={`\r\n                absolute ${position === 'bottom' ? 'bottom-full mb-2' : 'top-full mt-2'} \r\n                left-0\r\n                w-[380px] bg-white dark:bg-gray-800 \r\n                rounded-2xl shadow-2xl border dark:border-gray-700\r\n                z-50 overflow-hidden\r\n            `}\r\n        >\r\n            {/* Header */}\r\n            <div className=\"p-3 border-b dark:border-gray-700\">\r\n                <div className=\"relative\">\r\n                    <Search size={16} className=\"absolute left-3 top-1/2 -translate-y-1/2 text-gray-400\" />\r\n                    <input\r\n                        type=\"text\"\r\n                        placeholder=\"Search GIFs...\"\r\n                        value={searchQuery}\r\n                        onChange={(e) => setSearchQuery(e.target.value)}\r\n                        className=\"w-full pl-9 pr-10 py-2 bg-gray-100 dark:bg-gray-700 rounded-lg text-sm outline-none focus:ring-2 focus:ring-brand-blue dark:text-white\"\r\n                    />\r\n                    {searchQuery && (\r\n                        <button\r\n                            onClick={() => setSearchQuery('')}\r\n                            className=\"absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600\"\r\n                        >\r\n                            <X size={16} />\r\n                        </button>\r\n                    )}\r\n                </div>\r\n            </div>\r\n\r\n            {/* GIF Grid */}\r\n            <div className=\"h-[320px] overflow-y-auto custom-scrollbar p-3\">\r\n                {loading ? (\r\n                    <div className=\"flex flex-col items-center justify-center h-full\">\r\n                        <Loader2 className=\"animate-spin text-brand-blue mb-2\" size={24} />\r\n                        <p className=\"text-sm text-gray-500\">Loading GIFs...</p>\r\n                    </div>\r\n                ) : displayGifs.length === 0 ? (\r\n                    <div className=\"flex flex-col items-center justify-center h-full text-gray-400\">\r\n                        <TrendingUp size={32} className=\"mb-2 opacity-50\" />\r\n                        <p className=\"text-sm\">\r\n                            {activeTab === 'search' \r\n                                ? 'No GIFs found. Try a different search.'\r\n                                : 'Loading trending GIFs...'\r\n                            }\r\n                        </p>\r\n                    </div>\r\n                ) : (\r\n                    <div className=\"grid grid-cols-2 gap-2\">\r\n                        {displayGifs.map((gif) => (\r\n                            <motion.div\r\n                                key={gif.id}\r\n                                whileHover={{ scale: 1.02 }}\r\n                                whileTap={{ scale: 0.98 }}\r\n                                onClick={() => handleGifSelect(gif)}\r\n                                className=\"relative aspect-square rounded-lg overflow-hidden cursor-pointer bg-gray-100 dark:bg-gray-700 group\"\r\n                            >\r\n                                <img\r\n                                    src={gif.images.fixed_height_small.url || gif.images.preview_gif.url}\r\n                                    alt={gif.title}\r\n                                    className=\"w-full h-full object-cover\"\r\n                                    loading=\"lazy\"\r\n                                />\r\n                                <div className=\"absolute inset-0 bg-black/0 group-hover:bg-black/10 transition\" />\r\n                            </motion.div>\r\n                        ))}\r\n                    </div>\r\n                )}\r\n            </div>\r\n\r\n            {/* Footer */}\r\n            <div className=\"p-2 border-t dark:border-gray-700 bg-gray-50 dark:bg-gray-900 text-center\">\r\n                <p className=\"text-[10px] text-gray-400\">\r\n                    Powered by <span className=\"font-bold\">GIPHY</span>\r\n                </p>\r\n            </div>\r\n        </motion.div>\r\n    );\r\n}\r\n\r\n","import React, { useState, useRef, useEffect } from 'react';\r\nimport { Video, StopCircle, X, Check, Loader2, Camera, CameraOff } from 'lucide-react';\r\nimport { motion, AnimatePresence } from 'framer-motion';\r\n\r\n/**\r\n * Video message recorder component\r\n * Records short video clips for messages\r\n */\r\nexport default function VideoRecorder({ \r\n    onRecorded, \r\n    onClose,\r\n    maxDuration = 60 // seconds\r\n}) {\r\n    const [isRecording, setIsRecording] = useState(false);\r\n    const [recordedBlob, setRecordedBlob] = useState(null);\r\n    const [recordingTime, setRecordingTime] = useState(0);\r\n    const [hasPermission, setHasPermission] = useState(null);\r\n    const [error, setError] = useState(null);\r\n    \r\n    const videoRef = useRef(null);\r\n    const streamRef = useRef(null);\r\n    const mediaRecorderRef = useRef(null);\r\n    const chunksRef = useRef([]);\r\n    const timerRef = useRef(null);\r\n\r\n    // Request camera/mic access\r\n    useEffect(() => {\r\n        requestPermissions();\r\n        return () => {\r\n            cleanup();\r\n        };\r\n    }, []);\r\n\r\n    const requestPermissions = async () => {\r\n        try {\r\n            const stream = await navigator.mediaDevices.getUserMedia({ \r\n                video: { facingMode: 'user' },\r\n                audio: true \r\n            });\r\n            streamRef.current = stream;\r\n            \r\n            if (videoRef.current) {\r\n                videoRef.current.srcObject = stream;\r\n            }\r\n            setHasPermission(true);\r\n            setError(null);\r\n        } catch (err) {\r\n            console.error('Permission error:', err);\r\n            setHasPermission(false);\r\n            setError('Camera/microphone access denied');\r\n        }\r\n    };\r\n\r\n    const cleanup = () => {\r\n        if (streamRef.current) {\r\n            streamRef.current.getTracks().forEach(track => track.stop());\r\n            streamRef.current = null;\r\n        }\r\n        if (timerRef.current) {\r\n            clearInterval(timerRef.current);\r\n        }\r\n    };\r\n\r\n    const startRecording = async () => {\r\n        if (!streamRef.current) {\r\n            await requestPermissions();\r\n            return;\r\n        }\r\n\r\n        try {\r\n            chunksRef.current = [];\r\n            const options = {\r\n                mimeType: 'video/webm;codecs=vp9,opus',\r\n                videoBitsPerSecond: 2500000\r\n            };\r\n\r\n            mediaRecorderRef.current = new MediaRecorder(streamRef.current, options);\r\n            \r\n            mediaRecorderRef.current.ondataavailable = (e) => {\r\n                if (e.data.size > 0) {\r\n                    chunksRef.current.push(e.data);\r\n                }\r\n            };\r\n\r\n            mediaRecorderRef.current.onstop = () => {\r\n                const blob = new Blob(chunksRef.current, { type: 'video/webm' });\r\n                setRecordedBlob(blob);\r\n                setIsRecording(false);\r\n                setRecordingTime(0);\r\n                if (timerRef.current) {\r\n                    clearInterval(timerRef.current);\r\n                }\r\n            };\r\n\r\n            mediaRecorderRef.current.start();\r\n            setIsRecording(true);\r\n            setRecordingTime(0);\r\n\r\n            // Timer\r\n            timerRef.current = setInterval(() => {\r\n                setRecordingTime(prev => {\r\n                    const newTime = prev + 1;\r\n                    if (newTime >= maxDuration) {\r\n                        stopRecording();\r\n                    }\r\n                    return newTime;\r\n                });\r\n            }, 1000);\r\n\r\n        } catch (err) {\r\n            console.error('Recording error:', err);\r\n            setError('Failed to start recording');\r\n        }\r\n    };\r\n\r\n    const stopRecording = () => {\r\n        if (mediaRecorderRef.current && isRecording) {\r\n            mediaRecorderRef.current.stop();\r\n        }\r\n    };\r\n\r\n    const handleDiscard = () => {\r\n        setRecordedBlob(null);\r\n        setRecordingTime(0);\r\n        setIsRecording(false);\r\n    };\r\n\r\n    const handleSend = () => {\r\n        if (recordedBlob) {\r\n            const file = new File([recordedBlob], `video_${Date.now()}.webm`, { type: 'video/webm' });\r\n            onRecorded?.(file);\r\n            cleanup();\r\n            onClose?.();\r\n        }\r\n    };\r\n\r\n    const formatTime = (seconds) => {\r\n        const mins = Math.floor(seconds / 60);\r\n        const secs = seconds % 60;\r\n        return `${mins}:${secs.toString().padStart(2, '0')}`;\r\n    };\r\n\r\n    if (!hasPermission && hasPermission !== null) {\r\n        return (\r\n            <div className=\"fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-[80] p-4\">\r\n                <motion.div\r\n                    initial={{ opacity: 0, scale: 0.95 }}\r\n                    animate={{ opacity: 1, scale: 1 }}\r\n                    className=\"bg-white dark:bg-[#2c2e36] rounded-2xl p-6 max-w-sm\"\r\n                >\r\n                    <div className=\"text-center\">\r\n                        <CameraOff size={48} className=\"text-red-500 mx-auto mb-4\" />\r\n                        <h3 className=\"text-lg font-bold dark:text-white mb-2\">Camera Access Required</h3>\r\n                        <p className=\"text-sm text-gray-500 mb-4\">\r\n                            Please allow camera and microphone access to record video messages.\r\n                        </p>\r\n                        <div className=\"flex gap-2\">\r\n                            <button\r\n                                onClick={onClose}\r\n                                className=\"flex-1 px-4 py-2 bg-gray-100 dark:bg-gray-700 rounded-lg text-sm font-semibold hover:bg-gray-200 transition\"\r\n                            >\r\n                                Cancel\r\n                            </button>\r\n                            <button\r\n                                onClick={requestPermissions}\r\n                                className=\"flex-1 px-4 py-2 bg-brand-blue text-white rounded-lg text-sm font-semibold hover:bg-blue-600 transition\"\r\n                            >\r\n                                Allow Access\r\n                            </button>\r\n                        </div>\r\n                    </div>\r\n                </motion.div>\r\n            </div>\r\n        );\r\n    }\r\n\r\n    return (\r\n        <div className=\"fixed inset-0 bg-black/90 backdrop-blur-sm flex items-center justify-center z-[80]\">\r\n            <motion.div\r\n                initial={{ opacity: 0, scale: 0.95 }}\r\n                animate={{ opacity: 1, scale: 1 }}\r\n                className=\"relative w-full max-w-2xl aspect-video bg-black rounded-2xl overflow-hidden\"\r\n            >\r\n                {/* Video preview */}\r\n                <video\r\n                    ref={videoRef}\r\n                    autoPlay\r\n                    muted\r\n                    playsInline\r\n                    className=\"w-full h-full object-cover\"\r\n                />\r\n\r\n                {/* Recording overlay */}\r\n                {isRecording && (\r\n                    <div className=\"absolute top-4 left-1/2 -translate-x-1/2 flex items-center gap-2 bg-red-500 text-white px-4 py-2 rounded-full\">\r\n                        <div className=\"w-2 h-2 bg-white rounded-full animate-pulse\" />\r\n                        <span className=\"text-sm font-bold\">{formatTime(recordingTime)}</span>\r\n                    </div>\r\n                )}\r\n\r\n                {/* Controls */}\r\n                <div className=\"absolute bottom-0 left-0 right-0 p-6 bg-gradient-to-t from-black/80 to-transparent\">\r\n                    <div className=\"flex items-center justify-center gap-4\">\r\n                        {!recordedBlob ? (\r\n                            <>\r\n                                {!isRecording ? (\r\n                                    <>\r\n                                        <button\r\n                                            onClick={onClose}\r\n                                            className=\"p-3 bg-white/20 hover:bg-white/30 rounded-full text-white transition\"\r\n                                        >\r\n                                            <X size={24} />\r\n                                        </button>\r\n                                        <button\r\n                                            onClick={startRecording}\r\n                                            className=\"p-4 bg-red-500 hover:bg-red-600 rounded-full text-white transition shadow-lg\"\r\n                                        >\r\n                                            <Video size={28} />\r\n                                        </button>\r\n                                        <div className=\"w-12\" /> {/* Spacer */}\r\n                                    </>\r\n                                ) : (\r\n                                    <>\r\n                                        <button\r\n                                            onClick={handleDiscard}\r\n                                            className=\"p-3 bg-white/20 hover:bg-white/30 rounded-full text-white transition\"\r\n                                        >\r\n                                            <X size={24} />\r\n                                        </button>\r\n                                        <button\r\n                                            onClick={stopRecording}\r\n                                            className=\"p-4 bg-red-500 hover:bg-red-600 rounded-full text-white transition shadow-lg animate-pulse\"\r\n                                        >\r\n                                            <StopCircle size={28} />\r\n                                        </button>\r\n                                        <div className=\"w-12\" /> {/* Spacer */}\r\n                                    </>\r\n                                )}\r\n                            </>\r\n                        ) : (\r\n                            <>\r\n                                <button\r\n                                    onClick={handleDiscard}\r\n                                    className=\"p-3 bg-white/20 hover:bg-white/30 rounded-full text-white transition\"\r\n                                >\r\n                                    <X size={24} />\r\n                                </button>\r\n                                <button\r\n                                    onClick={handleSend}\r\n                                    className=\"p-4 bg-green-500 hover:bg-green-600 rounded-full text-white transition shadow-lg\"\r\n                                >\r\n                                    <Check size={28} />\r\n                                </button>\r\n                                <div className=\"w-12\" /> {/* Spacer */}\r\n                            </>\r\n                        )}\r\n                    </div>\r\n                </div>\r\n\r\n                {/* Error message */}\r\n                {error && (\r\n                    <div className=\"absolute top-4 left-4 bg-red-500 text-white px-4 py-2 rounded-lg text-sm\">\r\n                        {error}\r\n                    </div>\r\n                )}\r\n            </motion.div>\r\n        </div>\r\n    );\r\n}\r\n\r\n","import { useState, useEffect, useRef, useCallback, useMemo } from 'react';\r\nimport { useQuery, useMutation } from \"convex/react\";\r\nimport { api } from \"../../convex/_generated/api\";\r\nimport { isConvexAvailable } from '../config/convex';\r\n\r\n/**\r\n * Hook for managing typing indicators in a chat\r\n * @param {string} chatId - Current chat ID\r\n * @param {string} userId - Current user's UID\r\n * @param {string} userName - Current user's display name\r\n * @returns {object} { typingUsers, setTyping, clearTyping }\r\n */\r\nexport function useTypingIndicator(chatId, userId, userName) {\r\n    const typingTimeoutRef = useRef(null);\r\n    const isTypingRef = useRef(false);\r\n    \r\n    // Check Convex availability\r\n    const convexAvailable = isConvexAvailable();\r\n    \r\n    // Query typing indicators for the current chat\r\n    const typingQuery = useMemo(() => {\r\n        return chatId && convexAvailable ? { chatId } : \"skip\";\r\n    }, [chatId, convexAvailable]);\r\n    \r\n    const typingData = useQuery(\r\n        api.presence.getTypingIndicators,\r\n        typingQuery\r\n    );\r\n    \r\n    // Mutation to update typing status\r\n    const updateTypingMutation = useMutation(api.presence.updateTypingIndicator);\r\n    const clearTypingMutation = useMutation(api.presence.clearTypingIndicator);\r\n    \r\n    // Filter out current user from typing indicators\r\n    const typingUsers = useMemo(() => {\r\n        if (!typingData) return [];\r\n        return typingData\r\n            .filter(indicator => indicator.userId !== userId && indicator.isTyping)\r\n            .map(indicator => ({\r\n                id: indicator.userId,\r\n                name: indicator.userName,\r\n            }));\r\n    }, [typingData, userId]);\r\n    \r\n    // Set typing status with auto-clear after delay\r\n    const setTyping = useCallback(() => {\r\n        if (!chatId || !userId || !convexAvailable) return;\r\n        \r\n        // Only update if not already marked as typing\r\n        if (!isTypingRef.current) {\r\n            isTypingRef.current = true;\r\n            updateTypingMutation({\r\n                chatId,\r\n                userId,\r\n                userName: userName || 'User',\r\n                isTyping: true,\r\n            }).catch(console.error);\r\n        }\r\n        \r\n        // Clear previous timeout\r\n        if (typingTimeoutRef.current) {\r\n            clearTimeout(typingTimeoutRef.current);\r\n        }\r\n        \r\n        // Auto-clear typing after 3 seconds of inactivity\r\n        typingTimeoutRef.current = setTimeout(() => {\r\n            if (isTypingRef.current) {\r\n                isTypingRef.current = false;\r\n                clearTypingMutation({\r\n                    chatId,\r\n                    userId,\r\n                }).catch(console.error);\r\n            }\r\n        }, 3000);\r\n    }, [chatId, userId, userName, convexAvailable, updateTypingMutation, clearTypingMutation]);\r\n    \r\n    // Immediately clear typing status\r\n    const clearTyping = useCallback(() => {\r\n        if (!chatId || !userId || !convexAvailable) return;\r\n        \r\n        if (typingTimeoutRef.current) {\r\n            clearTimeout(typingTimeoutRef.current);\r\n        }\r\n        \r\n        if (isTypingRef.current) {\r\n            isTypingRef.current = false;\r\n            clearTypingMutation({\r\n                chatId,\r\n                userId,\r\n            }).catch(console.error);\r\n        }\r\n    }, [chatId, userId, convexAvailable, clearTypingMutation]);\r\n    \r\n    // Cleanup on unmount or chat change\r\n    useEffect(() => {\r\n        return () => {\r\n            if (typingTimeoutRef.current) {\r\n                clearTimeout(typingTimeoutRef.current);\r\n            }\r\n            // Clear typing when leaving chat\r\n            if (chatId && userId && isTypingRef.current && convexAvailable) {\r\n                clearTypingMutation({\r\n                    chatId,\r\n                    userId,\r\n                }).catch(console.error);\r\n            }\r\n        };\r\n    }, [chatId, userId, convexAvailable, clearTypingMutation]);\r\n    \r\n    return {\r\n        typingUsers,\r\n        setTyping,\r\n        clearTyping,\r\n    };\r\n}\r\n\r\n/**\r\n * Format typing users into display string\r\n * @param {Array} typingUsers - Array of typing user objects\r\n * @returns {string} Formatted string\r\n */\r\nexport function formatTypingUsers(typingUsers) {\r\n    if (!typingUsers || typingUsers.length === 0) return '';\r\n    \r\n    if (typingUsers.length === 1) {\r\n        return `${typingUsers[0].name} is typing...`;\r\n    }\r\n    \r\n    if (typingUsers.length === 2) {\r\n        return `${typingUsers[0].name} and ${typingUsers[1].name} are typing...`;\r\n    }\r\n    \r\n    return `${typingUsers[0].name} and ${typingUsers.length - 1} others are typing...`;\r\n}\r\n","import React, { useState, useRef, useEffect, useCallback } from 'react';\r\nimport { \r\n    Paperclip, \r\n    Send, \r\n    X, \r\n    Loader2, \r\n    FileAudio, \r\n    CheckCircle, \r\n    Mic, \r\n    StopCircle,\r\n    CornerUpLeft,\r\n    Pencil,\r\n    Smile,\r\n    Image as ImageIcon,\r\n    Video,\r\n    FileText,\r\n    ImagePlus,\r\n    Trash2,\r\n    Play,\r\n    Pause,\r\n    Square\r\n} from 'lucide-react';\r\nimport { useMediaUpload } from '../../hooks/useMediaUpload';\r\nimport { motion, AnimatePresence } from 'framer-motion';\r\nimport EmojiPicker from './media/EmojiPicker';\r\nimport GifPicker from './media/GifPicker';\r\nimport VideoRecorder from './media/VideoRecorder';\r\nimport { formatTypingUsers } from '../../hooks/useTypingIndicator';\r\n\r\nexport default function ChatInput({ \r\n    activeChatId, \r\n    uid, \r\n    onSend, \r\n    replyingTo, \r\n    editingMessage, \r\n    onCancelReply,\r\n    onCancelEdit, \r\n    typingUsers = [],\r\n    onTyping,\r\n    onStopTyping\r\n}) {\r\n    const [input, setInput] = useState('');\r\n    const [attachment, setAttachment] = useState(null);\r\n    const [isRecording, setIsRecording] = useState(false);\r\n    const [recordingDuration, setRecordingDuration] = useState(0);\r\n    const [dragActive, setDragActive] = useState(false);\r\n    const [showEmojiPicker, setShowEmojiPicker] = useState(false);\r\n    const [showGifPicker, setShowGifPicker] = useState(false);\r\n    const [showVideoRecorder, setShowVideoRecorder] = useState(false);\r\n    const [isPlayingPreview, setIsPlayingPreview] = useState(false);\r\n    \r\n    const fileInputRef = useRef(null);\r\n    const textareaRef = useRef(null);\r\n    const mediaRecorder = useRef(null);\r\n    const audioChunks = useRef([]);\r\n    const emojiPickerRef = useRef(null);\r\n    const gifPickerRef = useRef(null);\r\n    const recordingIntervalRef = useRef(null);\r\n    const audioPreviewRef = useRef(null);\r\n    const { uploadMedia, uploading } = useMediaUpload();\r\n\r\n    // Set input when editing\r\n    useEffect(() => { \r\n        if (editingMessage) {\r\n            setInput(editingMessage.b || '');\r\n            textareaRef.current?.focus();\r\n        }\r\n    }, [editingMessage]);\r\n\r\n    // Focus on reply\r\n    useEffect(() => {\r\n        if (replyingTo) {\r\n            textareaRef.current?.focus();\r\n        }\r\n    }, [replyingTo]);\r\n\r\n    // Close pickers on outside click\r\n    useEffect(() => {\r\n        const handleClickOutside = (e) => {\r\n            if (emojiPickerRef.current && !emojiPickerRef.current.contains(e.target)) {\r\n                setShowEmojiPicker(false);\r\n            }\r\n            if (gifPickerRef.current && !gifPickerRef.current.contains(e.target)) {\r\n                setShowGifPicker(false);\r\n            }\r\n        };\r\n        document.addEventListener('mousedown', handleClickOutside);\r\n        return () => document.removeEventListener('mousedown', handleClickOutside);\r\n    }, []);\r\n\r\n    // Handle GIF selection\r\n    const handleGifSelect = async (gifData) => {\r\n        try {\r\n            // Convert GIF URL to file-like object for upload\r\n            const response = await fetch(gifData.url);\r\n            const blob = await response.blob();\r\n            const file = new File([blob], `gif_${Date.now()}.gif`, { type: 'image/gif' });\r\n            \r\n            const res = await uploadMedia(file, `chat_media/${activeChatId}`);\r\n            if (res) {\r\n                const gifMediaData = { \r\n                    url: res.url, \r\n                    type: 'image', \r\n                    name: gifData.title || 'GIF',\r\n                    gif: true // Flag to indicate it's a GIF\r\n                };\r\n                onSend('', gifMediaData);\r\n            }\r\n        } catch (error) {\r\n            console.error('GIF upload error:', error);\r\n            alert('Failed to send GIF');\r\n        }\r\n        setShowGifPicker(false);\r\n    };\r\n\r\n    // Handle video recording\r\n    const handleVideoRecorded = async (videoFile) => {\r\n        try {\r\n            const res = await uploadMedia(videoFile, `chat_media/${activeChatId}`);\r\n            if (res) {\r\n                const videoMediaData = { \r\n                    url: res.url, \r\n                    type: 'video', \r\n                    name: videoFile.name \r\n                };\r\n                onSend('', videoMediaData);\r\n            }\r\n        } catch (error) {\r\n            console.error('Video upload error:', error);\r\n            alert('Failed to send video');\r\n        }\r\n        setShowVideoRecorder(false);\r\n    };\r\n\r\n    // --- TEXT & TYPING ---\r\n    const handleTyping = (e) => {\r\n        setInput(e.target.value);\r\n        \r\n        // Update typing indicator via Convex\r\n        if (onTyping && e.target.value.trim()) {\r\n            onTyping();\r\n        }\r\n    };\r\n\r\n    // Insert emoji at cursor position\r\n    const insertEmoji = (emoji) => {\r\n        const textarea = textareaRef.current;\r\n        if (textarea) {\r\n            const start = textarea.selectionStart;\r\n            const end = textarea.selectionEnd;\r\n            const newValue = input.substring(0, start) + emoji + input.substring(end);\r\n            setInput(newValue);\r\n            \r\n            // Set cursor position after emoji\r\n            setTimeout(() => {\r\n                textarea.selectionStart = textarea.selectionEnd = start + emoji.length;\r\n                textarea.focus();\r\n            }, 0);\r\n        } else {\r\n            setInput(prev => prev + emoji);\r\n        }\r\n    };\r\n\r\n    // --- AUDIO RECORDING ---\r\n    const startRecording = async () => {\r\n        try {\r\n            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });\r\n            mediaRecorder.current = new MediaRecorder(stream);\r\n            audioChunks.current = [];\r\n            setRecordingDuration(0);\r\n            \r\n            mediaRecorder.current.ondataavailable = (e) => audioChunks.current.push(e.data);\r\n            mediaRecorder.current.onstop = () => {\r\n                const audioBlob = new Blob(audioChunks.current, { type: 'audio/webm' });\r\n                const audioFile = new File([audioBlob], `voice_note_${Date.now()}.webm`, { type: 'audio/webm' });\r\n                setAttachment({ \r\n                    file: audioFile, \r\n                    type: 'audio', \r\n                    previewUrl: URL.createObjectURL(audioBlob),\r\n                    duration: recordingDuration\r\n                });\r\n                stream.getTracks().forEach(track => track.stop());\r\n                if (recordingIntervalRef.current) {\r\n                    clearInterval(recordingIntervalRef.current);\r\n                }\r\n            };\r\n            \r\n            mediaRecorder.current.start();\r\n            setIsRecording(true);\r\n            \r\n            // Start duration timer\r\n            recordingIntervalRef.current = setInterval(() => {\r\n                setRecordingDuration(prev => prev + 1);\r\n            }, 1000);\r\n        } catch (e) { \r\n            alert(\"Microphone access denied. Please allow microphone permissions.\"); \r\n        }\r\n    };\r\n\r\n    const stopRecording = () => {\r\n        if (mediaRecorder.current && isRecording) {\r\n            mediaRecorder.current.stop();\r\n            setIsRecording(false);\r\n            if (recordingIntervalRef.current) {\r\n                clearInterval(recordingIntervalRef.current);\r\n            }\r\n        }\r\n    };\r\n\r\n    const cancelRecording = () => {\r\n        if (mediaRecorder.current && isRecording) {\r\n            mediaRecorder.current.stop();\r\n            // Clear the chunks so nothing is saved\r\n            audioChunks.current = [];\r\n            setIsRecording(false);\r\n            setRecordingDuration(0);\r\n            if (recordingIntervalRef.current) {\r\n                clearInterval(recordingIntervalRef.current);\r\n            }\r\n            // Stop the stream\r\n            mediaRecorder.current.stream?.getTracks().forEach(track => track.stop());\r\n        }\r\n    };\r\n\r\n    // Format duration as MM:SS\r\n    const formatDuration = (seconds) => {\r\n        const mins = Math.floor(seconds / 60);\r\n        const secs = seconds % 60;\r\n        return `${mins}:${secs.toString().padStart(2, '0')}`;\r\n    };\r\n\r\n    // Toggle audio preview playback\r\n    const toggleAudioPreview = () => {\r\n        if (!audioPreviewRef.current || !attachment?.previewUrl) return;\r\n        \r\n        if (isPlayingPreview) {\r\n            audioPreviewRef.current.pause();\r\n            setIsPlayingPreview(false);\r\n        } else {\r\n            audioPreviewRef.current.play();\r\n            setIsPlayingPreview(true);\r\n        }\r\n    };\r\n\r\n    // Cleanup recording on unmount\r\n    useEffect(() => {\r\n        return () => {\r\n            if (recordingIntervalRef.current) {\r\n                clearInterval(recordingIntervalRef.current);\r\n            }\r\n            if (mediaRecorder.current && isRecording) {\r\n                mediaRecorder.current.stop();\r\n            }\r\n        };\r\n    }, []);\r\n\r\n    // --- DRAG & DROP ---\r\n    const handleDrag = (e) => { \r\n        e.preventDefault(); \r\n        e.stopPropagation(); \r\n        if (e.type === 'dragenter' || e.type === 'dragover') {\r\n            setDragActive(true);\r\n        } else {\r\n            setDragActive(false);\r\n        }\r\n    };\r\n    \r\n    const handleDrop = (e) => {\r\n        e.preventDefault(); \r\n        e.stopPropagation(); \r\n        setDragActive(false);\r\n        if (e.dataTransfer.files && e.dataTransfer.files[0]) {\r\n            handleFileSelect(e.dataTransfer.files[0]);\r\n        }\r\n    };\r\n\r\n    const handleFileSelect = (file) => {\r\n        const type = file.type.startsWith('image/') ? 'image' : \r\n                     file.type.startsWith('video/') ? 'video' :\r\n                     file.type.startsWith('audio/') ? 'audio' : 'file';\r\n        setAttachment({ \r\n            file, \r\n            type, \r\n            previewUrl: URL.createObjectURL(file) \r\n        });\r\n    };\r\n\r\n    const handleSubmit = async (e) => {\r\n        e.preventDefault();\r\n        if ((!input.trim() && !attachment) || uploading) return;\r\n\r\n        let mediaData = null;\r\n        if (attachment) {\r\n            const res = await uploadMedia(attachment.file, `chat_media/${activeChatId}`);\r\n            if (res) {\r\n                mediaData = { \r\n                    url: res.url, \r\n                    type: res.type, \r\n                    name: res.name,\r\n                    duration: attachment.duration // Include duration for voice notes\r\n                };\r\n            }\r\n        }\r\n\r\n        onSend(input, mediaData);\r\n        setInput('');\r\n        setAttachment(null);\r\n        setIsPlayingPreview(false);\r\n        \r\n        // Clear typing indicator via Convex\r\n        if (onStopTyping) {\r\n            onStopTyping();\r\n        }\r\n    };\r\n\r\n    const handleCancel = () => {\r\n        if (editingMessage) {\r\n            setInput('');\r\n            onCancelEdit?.();\r\n        } else {\r\n            onCancelReply?.();\r\n        }\r\n    };\r\n\r\n    // Get reply/edit preview text\r\n    const getContextPreview = () => {\r\n        if (editingMessage) {\r\n            return editingMessage.b?.substring(0, 50) || 'Message';\r\n        }\r\n        if (replyingTo) {\r\n            return replyingTo.b?.substring(0, 50) || 'Media';\r\n        }\r\n        return '';\r\n    };\r\n\r\n    return (\r\n        <div \r\n            className={`p-3 bg-white dark:bg-[#2c2e36] border-t dark:border-gray-700 shrink-0 transition-colors ${\r\n                dragActive ? 'bg-blue-50 dark:bg-blue-900/20 border-blue-400' : ''\r\n            }`}\r\n            onDragEnter={handleDrag} \r\n            onDragLeave={handleDrag} \r\n            onDragOver={handleDrag} \r\n            onDrop={handleDrop}\r\n        >\r\n            {/* Typing Indicator */}\r\n            <AnimatePresence>\r\n                {typingUsers.length > 0 && (\r\n                    <motion.div \r\n                        initial={{ opacity: 0, y: 10 }}\r\n                        animate={{ opacity: 1, y: 0 }}\r\n                        exit={{ opacity: 0, y: 10 }}\r\n                        className=\"mb-2 px-2 flex items-center gap-2\"\r\n                    >\r\n                        <div className=\"flex gap-1\">\r\n                            <span className=\"w-1.5 h-1.5 bg-brand-blue rounded-full animate-bounce\"></span>\r\n                            <span className=\"w-1.5 h-1.5 bg-brand-blue rounded-full animate-bounce\" style={{ animationDelay: '0.1s' }}></span>\r\n                            <span className=\"w-1.5 h-1.5 bg-brand-blue rounded-full animate-bounce\" style={{ animationDelay: '0.2s' }}></span>\r\n                        </div>\r\n                        <span className=\"text-xs text-gray-500 dark:text-gray-400\">\r\n                            {formatTypingUsers(typingUsers)}\r\n                        </span>\r\n                    </motion.div>\r\n                )}\r\n            </AnimatePresence>\r\n\r\n            {/* Voice Recording UI */}\r\n            <AnimatePresence>\r\n                {isRecording && (\r\n                    <motion.div\r\n                        initial={{ opacity: 0, height: 0 }}\r\n                        animate={{ opacity: 1, height: 'auto' }}\r\n                        exit={{ opacity: 0, height: 0 }}\r\n                        className=\"mb-2 p-3 bg-red-50 dark:bg-red-900/20 rounded-xl border border-red-200 dark:border-red-800\"\r\n                    >\r\n                        <div className=\"flex items-center justify-between\">\r\n                            <div className=\"flex items-center gap-3\">\r\n                                <div className=\"w-3 h-3 bg-red-500 rounded-full animate-pulse\"></div>\r\n                                <span className=\"font-medium text-red-700 dark:text-red-400\">\r\n                                    Recording...\r\n                                </span>\r\n                                <span className=\"font-mono text-red-600 dark:text-red-300 text-sm\">\r\n                                    {formatDuration(recordingDuration)}\r\n                                </span>\r\n                            </div>\r\n                            \r\n                            {/* Recording Waveform Visualization */}\r\n                            <div className=\"flex items-center gap-0.5 mx-4\">\r\n                                {[...Array(20)].map((_, i) => (\r\n                                    <motion.div\r\n                                        key={i}\r\n                                        className=\"w-1 bg-red-400 rounded-full\"\r\n                                        animate={{\r\n                                            height: [8, Math.random() * 20 + 8, 8],\r\n                                        }}\r\n                                        transition={{\r\n                                            duration: 0.5,\r\n                                            repeat: Infinity,\r\n                                            delay: i * 0.05,\r\n                                        }}\r\n                                    />\r\n                                ))}\r\n                            </div>\r\n                            \r\n                            <div className=\"flex items-center gap-2\">\r\n                                <button\r\n                                    type=\"button\"\r\n                                    onClick={cancelRecording}\r\n                                    className=\"p-2 text-red-600 hover:bg-red-100 dark:hover:bg-red-900/40 rounded-full transition\"\r\n                                    title=\"Cancel recording\"\r\n                                >\r\n                                    <Trash2 size={18} />\r\n                                </button>\r\n                                <button\r\n                                    type=\"button\"\r\n                                    onClick={stopRecording}\r\n                                    className=\"p-2 bg-red-500 text-white rounded-full hover:bg-red-600 transition\"\r\n                                    title=\"Stop recording\"\r\n                                >\r\n                                    <Square size={16} fill=\"white\" />\r\n                                </button>\r\n                            </div>\r\n                        </div>\r\n                    </motion.div>\r\n                )}\r\n            </AnimatePresence>\r\n\r\n            {/* Reply/Edit Context Header */}\r\n            <AnimatePresence>\r\n                {(replyingTo || editingMessage) && (\r\n                    <motion.div \r\n                        initial={{ opacity: 0, y: 10 }}\r\n                        animate={{ opacity: 1, y: 0 }}\r\n                        exit={{ opacity: 0, y: -10 }}\r\n                        className=\"flex justify-between items-center bg-gray-100 dark:bg-gray-800 p-2.5 px-4 rounded-xl border-l-4 border-brand-blue mb-2\"\r\n                    >\r\n                        <div className=\"flex items-center gap-3 flex-1 min-w-0\">\r\n                            {editingMessage ? (\r\n                                <Pencil size={16} className=\"text-brand-blue shrink-0\" />\r\n                            ) : (\r\n                                <CornerUpLeft size={16} className=\"text-brand-blue shrink-0\" />\r\n                            )}\r\n                            <div className=\"min-w-0\">\r\n                                <span className=\"text-xs font-bold text-brand-blue block\">\r\n                                    {editingMessage ? 'Editing Message' : `Replying to ${replyingTo?.n || 'User'}`}\r\n                                </span>\r\n                                <span className=\"text-xs text-gray-500 dark:text-gray-400 truncate block\">\r\n                                    {getContextPreview()}\r\n                                </span>\r\n                            </div>\r\n                        </div>\r\n                        <button \r\n                            onClick={handleCancel}\r\n                            className=\"p-1 hover:bg-gray-200 dark:hover:bg-gray-700 rounded-full transition\"\r\n                        >\r\n                            <X size={16} className=\"text-gray-400 hover:text-red-500\"/>\r\n                        </button>\r\n                    </motion.div>\r\n                )}\r\n            </AnimatePresence>\r\n\r\n            {/* Attachment Preview */}\r\n            <AnimatePresence>\r\n                {attachment && (\r\n                    <motion.div \r\n                        initial={{ opacity: 0, scale: 0.95 }}\r\n                        animate={{ opacity: 1, scale: 1 }}\r\n                        exit={{ opacity: 0, scale: 0.95 }}\r\n                        className=\"flex items-center gap-3 p-3 bg-gray-100 dark:bg-gray-800 rounded-xl mb-2 border dark:border-gray-700\"\r\n                    >\r\n                        {attachment.type === 'image' ? (\r\n                            <img src={attachment.previewUrl} className=\"h-14 w-14 object-cover rounded-lg\"/>\r\n                        ) : attachment.type === 'video' ? (\r\n                            <video src={attachment.previewUrl} className=\"h-14 w-14 object-cover rounded-lg\"/>\r\n                        ) : attachment.type === 'audio' ? (\r\n                            <div className=\"flex items-center gap-3 flex-1\">\r\n                                {/* Audio preview with playback */}\r\n                                <button\r\n                                    type=\"button\"\r\n                                    onClick={toggleAudioPreview}\r\n                                    className=\"h-12 w-12 bg-purple-500 text-white flex items-center justify-center rounded-full hover:bg-purple-600 transition shrink-0\"\r\n                                >\r\n                                    {isPlayingPreview ? <Pause size={20} /> : <Play size={20} className=\"ml-0.5\" />}\r\n                                </button>\r\n                                <div className=\"flex-1 min-w-0\">\r\n                                    <div className=\"flex items-center gap-2\">\r\n                                        <Mic size={14} className=\"text-purple-500\" />\r\n                                        <span className=\"text-sm font-bold dark:text-white\">Voice Message</span>\r\n                                    </div>\r\n                                    <div className=\"flex items-center gap-2 mt-1\">\r\n                                        {/* Simple waveform visualization */}\r\n                                        <div className=\"flex items-center gap-0.5 flex-1\">\r\n                                            {[...Array(30)].map((_, i) => (\r\n                                                <div\r\n                                                    key={i}\r\n                                                    className=\"w-1 bg-purple-300 dark:bg-purple-700 rounded-full\"\r\n                                                    style={{ height: `${Math.random() * 12 + 4}px` }}\r\n                                                />\r\n                                            ))}\r\n                                        </div>\r\n                                        <span className=\"text-xs text-gray-500 font-mono\">\r\n                                            {attachment.duration ? formatDuration(attachment.duration) : '0:00'}\r\n                                        </span>\r\n                                    </div>\r\n                                </div>\r\n                                <audio \r\n                                    ref={audioPreviewRef}\r\n                                    src={attachment.previewUrl}\r\n                                    onEnded={() => setIsPlayingPreview(false)}\r\n                                    className=\"hidden\"\r\n                                />\r\n                            </div>\r\n                        ) : (\r\n                            <>\r\n                                <div className=\"h-14 w-14 bg-gray-200 dark:bg-gray-700 text-gray-500 flex items-center justify-center rounded-lg\">\r\n                                    <FileText size={24}/>\r\n                                </div>\r\n                                <div className=\"flex-1 min-w-0\">\r\n                                    <div className=\"text-sm font-bold dark:text-white truncate\">{attachment.file.name}</div>\r\n                                    <div className=\"text-xs text-gray-500\">{(attachment.file.size / 1024).toFixed(1)} KB</div>\r\n                                </div>\r\n                            </>\r\n                        )}\r\n                        <button \r\n                            onClick={() => {\r\n                                setAttachment(null);\r\n                                setIsPlayingPreview(false);\r\n                            }}\r\n                            className=\"p-2 hover:bg-gray-200 dark:hover:bg-gray-700 rounded-full transition shrink-0\"\r\n                        >\r\n                            <X size={18} className=\"text-gray-400 hover:text-red-500\"/>\r\n                        </button>\r\n                    </motion.div>\r\n                )}\r\n            </AnimatePresence>\r\n\r\n            {/* Main Input Row */}\r\n            <form onSubmit={handleSubmit} className=\"flex items-end gap-2\">\r\n                {/* Attachment button with dropdown */}\r\n                <div className=\"relative\">\r\n                    <input \r\n                        type=\"file\" \r\n                        ref={fileInputRef} \r\n                        className=\"hidden\" \r\n                        accept=\"image/*,audio/*,video/*,.pdf,.doc,.docx,.txt,.zip\" \r\n                        onChange={(e) => handleFileSelect(e.target.files[0])} \r\n                    />\r\n                    \r\n                    <button \r\n                        type=\"button\" \r\n                        onClick={() => fileInputRef.current?.click()} \r\n                        className=\"p-2.5 text-gray-500 hover:text-brand-blue hover:bg-gray-100 dark:hover:bg-gray-700 rounded-full transition shrink-0\"\r\n                        title=\"Attach file\"\r\n                    >\r\n                        <Paperclip size={20}/>\r\n                    </button>\r\n                </div>\r\n\r\n                {/* Media options */}\r\n                <div className=\"flex items-center gap-1 border-r dark:border-gray-700 pr-2\">\r\n                    <button\r\n                        type=\"button\"\r\n                        onClick={() => {\r\n                            setShowVideoRecorder(true);\r\n                            setShowEmojiPicker(false);\r\n                            setShowGifPicker(false);\r\n                        }}\r\n                        className=\"p-2 text-gray-500 hover:text-red-500 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-full transition\"\r\n                        title=\"Record video\"\r\n                    >\r\n                        <Video size={18} />\r\n                    </button>\r\n                    \r\n                    <button\r\n                        type=\"button\"\r\n                        onClick={() => {\r\n                            setShowGifPicker(!showGifPicker);\r\n                            setShowEmojiPicker(false);\r\n                        }}\r\n                        className=\"p-2 text-gray-500 hover:text-purple-500 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-full transition relative\"\r\n                        title=\"GIF\"\r\n                        ref={gifPickerRef}\r\n                    >\r\n                        <ImagePlus size={18} />\r\n                        {showGifPicker && (\r\n                            <GifPicker\r\n                                onSelect={handleGifSelect}\r\n                                onClose={() => setShowGifPicker(false)}\r\n                                position=\"bottom\"\r\n                            />\r\n                        )}\r\n                    </button>\r\n                </div>\r\n                \r\n                {/* Input field with emoji button */}\r\n                <div className=\"flex-1 bg-gray-100 dark:bg-[#1f2128] rounded-2xl border dark:border-gray-700 focus-within:ring-2 focus-within:ring-brand-blue transition-all flex items-end relative\">\r\n                    <textarea \r\n                        ref={textareaRef}\r\n                        className=\"w-full bg-transparent p-3 max-h-32 min-h-[44px] text-sm resize-none outline-none dark:text-white custom-scrollbar pr-20\" \r\n                        placeholder={\r\n                            editingMessage ? \"Update message...\" : \r\n                            dragActive ? \"Drop files here...\" : \r\n                            \"Type a message...\"\r\n                        } \r\n                        value={input} \r\n                        onChange={handleTyping} \r\n                        onKeyDown={e => { \r\n                            if(e.key === 'Enter' && !e.shiftKey) { \r\n                                e.preventDefault(); \r\n                                handleSubmit(e); \r\n                            }\r\n                        }}\r\n                        rows={1}\r\n                    />\r\n                    \r\n                    {/* Right-side buttons inside input */}\r\n                    <div className=\"absolute right-2 bottom-1.5 flex items-center gap-1\">\r\n                        {/* Full Emoji picker */}\r\n                        <div className=\"relative\" ref={emojiPickerRef}>\r\n                            <button \r\n                                type=\"button\" \r\n                                onClick={() => {\r\n                                    setShowEmojiPicker(!showEmojiPicker);\r\n                                    setShowGifPicker(false);\r\n                                }}\r\n                                className={`p-1.5 rounded-full transition ${\r\n                                    showEmojiPicker \r\n                                        ? 'bg-brand-blue/20 text-brand-blue' \r\n                                        : 'text-gray-400 hover:text-gray-600 dark:hover:text-gray-300'\r\n                                }`}\r\n                                title=\"Emoji\"\r\n                            >\r\n                                <Smile size={18}/>\r\n                            </button>\r\n                            \r\n                            <AnimatePresence>\r\n                                {showEmojiPicker && (\r\n                                    <EmojiPicker\r\n                                        onSelect={insertEmoji}\r\n                                        onClose={() => setShowEmojiPicker(false)}\r\n                                        position=\"bottom\"\r\n                                    />\r\n                                )}\r\n                            </AnimatePresence>\r\n                        </div>\r\n\r\n                        {/* Voice record button */}\r\n                        <button \r\n                            type=\"button\" \r\n                            onClick={isRecording ? stopRecording : startRecording} \r\n                            className={`p-1.5 rounded-full transition ${\r\n                                isRecording \r\n                                    ? 'bg-red-500 text-white animate-pulse' \r\n                                    : 'text-gray-400 hover:text-gray-600 dark:hover:text-gray-300'\r\n                            }`}\r\n                        >\r\n                            {isRecording ? <StopCircle size={18}/> : <Mic size={18}/>}\r\n                        </button>\r\n                    </div>\r\n                </div>\r\n\r\n                {/* Send button */}\r\n                <button \r\n                    type=\"submit\" \r\n                    disabled={(!input.trim() && !attachment) || uploading} \r\n                    className={`p-2.5 text-white rounded-full shadow-lg disabled:opacity-50 disabled:cursor-not-allowed transition-all shrink-0 ${\r\n                        editingMessage \r\n                            ? 'bg-green-600 hover:bg-green-700' \r\n                            : 'bg-brand-blue hover:bg-blue-600'\r\n                    }`}\r\n                >\r\n                    {uploading ? (\r\n                        <Loader2 size={20} className=\"animate-spin\"/>\r\n                    ) : editingMessage ? (\r\n                        <CheckCircle size={20}/>\r\n                    ) : (\r\n                        <Send size={20}/>\r\n                    )}\r\n                </button>\r\n            </form>\r\n\r\n            {/* Video Recorder Modal */}\r\n            {showVideoRecorder && (\r\n                <VideoRecorder\r\n                    onRecorded={handleVideoRecorded}\r\n                    onClose={() => setShowVideoRecorder(false)}\r\n                    maxDuration={60}\r\n                />\r\n            )}\r\n        </div>\r\n    );\r\n}\r\n","import React from 'react';\r\nimport { clsx } from 'clsx';\r\nimport { twMerge } from 'tailwind-merge';\r\n\r\n// Utility for merging tailwind classes\r\nfunction cn(...inputs) {\r\n  return twMerge(clsx(inputs));\r\n}\r\n\r\nconst Button = React.forwardRef(({ className, variant = \"default\", size = \"default\", ...props }, ref) => {\r\n  const variants = {\r\n    default: \"bg-blue-600 text-white hover:bg-blue-700 shadow-sm\",\r\n    destructive: \"bg-red-500 text-white hover:bg-red-600 shadow-sm\",\r\n    outline: \"border border-gray-200 bg-transparent hover:bg-gray-100 text-gray-900\",\r\n    secondary: \"bg-gray-100 text-gray-900 hover:bg-gray-200\",\r\n    ghost: \"hover:bg-gray-100 hover:text-gray-900 text-gray-600\",\r\n    link: \"text-blue-600 underline-offset-4 hover:underline\",\r\n  };\r\n\r\n  const sizes = {\r\n    default: \"h-9 px-4 py-2\",\r\n    sm: \"h-8 rounded-md px-3 text-xs\",\r\n    lg: \"h-10 rounded-md px-8\",\r\n    icon: \"h-9 w-9\",\r\n  };\r\n\r\n  return (\r\n    <button\r\n      ref={ref}\r\n      className={cn(\r\n        \"inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-gray-950 disabled:pointer-events-none disabled:opacity-50\",\r\n        variants[variant],\r\n        sizes[size],\r\n        className\r\n      )}\r\n      {...props}\r\n    />\r\n  );\r\n});\r\n\r\nButton.displayName = \"Button\";\r\n\r\nexport { Button };\r\n","import React from 'react';\r\nimport { X, ExternalLink } from 'lucide-react';\r\nimport { Button } from '@/components/ui/button';\r\n\r\n/**\r\n * A modal to embed and display content (like a profile or session detail) \r\n * shared via a SeshNx platform link, without leaving the chat interface.\r\n * * @param {object} props\r\n * @param {string} props.url - The SeshNx URL to be embedded.\r\n * @param {boolean} props.isOpen - Controls the modal visibility.\r\n * @param {function} props.onClose - Function to close the modal.\r\n * @param {object} props.previewData - Pre-fetched metadata about the link (e.g., title).\r\n */\r\nexport default function SeshNxEmbedModal({ url, isOpen, onClose, previewData }) {\r\n    if (!isOpen || !url) return null;\r\n\r\n    // Determine the type of content for better display titles\r\n    const contentPath = new URL(url).pathname;\r\n    let contentType = 'Content';\r\n    if (contentPath.startsWith('/profile/')) {\r\n        contentType = 'User Profile';\r\n    } else if (contentPath.startsWith('/session/')) {\r\n        contentType = 'Session Details';\r\n    } else if (contentPath.startsWith('/studio/')) {\r\n        contentType = 'Studio Listing';\r\n    }\r\n\r\n    // Determine the actual title to display\r\n    const title = previewData?.title || `${contentType} Preview`;\r\n\r\n    return (\r\n        <div \r\n            className=\"fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black bg-opacity-70 backdrop-blur-sm\"\r\n            onClick={onClose} // Close on backdrop click\r\n        >\r\n            <div \r\n                className=\"bg-gray-900 rounded-xl shadow-2xl w-full max-w-2xl h-3/4 max-h-[800px] flex flex-col transform transition-all duration-300 scale-100 opacity-100\"\r\n                onClick={(e) => e.stopPropagation()} // Prevent closing when clicking inside modal\r\n            >\r\n                {/* Modal Header */}\r\n                <div className=\"flex items-center justify-between p-4 border-b border-gray-700 bg-gray-800 rounded-t-xl sticky top-0\">\r\n                    <h3 className=\"text-xl font-bold text-white truncate max-w-[80%]\">{title}</h3>\r\n                    <div className=\"flex items-center space-x-2\">\r\n                        {/* Open in new tab button */}\r\n                        <a href={url} target=\"_blank\" rel=\"noopener noreferrer\">\r\n                            <Button variant=\"ghost\" size=\"icon\" className=\"text-blue-400 hover:text-blue-300\">\r\n                                <ExternalLink className=\"w-5 h-5\" />\r\n                            </Button>\r\n                        </a>\r\n                        {/* Close button */}\r\n                        <Button onClick={onClose} variant=\"ghost\" size=\"icon\" className=\"text-white hover:bg-gray-700\">\r\n                            <X className=\"w-5 h-5\" />\r\n                        </Button>\r\n                    </div>\r\n                </div>\r\n\r\n                {/* Modal Content - Placeholder for actual embedded view */}\r\n                <div className=\"flex-1 p-4 overflow-y-auto custom-scrollbar text-gray-400 flex flex-col items-center justify-center text-center\">\r\n                    <p className=\"mb-4 text-lg font-medium text-white\">Embedded Content Simulation</p>\r\n                    <p className=\"mb-2\">This is where the actual SeshNx content (e.g., profile card, session details) would be rendered, based on the URL:</p>\r\n                    <a href={url} target=\"_blank\" rel=\"noopener noreferrer\" className=\"text-blue-400 hover:underline break-all p-2 bg-gray-700 rounded-lg text-sm\">\r\n                        {url}\r\n                    </a>\r\n                    <p className=\"mt-4 text-sm\">In a real implementation, you would use a dedicated component (e.g., `ProfileCard id=\"...\"`) here instead of an iframe to display the content securely and natively.</p>\r\n                </div>\r\n                \r\n                {/* Modal Footer */}\r\n                <div className=\"p-3 border-t border-gray-700 bg-gray-800 rounded-b-xl flex justify-end\">\r\n                    <Button onClick={onClose} variant=\"secondary\">Done</Button>\r\n                </div>\r\n            </div>\r\n        </div>\r\n    );\r\n}\r\n","import React from 'react';\r\nimport { Check, CheckCheck, Clock } from 'lucide-react';\r\nimport { motion } from 'framer-motion';\r\n\r\n/**\r\n * Message delivery/read status indicators\r\n * \r\n * States:\r\n * - Sending: Clock icon (not yet sent)\r\n * - Sent: Single checkmark (delivered to server)\r\n * - Delivered: Double checkmark (delivered to recipient)\r\n * - Read: Double checkmark (blue) (read by recipient)\r\n */\r\nexport default function MessageStatus({ \r\n    status = 'sent', // 'sending' | 'sent' | 'delivered' | 'read'\r\n    size = 12,\r\n    className = ''\r\n}) {\r\n    const statusConfig = {\r\n        sending: {\r\n            icon: Clock,\r\n            color: 'text-gray-400',\r\n            animate: true\r\n        },\r\n        sent: {\r\n            icon: Check,\r\n            color: 'text-gray-400',\r\n            animate: false\r\n        },\r\n        delivered: {\r\n            icon: CheckCheck,\r\n            color: 'text-gray-400',\r\n            animate: false\r\n        },\r\n        read: {\r\n            icon: CheckCheck,\r\n            color: 'text-brand-blue',\r\n            animate: false\r\n        }\r\n    };\r\n\r\n    const config = statusConfig[status] || statusConfig.sent;\r\n    const Icon = config.icon;\r\n\r\n    return (\r\n        <motion.div\r\n            animate={config.animate ? { rotate: [0, 360] } : {}}\r\n            transition={config.animate ? { duration: 2, repeat: Infinity, ease: \"linear\" } : {}}\r\n            className={`inline-flex items-center ${config.color} ${className}`}\r\n        >\r\n            <Icon size={size} className={status === 'read' ? 'fill-current' : ''} />\r\n        </motion.div>\r\n    );\r\n}\r\n\r\n/**\r\n * Compact status for message bubbles\r\n */\r\nexport function MessageStatusCompact({ status, messageTime, isOwn }) {\r\n    if (!isOwn) return null;\r\n\r\n    return (\r\n        <div className=\"flex items-center gap-1\">\r\n            <MessageStatus status={status} size={10} />\r\n            <span className=\"text-[10px] text-gray-400\">\r\n                {messageTime}\r\n            </span>\r\n        </div>\r\n    );\r\n}\r\n\r\n","import React, { useRef, useEffect, useState } from 'react';\r\nimport { Play, Pause } from 'lucide-react';\r\n\r\n/**\r\n * Audio waveform visualizer component\r\n * Displays waveform for voice messages\r\n */\r\nexport default function AudioWaveform({ \r\n    audioUrl, \r\n    color = 'brand-blue',\r\n    height = 40 \r\n}) {\r\n    const canvasRef = useRef(null);\r\n    const audioRef = useRef(null);\r\n    const animationRef = useRef(null);\r\n    const audioContextRef = useRef(null);\r\n    const analyserRef = useRef(null);\r\n    const [isPlaying, setIsPlaying] = useState(false);\r\n\r\n    useEffect(() => {\r\n        if (!audioUrl || !canvasRef.current) return;\r\n\r\n        const canvas = canvasRef.current;\r\n        const ctx = canvas.getContext('2d');\r\n        const audio = new Audio(audioUrl);\r\n\r\n        audioRef.current = audio;\r\n\r\n        // Set canvas size\r\n        canvas.width = canvas.offsetWidth;\r\n        canvas.height = height;\r\n\r\n        // Create audio context for visualization\r\n        const audioContext = new (window.AudioContext || window.webkitAudioContext)();\r\n        const analyser = audioContext.createAnalyser();\r\n        const source = audioContext.createMediaElementSource(audio);\r\n\r\n        analyser.fftSize = 256;\r\n        source.connect(analyser);\r\n        analyser.connect(audioContext.destination);\r\n\r\n        audioContextRef.current = audioContext;\r\n        analyserRef.current = analyser;\r\n\r\n        // Visualize\r\n        const bufferLength = analyser.frequencyBinCount;\r\n        const dataArray = new Uint8Array(bufferLength);\r\n\r\n        const draw = () => {\r\n            if (audio.paused) {\r\n                // Draw static waveform when paused\r\n                drawStaticWaveform(ctx, canvas.width, canvas.height);\r\n                return;\r\n            }\r\n\r\n            animationRef.current = requestAnimationFrame(draw);\r\n            analyser.getByteFrequencyData(dataArray);\r\n\r\n            ctx.clearRect(0, 0, canvas.width, canvas.height);\r\n            \r\n            const barWidth = canvas.width / bufferLength * 2;\r\n            let x = 0;\r\n\r\n            for (let i = 0; i < bufferLength; i++) {\r\n                const barHeight = (dataArray[i] / 255) * canvas.height;\r\n\r\n                const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);\r\n                gradient.addColorStop(0, '#3b82f6'); // brand-blue\r\n                gradient.addColorStop(1, '#8b5cf6'); // purple\r\n\r\n                ctx.fillStyle = gradient;\r\n                ctx.fillRect(x, canvas.height - barHeight, barWidth - 1, barHeight);\r\n                x += barWidth;\r\n            }\r\n        };\r\n\r\n        audio.addEventListener('play', () => {\r\n            setIsPlaying(true);\r\n            draw();\r\n        });\r\n\r\n        audio.addEventListener('pause', () => {\r\n            setIsPlaying(false);\r\n            if (animationRef.current) {\r\n                cancelAnimationFrame(animationRef.current);\r\n            }\r\n            drawStaticWaveform(ctx, canvas.width, canvas.height);\r\n        });\r\n\r\n        audio.addEventListener('ended', () => {\r\n            setIsPlaying(false);\r\n            if (animationRef.current) {\r\n                cancelAnimationFrame(animationRef.current);\r\n            }\r\n            drawStaticWaveform(ctx, canvas.width, canvas.height);\r\n        });\r\n\r\n        // Initial static waveform\r\n        drawStaticWaveform(ctx, canvas.width, canvas.height);\r\n\r\n        return () => {\r\n            if (animationRef.current) {\r\n                cancelAnimationFrame(animationRef.current);\r\n            }\r\n            audio.pause();\r\n            audioContextRef.current?.close();\r\n        };\r\n    }, [audioUrl, height, isPlaying]);\r\n\r\n    const drawStaticWaveform = (ctx, width, height) => {\r\n        ctx.clearRect(0, 0, width, height);\r\n        ctx.fillStyle = '#3b82f6';\r\n        \r\n        const barCount = 50;\r\n        const barWidth = width / barCount;\r\n        const gap = 2;\r\n\r\n        for (let i = 0; i < barCount; i++) {\r\n            const barHeight = Math.random() * height * 0.3 + height * 0.1;\r\n            const x = i * barWidth;\r\n            ctx.fillRect(x, height - barHeight, barWidth - gap, barHeight);\r\n        }\r\n    };\r\n\r\n    const togglePlay = () => {\r\n        if (!audioRef.current) return;\r\n\r\n        if (isPlaying) {\r\n            audioRef.current.pause();\r\n        } else {\r\n            audioRef.current.play();\r\n        }\r\n    };\r\n\r\n    return (\r\n        <div className=\"flex items-center gap-3\">\r\n            <button\r\n                onClick={togglePlay}\r\n                className=\"w-10 h-10 flex items-center justify-center bg-brand-blue text-white rounded-full hover:bg-blue-600 transition shrink-0\"\r\n            >\r\n                {isPlaying ? <Pause size={16} /> : <Play size={16} className=\"ml-0.5\" />}\r\n            </button>\r\n            <div className=\"flex-1\">\r\n                <canvas\r\n                    ref={canvasRef}\r\n                    className=\"w-full rounded\"\r\n                    style={{ height: `${height}px` }}\r\n                />\r\n                <audio ref={audioRef} src={audioUrl} />\r\n            </div>\r\n        </div>\r\n    );\r\n}\r\n\r\n","import React, { useState, useRef, useEffect } from 'react';\r\nimport { \r\n    CornerUpLeft, \r\n    Pencil, \r\n    Trash2, \r\n    Forward, \r\n    Copy, \r\n    MoreHorizontal,\r\n    FileText,\r\n    Globe,\r\n    Link as LinkIcon,\r\n    X,\r\n    Download\r\n} from 'lucide-react';\r\nimport { motion, AnimatePresence } from 'framer-motion';\r\nimport MessageReactions from './MessageReactions';\r\nimport MessageStatus from './MessageStatus';\r\nimport AudioWaveform from '../media/AudioWaveform';\r\nimport UserAvatar from '../../shared/UserAvatar';\r\n\r\n// Reaction emoji set (6 reactions)\r\nexport const CHAT_REACTIONS = ['ðŸ‘', 'â¤ï¸', 'ðŸ˜‚', 'ðŸ˜®', 'ðŸ˜¢', 'ðŸ”¥'];\r\n\r\n/**\r\n * Enhanced message bubble component with reactions, reply, edit, delete\r\n */\r\nexport default function MessageBubble({\r\n    message,\r\n    isCurrentUser,\r\n    previousMessage,\r\n    currentUserId,\r\n    chatId,\r\n    linkPreviewData,\r\n    messageStatus = 'sent', // 'sending' | 'sent' | 'delivered' | 'read'\r\n    onReaction,\r\n    onReply,\r\n    onEdit,\r\n    onDelete,\r\n    onForward,\r\n    onSeshNxLinkClick,\r\n    onUserClick\r\n}) {\r\n    const [showMenu, setShowMenu] = useState(false);\r\n    const [showReactionPicker, setShowReactionPicker] = useState(false);\r\n    const [copied, setCopied] = useState(false);\r\n    const menuRef = useRef(null);\r\n    const bubbleRef = useRef(null);\r\n\r\n    // Calculate grouping logic\r\n    const isFirstInGroup = !previousMessage || previousMessage.s !== message.s;\r\n    const isSameDay = previousMessage && \r\n        new Date(message.t).toDateString() === new Date(previousMessage.t).toDateString();\r\n    const currentMs = message.t || Date.now();\r\n    const prevMs = previousMessage?.t || 0;\r\n    const isFarApart = previousMessage && (currentMs - prevMs > 300000); // 5 min gap\r\n\r\n    const shouldShowDate = !isSameDay || !previousMessage;\r\n    const shouldShowTime = isFirstInGroup || isFarApart;\r\n    const shouldShowAvatar = !isCurrentUser && isFirstInGroup;\r\n\r\n    const msgDate = new Date(message.t || Date.now());\r\n\r\n    // Close menu on outside click\r\n    useEffect(() => {\r\n        const handleClickOutside = (e) => {\r\n            if (menuRef.current && !menuRef.current.contains(e.target)) {\r\n                setShowMenu(false);\r\n                setShowReactionPicker(false);\r\n            }\r\n        };\r\n        document.addEventListener('mousedown', handleClickOutside);\r\n        return () => document.removeEventListener('mousedown', handleClickOutside);\r\n    }, []);\r\n\r\n    // Copy message text\r\n    const handleCopy = () => {\r\n        navigator.clipboard.writeText(message.b || '');\r\n        setCopied(true);\r\n        setTimeout(() => setCopied(false), 2000);\r\n        setShowMenu(false);\r\n    };\r\n\r\n    // Handle reaction click\r\n    const handleReaction = (emoji) => {\r\n        onReaction?.(message.id, emoji);\r\n        setShowReactionPicker(false);\r\n        setShowMenu(false);\r\n    };\r\n\r\n    // Get reaction counts\r\n    const reactionCounts = message.reactions \r\n        ? Object.entries(message.reactions).reduce((acc, [emoji, users]) => {\r\n            const count = typeof users === 'object' ? Object.keys(users).length : 0;\r\n            if (count > 0) acc[emoji] = count;\r\n            return acc;\r\n        }, {})\r\n        : {};\r\n    \r\n    const hasReactions = Object.keys(reactionCounts).length > 0;\r\n    const myReaction = message.reactions \r\n        ? Object.entries(message.reactions).find(([emoji, users]) => \r\n            typeof users === 'object' && users[currentUserId]\r\n          )?.[0]\r\n        : null;\r\n\r\n    // Message styling\r\n    const bubbleClass = isCurrentUser\r\n        ? 'bg-brand-blue text-white rounded-br-sm'\r\n        : 'bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-white rounded-bl-sm';\r\n\r\n    // Deleted message\r\n    if (message.deleted || message.deletedForAll) {\r\n        return (\r\n            <div className={`flex ${isCurrentUser ? 'justify-end' : 'justify-start'} ${isFirstInGroup ? 'mt-3' : 'mt-0.5'}`}>\r\n                <div className=\"px-4 py-2 rounded-2xl bg-gray-100 dark:bg-gray-800 text-gray-400 italic text-sm\">\r\n                    ðŸš« This message was deleted\r\n                </div>\r\n            </div>\r\n        );\r\n    }\r\n\r\n    // Check if deleted for current user only\r\n    if (message.deletedFor && message.deletedFor[currentUserId]) {\r\n        return null;\r\n    }\r\n\r\n    // Render link preview\r\n    const renderLinkPreview = () => {\r\n        if (!linkPreviewData) return null;\r\n        const isSeshNxLink = linkPreviewData.url?.includes('app.seshnx.com');\r\n\r\n        return (\r\n            <div className=\"mt-2 block border border-gray-300 dark:border-gray-600 rounded-lg overflow-hidden bg-white dark:bg-gray-800 max-w-[280px]\">\r\n                {isSeshNxLink ? (\r\n                    <button \r\n                        onClick={() => onSeshNxLinkClick?.(linkPreviewData)} \r\n                        className=\"w-full text-left\"\r\n                    >\r\n                        {linkPreviewData.image && (\r\n                            <div \r\n                                className=\"h-28 w-full bg-cover bg-center\" \r\n                                style={{ backgroundImage: `url(${linkPreviewData.image})` }}\r\n                            />\r\n                        )}\r\n                        <div className=\"p-2\">\r\n                            <p className=\"font-semibold text-xs text-brand-blue truncate flex items-center\">\r\n                                <LinkIcon className=\"w-3 h-3 mr-1\"/>\r\n                                {linkPreviewData.title || 'SeshNx Link'}\r\n                            </p>\r\n                            {linkPreviewData.description && (\r\n                                <p className=\"text-[10px] text-gray-500 mt-0.5 line-clamp-2\">\r\n                                    {linkPreviewData.description}\r\n                                </p>\r\n                            )}\r\n                        </div>\r\n                    </button>\r\n                ) : (\r\n                    <a href={linkPreviewData.url} target=\"_blank\" rel=\"noopener noreferrer\">\r\n                        {linkPreviewData.image && (\r\n                            <div \r\n                                className=\"h-28 w-full bg-cover bg-center\" \r\n                                style={{ backgroundImage: `url(${linkPreviewData.image})` }}\r\n                            />\r\n                        )}\r\n                        <div className=\"p-2\">\r\n                            <p className=\"font-semibold text-xs text-brand-blue truncate\">\r\n                                {linkPreviewData.title || linkPreviewData.url}\r\n                            </p>\r\n                            {linkPreviewData.description && (\r\n                                <p className=\"text-[10px] text-gray-500 mt-0.5 line-clamp-2\">\r\n                                    {linkPreviewData.description}\r\n                                </p>\r\n                            )}\r\n                            <p className=\"text-[10px] text-gray-400 mt-1 flex items-center\">\r\n                                <Globe className=\"w-2.5 h-2.5 mr-1\"/>\r\n                                {new URL(linkPreviewData.url).hostname}\r\n                            </p>\r\n                        </div>\r\n                    </a>\r\n                )}\r\n            </div>\r\n        );\r\n    };\r\n\r\n    return (\r\n        <>\r\n            {/* Date separator */}\r\n            {shouldShowDate && (\r\n                <div className=\"text-center my-4\">\r\n                    <span className=\"text-[10px] text-gray-400 dark:text-gray-500 font-bold uppercase tracking-wider bg-gray-100 dark:bg-gray-800 px-3 py-1 rounded-full\">\r\n                        {msgDate.toLocaleDateString('en-US', { \r\n                            year: 'numeric', \r\n                            month: 'long', \r\n                            day: 'numeric' \r\n                        })}\r\n                    </span>\r\n                </div>\r\n            )}\r\n\r\n            {/* Message row */}\r\n            <div \r\n                className={`group flex items-end gap-2 ${isCurrentUser ? 'flex-row-reverse' : 'flex-row'} ${isFirstInGroup ? 'mt-3' : 'mt-0.5'}`}\r\n                ref={bubbleRef}\r\n            >\r\n                {/* Avatar (for others' messages) */}\r\n                {!isCurrentUser && (\r\n                    <div className=\"w-8 shrink-0\">\r\n                        {shouldShowAvatar && (\r\n                            <UserAvatar \r\n                                src={message.photo}\r\n                                name={message.n}\r\n                                size=\"xs\"\r\n                                className=\"cursor-pointer\"\r\n                                onClick={() => onUserClick?.(message.s)}\r\n                            />\r\n                        )}\r\n                    </div>\r\n                )}\r\n\r\n                {/* Message content */}\r\n                <div className={`relative max-w-[75%] ${isCurrentUser ? 'items-end' : 'items-start'}`}>\r\n                    {/* Sender name (for group chats, first in group) */}\r\n                    {!isCurrentUser && isFirstInGroup && message.n && (\r\n                        <p className=\"text-[10px] font-bold text-gray-500 dark:text-gray-400 mb-1 ml-1\">\r\n                            {message.n}\r\n                        </p>\r\n                    )}\r\n\r\n                    {/* Reply preview */}\r\n                    {message.replyTo && (\r\n                        <div className={`mb-1 px-3 py-1.5 rounded-lg text-xs border-l-2 border-brand-blue ${\r\n                            isCurrentUser \r\n                                ? 'bg-blue-400/30 text-blue-100' \r\n                                : 'bg-gray-200 dark:bg-gray-600 text-gray-600 dark:text-gray-300'\r\n                        }`}>\r\n                            <p className=\"font-bold text-[10px] mb-0.5\">{message.replyTo.sender}</p>\r\n                            <p className=\"truncate opacity-80\">{message.replyTo.text}</p>\r\n                        </div>\r\n                    )}\r\n\r\n                    {/* Main bubble */}\r\n                    <div \r\n                        className={`relative px-3 py-2 rounded-2xl shadow-sm ${bubbleClass} cursor-pointer transition-all hover:shadow-md`}\r\n                        onClick={() => setShowMenu(!showMenu)}\r\n                    >\r\n                        {/* Media content */}\r\n                        {message.media && (\r\n                            <div className=\"mb-2\">\r\n                                {message.media.type === 'image' && (\r\n                                    <div className=\"relative rounded-lg overflow-hidden\">\r\n                                        {message.media.gif && (\r\n                                            <span className=\"absolute top-2 left-2 bg-black/60 text-white text-xs px-2 py-0.5 rounded-full font-bold\">\r\n                                                GIF\r\n                                            </span>\r\n                                        )}\r\n                                        <img \r\n                                            src={message.media.url} \r\n                                            alt=\"Shared\" \r\n                                            className=\"max-w-full h-auto rounded-lg max-h-60 object-cover\"\r\n                                        />\r\n                                    </div>\r\n                                )}\r\n                                {message.media.type === 'video' && (\r\n                                    <video \r\n                                        controls \r\n                                        src={message.media.url} \r\n                                        className=\"max-w-full h-auto rounded-lg max-h-60\"\r\n                                    />\r\n                                )}\r\n                                {message.media.type === 'audio' && (\r\n                                    <div className=\"bg-gray-50 dark:bg-gray-800 rounded-lg p-3 max-w-[280px]\">\r\n                                        <AudioWaveform \r\n                                            audioUrl={message.media.url}\r\n                                            height={50}\r\n                                        />\r\n                                    </div>\r\n                                )}\r\n                                {message.media.type === 'file' && (\r\n                                    <a \r\n                                        href={message.media.url} \r\n                                        target=\"_blank\" \r\n                                        rel=\"noopener noreferrer\"\r\n                                        download={message.media.name}\r\n                                        className=\"flex items-center gap-3 p-3 bg-gray-50 dark:bg-gray-800 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition group\"\r\n                                    >\r\n                                        <div className=\"w-10 h-10 bg-blue-100 dark:bg-blue-900/30 rounded-lg flex items-center justify-center shrink-0\">\r\n                                            <FileText size={20} className=\"text-blue-600 dark:text-blue-400\" />\r\n                                        </div>\r\n                                        <div className=\"flex-1 min-w-0\">\r\n                                            <p className=\"text-sm font-semibold dark:text-white truncate\">\r\n                                                {message.media.name || 'File'}\r\n                                            </p>\r\n                                            <p className=\"text-xs text-gray-500\">\r\n                                                Click to download\r\n                                            </p>\r\n                                        </div>\r\n                                        <Download size={18} className=\"text-gray-400 group-hover:text-brand-blue transition shrink-0\" />\r\n                                    </a>\r\n                                )}\r\n                            </div>\r\n                        )}\r\n\r\n                        {/* Text content */}\r\n                        {message.b && (\r\n                            <p className=\"text-sm break-words whitespace-pre-wrap leading-relaxed\">\r\n                                {message.b}\r\n                            </p>\r\n                        )}\r\n\r\n                        {/* Link preview */}\r\n                        {message.b && renderLinkPreview()}\r\n\r\n                        {/* Edited indicator */}\r\n                        {message.edited && (\r\n                            <span className={`text-[9px] ${isCurrentUser ? 'text-blue-200' : 'text-gray-400'} ml-1`}>\r\n                                (edited)\r\n                            </span>\r\n                        )}\r\n                    </div>\r\n\r\n                    {/* Reactions display */}\r\n                    {hasReactions && (\r\n                        <div className={`flex flex-wrap gap-1 mt-1 ${isCurrentUser ? 'justify-end' : 'justify-start'}`}>\r\n                            {Object.entries(reactionCounts).map(([emoji, count]) => (\r\n                                <motion.button\r\n                                    key={emoji}\r\n                                    initial={{ scale: 0 }}\r\n                                    animate={{ scale: 1 }}\r\n                                    onClick={() => handleReaction(emoji)}\r\n                                    className={`flex items-center gap-0.5 px-1.5 py-0.5 rounded-full text-xs border transition-all ${\r\n                                        myReaction === emoji\r\n                                            ? 'bg-brand-blue/20 border-brand-blue text-brand-blue'\r\n                                            : 'bg-gray-100 dark:bg-gray-700 border-gray-200 dark:border-gray-600 hover:border-gray-300'\r\n                                    }`}\r\n                                >\r\n                                    <span>{emoji}</span>\r\n                                    <span className=\"text-[10px] font-bold\">{count}</span>\r\n                                </motion.button>\r\n                            ))}\r\n                        </div>\r\n                    )}\r\n\r\n                    {/* Time & status */}\r\n                    {shouldShowTime && (\r\n                        <div className={`flex items-center gap-1 mt-1 ${isCurrentUser ? 'justify-end' : 'justify-start'}`}>\r\n                            <span className=\"text-[10px] text-gray-400\">\r\n                                {msgDate.toLocaleTimeString('en-US', { \r\n                                    hour: 'numeric', \r\n                                    minute: '2-digit' \r\n                                })}\r\n                            </span>\r\n                            {isCurrentUser && (\r\n                                <MessageStatus \r\n                                    status={messageStatus} \r\n                                    size={10} \r\n                                    className=\"ml-0.5\"\r\n                                />\r\n                            )}\r\n                        </div>\r\n                    )}\r\n\r\n                    {/* Context menu */}\r\n                    <AnimatePresence>\r\n                        {showMenu && (\r\n                            <motion.div\r\n                                ref={menuRef}\r\n                                initial={{ opacity: 0, scale: 0.9, y: -10 }}\r\n                                animate={{ opacity: 1, scale: 1, y: 0 }}\r\n                                exit={{ opacity: 0, scale: 0.9, y: -10 }}\r\n                                className={`absolute z-50 ${\r\n                                    isCurrentUser ? 'right-0' : 'left-0'\r\n                                } bottom-full mb-2 bg-white dark:bg-gray-800 rounded-xl shadow-xl border dark:border-gray-700 overflow-hidden min-w-[180px]`}\r\n                            >\r\n                                {/* Quick reactions */}\r\n                                <div className=\"flex justify-center gap-1 p-2 border-b dark:border-gray-700 bg-gray-50 dark:bg-gray-900\">\r\n                                    {CHAT_REACTIONS.map(emoji => (\r\n                                        <motion.button\r\n                                            key={emoji}\r\n                                            whileHover={{ scale: 1.2 }}\r\n                                            whileTap={{ scale: 0.9 }}\r\n                                            onClick={() => handleReaction(emoji)}\r\n                                            className={`text-lg p-1 rounded-full transition ${\r\n                                                myReaction === emoji \r\n                                                    ? 'bg-brand-blue/20' \r\n                                                    : 'hover:bg-gray-200 dark:hover:bg-gray-700'\r\n                                            }`}\r\n                                        >\r\n                                            {emoji}\r\n                                        </motion.button>\r\n                                    ))}\r\n                                </div>\r\n\r\n                                {/* Action buttons */}\r\n                                <div className=\"p-1\">\r\n                                    <button \r\n                                        onClick={() => { onReply?.(message); setShowMenu(false); }}\r\n                                        className=\"w-full flex items-center gap-3 px-3 py-2 text-sm text-left hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition\"\r\n                                    >\r\n                                        <CornerUpLeft size={16} className=\"text-gray-400\" />\r\n                                        <span className=\"dark:text-gray-200\">Reply</span>\r\n                                    </button>\r\n\r\n                                    <button \r\n                                        onClick={handleCopy}\r\n                                        className=\"w-full flex items-center gap-3 px-3 py-2 text-sm text-left hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition\"\r\n                                    >\r\n                                        <Copy size={16} className=\"text-gray-400\" />\r\n                                        <span className=\"dark:text-gray-200\">\r\n                                            {copied ? 'Copied!' : 'Copy'}\r\n                                        </span>\r\n                                    </button>\r\n\r\n                                    <button \r\n                                        onClick={() => { onForward?.(message); setShowMenu(false); }}\r\n                                        className=\"w-full flex items-center gap-3 px-3 py-2 text-sm text-left hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition\"\r\n                                    >\r\n                                        <Forward size={16} className=\"text-gray-400\" />\r\n                                        <span className=\"dark:text-gray-200\">Forward</span>\r\n                                    </button>\r\n\r\n                                    {isCurrentUser && (\r\n                                        <>\r\n                                            <button \r\n                                                onClick={() => { onEdit?.(message); setShowMenu(false); }}\r\n                                                className=\"w-full flex items-center gap-3 px-3 py-2 text-sm text-left hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition\"\r\n                                            >\r\n                                                <Pencil size={16} className=\"text-gray-400\" />\r\n                                                <span className=\"dark:text-gray-200\">Edit</span>\r\n                                            </button>\r\n\r\n                                            <button \r\n                                                onClick={() => { onDelete?.(message, 'everyone'); setShowMenu(false); }}\r\n                                                className=\"w-full flex items-center gap-3 px-3 py-2 text-sm text-left hover:bg-red-50 dark:hover:bg-red-900/20 rounded-lg transition text-red-500\"\r\n                                            >\r\n                                                <Trash2 size={16} />\r\n                                                <span>Delete for Everyone</span>\r\n                                            </button>\r\n                                        </>\r\n                                    )}\r\n\r\n                                    <button \r\n                                        onClick={() => { onDelete?.(message, 'me'); setShowMenu(false); }}\r\n                                        className=\"w-full flex items-center gap-3 px-3 py-2 text-sm text-left hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition text-gray-500\"\r\n                                    >\r\n                                        <Trash2 size={16} />\r\n                                        <span>Delete for Me</span>\r\n                                    </button>\r\n                                </div>\r\n                            </motion.div>\r\n                        )}\r\n                    </AnimatePresence>\r\n                </div>\r\n\r\n                {/* Spacer for current user's messages */}\r\n                {isCurrentUser && <div className=\"w-8 shrink-0\" />}\r\n            </div>\r\n        </>\r\n    );\r\n}\r\n\r\n","import React, { useState } from 'react';\r\nimport { X, Search, Forward, Loader2, Check } from 'lucide-react';\r\nimport { motion, AnimatePresence } from 'framer-motion';\r\nimport UserAvatar from '../../shared/UserAvatar';\r\n\r\n/**\r\n * Modal for forwarding a message to other conversations\r\n */\r\nexport default function ForwardMessageModal({\r\n    message,\r\n    conversations,\r\n    currentUserId,\r\n    onForward,\r\n    onClose\r\n}) {\r\n    const [searchQuery, setSearchQuery] = useState('');\r\n    const [selectedChats, setSelectedChats] = useState([]);\r\n    const [forwarding, setForwarding] = useState(false);\r\n\r\n    // Filter conversations by search\r\n    const filteredConversations = searchQuery.trim()\r\n        ? conversations.filter(c => \r\n            c.n?.toLowerCase().includes(searchQuery.toLowerCase())\r\n          )\r\n        : conversations;\r\n\r\n    const toggleSelect = (chatId) => {\r\n        setSelectedChats(prev => \r\n            prev.includes(chatId)\r\n                ? prev.filter(id => id !== chatId)\r\n                : [...prev, chatId]\r\n        );\r\n    };\r\n\r\n    const handleForward = async () => {\r\n        if (selectedChats.length === 0) return;\r\n        \r\n        setForwarding(true);\r\n        try {\r\n            await onForward(message, selectedChats);\r\n            onClose();\r\n        } catch (error) {\r\n            console.error('Forward error:', error);\r\n            alert('Failed to forward message');\r\n        }\r\n        setForwarding(false);\r\n    };\r\n\r\n    // Message preview\r\n    const getMessagePreview = () => {\r\n        if (message.media) {\r\n            if (message.media.type === 'image') return 'ðŸ“· Image';\r\n            if (message.media.type === 'video') return 'ðŸŽ¥ Video';\r\n            if (message.media.type === 'audio') return 'ðŸŽµ Audio';\r\n            return 'ðŸ“Ž File';\r\n        }\r\n        return message.b?.substring(0, 100) || 'Message';\r\n    };\r\n\r\n    return (\r\n        <div className=\"fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-[80] p-4\">\r\n            <motion.div\r\n                initial={{ opacity: 0, scale: 0.95, y: 20 }}\r\n                animate={{ opacity: 1, scale: 1, y: 0 }}\r\n                exit={{ opacity: 0, scale: 0.95, y: 20 }}\r\n                className=\"bg-white dark:bg-[#2c2e36] rounded-2xl shadow-2xl w-full max-w-md max-h-[80vh] flex flex-col overflow-hidden\"\r\n            >\r\n                {/* Header */}\r\n                <div className=\"p-4 border-b dark:border-gray-700 flex items-center justify-between shrink-0\">\r\n                    <div className=\"flex items-center gap-3\">\r\n                        <Forward className=\"text-brand-blue\" size={20} />\r\n                        <h3 className=\"font-bold text-lg dark:text-white\">Forward Message</h3>\r\n                    </div>\r\n                    <button \r\n                        onClick={onClose}\r\n                        className=\"p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-500 transition\"\r\n                    >\r\n                        <X size={20} />\r\n                    </button>\r\n                </div>\r\n\r\n                {/* Message preview */}\r\n                <div className=\"px-4 py-3 bg-gray-50 dark:bg-gray-800 border-b dark:border-gray-700 shrink-0\">\r\n                    <p className=\"text-xs text-gray-500 mb-1\">Forwarding:</p>\r\n                    <div className=\"bg-white dark:bg-gray-700 p-3 rounded-lg border dark:border-gray-600\">\r\n                        <p className=\"text-sm dark:text-gray-200 line-clamp-2\">\r\n                            {getMessagePreview()}\r\n                        </p>\r\n                    </div>\r\n                </div>\r\n\r\n                {/* Search */}\r\n                <div className=\"px-4 py-3 border-b dark:border-gray-700 shrink-0\">\r\n                    <div className=\"relative\">\r\n                        <Search size={16} className=\"absolute left-3 top-1/2 -translate-y-1/2 text-gray-400\" />\r\n                        <input\r\n                            type=\"text\"\r\n                            placeholder=\"Search conversations...\"\r\n                            value={searchQuery}\r\n                            onChange={(e) => setSearchQuery(e.target.value)}\r\n                            className=\"w-full pl-9 pr-4 py-2 bg-gray-100 dark:bg-gray-800 rounded-lg text-sm outline-none focus:ring-2 focus:ring-brand-blue dark:text-white transition\"\r\n                        />\r\n                    </div>\r\n                </div>\r\n\r\n                {/* Conversation list */}\r\n                <div className=\"flex-1 overflow-y-auto custom-scrollbar\">\r\n                    {filteredConversations.length === 0 ? (\r\n                        <div className=\"flex flex-col items-center justify-center py-12 text-gray-500\">\r\n                            <p className=\"text-sm\">No conversations found</p>\r\n                        </div>\r\n                    ) : (\r\n                        filteredConversations.map(convo => {\r\n                            const isSelected = selectedChats.includes(convo.id);\r\n                            return (\r\n                                <motion.div\r\n                                    key={convo.id}\r\n                                    whileTap={{ scale: 0.98 }}\r\n                                    onClick={() => toggleSelect(convo.id)}\r\n                                    className={`\r\n                                        flex items-center gap-3 p-4 cursor-pointer transition\r\n                                        border-b dark:border-gray-700/50\r\n                                        ${isSelected \r\n                                            ? 'bg-brand-blue/10 dark:bg-brand-blue/20' \r\n                                            : 'hover:bg-gray-50 dark:hover:bg-gray-800'\r\n                                        }\r\n                                    `}\r\n                                >\r\n                                    <div className=\"relative\">\r\n                                        <UserAvatar\r\n                                            src={convo.photo}\r\n                                            name={convo.n}\r\n                                            size=\"md\"\r\n                                            isGroup={convo.type === 'group'}\r\n                                        />\r\n                                        {isSelected && (\r\n                                            <motion.div\r\n                                                initial={{ scale: 0 }}\r\n                                                animate={{ scale: 1 }}\r\n                                                className=\"absolute -bottom-1 -right-1 w-5 h-5 bg-brand-blue rounded-full flex items-center justify-center\"\r\n                                            >\r\n                                                <Check size={12} className=\"text-white\" />\r\n                                            </motion.div>\r\n                                        )}\r\n                                    </div>\r\n                                    <div className=\"flex-1 min-w-0\">\r\n                                        <h4 className=\"font-semibold text-sm dark:text-white truncate\">\r\n                                            {convo.n}\r\n                                        </h4>\r\n                                        <p className=\"text-xs text-gray-500 truncate\">\r\n                                            {convo.type === 'group' ? 'Group' : 'Direct message'}\r\n                                        </p>\r\n                                    </div>\r\n                                    <div className={`\r\n                                        w-5 h-5 rounded-full border-2 transition\r\n                                        ${isSelected \r\n                                            ? 'border-brand-blue bg-brand-blue' \r\n                                            : 'border-gray-300 dark:border-gray-600'\r\n                                        }\r\n                                    `}>\r\n                                        {isSelected && <Check size={12} className=\"text-white m-auto\" />}\r\n                                    </div>\r\n                                </motion.div>\r\n                            );\r\n                        })\r\n                    )}\r\n                </div>\r\n\r\n                {/* Footer */}\r\n                <div className=\"p-4 border-t dark:border-gray-700 bg-gray-50 dark:bg-[#23262f] shrink-0\">\r\n                    <div className=\"flex items-center justify-between mb-3\">\r\n                        <span className=\"text-sm text-gray-500\">\r\n                            {selectedChats.length} conversation{selectedChats.length !== 1 ? 's' : ''} selected\r\n                        </span>\r\n                        {selectedChats.length > 0 && (\r\n                            <button \r\n                                onClick={() => setSelectedChats([])}\r\n                                className=\"text-xs text-brand-blue hover:underline\"\r\n                            >\r\n                                Clear all\r\n                            </button>\r\n                        )}\r\n                    </div>\r\n                    <button\r\n                        onClick={handleForward}\r\n                        disabled={selectedChats.length === 0 || forwarding}\r\n                        className=\"w-full bg-brand-blue text-white py-3 rounded-xl font-bold hover:bg-blue-600 disabled:opacity-50 disabled:cursor-not-allowed transition flex items-center justify-center gap-2\"\r\n                    >\r\n                        {forwarding ? (\r\n                            <>\r\n                                <Loader2 className=\"animate-spin\" size={18} />\r\n                                Forwarding...\r\n                            </>\r\n                        ) : (\r\n                            <>\r\n                                <Forward size={18} />\r\n                                Forward\r\n                            </>\r\n                        )}\r\n                    </button>\r\n                </div>\r\n            </motion.div>\r\n        </div>\r\n    );\r\n}\r\n\r\n","import { useMemo, useCallback } from 'react';\r\nimport { useQuery, useMutation } from \"convex/react\";\r\nimport { api } from \"../../convex/_generated/api\";\r\nimport { isConvexAvailable } from '../config/convex';\r\n\r\n/**\r\n * Hook for managing read receipts in a chat\r\n * Tracks which messages have been read by users\r\n * \r\n * @param {string} chatId - Chat ID\r\n * @param {string} currentUserId - Current user's UID\r\n */\r\nexport function useReadReceipts(chatId, currentUserId) {\r\n    // Check Convex availability directly to avoid hook initialization issues\r\n    const convexAvailable = isConvexAvailable();\r\n    const readReceiptsQuery = useMemo(() => {\r\n        return chatId && currentUserId && convexAvailable ? { chatId } : \"skip\";\r\n    }, [chatId, currentUserId, convexAvailable]);\r\n    \r\n    // Fetch read receipts from Convex\r\n    // Hook must always be called, but we skip if Convex not available\r\n    const readReceiptsData = useQuery(\r\n        api.readReceipts.getReadReceipts,\r\n        readReceiptsQuery\r\n    );\r\n\r\n    // Hooks must be called unconditionally (React rules)\r\n    const markAsReadMutation = useMutation(api.readReceipts.markAsRead);\r\n    const markMultipleAsReadMutation = useMutation(api.readReceipts.markMultipleAsRead);\r\n\r\n    // Transform Convex data to match existing format\r\n    const readReceipts = useMemo(() => {\r\n        if (!readReceiptsData) return {};\r\n        \r\n        const receipts = {};\r\n        readReceiptsData.forEach(receipt => {\r\n            if (!receipts[receipt.userId]) {\r\n                receipts[receipt.userId] = {\r\n                    lastReadMessageId: receipt.messageId,\r\n                    readAt: receipt.readAt,\r\n                };\r\n            } else {\r\n                // Keep the latest read message\r\n                if (receipt.readAt > receipts[receipt.userId].readAt) {\r\n                    receipts[receipt.userId] = {\r\n                        lastReadMessageId: receipt.messageId,\r\n                        readAt: receipt.readAt,\r\n                    };\r\n                }\r\n            }\r\n        });\r\n        return receipts;\r\n    }, [readReceiptsData]);\r\n\r\n    // Get current user's last read\r\n    const myLastRead = readReceipts[currentUserId]?.lastReadMessageId || null;\r\n\r\n    /**\r\n     * Mark a message (or all messages up to a message) as read\r\n     */\r\n    const markAsRead = useCallback(async (messageIds) => {\r\n        if (!chatId || !currentUserId || !messageIds || !isConvexAvailable() || !markAsReadMutation || !markMultipleAsReadMutation) return;\r\n\r\n        try {\r\n            const messageIdArray = Array.isArray(messageIds) ? messageIds : [messageIds];\r\n            \r\n            if (messageIdArray.length === 1) {\r\n                await markAsReadMutation({\r\n                    chatId,\r\n                    messageId: messageIdArray[0],\r\n                    userId: currentUserId,\r\n                });\r\n            } else {\r\n                await markMultipleAsReadMutation({\r\n                    chatId,\r\n                    messageIds: messageIdArray,\r\n                    userId: currentUserId,\r\n                });\r\n            }\r\n        } catch (error) {\r\n            console.error('Mark as read error:', error);\r\n        }\r\n    }, [chatId, currentUserId, markAsReadMutation, markMultipleAsReadMutation]);\r\n\r\n    /**\r\n     * Check if a specific message has been read by a user\r\n     */\r\n    const isMessageRead = useCallback((messageId, userId, messages = null) => {\r\n        if (!messageId || !userId) return false;\r\n        \r\n        const userReceipt = readReceipts[userId];\r\n        if (!userReceipt || !userReceipt.lastReadMessageId) return false;\r\n\r\n        const lastReadMessageId = userReceipt.lastReadMessageId;\r\n        \r\n        // If exact match, definitely read\r\n        if (lastReadMessageId === messageId) {\r\n            return true;\r\n        }\r\n\r\n        // If we have messages array, compare timestamps\r\n        if (messages && Array.isArray(messages)) {\r\n            const message = messages.find(m => m.id === messageId);\r\n            const lastReadMessage = messages.find(m => m.id === lastReadMessageId);\r\n            \r\n            if (message && lastReadMessage && message.t && lastReadMessage.t) {\r\n                return message.t <= lastReadMessage.t;\r\n            }\r\n        }\r\n\r\n        // For Convex, we can compare IDs directly\r\n        // Convex IDs are sortable and maintain order\r\n        return lastReadMessageId >= messageId;\r\n    }, [readReceipts]);\r\n\r\n    /**\r\n     * Get the latest read message ID for a user\r\n     */\r\n    const getLastReadMessage = useCallback((userId) => {\r\n        return readReceipts[userId]?.lastReadMessageId || null;\r\n    }, [readReceipts]);\r\n\r\n    /**\r\n     * Check if current user has read a message\r\n     */\r\n    const hasCurrentUserRead = useCallback((messageId) => {\r\n        return myLastRead === messageId || (myLastRead && myLastRead >= messageId);\r\n    }, [myLastRead]);\r\n\r\n    return {\r\n        readReceipts,\r\n        myLastRead,\r\n        markAsRead,\r\n        isMessageRead,\r\n        getLastReadMessage,\r\n        hasCurrentUserRead\r\n    };\r\n}\r\n","// Link preview utility - uses client-side inference and public APIs\r\n\r\n// Cache for link previews to avoid repeated API calls\r\nconst previewCache = new Map();\r\nconst CACHE_DURATION = 5 * 60 * 1000; // 5 minutes\r\n\r\n/**\r\n * Fetch link preview data using Firebase Function.\r\n * Falls back to smart client-side inference if the function is unavailable.\r\n */\r\nexport default async function getLinkPreview(url) {\r\n    // Simple regex to extract the first full URL\r\n    const urlMatch = url.match(/(https?:\\/\\/[^\\s]+)/);\r\n    if (!urlMatch) {\r\n        return null;\r\n    }\r\n\r\n    const matchedUrl = urlMatch[0];\r\n\r\n    // Check cache first\r\n    const cached = previewCache.get(matchedUrl);\r\n    if (cached && Date.now() - cached.timestamp < CACHE_DURATION) {\r\n        return cached.data;\r\n    }\r\n\r\n    // Use client-side inference and public APIs\r\n    const data = await getClientSideLinkPreview(matchedUrl);\r\n    previewCache.set(matchedUrl, { data, timestamp: Date.now() });\r\n    return data;\r\n}\r\n\r\n/**\r\n * Client-side link preview with smart inference for known platforms.\r\n * Uses Open Graph meta tags when possible, falls back to platform-specific inference.\r\n */\r\nasync function getClientSideLinkPreview(url) {\r\n    // Try to fetch Open Graph data first (if CORS allows)\r\n    try {\r\n        // Use a CORS proxy or direct fetch if same-origin\r\n        const response = await fetch(url, { \r\n            method: 'HEAD',\r\n            mode: 'no-cors' // This won't give us headers, but we can try\r\n        });\r\n        \r\n        // For same-origin or CORS-enabled sites, try to get actual meta tags\r\n        // This is a best-effort approach\r\n    } catch (e) {\r\n        // CORS blocked - continue with inference\r\n    }\r\n    const data = {\r\n        url: url,\r\n        title: null,\r\n        description: null,\r\n        image: null,\r\n        siteName: null\r\n    };\r\n\r\n    try {\r\n        const urlObj = new URL(url);\r\n        const hostname = urlObj.hostname.toLowerCase();\r\n\r\n        // YouTube\r\n        if (hostname.includes('youtube.com') || hostname.includes('youtu.be')) {\r\n            let videoId = null;\r\n            if (hostname.includes('youtu.be')) {\r\n                videoId = urlObj.pathname.slice(1);\r\n            } else {\r\n                videoId = urlObj.searchParams.get('v');\r\n            }\r\n            \r\n            data.siteName = 'YouTube';\r\n            data.title = 'YouTube Video';\r\n            data.description = 'Watch this video on YouTube';\r\n            if (videoId) {\r\n                data.image = `https://img.youtube.com/vi/${videoId}/mqdefault.jpg`;\r\n            }\r\n        }\r\n        // Spotify\r\n        else if (hostname.includes('spotify.com')) {\r\n            data.siteName = 'Spotify';\r\n            data.title = 'Spotify Content';\r\n            data.description = 'Listen on Spotify';\r\n            data.image = 'https://storage.googleapis.com/pr-newsroom-wp/1/2018/11/Spotify_Logo_RGB_Green.png';\r\n        }\r\n        // SoundCloud\r\n        else if (hostname.includes('soundcloud.com')) {\r\n            data.siteName = 'SoundCloud';\r\n            data.title = 'SoundCloud Track';\r\n            data.description = 'Listen on SoundCloud';\r\n            data.image = 'https://soundcloud.com/press/assets/press-kit/soundcloud-logo.png';\r\n        }\r\n        // GitHub\r\n        else if (hostname.includes('github.com')) {\r\n            const pathParts = urlObj.pathname.split('/').filter(p => p);\r\n            data.siteName = 'GitHub';\r\n            data.title = pathParts.length >= 2 ? `${pathParts[0]}/${pathParts[1]}` : 'GitHub Repository';\r\n            data.description = 'View on GitHub';\r\n            if (pathParts.length >= 2) {\r\n                data.image = `https://opengraph.githubassets.com/1/${pathParts[0]}/${pathParts[1]}`;\r\n            }\r\n        }\r\n        // Twitter/X\r\n        else if (hostname.includes('twitter.com') || hostname.includes('x.com')) {\r\n            data.siteName = 'X (Twitter)';\r\n            data.title = 'Tweet';\r\n            data.description = 'View on X';\r\n        }\r\n        // Instagram\r\n        else if (hostname.includes('instagram.com')) {\r\n            data.siteName = 'Instagram';\r\n            data.title = 'Instagram Post';\r\n            data.description = 'View on Instagram';\r\n        }\r\n        // SeshNx internal links\r\n        else if (hostname.includes('app.seshnx.com') || hostname.includes('seshnx.com')) {\r\n            data.siteName = 'SeshNx';\r\n            data.title = 'SeshNx Link';\r\n            data.description = 'View on SeshNx platform';\r\n            data.image = 'https://app.seshnx.com/pwa-512x512.png';\r\n        }\r\n        // LinkedIn\r\n        else if (hostname.includes('linkedin.com')) {\r\n            data.siteName = 'LinkedIn';\r\n            data.title = 'LinkedIn Post';\r\n            data.description = 'View on LinkedIn';\r\n        }\r\n        // Apple Music\r\n        else if (hostname.includes('music.apple.com')) {\r\n            data.siteName = 'Apple Music';\r\n            data.title = 'Apple Music';\r\n            data.description = 'Listen on Apple Music';\r\n        }\r\n        // TikTok\r\n        else if (hostname.includes('tiktok.com')) {\r\n            data.siteName = 'TikTok';\r\n            data.title = 'TikTok Video';\r\n            data.description = 'Watch on TikTok';\r\n        }\r\n        // Vimeo\r\n        else if (hostname.includes('vimeo.com')) {\r\n            data.siteName = 'Vimeo';\r\n            data.title = 'Vimeo Video';\r\n            data.description = 'Watch on Vimeo';\r\n        }\r\n        // Bandcamp\r\n        else if (hostname.includes('bandcamp.com')) {\r\n            const subdomain = hostname.split('.')[0];\r\n            data.siteName = 'Bandcamp';\r\n            data.title = subdomain !== 'bandcamp' ? `${subdomain} on Bandcamp` : 'Bandcamp';\r\n            data.description = 'Listen on Bandcamp';\r\n        }\r\n        // Generic fallback\r\n        else {\r\n            data.siteName = hostname.replace('www.', '');\r\n            data.title = hostname.replace('www.', '');\r\n            data.description = `Visit ${hostname}`;\r\n        }\r\n\r\n        return data;\r\n    } catch (e) {\r\n        console.warn('Link preview parsing error:', e);\r\n        return {\r\n            url: url,\r\n            title: url,\r\n            description: null,\r\n            image: null\r\n        };\r\n    }\r\n}\r\n","import React, { useState, useEffect, useRef, useMemo, useCallback } from 'react';\r\nimport { ArrowLeft, Info, MessageSquare, Users } from 'lucide-react';\r\nimport { useQuery, useMutation } from \"convex/react\";\r\nimport { api } from \"../../../convex/_generated/api\";\r\nimport { isConvexAvailable } from '../../config/convex';\r\nimport ChatInput from './ChatInput';\r\nimport SeshNxEmbedModal from '../SeshNxEmbedModal'; \r\nimport MessageBubble from './message/MessageBubble';\r\nimport ForwardMessageModal from './message/ForwardMessageModal';\r\nimport PresenceIndicator, { StatusBadge } from './PresenceIndicator';\r\nimport { useUserPresence } from '../../hooks/usePresence';\r\nimport { useReadReceipts } from '../../hooks/useReadReceipts';\r\nimport { useTypingIndicator, formatTypingUsers } from '../../hooks/useTypingIndicator';\r\nimport getLinkPreview from '../../utils/linkPreview'; \r\nimport UserAvatar from '../shared/UserAvatar';\r\n\r\nexport default function ChatWindow({ user, userData, activeChat, conversations, onBack, toggleDetails, openPublicProfile }) {\r\n    const [linkPreviewData, setLinkPreviewData] = useState({});\r\n    const [embedModal, setEmbedModal] = useState({ isOpen: false, url: '', previewData: null }); \r\n    const [replyingTo, setReplyingTo] = useState(null);\r\n    const [editingMessage, setEditingMessage] = useState(null);\r\n    const [forwardingMessage, setForwardingMessage] = useState(null);\r\n    const messagesEndRef = useRef(null);\r\n\r\n    const chatId = activeChat?.id;\r\n    const chatName = activeChat?.name || activeChat?.n || 'Unknown User';\r\n\r\n    // Get other user's UID for direct chats (for presence and read receipts)\r\n    const otherUserId = useMemo(() => {\r\n        if (activeChat?.type === 'group') return null;\r\n        if (activeChat?.uid) return activeChat.uid;\r\n        if (chatId && chatId.includes('_')) {\r\n            const parts = chatId.split('_');\r\n            return parts.find(id => id !== user?.uid);\r\n        }\r\n        return null;\r\n    }, [activeChat, chatId, user?.uid]);\r\n\r\n    // Presence tracking\r\n    const { online, lastSeen, loading: presenceLoading } = useUserPresence(otherUserId);\r\n\r\n    // Read receipts tracking\r\n    const { \r\n        markAsRead, \r\n        hasCurrentUserRead, \r\n        isMessageRead,\r\n        myLastRead \r\n    } = useReadReceipts(chatId, user?.uid);\r\n\r\n    // Typing indicator tracking\r\n    const { typingUsers, setTyping, clearTyping } = useTypingIndicator(\r\n        chatId, \r\n        user?.uid, \r\n        userData?.firstName || 'User'\r\n    );\r\n\r\n    // FIX: Determine Convex availability directly. \r\n    // Removing useMemo prevents the \"Cannot access before initialization\" error.\r\n    const convexAvailable = isConvexAvailable();\r\n\r\n    const messagesQuery = useMemo(() => {\r\n        return chatId && convexAvailable ? { chatId, limit: 100 } : \"skip\";\r\n    }, [chatId, convexAvailable]);\r\n\r\n    // Query for group chat members\r\n    const chatMembersQuery = useMemo(() => {\r\n        return chatId && convexAvailable && activeChat?.type === 'group' ? { chatId } : \"skip\";\r\n    }, [chatId, convexAvailable, activeChat?.type]);\r\n\r\n    const chatMembersData = useQuery(\r\n        api.conversations.getChatMembers,\r\n        chatMembersQuery\r\n    );\r\n\r\n    // Extract member user IDs from chat members data\r\n    const groupMemberIds = useMemo(() => {\r\n        if (!chatMembersData) return [];\r\n        return chatMembersData.map(m => m.userId);\r\n    }, [chatMembersData]);\r\n\r\n    // Fetch messages from Convex (automatically reactive)\r\n    // Hook must always be called, but we skip if Convex not available\r\n    const messagesData = useQuery(\r\n        api.messages.getMessages,\r\n        messagesQuery\r\n    );\r\n\r\n    // Transform Convex messages to match existing format\r\n    const messages = useMemo(() => {\r\n        if (!messagesData) return [];\r\n        \r\n        return messagesData.map(msg => ({\r\n            id: msg._id,\r\n            b: msg.content || '',\r\n            s: msg.senderId,\r\n            n: msg.senderName,\r\n            photo: msg.senderPhoto || '',\r\n            t: msg.timestamp,\r\n            edited: msg.edited || false,\r\n            editedAt: msg.editedAt,\r\n            deleted: msg.deleted || false,\r\n            deletedForAll: msg.deletedForAll || false,\r\n            media: msg.media,\r\n            replyTo: msg.replyTo,\r\n            reactions: msg.reactions || {},\r\n        }));\r\n    }, [messagesData]);\r\n\r\n    // Mutations - hooks must be called unconditionally (React rules)\r\n    const sendMessageMutation = useMutation(api.messages.sendMessage);\r\n    const editMessageMutation = useMutation(api.messages.editMessage);\r\n    const deleteMessageMutation = useMutation(api.messages.deleteMessage);\r\n    const addReactionMutation = useMutation(api.messages.addReaction);\r\n    const removeReactionMutation = useMutation(api.messages.removeReaction);\r\n    const updateConversationMutation = useMutation(api.conversations.updateConversation);\r\n    const updateUnreadCountMutation = useMutation(api.conversations.updateUnreadCount);\r\n\r\n    // Auto-scroll to bottom and mark messages as read\r\n    useEffect(() => { \r\n        if (messagesEndRef.current && messages.length > 0) {\r\n            messagesEndRef.current.scrollIntoView({ behavior: 'smooth' });\r\n        }\r\n    }, [messages]);\r\n\r\n    // Mark messages as read when viewing\r\n    // Use a ref to track the last message count to prevent infinite loops\r\n    const lastMarkedCountRef = useRef(0);\r\n    \r\n    useEffect(() => {\r\n        if (chatId && user?.uid && messages.length > 0) {\r\n            // Only mark as read if the message count actually changed\r\n            // This prevents infinite loops from markAsRead triggering re-renders\r\n            const currentMessageIds = messages.map(m => m.id);\r\n            const currentCount = currentMessageIds.length;\r\n            \r\n            if (currentCount !== lastMarkedCountRef.current) {\r\n                lastMarkedCountRef.current = currentCount;\r\n                markAsRead(currentMessageIds);\r\n            }\r\n        }\r\n    }, [chatId, user?.uid, messages.length, markAsRead]);\r\n\r\n    // Fetch link previews for messages\r\n    useEffect(() => {\r\n        messages.forEach(msg => {\r\n            if (msg.b) {\r\n                const urlMatch = msg.b.match(/(https?:\\/\\/[^\\s]+)/);\r\n                if (urlMatch) {\r\n                    const url = urlMatch[0];\r\n                    if (!linkPreviewData[msg.id]) {\r\n                        getLinkPreview(url)\r\n                            .then(data => setLinkPreviewData(prev => ({ ...prev, [msg.id]: data })))\r\n                            .catch(e => console.error(e));\r\n                    }\r\n                }\r\n            }\r\n        });\r\n    }, [messages]);\r\n\r\n    // --- REACTION HANDLER ---\r\n    const handleReaction = async (messageId, emoji) => {\r\n        if (!chatId || !user?.uid || !isConvexAvailable()) return;\r\n\r\n        try {\r\n            // Check if user already has this reaction\r\n            const message = messages.find(m => m.id === messageId);\r\n            if (!message) return;\r\n\r\n            const hasReaction = message.reactions?.[emoji]?.includes(user.uid);\r\n            \r\n            if (hasReaction) {\r\n                await removeReactionMutation({ messageId, userId: user.uid, emoji });\r\n            } else {\r\n                await addReactionMutation({ messageId, userId: user.uid, emoji });\r\n            }\r\n        } catch (error) {\r\n            console.error('Reaction error:', error);\r\n        }\r\n    };\r\n\r\n    // --- FORWARD HANDLER ---\r\n    const handleForward = async (message, targetChatIds) => {\r\n        if (!isConvexAvailable() || !sendMessageMutation || !updateConversationMutation) {\r\n            alert(\"Chat functionality is not available. Convex is not configured.\");\r\n            return;\r\n        }\r\n\r\n        const forwardText = message.b || '';\r\n        const forwardMedia = message.media || null;\r\n\r\n        for (const targetChatId of targetChatIds) {\r\n            try {\r\n                // GUARD: Ensure no nulls are passed to optional fields\r\n                await sendMessageMutation({\r\n                    chatId: targetChatId,\r\n                    senderId: user.uid,\r\n                    senderName: userData.firstName || 'User',\r\n                    senderPhoto: userData.photoURL || undefined, // Strict undefined\r\n                    content: `ç«Šï½ª Forwarded: ${forwardText}`,\r\n                    media: forwardMedia || undefined, // Strict undefined\r\n                });\r\n\r\n                // Update conversation\r\n                const targetConvo = conversations?.find(c => c.id === targetChatId);\r\n                const summary = forwardText || (forwardMedia ? `Forwarded ${forwardMedia.type}` : 'Forwarded message');\r\n                \r\n                await updateConversationMutation({\r\n                    userId: user.uid,\r\n                    chatId: targetChatId,\r\n                    lastMessage: `ç«Šï½ª ${summary}`,\r\n                    lastMessageTime: Date.now(),\r\n                    lastSenderId: user.uid,\r\n                    chatName: targetConvo?.name || targetConvo?.n,\r\n                    chatPhoto: targetConvo?.photo || '',\r\n                    chatType: targetConvo?.type || 'direct',\r\n                    otherUserId: targetConvo?.uid,\r\n                });\r\n            } catch (error) {\r\n                console.error('Forward error for chat:', targetChatId, error);\r\n            }\r\n        }\r\n    };\r\n\r\n    // --- SEND LOGIC ---\r\n    const sendMessage = async (text, mediaData) => {\r\n        if (!chatId || (!text?.trim() && !mediaData) || !isConvexAvailable() || !sendMessageMutation || !editMessageMutation || !updateConversationMutation || !updateUnreadCountMutation) return;\r\n        \r\n        let msgText = text ? text.trim() : '';\r\n        if (msgText.length === 0 && mediaData) {\r\n            msgText = mediaData.type === 'image' ? 'ðŸ“· Image' : \r\n                      mediaData.type === 'video' ? 'ðŸŽ¥ Video' : \r\n                      mediaData.type === 'audio' ? 'ðŸŽµ Audio' : 'ðŸ“Ž File';\r\n        }\r\n\r\n        // Handle edit mode\r\n        if (editingMessage) {\r\n            try {\r\n                await editMessageMutation({\r\n                    messageId: editingMessage.id,\r\n                    content: msgText,\r\n                    senderId: user.uid,\r\n                });\r\n                setEditingMessage(null);\r\n                return;\r\n            } catch (error) {\r\n                console.error('Edit error:', error);\r\n                return;\r\n            }\r\n        }\r\n\r\n        try {\r\n            // Send message\r\n            // GUARD: Ensure strictly undefined for null/empty optional fields\r\n            await sendMessageMutation({\r\n                chatId,\r\n                senderId: user.uid,\r\n                senderName: userData.firstName || 'User',\r\n                senderPhoto: userData.photoURL || undefined, // undefined if null\r\n                content: msgText || undefined,               // undefined if empty\r\n                media: mediaData || undefined,               // undefined if null\r\n                replyTo: replyingTo ? {\r\n                    messageId: replyingTo.id,\r\n                    text: replyingTo.b?.substring(0, 100) || 'Media',\r\n                    sender: replyingTo.n || 'User',\r\n                } : undefined,\r\n            });\r\n\r\n            // Update conversation for all recipients\r\n            const summary = msgText || (mediaData ? `Sent ${mediaData.type}` : 'Message');\r\n            let recipientIds = [];\r\n            let otherUid = activeChat.uid;\r\n            \r\n            if (!otherUid && activeChat.type !== 'group' && chatId && chatId.includes('_')) {\r\n                const parts = chatId.split('_');\r\n                otherUid = parts.find(id => id !== user.uid);\r\n            }\r\n            \r\n            if (activeChat.type === 'group') {\r\n                // For group chats, use the queried members from chatMembers table\r\n                // Include current user if not already in the list\r\n                recipientIds = groupMemberIds.length > 0 \r\n                    ? [...new Set([user.uid, ...groupMemberIds])] \r\n                    : [user.uid];\r\n            } else if (otherUid) {\r\n                recipientIds = [user.uid, otherUid];\r\n            } else {\r\n                recipientIds = [user.uid];\r\n            }\r\n\r\n            // Update conversations for all recipients\r\n            for (const recipientUid of recipientIds) {\r\n                await updateConversationMutation({\r\n                    userId: recipientUid,\r\n                    chatId,\r\n                    lastMessage: summary,\r\n                    lastMessageTime: Date.now(),\r\n                    lastSenderId: user.uid,\r\n                    chatName: activeChat.type === 'group' ? chatName : (activeChat.name || activeChat.n),\r\n                    chatPhoto: activeChat.photo || '',\r\n                    chatType: activeChat.type || 'direct',\r\n                    otherUserId: activeChat.type === 'direct' ? (recipientUid === user.uid ? otherUid : user.uid) : undefined,\r\n                });\r\n\r\n                // Update unread count (increment for others, reset for sender)\r\n                if (recipientUid === user.uid) {\r\n                    await updateUnreadCountMutation({\r\n                        userId: recipientUid,\r\n                        chatId,\r\n                        setTo: 0,\r\n                    });\r\n                } else {\r\n                    await updateUnreadCountMutation({\r\n                        userId: recipientUid,\r\n                        chatId,\r\n                        increment: 1,\r\n                    });\r\n                }\r\n            }\r\n\r\n            setReplyingTo(null);\r\n        } catch (error) {\r\n            console.error('Send message error:', error);\r\n        }\r\n    };\r\n\r\n    // --- DELETE HANDLER ---\r\n    const handleDelete = async (messageId, forEveryone = false) => {\r\n        if (!chatId || !user?.uid || !isConvexAvailable() || !deleteMessageMutation) return;\r\n\r\n        try {\r\n            await deleteMessageMutation({\r\n                messageId,\r\n                senderId: user.uid,\r\n                forEveryone,\r\n            });\r\n        } catch (error) {\r\n            console.error('Delete error:', error);\r\n        }\r\n    };\r\n\r\n    // --- HEADER ---\r\n    const ChatHeader = useMemo(() => (\r\n        <div className=\"flex items-center justify-between p-4 border-b dark:border-gray-800 bg-white dark:bg-[#1f2128]\">\r\n            <div className=\"flex items-center gap-3 flex-1 min-w-0\">\r\n                <button\r\n                    onClick={onBack}\r\n                    className=\"md:hidden p-2 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-lg transition-colors\"\r\n                >\r\n                    <ArrowLeft className=\"w-5 h-5\" />\r\n                </button>\r\n                \r\n                <div \r\n                    className=\"flex items-center gap-3 flex-1 min-w-0 cursor-pointer\"\r\n                    onClick={() => openPublicProfile?.(otherUserId ? { uid: otherUserId } : null)}\r\n                >\r\n                    <UserAvatar \r\n                        src={activeChat?.photo || activeChat?.n?.photo || ''} \r\n                        name={chatName}\r\n                        size=\"md\"\r\n                    />\r\n                    <div className=\"flex-1 min-w-0\">\r\n                        <div className=\"flex items-center gap-2\">\r\n                            <h3 className=\"font-semibold text-gray-900 dark:text-white truncate\">\r\n                                {chatName}\r\n                            </h3>\r\n                            {activeChat?.type !== 'group' && (\r\n                                <PresenceIndicator \r\n                                    online={online} \r\n                                    lastSeen={lastSeen} \r\n                                    loading={presenceLoading}\r\n                                />\r\n                            )}\r\n                        </div>\r\n                        {activeChat?.type !== 'group' && (\r\n                            <p className=\"text-xs text-gray-500 dark:text-gray-400\">\r\n                                {online ? 'Online' : lastSeen ? `Last seen ${formatLastSeen(lastSeen)}` : 'Offline'}\r\n                            </p>\r\n                        )}\r\n                    </div>\r\n                </div>\r\n            </div>\r\n\r\n            <button\r\n                onClick={toggleDetails}\r\n                className=\"p-2 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-lg transition-colors\"\r\n            >\r\n                <Info className=\"w-5 h-5 text-gray-600 dark:text-gray-400\" />\r\n            </button>\r\n        </div>\r\n    ), [activeChat, chatName, online, lastSeen, presenceLoading, otherUserId, onBack, toggleDetails, openPublicProfile]);\r\n\r\n    // Format last seen helper\r\n    const formatLastSeen = (timestamp) => {\r\n        if (!timestamp) return 'Never';\r\n        const lastSeenMs = typeof timestamp === 'number' ? timestamp : timestamp;\r\n        const now = Date.now();\r\n        const diffMs = now - lastSeenMs;\r\n        const diffMins = Math.floor(diffMs / 60000);\r\n        const diffHours = Math.floor(diffMins / 60);\r\n        const diffDays = Math.floor(diffHours / 24);\r\n\r\n        if (diffMins < 1) return 'Just now';\r\n        if (diffMins < 60) return `${diffMins}m ago`;\r\n        if (diffHours < 24) return `${diffHours}h ago`;\r\n        if (diffDays < 7) return `${diffDays}d ago`;\r\n        return new Date(lastSeenMs).toLocaleDateString();\r\n    };\r\n\r\n    // Early return for no active chat (after all hooks are called to maintain hook count)\r\n    if (!activeChat || !chatId) {\r\n        return (\r\n            <div className=\"flex flex-col h-full bg-white dark:bg-[#1f2128] items-center justify-center text-gray-400\">\r\n                <div className=\"w-20 h-20 bg-gray-100 dark:bg-gray-800 rounded-full flex items-center justify-center mb-4\">\r\n                    <Users size={64} className=\"text-gray-200 dark:text-gray-700 mb-2\" />\r\n                </div>\r\n                <p>Select a conversation to start chatting</p>\r\n            </div>\r\n        );\r\n    }\r\n\r\n    return (\r\n        <div className=\"flex flex-col h-full bg-white dark:bg-[#1f2128]\">\r\n            {ChatHeader}\r\n\r\n            {/* Messages Area */}\r\n            <div className=\"flex-1 overflow-y-auto p-4 space-y-4 scrollbar-hide\">\r\n                {messages.length === 0 ? (\r\n                    <div className=\"flex items-center justify-center h-full text-gray-400\">\r\n                        <p>No messages yet. Start the conversation!</p>\r\n                    </div>\r\n                ) : (\r\n                    messages.map((message, index) => {\r\n                        const previousMessage = index > 0 ? messages[index - 1] : null;\r\n                        const isCurrentUser = message.s === user?.uid;\r\n                        const isRead = isMessageRead(message.id);\r\n                        const hasRead = hasCurrentUserRead(message.id);\r\n\r\n                        return (\r\n                            <MessageBubble\r\n                                key={message.id}\r\n                                message={message}\r\n                                isCurrentUser={isCurrentUser}\r\n                                previousMessage={previousMessage}\r\n                                currentUserId={user?.uid}\r\n                                chatId={chatId}\r\n                                linkPreviewData={linkPreviewData[message.id]}\r\n                                messageStatus={isRead ? 'read' : hasRead ? 'delivered' : 'sent'}\r\n                                onReaction={(emoji) => handleReaction(message.id, emoji)}\r\n                                onReply={() => setReplyingTo(message)}\r\n                                onEdit={() => setEditingMessage(message)}\r\n                                onDelete={(forEveryone) => handleDelete(message.id, forEveryone)}\r\n                                onForward={() => setForwardingMessage(message)}\r\n                                onSeshNxLinkClick={(url) => setEmbedModal({ isOpen: true, url, previewData: null })}\r\n                                onUserClick={() => openPublicProfile?.({ uid: message.s })}\r\n                            />\r\n                        );\r\n                    })\r\n                )}\r\n                <div ref={messagesEndRef} />\r\n            </div>\r\n\r\n            {/* Chat Input */}\r\n            <ChatInput\r\n                activeChatId={chatId}\r\n                uid={user?.uid}\r\n                onSend={sendMessage}\r\n                replyingTo={replyingTo}\r\n                editingMessage={editingMessage}\r\n                onCancelReply={() => setReplyingTo(null)}\r\n                onCancelEdit={() => setEditingMessage(null)}\r\n                typingUsers={typingUsers}\r\n                onTyping={setTyping}\r\n                onStopTyping={clearTyping}\r\n            />\r\n\r\n            {/* Forward Modal */}\r\n            {forwardingMessage && (\r\n                <ForwardMessageModal\r\n                    message={forwardingMessage}\r\n                    conversations={conversations}\r\n                    onClose={() => setForwardingMessage(null)}\r\n                    onForward={handleForward}\r\n                />\r\n            )}\r\n\r\n            {/* Embed Modal */}\r\n            {embedModal.isOpen && (\r\n                <SeshNxEmbedModal\r\n                    url={embedModal.url}\r\n                    previewData={embedModal.previewData}\r\n                    onClose={() => setEmbedModal({ isOpen: false, url: '', previewData: null })}\r\n                />\r\n            )}\r\n        </div>\r\n    );\r\n}\r\n","import React from 'react';\r\n\r\nexport default function StatCard({ title, value, icon, sub, bg = \"bg-white dark:bg-[#2c2e36]\", text = \"text-gray-900 dark:text-white\" }) {\r\n  return (\r\n    <div className={`${bg} p-5 rounded-xl border border-gray-100 dark:border-gray-700 shadow-sm flex flex-col justify-between h-28`}>\r\n      <div className=\"flex justify-between items-start\">\r\n        <div>\r\n          <div className={`text-sm font-medium ${text === 'text-white' ? 'text-blue-100' : 'text-gray-500'}`}>{title}</div>\r\n          <div className={`text-2xl font-extrabold ${text}`}>{value}</div>\r\n        </div>\r\n        <div className=\"opacity-80\">{icon}</div>\r\n      </div>\r\n      {sub && <div className=\"text-xs mt-auto opacity-75\">{sub}</div>}\r\n    </div>\r\n  );\r\n}\r\n","import React, { useState, useEffect } from 'react';\r\nimport { X, Image as ImageIcon, Video, FileText, Music, ChevronLeft, ChevronRight, Download } from 'lucide-react';\r\nimport { motion, AnimatePresence } from 'framer-motion';\r\nimport { useQuery } from \"convex/react\";\r\nimport { api } from \"../../../../convex/_generated/api\";\r\nimport { isConvexAvailable } from '../../../config/convex';\r\n\r\n/**\r\n * Media gallery component to view all shared media in a chat\r\n */\r\nexport default function MediaGallery({ \r\n    chatId, \r\n    onClose,\r\n    onMediaSelect \r\n}) {\r\n    const [media, setMedia] = useState([]);\r\n    const [loading, setLoading] = useState(true);\r\n    const [selectedMedia, setSelectedMedia] = useState(null);\r\n    const [filter, setFilter] = useState('all'); // 'all' | 'images' | 'videos' | 'audio' | 'files'\r\n\r\n    const convexAvailable = isConvexAvailable();\r\n    const mediaQuery = (chatId && convexAvailable) ? { chatId, limit: 500 } : \"skip\";\r\n    const mediaMessages = useQuery(api.messages.getMediaMessages, mediaQuery);\r\n\r\n    useEffect(() => {\r\n        if (!chatId || !convexAvailable) {\r\n            setMedia([]);\r\n            setLoading(false);\r\n            return;\r\n        }\r\n        if (!mediaMessages) return;\r\n\r\n        const mediaItems = (mediaMessages || [])\r\n            .filter(msg => msg.media && !msg.deleted && !msg.deletedForAll)\r\n            .map(msg => ({\r\n                id: msg._id,\r\n                ...(msg.media || {}),\r\n                messageId: msg._id,\r\n                timestamp: msg.timestamp,\r\n                sender: msg.senderName\r\n            }))\r\n            .sort((a, b) => (a.timestamp || 0) - (b.timestamp || 0));\r\n\r\n        setMedia(mediaItems);\r\n        setLoading(false);\r\n    }, [chatId, convexAvailable, mediaMessages]);\r\n\r\n    const filteredMedia = filter === 'all' \r\n        ? media \r\n        : media.filter(item => {\r\n            if (filter === 'images') return item.type === 'image';\r\n            if (filter === 'videos') return item.type === 'video';\r\n            if (filter === 'audio') return item.type === 'audio';\r\n            if (filter === 'files') return item.type === 'file';\r\n            return true;\r\n        });\r\n\r\n    const handleMediaClick = (item) => {\r\n        setSelectedMedia(item);\r\n        if (onMediaSelect) {\r\n            onMediaSelect(item);\r\n        }\r\n    };\r\n\r\n    const handleDownload = (item) => {\r\n        const link = document.createElement('a');\r\n        link.href = item.url;\r\n        link.download = item.name || 'download';\r\n        link.target = '_blank';\r\n        document.body.appendChild(link);\r\n        link.click();\r\n        document.body.removeChild(link);\r\n    };\r\n\r\n    return (\r\n        <div className=\"fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-[80] p-4\">\r\n            <motion.div\r\n                initial={{ opacity: 0, scale: 0.95 }}\r\n                animate={{ opacity: 1, scale: 1 }}\r\n                exit={{ opacity: 0, scale: 0.95 }}\r\n                className=\"bg-white dark:bg-[#2c2e36] rounded-2xl shadow-2xl w-full max-w-4xl max-h-[90vh] flex flex-col overflow-hidden\"\r\n            >\r\n                {/* Header */}\r\n                <div className=\"p-4 border-b dark:border-gray-700 flex items-center justify-between shrink-0\">\r\n                    <h3 className=\"font-bold text-lg dark:text-white\">Media Gallery</h3>\r\n                    <button \r\n                        onClick={onClose}\r\n                        className=\"p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-500 transition\"\r\n                    >\r\n                        <X size={20} />\r\n                    </button>\r\n                </div>\r\n\r\n                {/* Filters */}\r\n                <div className=\"p-3 border-b dark:border-gray-700 flex gap-2 overflow-x-auto scrollbar-hide shrink-0\">\r\n                    {[\r\n                        { key: 'all', label: 'All', icon: null },\r\n                        { key: 'images', label: 'Images', icon: ImageIcon },\r\n                        { key: 'videos', label: 'Videos', icon: Video },\r\n                        { key: 'audio', label: 'Audio', icon: Music },\r\n                        { key: 'files', label: 'Files', icon: FileText }\r\n                    ].map(f => (\r\n                        <button\r\n                            key={f.key}\r\n                            onClick={() => setFilter(f.key)}\r\n                            className={`flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-semibold whitespace-nowrap transition ${\r\n                                filter === f.key\r\n                                    ? 'bg-brand-blue text-white'\r\n                                    : 'bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300 hover:bg-gray-200'\r\n                            }`}\r\n                        >\r\n                            {f.icon && <f.icon size={16} />}\r\n                            {f.label}\r\n                            <span className=\"text-xs opacity-70\">\r\n                                ({filteredMedia.filter(m => f.key === 'all' || m.type === f.key).length})\r\n                            </span>\r\n                        </button>\r\n                    ))}\r\n                </div>\r\n\r\n                {/* Media Grid */}\r\n                <div className=\"flex-1 overflow-y-auto custom-scrollbar p-4\">\r\n                    {loading ? (\r\n                        <div className=\"flex flex-col items-center justify-center h-full\">\r\n                            <div className=\"w-8 h-8 border-2 border-brand-blue border-t-transparent rounded-full animate-spin mb-2\" />\r\n                            <p className=\"text-sm text-gray-500\">Loading media...</p>\r\n                        </div>\r\n                    ) : filteredMedia.length === 0 ? (\r\n                        <div className=\"flex flex-col items-center justify-center h-full text-gray-400\">\r\n                            <ImageIcon size={48} className=\"mb-4 opacity-30\" />\r\n                            <p className=\"text-sm\">No media found</p>\r\n                        </div>\r\n                    ) : (\r\n                        <div className=\"grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 gap-3\">\r\n                            {filteredMedia.map((item) => (\r\n                                <motion.div\r\n                                    key={item.id}\r\n                                    initial={{ opacity: 0, scale: 0.9 }}\r\n                                    animate={{ opacity: 1, scale: 1 }}\r\n                                    whileHover={{ scale: 1.05 }}\r\n                                    whileTap={{ scale: 0.95 }}\r\n                                    onClick={() => handleMediaClick(item)}\r\n                                    className=\"relative aspect-square rounded-lg overflow-hidden bg-gray-100 dark:bg-gray-800 cursor-pointer group\"\r\n                                >\r\n                                    {item.type === 'image' ? (\r\n                                        <img \r\n                                            src={item.url} \r\n                                            alt=\"Media\" \r\n                                            className=\"w-full h-full object-cover\"\r\n                                        />\r\n                                    ) : item.type === 'video' ? (\r\n                                        <video \r\n                                            src={item.url} \r\n                                            className=\"w-full h-full object-cover\"\r\n                                        />\r\n                                    ) : item.type === 'audio' ? (\r\n                                        <div className=\"w-full h-full flex items-center justify-center bg-purple-100 dark:bg-purple-900/30\">\r\n                                            <Music size={32} className=\"text-purple-600 dark:text-purple-400\" />\r\n                                        </div>\r\n                                    ) : (\r\n                                        <div className=\"w-full h-full flex items-center justify-center bg-blue-100 dark:bg-blue-900/30\">\r\n                                            <FileText size={32} className=\"text-blue-600 dark:text-blue-400\" />\r\n                                        </div>\r\n                                    )}\r\n                                    <div className=\"absolute inset-0 bg-black/0 group-hover:bg-black/30 transition flex items-center justify-center\">\r\n                                        <Download \r\n                                            size={20} \r\n                                            className=\"text-white opacity-0 group-hover:opacity-100 transition\"\r\n                                        />\r\n                                    </div>\r\n                                </motion.div>\r\n                            ))}\r\n                        </div>\r\n                    )}\r\n                </div>\r\n            </motion.div>\r\n\r\n            {/* Media Viewer Modal */}\r\n            <AnimatePresence>\r\n                {selectedMedia && (\r\n                    <MediaViewer\r\n                        media={selectedMedia}\r\n                        onClose={() => setSelectedMedia(null)}\r\n                        onDownload={handleDownload}\r\n                    />\r\n                )}\r\n            </AnimatePresence>\r\n        </div>\r\n    );\r\n}\r\n\r\n/**\r\n * Full-screen media viewer\r\n */\r\nfunction MediaViewer({ media, onClose, onDownload }) {\r\n    const [allMedia, setAllMedia] = useState([]);\r\n    const [currentIndex, setCurrentIndex] = useState(0);\r\n\r\n    useEffect(() => {\r\n        // Get all media items from gallery context (simplified - in real app, pass from parent)\r\n        // For now, just show the selected media\r\n        setAllMedia([media]);\r\n        setCurrentIndex(0);\r\n    }, [media]);\r\n\r\n    const nextMedia = () => {\r\n        if (currentIndex < allMedia.length - 1) {\r\n            setCurrentIndex(currentIndex + 1);\r\n        }\r\n    };\r\n\r\n    const prevMedia = () => {\r\n        if (currentIndex > 0) {\r\n            setCurrentIndex(currentIndex - 1);\r\n        }\r\n    };\r\n\r\n    const current = allMedia[currentIndex] || media;\r\n\r\n    return (\r\n        <motion.div\r\n            initial={{ opacity: 0 }}\r\n            animate={{ opacity: 1 }}\r\n            exit={{ opacity: 0 }}\r\n            className=\"fixed inset-0 bg-black/95 z-[90] flex items-center justify-center\"\r\n            onClick={onClose}\r\n        >\r\n            <div className=\"relative max-w-7xl max-h-[90vh] w-full h-full flex items-center justify-center p-4\" onClick={e => e.stopPropagation()}>\r\n                <button\r\n                    onClick={onClose}\r\n                    className=\"absolute top-4 right-4 p-2 bg-black/50 text-white rounded-full hover:bg-black/70 transition z-10\"\r\n                >\r\n                    <X size={24} />\r\n                </button>\r\n\r\n                {current.type === 'image' && (\r\n                    <img \r\n                        src={current.url} \r\n                        alt=\"Media\" \r\n                        className=\"max-w-full max-h-full object-contain rounded-lg\"\r\n                    />\r\n                )}\r\n\r\n                {current.type === 'video' && (\r\n                    <video \r\n                        src={current.url} \r\n                        controls \r\n                        className=\"max-w-full max-h-full rounded-lg\"\r\n                        autoPlay\r\n                    />\r\n                )}\r\n\r\n                {current.type === 'audio' && (\r\n                    <div className=\"bg-white dark:bg-gray-800 rounded-xl p-8 max-w-md\">\r\n                        <div className=\"w-32 h-32 bg-purple-100 dark:bg-purple-900/30 rounded-full flex items-center justify-center mx-auto mb-6\">\r\n                            <Music size={48} className=\"text-purple-600 dark:text-purple-400\" />\r\n                        </div>\r\n                        <audio src={current.url} controls className=\"w-full\" autoPlay />\r\n                        <p className=\"text-center mt-4 text-sm text-gray-500\">{current.name}</p>\r\n                    </div>\r\n                )}\r\n\r\n                {current.type === 'file' && (\r\n                    <div className=\"bg-white dark:bg-gray-800 rounded-xl p-8 max-w-md text-center\">\r\n                        <FileText size={64} className=\"text-blue-600 dark:text-blue-400 mx-auto mb-4\" />\r\n                        <h4 className=\"text-lg font-bold dark:text-white mb-2\">{current.name}</h4>\r\n                        <a \r\n                            href={current.url} \r\n                            target=\"_blank\" \r\n                            rel=\"noopener noreferrer\"\r\n                            className=\"inline-block mt-4 px-6 py-2 bg-brand-blue text-white rounded-lg hover:bg-blue-600 transition\"\r\n                        >\r\n                            Open File\r\n                        </a>\r\n                    </div>\r\n                )}\r\n\r\n                {/* Navigation arrows */}\r\n                {allMedia.length > 1 && (\r\n                    <>\r\n                        <button\r\n                            onClick={prevMedia}\r\n                            disabled={currentIndex === 0}\r\n                            className=\"absolute left-4 top-1/2 -translate-y-1/2 p-3 bg-black/50 text-white rounded-full hover:bg-black/70 disabled:opacity-30 transition\"\r\n                        >\r\n                            <ChevronLeft size={24} />\r\n                        </button>\r\n                        <button\r\n                            onClick={nextMedia}\r\n                            disabled={currentIndex === allMedia.length - 1}\r\n                            className=\"absolute right-4 top-1/2 -translate-y-1/2 p-3 bg-black/50 text-white rounded-full hover:bg-black/70 disabled:opacity-30 transition\"\r\n                        >\r\n                            <ChevronRight size={24} />\r\n                        </button>\r\n                    </>\r\n                )}\r\n\r\n                {/* Download button */}\r\n                <button\r\n                    onClick={() => onDownload(current)}\r\n                    className=\"absolute bottom-4 left-1/2 -translate-x-1/2 p-3 bg-black/50 text-white rounded-full hover:bg-black/70 transition\"\r\n                >\r\n                    <Download size={20} />\r\n                </button>\r\n            </div>\r\n        </motion.div>\r\n    );\r\n}\r\n\r\n","import React, { useState, useEffect } from 'react';\r\nimport { X, User, Bell, Flag, Lock, Users, Briefcase, FileText, Clock, Video, Image as ImageIcon, Loader2, Images } from 'lucide-react';\r\nimport StatCard from '../shared/StatCard';\r\nimport MediaGallery from './media/MediaGallery';\r\nimport { supabase } from '../../config/supabase';\r\n\r\nexport default function ChatDetailsPane({ activeChat, onClose, currentUser }) {\r\n    const [media, setMedia] = useState([]);\r\n    const [stats, setStats] = useState({ sessions: 0, rating: 0, responseTime: 'N/A' });\r\n    const [loading, setLoading] = useState(true);\r\n    const [blocking, setBlocking] = useState(false);\r\n    const [showMediaGallery, setShowMediaGallery] = useState(false);\r\n\r\n    const isGroup = activeChat.type === 'group';\r\n    const targetUid = activeChat.uid;\r\n    // FIX: Normalize name (activeChat might use 'n' or 'name')\r\n    const chatName = activeChat.name || activeChat.n || 'Unknown';\r\n\r\n    useEffect(() => {\r\n        const loadData = async () => {\r\n            setLoading(true);\r\n            try {\r\n                // 1. FETCH SHARED MEDIA from RTDB? \r\n                // Note: The previous version looked in Firestore 'chats/{id}/messages'. \r\n                // Since we moved to RTDB for messages, we should conceptually query RTDB here or ignore for now.\r\n                // For simplicity, we will skip fetching media from RTDB in this iteration to avoid complex queries,\r\n                // or we can just leave the list empty until a dedicated media index is built.\r\n                setMedia([]); \r\n\r\n                // 2. FETCH USER STATS (Only for Direct Chats)\r\n                if (!isGroup && targetUid && supabase) {\r\n                    const currentUserId = currentUser?.id || currentUser?.uid;\r\n                    \r\n                    // Fetch profile\r\n                    const { data: profileData } = await supabase\r\n                        .from('profiles')\r\n                        .select('rating, response_time')\r\n                        .eq('id', targetUid)\r\n                        .single();\r\n\r\n                    // Count completed bookings\r\n                    const { count } = await supabase\r\n                        .from('bookings')\r\n                        .select('*', { count: 'exact', head: true })\r\n                        .eq('sender_id', currentUserId)\r\n                        .eq('target_id', targetUid)\r\n                        .eq('status', 'Completed');\r\n\r\n                    setStats({\r\n                        sessions: count || 0,\r\n                        rating: profileData?.rating || 'New',\r\n                        responseTime: profileData?.response_time || '~1hr' \r\n                    });\r\n                }\r\n            } catch (e) {\r\n                console.error(\"Failed to load details:\", e);\r\n            }\r\n            setLoading(false);\r\n        };\r\n\r\n        if (activeChat?.id) {\r\n            loadData();\r\n        }\r\n    }, [activeChat.id, targetUid, isGroup, currentUser?.id || currentUser?.uid]);\r\n\r\n    const handleBlockUser = async () => {\r\n        if (isGroup || !targetUid || !currentUser || !supabase) return;\r\n        if (!confirm(`Are you sure you want to block ${chatName}?`)) return;\r\n\r\n        setBlocking(true);\r\n        try {\r\n            const userId = currentUser?.id || currentUser?.uid;\r\n            \r\n            // Get current settings\r\n            const { data: profile } = await supabase\r\n                .from('profiles')\r\n                .select('settings')\r\n                .eq('id', userId)\r\n                .single();\r\n            \r\n            const currentSettings = profile?.settings || {};\r\n            const blockedUsers = currentSettings.social?.blockedUsers || [];\r\n            \r\n            if (!blockedUsers.includes(targetUid)) {\r\n                await supabase\r\n                    .from('profiles')\r\n                    .update({\r\n                        settings: {\r\n                            ...currentSettings,\r\n                            social: {\r\n                                ...currentSettings.social,\r\n                                blockedUsers: [...blockedUsers, targetUid]\r\n                            }\r\n                        }\r\n                    })\r\n                    .eq('id', userId);\r\n            }\r\n            \r\n            alert(\"User blocked.\");\r\n            onClose(); \r\n        } catch (e) {\r\n            console.error(\"Block failed:\", e);\r\n            alert(\"Failed to block user.\");\r\n        }\r\n        setBlocking(false);\r\n    };\r\n\r\n    const handleReportUser = () => {\r\n        alert(\"Please use the report option on their profile page for full moderation tools.\");\r\n    };\r\n\r\n    return (\r\n        <div className=\"absolute right-0 top-0 h-full w-full md:w-80 bg-gray-800 shadow-xl z-20 flex flex-col transition-transform duration-300 ease-in-out border-l border-gray-700\">\r\n            {/* Header */}\r\n            <div className=\"flex items-center justify-between p-4 border-b border-gray-700 bg-gray-900\">\r\n                <h3 className=\"text-lg font-semibold text-white\">Details</h3>\r\n                <button \r\n                    onClick={onClose} \r\n                    className=\"p-2 text-gray-400 hover:text-white hover:bg-gray-700 rounded-full transition duration-150\"\r\n                    aria-label=\"Close details\"\r\n                >\r\n                    <X className=\"w-5 h-5\" />\r\n                </button>\r\n            </div>\r\n\r\n            {/* Profile Section */}\r\n            <div className=\"p-6 flex flex-col items-center border-b border-gray-700 bg-gray-800\">\r\n                <div className=\"relative w-24 h-24 rounded-full overflow-hidden mb-4 bg-gray-700 flex items-center justify-center shadow-lg border-4 border-gray-600\">\r\n                    <img \r\n                        src={activeChat.photo} \r\n                        className=\"w-full h-full object-cover\" \r\n                        onError={(e) => e.target.src = ''}\r\n                        alt={chatName}\r\n                    />\r\n                    {!activeChat.photo && (isGroup ? <Users className=\"w-10 h-10 text-gray-500\"/> : <User className=\"w-10 h-10 text-gray-500\" />)}\r\n                </div>\r\n                <h4 className=\"text-xl font-bold text-white text-center leading-tight\">{chatName}</h4>\r\n                <p className=\"text-xs text-gray-400 mt-2 flex items-center px-3 py-1 bg-gray-700 rounded-full\">\r\n                    {isGroup ? <Users className=\"w-3 h-3 mr-1\"/> : <Briefcase className=\"w-3 h-3 mr-1\" />}\r\n                    {isGroup ? 'Group Chat' : (activeChat.role || 'Creative')}\r\n                </p>\r\n            </div>\r\n\r\n            <div className=\"flex-1 overflow-y-auto custom-scrollbar\">\r\n                {/* Stats (Hidden for Groups) */}\r\n                {!isGroup && (\r\n                    <div className=\"p-4 border-b border-gray-700\">\r\n                        <h5 className=\"text-xs font-bold text-gray-500 uppercase mb-3 tracking-wider\">Performance</h5>\r\n                        {loading ? (\r\n                            <div className=\"flex justify-center py-4\"><Loader2 className=\"animate-spin text-brand-blue\"/></div>\r\n                        ) : (\r\n                            <div className=\"grid grid-cols-3 gap-2\">\r\n                                <StatCard title=\"Sessions\" value={stats.sessions} icon={Briefcase} color=\"text-blue-400\" />\r\n                                <StatCard title=\"Rating\" value={stats.rating} icon={Flag} color=\"text-yellow-400\" />\r\n                                <StatCard title=\"Reply Time\" value={stats.responseTime} icon={Clock} color=\"text-green-400\" />\r\n                            </div>\r\n                        )}\r\n                    </div>\r\n                )}\r\n\r\n                {/* Shared Media Section */}\r\n                <div className=\"p-4 border-b border-gray-700\">\r\n                    <div className=\"flex items-center justify-between mb-3\">\r\n                        <h5 className=\"text-xs font-bold text-gray-500 uppercase tracking-wider\">Shared Media</h5>\r\n                        <button\r\n                            onClick={() => setShowMediaGallery(true)}\r\n                            className=\"text-xs text-brand-blue hover:underline font-medium\"\r\n                        >\r\n                            View All\r\n                        </button>\r\n                    </div>\r\n                    {media.length > 0 ? (\r\n                        <div className=\"grid grid-cols-3 gap-2\">\r\n                            {media.slice(0, 6).map((item, i) => (\r\n                                <div\r\n                                    key={i}\r\n                                    className=\"aspect-square rounded-lg overflow-hidden bg-gray-700 cursor-pointer hover:opacity-80 transition\"\r\n                                >\r\n                                    {item.type === 'image' && (\r\n                                        <img src={item.url} className=\"w-full h-full object-cover\" alt=\"Media\" />\r\n                                    )}\r\n                                    {item.type === 'video' && (\r\n                                        <div className=\"w-full h-full flex items-center justify-center\">\r\n                                            <Video size={20} className=\"text-gray-400\" />\r\n                                        </div>\r\n                                    )}\r\n                                </div>\r\n                            ))}\r\n                        </div>\r\n                    ) : (\r\n                        <p className=\"text-xs text-gray-500 text-center py-4\">No shared media yet</p>\r\n                    )}\r\n                </div>\r\n\r\n                {/* Actions */}\r\n                <div className=\"p-4 space-y-2\">\r\n                    <button className=\"w-full flex items-center gap-3 px-4 py-2.5 text-left text-gray-300 hover:bg-gray-700 hover:text-white rounded-lg transition\">\r\n                        <Bell className=\"w-4 h-4 text-yellow-500\" />\r\n                        <span>Mute Notifications</span>\r\n                    </button>\r\n\r\n                    <button\r\n                        onClick={() => setShowMediaGallery(true)}\r\n                        className=\"w-full flex items-center gap-3 px-4 py-2.5 text-left text-gray-300 hover:bg-gray-700 hover:text-white rounded-lg transition\"\r\n                    >\r\n                        <Images className=\"w-4 h-4 text-purple-500\" />\r\n                        <span>Media Gallery</span>\r\n                    </button>\r\n                    \r\n                    {!isGroup && (\r\n                        <>\r\n                            <button \r\n                                onClick={handleBlockUser}\r\n                                disabled={blocking}\r\n                                className=\"w-full flex items-center gap-3 px-4 py-2.5 text-left text-red-400 hover:bg-red-900/20 hover:text-red-300 rounded-lg transition disabled:opacity-50\"\r\n                            >\r\n                                {blocking ? <Loader2 className=\"w-4 h-4 animate-spin\"/> : <Lock className=\"w-4 h-4\" />}\r\n                                <span>Block User</span>\r\n                            </button>\r\n                            \r\n                            <button \r\n                                onClick={handleReportUser}\r\n                                className=\"w-full flex items-center gap-3 px-4 py-2.5 text-left text-red-400 hover:bg-red-900/20 hover:text-red-300 rounded-lg transition\"\r\n                            >\r\n                                <Flag className=\"w-4 h-4\" />\r\n                                <span>Report User</span>\r\n                            </button>\r\n                        </>\r\n                    )}\r\n                </div>\r\n            </div>\r\n\r\n            {/* Media Gallery Modal */}\r\n            {showMediaGallery && (\r\n                <MediaGallery\r\n                    chatId={activeChat.id}\r\n                    onClose={() => setShowMediaGallery(false)}\r\n                />\r\n            )}\r\n        </div>\r\n    );\r\n}\r\n"],"names":["supabase","convexUrl","clientUrl","convex","ConvexReactClient","isConvexAvailable","getInitials","name","parts","_b","_a","getAvatarColor","colors","hash","acc","char","UserAvatar","src","size","className","onClick","status","isGroup","square","imgError","setImgError","useState","containerClass","twMerge","clsx","showFallback","initials","avatarColor","jsxs","jsx","Users","User","api","anyApi","componentsGeneric","API_ENDPOINT","useMediaUpload","uploading","setUploading","error","setError","file","uploadType","formData","response","errorData","result","err","usePresence","userId","isOnlineRef","useRef","updatePresenceMutation","useMutation","useEffect","interval","useUserPresence","convexAvailable","presenceQuery","useMemo","presenceData","useQuery","formatLastSeen","timestamp","lastSeenMs","diffMs","diffMins","diffHours","diffDays","PresenceIndicator","online","lastSeen","showText","sizeClasses","textSizes","Circle","ConversationItem","conversation","activeChat","currentUserId","onSelect","onDelete","otherUserId","id","e","Trash2","ChatSidebar","user","conversations","onSelectChat","showSearch","setShowSearch","showGroupModal","setShowGroupModal","searchMode","setSearchMode","isCreating","setIsCreating","groupName","setGroupName","groupMembers","setGroupMembers","searchQuery","setSearchQuery","searchResults","setSearchResults","createGroupChatMutation","deleteConversationMutation","handleUserSearch","term","handleSelectSearchResult","chatId","closeSearch","m","prev","openGroupModal","handleAddMemberClick","handleCreateGroup","memberIds","newGroupId","handleDeleteChat","Plus","c","ArrowLeft","p","X","Loader2","Fragment","ChevronRight","Search","res","isSelected","EMOJI_CATEGORIES","ALL_EMOJIS","EmojiPicker","onClose","position","activeCategory","setActiveCategory","recentEmojis","setRecentEmojis","stored","filteredEmojis","emoji","handleEmojiSelect","updatedRecent","categories","motion","category","Clock","index","GIPHY_API_KEY","GIPHY_BASE_URL","GifPicker","gifs","setGifs","trendingGifs","setTrendingGifs","loading","setLoading","activeTab","setActiveTab","searchTimeoutRef","loadTrending","searchGifs","data","query","handleGifSelect","gif","displayGifs","TrendingUp","VideoRecorder","onRecorded","maxDuration","isRecording","setIsRecording","recordedBlob","setRecordedBlob","recordingTime","setRecordingTime","hasPermission","setHasPermission","videoRef","streamRef","mediaRecorderRef","chunksRef","timerRef","requestPermissions","cleanup","stream","track","startRecording","options","blob","newTime","stopRecording","handleDiscard","handleSend","formatTime","seconds","mins","secs","CameraOff","Check","StopCircle","Video","useTypingIndicator","userName","typingTimeoutRef","isTypingRef","typingQuery","typingData","updateTypingMutation","clearTypingMutation","typingUsers","indicator","setTyping","useCallback","clearTyping","formatTypingUsers","ChatInput","activeChatId","uid","onSend","replyingTo","editingMessage","onCancelReply","onCancelEdit","onTyping","onStopTyping","input","setInput","attachment","setAttachment","recordingDuration","setRecordingDuration","dragActive","setDragActive","showEmojiPicker","setShowEmojiPicker","showGifPicker","setShowGifPicker","showVideoRecorder","setShowVideoRecorder","isPlayingPreview","setIsPlayingPreview","fileInputRef","textareaRef","mediaRecorder","audioChunks","emojiPickerRef","gifPickerRef","recordingIntervalRef","audioPreviewRef","uploadMedia","handleClickOutside","gifData","gifMediaData","handleVideoRecorded","videoFile","videoMediaData","handleTyping","insertEmoji","textarea","start","end","newValue","audioBlob","audioFile","cancelRecording","formatDuration","toggleAudioPreview","handleDrag","handleDrop","handleFileSelect","type","handleSubmit","mediaData","handleCancel","getContextPreview","AnimatePresence","_","i","Square","Pencil","CornerUpLeft","Pause","Play","Mic","FileText","Paperclip","ImagePlus","Smile","CheckCircle","Send","cn","inputs","Button","React","variant","props","ref","variants","sizes","SeshNxEmbedModal","url","isOpen","previewData","contentPath","contentType","title","ExternalLink","MessageStatus","statusConfig","CheckCheck","config","Icon","AudioWaveform","audioUrl","color","height","canvasRef","audioRef","animationRef","audioContextRef","analyserRef","isPlaying","setIsPlaying","canvas","ctx","audio","audioContext","analyser","source","bufferLength","dataArray","draw","drawStaticWaveform","barWidth","x","barHeight","gradient","width","barCount","gap","togglePlay","CHAT_REACTIONS","MessageBubble","message","isCurrentUser","previousMessage","linkPreviewData","messageStatus","onReaction","onReply","onEdit","onForward","onSeshNxLinkClick","onUserClick","showMenu","setShowMenu","showReactionPicker","setShowReactionPicker","copied","setCopied","menuRef","bubbleRef","isFirstInGroup","isSameDay","currentMs","prevMs","isFarApart","shouldShowDate","shouldShowTime","shouldShowAvatar","msgDate","handleCopy","handleReaction","reactionCounts","users","count","hasReactions","myReaction","bubbleClass","renderLinkPreview","isSeshNxLink","LinkIcon","Globe","Download","Copy","Forward","ForwardMessageModal","selectedChats","setSelectedChats","forwarding","setForwarding","filteredConversations","toggleSelect","handleForward","getMessagePreview","convo","useReadReceipts","readReceiptsQuery","readReceiptsData","markAsReadMutation","markMultipleAsReadMutation","readReceipts","receipts","receipt","myLastRead","markAsRead","messageIds","messageIdArray","isMessageRead","messageId","messages","userReceipt","lastReadMessageId","lastReadMessage","getLastReadMessage","hasCurrentUserRead","previewCache","CACHE_DURATION","getLinkPreview","urlMatch","matchedUrl","cached","getClientSideLinkPreview","urlObj","hostname","videoId","pathParts","subdomain","ChatWindow","userData","onBack","toggleDetails","openPublicProfile","setLinkPreviewData","embedModal","setEmbedModal","setReplyingTo","setEditingMessage","forwardingMessage","setForwardingMessage","messagesEndRef","chatName","presenceLoading","messagesQuery","chatMembersQuery","chatMembersData","groupMemberIds","messagesData","msg","sendMessageMutation","editMessageMutation","deleteMessageMutation","addReactionMutation","removeReactionMutation","updateConversationMutation","updateUnreadCountMutation","lastMarkedCountRef","currentMessageIds","currentCount","targetChatIds","forwardText","forwardMedia","targetChatId","targetConvo","summary","sendMessage","text","msgText","recipientIds","otherUid","recipientUid","handleDelete","forEveryone","ChatHeader","Info","isRead","hasRead","StatCard","value","icon","sub","bg","MediaGallery","onMediaSelect","media","setMedia","selectedMedia","setSelectedMedia","filter","setFilter","mediaQuery","mediaMessages","mediaItems","a","b","filteredMedia","item","handleMediaClick","handleDownload","link","ImageIcon","Music","f","MediaViewer","onDownload","allMedia","setAllMedia","currentIndex","setCurrentIndex","nextMedia","prevMedia","current","ChevronLeft","ChatDetailsPane","currentUser","stats","setStats","blocking","setBlocking","showMediaGallery","setShowMediaGallery","targetUid","loadData","handleBlockUser","handleReportUser","Briefcase","Flag","Bell","Images","Lock"],"mappings":"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"}