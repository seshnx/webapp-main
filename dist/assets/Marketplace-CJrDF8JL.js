import{j as e,r as l,a6 as dt,X as Q,am as ve,al as ot,ap as re,W as ct,h as Be,y as V,n as qe,cW as xt,ac as gt,L as ne,ag as se,c5 as ke,cX as we,R as He,a0 as ye,a1 as oe,c0 as Le,i as xe,a2 as Ae,ao as Ye,c1 as le,cs as Ge,cr as Ve,S as Ze,cY as We,P as Ue,cZ as ie,c_ as Xe,c6 as K,cf as ht,N as Ke,ar as bt,as as mt,c$ as Qe,b_ as Je,z as pt,d0 as ze,cE as Fe,cN as et,d1 as tt,ce as st,Q as ut,Z as ft,D as yt,bM as jt,bL as Nt}from"./vendor-Dl7DtIXW.js";import{f as pe,s as g,U as Re,u as vt}from"./chat-BYF7Vx2D.js";import{PROXIMITY_THRESHOLD_METERS as ue,SAFE_ZONE_TYPES as kt,SAFE_ZONE_RADIUS_METERS as wt,SAFE_EXCHANGE_STATUS as f,SAFE_EXCHANGE_STEPS as $e,EQUIP_CATEGORIES as je,HIGH_VALUE_THRESHOLD as me}from"./config-DGZTEYpI.js";import{m as be,A as at}from"./vendor-framer-CUELlS5e.js";import{R as _t,S as St}from"./ReportModal-e6fXq6Ul.js";import"./vendor-audio-CY3oQc7h.js";(function(){try{var t=typeof window<"u"?window:typeof global<"u"?global:typeof globalThis<"u"?globalThis:typeof self<"u"?self:{};t.SENTRY_RELEASE={id:"local"}}catch{}})();try{(function(){var t=typeof window<"u"?window:typeof global<"u"?global:typeof globalThis<"u"?globalThis:typeof self<"u"?self:{},a=new t.Error().stack;a&&(t._sentryDebugIds=t._sentryDebugIds||{},t._sentryDebugIds[a]="2a810bc6-090f-44db-8c9d-3b4984a54b0b",t._sentryDebugIdIdentifier="sentry-dbid-2a810bc6-090f-44db-8c9d-3b4984a54b0b")})()}catch{}const Et=[{id:"guitar_electric",label:"Electric Guitar"},{id:"guitar_acoustic",label:"Acoustic Guitar"},{id:"amp_head",label:"Amplifier Head"},{id:"amp_combo",label:"Combo Amp"},{id:"keyboard",label:"Keyboard/Synth"},{id:"rack_unit",label:"Rack Gear (1U/2U)"},{id:"pedal",label:"Pedal/Stompbox"}],rt=({type:t,view:a,onClick:d,markers:o=[]})=>{var j;const I=()=>o.map((_,v)=>e.jsxs("g",{transform:`translate(${_.x}, ${_.y})`,children:[e.jsx("circle",{r:"6",fill:"#ef4444",stroke:"white",strokeWidth:"2",className:"drop-shadow-md"}),e.jsx("text",{y:"-10",textAnchor:"middle",fill:"#ef4444",fontSize:"10",fontWeight:"bold",children:v+1})]},v)),w={width:"100%",height:"400",viewBox:"0 0 300 400",className:"w-full h-full cursor-crosshair touch-none select-none",onClick:_=>{const v=_.target.getBoundingClientRect(),b=(_.clientX-v.left)*(300/v.width),$=(_.clientY-v.top)*(400/v.height);d(b,$)}},s={guitar_electric:{front:e.jsx("path",{d:"M150,20 C140,20 135,25 135,40 L135,100 C110,110 90,140 90,170 C90,190 100,200 110,210 C100,220 90,240 90,270 C90,330 110,360 150,360 C190,360 210,330 210,270 C210,240 200,220 190,210 C200,200 210,190 210,170 C210,140 190,110 165,100 L165,40 C165,25 160,20 150,20 Z",fill:"#e5e7eb",stroke:"#374151",strokeWidth:"2"}),back:e.jsx("path",{d:"M150,20 C140,20 135,25 135,40 L135,100 C110,110 90,140 90,170 C90,190 100,200 110,210 C100,220 90,240 90,270 C90,330 110,360 150,360 C190,360 210,330 210,270 C210,240 200,220 190,210 C200,200 210,190 210,170 C210,140 190,110 165,100 L165,40 C165,25 160,20 150,20 Z",fill:"#d1d5db",stroke:"#374151",strokeWidth:"2",strokeDasharray:"5,5"})},amp_combo:{front:e.jsx("rect",{x:"50",y:"50",width:"200",height:"250",rx:"5",fill:"#e5e7eb",stroke:"#374151",strokeWidth:"2"}),back:e.jsxs("g",{children:[e.jsx("rect",{x:"50",y:"50",width:"200",height:"250",rx:"5",fill:"#d1d5db",stroke:"#374151",strokeWidth:"2"}),e.jsx("rect",{x:"70",y:"200",width:"160",height:"80",fill:"#9ca3af",opacity:"0.5"})]})}},C=()=>e.jsx("rect",{x:"50",y:"50",width:"200",height:"300",rx:"10",fill:"#f3f4f6",stroke:"#9ca3af",strokeWidth:"2",strokeDasharray:"4"}),N=((j=s[t])==null?void 0:j[a])||e.jsx(C,{});return e.jsxs("svg",{...w,children:[N,I()]})};function Ct({initialData:t,onSave:a,onCancel:d,type:o}){const[I,w]=l.useState((t==null?void 0:t.gearType)||"guitar_electric"),[s,C]=l.useState("front"),[N,j]=l.useState((t==null?void 0:t.markers)||[]),[_,v]=l.useState((t==null?void 0:t.notes)||""),[b,$]=l.useState((t==null?void 0:t.photos)||[]),[S,F]=l.useState(null),[B,G]=l.useState(""),{uploadMedia:y,uploading:M}=pe(),p=(c,L)=>{const O={x:c,y:L,view:s,id:Date.now(),label:""};j([...N,O]),F(O),G("")},n=()=>{S&&(j(N.map(c=>c.id===S.id?{...c,label:B}:c)),F(null))},A=async c=>{const L=c.target.files[0];if(!L)return;const O=await y(L,`inspections/${Date.now()}`);O&&$(z=>[...z,O])};return e.jsxs("div",{className:"bg-white dark:bg-[#2c2e36] rounded-xl border dark:border-gray-700 overflow-hidden flex flex-col h-[80vh]",children:[e.jsxs("div",{className:"p-4 border-b dark:border-gray-700 flex justify-between items-center bg-gray-50 dark:bg-[#23262f]",children:[e.jsxs("h3",{className:"font-bold dark:text-white flex items-center gap-2",children:[e.jsx(dt,{className:o==="Pre"?"text-orange-500":"text-green-500",size:20})," ",o,"-Inspection Report"]}),e.jsx("button",{onClick:d,children:e.jsx(Q,{className:"text-gray-500"})})]}),e.jsxs("div",{className:"flex-1 flex flex-col md:flex-row overflow-hidden",children:[e.jsxs("div",{className:"flex-1 bg-gray-100 dark:bg-black/40 relative flex flex-col items-center justify-center p-4",children:[e.jsxs("div",{className:"absolute top-4 left-4 z-10 flex flex-col gap-2",children:[e.jsx("select",{className:"p-2 rounded-lg border dark:border-gray-600 bg-white dark:bg-[#1f2128] text-sm font-bold dark:text-white shadow-sm",value:I,onChange:c=>w(c.target.value),children:Et.map(c=>e.jsx("option",{value:c.id,children:c.label},c.id))}),e.jsx("div",{className:"flex bg-white dark:bg-[#1f2128] rounded-lg border dark:border-gray-600 p-1 shadow-sm",children:["front","back","sides"].map(c=>e.jsx("button",{onClick:()=>C(c),className:`px-3 py-1 text-xs font-bold rounded-md capitalize ${s===c?"bg-brand-blue text-white":"text-gray-500 hover:bg-gray-100 dark:hover:bg-gray-700"}`,children:c},c))})]}),e.jsxs("div",{className:"w-full max-w-md h-full aspect-[3/4] bg-white dark:bg-[#1f2128] rounded-xl shadow-inner border dark:border-gray-700 relative",children:[e.jsx(rt,{type:I,view:s,markers:N.filter(c=>c.view===s),onClick:p}),S&&e.jsxs("div",{className:"absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-64 bg-white dark:bg-[#2c2e36] p-4 rounded-xl shadow-2xl border border-brand-blue z-20 animate-in zoom-in-95",children:[e.jsx("h4",{className:"text-xs font-bold uppercase text-gray-500 mb-2",children:"Identify Issue"}),e.jsx("input",{autoFocus:!0,className:"w-full p-2 border rounded mb-2 text-sm dark:bg-black/20 dark:text-white",placeholder:"e.g. Scratch",value:B,onChange:c=>G(c.target.value),onKeyDown:c=>c.key==="Enter"&&n()}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:()=>{j(N.filter(c=>c.id!==S.id)),F(null)},className:"flex-1 bg-red-100 text-red-600 py-1 rounded text-xs font-bold",children:"Delete"}),e.jsx("button",{onClick:n,className:"flex-1 bg-brand-blue text-white py-1 rounded text-xs font-bold",children:"Save"})]})]})]})]}),e.jsxs("div",{className:"w-full md:w-80 bg-white dark:bg-[#2c2e36] border-l dark:border-gray-700 flex flex-col",children:[e.jsxs("div",{className:"p-4 flex-1 overflow-y-auto",children:[e.jsxs("div",{className:"mb-6",children:[e.jsx("h4",{className:"text-xs font-bold text-gray-500 uppercase mb-2",children:"Damage Log"}),e.jsx("div",{className:"space-y-2",children:N.map((c,L)=>e.jsxs("div",{className:"flex items-center gap-2 p-2 bg-gray-50 dark:bg-black/20 rounded border dark:border-gray-700",children:[e.jsx("span",{className:"w-5 h-5 rounded-full bg-red-500 text-white flex items-center justify-center text-xs font-bold shrink-0",children:L+1}),e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"text-sm font-bold dark:text-white",children:c.label||"Unlabeled"}),e.jsxs("div",{className:"text-[10px] text-gray-500 uppercase",children:[c.view," View"]})]}),e.jsx("button",{onClick:()=>j(N.filter(O=>O.id!==c.id)),children:e.jsx(Q,{size:14,className:"text-gray-400 hover:text-red-500"})})]},L))})]}),e.jsxs("div",{className:"mb-6",children:[e.jsx("label",{className:"text-xs font-bold text-gray-500 uppercase mb-2 block",children:"Notes"}),e.jsx("textarea",{className:"w-full p-3 border rounded-lg text-sm dark:bg-black/20 dark:border-gray-600 dark:text-white min-h-[100px]",placeholder:"Overall condition...",value:_,onChange:c=>v(c.target.value)})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex justify-between items-center mb-2",children:[e.jsx("label",{className:"text-xs font-bold text-gray-500 uppercase",children:"Evidence Photos"}),e.jsxs("label",{className:"cursor-pointer text-brand-blue hover:text-blue-600",children:[e.jsx(ve,{size:16}),e.jsx("input",{type:"file",className:"hidden",accept:"image/*",onChange:A,disabled:M})]})]}),e.jsx("div",{className:"grid grid-cols-3 gap-2",children:b.map((c,L)=>e.jsxs("div",{className:"aspect-square rounded-lg overflow-hidden border dark:border-gray-600 relative group",children:[e.jsx("img",{src:c.url,className:"w-full h-full object-cover"}),e.jsx("button",{onClick:()=>$(b.filter((O,z)=>z!==L)),className:"absolute top-1 right-1 bg-red-500 text-white p-0.5 rounded opacity-0 group-hover:opacity-100 transition",children:e.jsx(Q,{size:12})})]},L))})]})]}),e.jsx("div",{className:"p-4 border-t dark:border-gray-700",children:e.jsxs("button",{onClick:()=>a({gearType:I,markers:N,notes:_,photos:b,timestamp:new Date().toISOString()}),className:"w-full bg-green-600 text-white py-3 rounded-xl font-bold hover:bg-green-700 flex items-center justify-center gap-2",children:[e.jsx(ot,{size:18})," Finalize Report"]})})]})]})]})}const he=(t,a,d,o)=>{const w=t*Math.PI/180,s=d*Math.PI/180,C=(d-t)*Math.PI/180,N=(o-a)*Math.PI/180,j=Math.sin(C/2)*Math.sin(C/2)+Math.cos(w)*Math.cos(s)*Math.sin(N/2)*Math.sin(N/2);return 6371e3*(2*Math.atan2(Math.sqrt(j),Math.sqrt(1-j)))};function Pt(t,a){const[d,o]=l.useState(null),[I,w]=l.useState(null),[s,C]=l.useState(!1),[N,j]=l.useState(null),[_,v]=l.useState([]),[b,$]=l.useState(null),[S,F]=l.useState(null),[B,G]=l.useState(!1),[y,M]=l.useState(!0),[p,n]=l.useState(null),A=l.useRef(Date.now());l.useEffect(()=>{(async()=>{if(g)try{const{data:r,error:h}=await g.from("safe_zones").select("*");if(h)throw h;v((r||[]).map(x=>({id:x.id,name:x.name,address:x.address,lat:x.lat,lng:x.lng,type:x.type,typeLabel:x.type_label,priority:x.priority,verified:x.verified})))}catch(r){console.error("Failed to load safe zones:",r)}})()},[]);const c=l.useCallback(()=>{if(!navigator.geolocation){w("Geolocation is not supported by your browser"),M(!1);return}const E={enableHighAccuracy:!0,timeout:1e4,maximumAge:5e3},r=T=>{const{latitude:u,longitude:D,accuracy:i}=T.coords;o({lat:u,lng:D,accuracy:i,timestamp:Date.now()}),w(null),M(!1),A.current=Date.now()},h=T=>{let u;switch(T.code){case T.PERMISSION_DENIED:u="Location permission denied. Please enable location access.";break;case T.POSITION_UNAVAILABLE:u="Location information unavailable.";break;case T.TIMEOUT:u="Location request timed out.";break;default:u="An unknown error occurred getting location."}w(u),M(!1)},x=navigator.geolocation.watchPosition(r,h,E);return n(x),()=>{x&&navigator.geolocation.clearWatch(x)}},[]),L=l.useCallback(()=>{p&&(navigator.geolocation.clearWatch(p),n(null))},[p]);l.useEffect(()=>{if(!d||_.length===0){C(!1);return}let E=null,r=1/0,h=!1;for(const x of _){if(!x.lat||!x.lng)continue;const T=he(d.lat,d.lng,x.lat,x.lng);T<r&&(r=T,E={...x,distance:T}),T<=wt&&(h=!0)}j(E),C(h)},[d,_]),l.useEffect(()=>{if(!d||!b){F(null),G(!1);return}const E=he(d.lat,d.lng,b.lat,b.lng);F(E),G(E<=ue)},[d,b]);const O=l.useCallback(E=>{$(E)},[]),z=l.useCallback(async()=>{if(!d)return[];try{const E=["police","fire_station","bank","library","townhall"],r=[];for(const h of E)try{const x=await fetch(`https://nominatim.openstreetmap.org/search?q=${h}&format=json&lat=${d.lat}&lon=${d.lng}&bounded=1&viewbox=${d.lng-.1},${d.lat+.1},${d.lng+.1},${d.lat-.1}&limit=5`,{headers:{"User-Agent":"SeshNx-SafeExchange/1.0"}});if(x.ok){const T=await x.json();for(const u of T){const D=he(d.lat,d.lng,parseFloat(u.lat),parseFloat(u.lon)),i=kt.find(W=>h.includes(W.id.split("_")[0]));r.push({id:`osm_${u.place_id}`,name:u.display_name.split(",")[0],address:u.display_name,lat:parseFloat(u.lat),lng:parseFloat(u.lon),distance:D,type:(i==null?void 0:i.id)||"public_building",typeLabel:(i==null?void 0:i.label)||"Public Building",priority:(i==null?void 0:i.priority)||10})}}}catch(x){console.warn(`Failed to fetch ${h}:`,x)}return r.sort((h,x)=>h.priority!==x.priority?h.priority-x.priority:h.distance-x.distance),r.slice(0,10)}catch(E){return console.error("Failed to find nearby safe zones:",E),[]}},[d]),U=l.useCallback(async E=>{if(!g)throw new Error("Supabase not configured");try{const{data:r,error:h}=await g.from("safe_zones").insert({name:E.name,address:E.address,lat:E.lat,lng:E.lng,type:E.type,type_label:E.typeLabel,priority:E.priority||10,verified:!1}).select("id").single();if(h)throw h;return r.id}catch(r){throw console.error("Failed to create safe zone:",r),r}},[]),P=l.useCallback(()=>!d||!N?{verified:!1,message:"Unable to verify location"}:s?{verified:!0,zone:N,message:`Arrived at ${N.name}`,timestamp:Date.now()}:{verified:!1,message:`Not within safe zone. ${Math.round(N.distance)}m from ${N.name}`,nearestZone:N},[d,N,s]),Z=l.useCallback(()=>!d||!b?{verified:!1,message:"Unable to verify proximity - waiting for other party location"}:B?{verified:!0,distance:S,message:`Both parties are within ${ue}m`,timestamp:Date.now()}:{verified:!1,distance:S,message:`Other party is ${Math.round(S)}m away. Must be within ${ue}m to proceed.`},[d,b,B,S]);return{currentPosition:d,locationError:I,loading:y,isInSafeZone:s,nearestSafeZone:N,safeZones:_,otherPartyPosition:b,proximityToOther:S,isWithinProximity:B,startWatching:c,stopWatching:L,findNearbySafeZones:z,createSafeZone:U,updateOtherPartyPosition:O,verifyArrival:P,verifyProximity:Z,calculateDistance:he}}function Me({mode:t="capture",role:a="seller",listingPhotos:d=[],sellerDeparturePhotos:o=[],itemDescription:I="",onPhotosSubmitted:w,onVerificationComplete:s,requiredPhotoCount:C=3,userId:N}){const[j,_]=l.useState([]),[v,b]=l.useState(0),[$,S]=l.useState(!1),[F,B]=l.useState(0),[G,y]=l.useState(null),[M,p]=l.useState(""),[n,A]=l.useState(!1),[c,L]=l.useState(!1),O=l.useRef(null),z=l.useRef(null),U=l.useRef(null),{uploadMedia:P,uploading:Z}=pe(),E=l.useCallback(async()=>{try{const R=await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment",width:{ideal:1920},height:{ideal:1080}}});O.current&&(O.current.srcObject=R,U.current=R,A(!0))}catch(R){console.error("Failed to access camera:",R),alert("Unable to access camera. Please check permissions.")}},[]),r=l.useCallback(()=>{U.current&&(U.current.getTracks().forEach(R=>R.stop()),U.current=null),A(!1)},[]),h=l.useCallback(async()=>{if(!O.current||!z.current)return;const R=O.current,m=z.current;m.width=R.videoWidth,m.height=R.videoHeight,m.getContext("2d").drawImage(R,0,0),m.toBlob(async ee=>{if(ee)try{const J=new File([ee],`verification_${Date.now()}.jpg`,{type:"image/jpeg"}),te=await P(J,`safe_exchange/${N}/verification`);te!=null&&te.url&&_(ce=>[...ce,{url:te.url,timestamp:Date.now(),type:a==="seller"?"departure":"inspection"}])}catch(J){console.error("Failed to upload photo:",J)}},"image/jpeg",.9)},[P,N,a]),x=async R=>{const m=R.target.files[0];if(m)try{const q=await P(m,`safe_exchange/${N}/verification`);q!=null&&q.url&&_(ee=>[...ee,{url:q.url,timestamp:Date.now(),type:a==="seller"?"departure":"inspection"}])}catch(q){console.error("Failed to upload photo:",q)}},T=R=>{_(m=>m.filter((q,ee)=>ee!==R)),v>=j.length-1&&b(Math.max(0,j.length-2))},u=async()=>{if(j.length<C){alert(`Please capture at least ${C} photos.`);return}L(!0);try{await(w==null?void 0:w(j,M))}finally{L(!1),r()}},D=async R=>{y(R),L(!0);try{await(s==null?void 0:s({result:R,notes:M,buyerPhotos:j,timestamp:Date.now()}))}finally{L(!1)}},i=()=>{var R;return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"bg-gradient-to-r from-orange-600 to-red-600 p-6 rounded-xl text-white",children:[e.jsx("h3",{className:"text-xl font-bold mb-2",children:a==="seller"?"ðŸ“¦ Pre-Departure Photos":"ðŸ” Inspection Photos"}),e.jsx("p",{className:"text-sm opacity-90",children:a==="seller"?"Take clear photos of the item before leaving for the exchange. These will be shown to the buyer for verification.":"Take photos of the item as received. Compare with seller's photos to verify condition."})]}),e.jsx("div",{className:"relative bg-black rounded-xl overflow-hidden aspect-video",children:n?e.jsxs(e.Fragment,{children:[e.jsx("video",{ref:O,autoPlay:!0,playsInline:!0,className:"w-full h-full object-cover"}),e.jsx("canvas",{ref:z,className:"hidden"}),e.jsxs("div",{className:"absolute bottom-4 left-1/2 -translate-x-1/2 flex items-center gap-4",children:[e.jsx("button",{onClick:r,className:"p-3 bg-white/20 hover:bg-white/30 rounded-full backdrop-blur-sm transition",children:e.jsx(Q,{className:"text-white",size:24})}),e.jsx("button",{onClick:h,disabled:Z,className:"p-5 bg-white rounded-full shadow-lg hover:scale-110 transition disabled:opacity-50",children:e.jsx(re,{className:Z?"animate-pulse text-orange-500":"text-gray-900",size:32})}),e.jsx("button",{className:"p-3 bg-white/20 rounded-full opacity-0 pointer-events-none",children:e.jsx(Q,{size:24})})]})]}):j.length>0?e.jsxs(e.Fragment,{children:[e.jsx("img",{src:(R=j[v])==null?void 0:R.url,alt:`Photo ${v+1}`,className:"w-full h-full object-contain"}),j.length>1&&e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:()=>b(Math.max(0,v-1)),className:"absolute left-2 top-1/2 -translate-y-1/2 p-2 bg-black/50 rounded-full hover:bg-black/70",disabled:v===0,children:e.jsx(ct,{className:"text-white"})}),e.jsx("button",{onClick:()=>b(Math.min(j.length-1,v+1)),className:"absolute right-2 top-1/2 -translate-y-1/2 p-2 bg-black/50 rounded-full hover:bg-black/70",disabled:v===j.length-1,children:e.jsx(Be,{className:"text-white"})})]}),e.jsxs("div",{className:"absolute top-4 right-4 bg-black/60 text-white text-sm px-3 py-1 rounded-full",children:[v+1," / ",j.length]}),e.jsx("button",{onClick:()=>T(v),className:"absolute top-4 left-4 p-2 bg-red-600 rounded-full hover:bg-red-700",children:e.jsx(Q,{className:"text-white",size:16})})]}):e.jsxs("div",{className:"absolute inset-0 flex flex-col items-center justify-center text-gray-400",children:[e.jsx(re,{size:64,className:"mb-4 opacity-30"}),e.jsx("p",{children:"No photos captured yet"})]})}),j.length>0&&e.jsxs("div",{className:"flex gap-2 overflow-x-auto pb-2",children:[j.map((m,q)=>e.jsx("button",{onClick:()=>b(q),className:`relative shrink-0 w-16 h-16 rounded-lg overflow-hidden border-2 transition ${q===v?"border-orange-500 ring-2 ring-orange-500/30":"border-transparent hover:border-gray-400"}`,children:e.jsx("img",{src:m.url,alt:"",className:"w-full h-full object-cover"})},q)),j.length<10&&e.jsx("button",{onClick:E,className:"shrink-0 w-16 h-16 rounded-lg border-2 border-dashed border-gray-300 dark:border-gray-600 flex items-center justify-center hover:border-orange-500 hover:bg-orange-50 dark:hover:bg-orange-900/20 transition",children:e.jsx(re,{className:"text-gray-400",size:20})})]}),e.jsx("div",{className:"flex gap-3",children:!n&&e.jsxs(e.Fragment,{children:[e.jsxs("button",{onClick:E,className:"flex-1 bg-gray-900 dark:bg-white dark:text-black text-white py-3 rounded-xl font-bold flex items-center justify-center gap-2 hover:opacity-90 transition",children:[e.jsx(re,{size:20})," Open Camera"]}),e.jsxs("label",{className:"flex-1 bg-gray-100 dark:bg-gray-800 py-3 rounded-xl font-bold flex items-center justify-center gap-2 cursor-pointer hover:bg-gray-200 dark:hover:bg-gray-700 transition",children:[e.jsx(ve,{size:20})," Upload Photo",e.jsx("input",{type:"file",accept:"image/*",className:"hidden",onChange:x})]})]})}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-bold text-gray-500 uppercase mb-2 block",children:"Additional Notes (Optional)"}),e.jsx("textarea",{value:M,onChange:m=>p(m.target.value),placeholder:a==="seller"?"Any notes about current condition...":"Note any concerns or observations...",className:"w-full p-3 border rounded-xl dark:bg-gray-800 dark:border-gray-600 dark:text-white resize-none",rows:3})]}),e.jsxs("div",{className:"bg-gray-50 dark:bg-gray-800 p-4 rounded-xl",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("span",{className:"text-sm font-bold dark:text-white",children:["Photos: ",j.length," / ",C," required"]}),j.length>=C&&e.jsx(V,{className:"text-green-500",size:20})]}),e.jsx("div",{className:"h-2 bg-gray-200 dark:bg-gray-700 rounded-full overflow-hidden",children:e.jsx("div",{className:"h-full bg-green-500 transition-all duration-300",style:{width:`${Math.min(100,j.length/C*100)}%`}})})]}),e.jsx("button",{onClick:u,disabled:j.length<C||c,className:"w-full bg-orange-600 text-white py-4 rounded-xl font-bold flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed hover:bg-orange-700 transition shadow-lg",children:c?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"w-5 h-5 border-2 border-white/30 border-t-white rounded-full animate-spin"}),"Submitting..."]}):e.jsxs(e.Fragment,{children:[e.jsx(qe,{size:20})," Submit Photos"]})})]})},W=()=>e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"bg-gradient-to-r from-blue-600 to-indigo-600 p-6 rounded-xl text-white",children:[e.jsx("h3",{className:"text-xl font-bold mb-2",children:"ðŸ” Verify Item Condition"}),e.jsx("p",{className:"text-sm opacity-90",children:"Compare the seller's pre-departure photos with the item in front of you. Does it match the listing description?"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs("label",{className:"text-xs font-bold text-gray-500 uppercase",children:["Seller's Photo (",F+1,"/",o.length,")"]}),e.jsx("div",{className:"relative bg-black rounded-xl overflow-hidden aspect-square",children:o[F]?e.jsx("img",{src:o[F].url,alt:"Seller's photo",className:"w-full h-full object-contain"}):e.jsx("div",{className:"flex items-center justify-center h-full text-gray-500",children:"No photo available"})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("label",{className:"text-xs font-bold text-gray-500 uppercase",children:["Original Listing (",F+1,"/",d.length,")"]}),e.jsx("div",{className:"relative bg-black rounded-xl overflow-hidden aspect-square",children:d[F]?e.jsx("img",{src:d[F],alt:"Listing photo",className:"w-full h-full object-contain"}):e.jsx("div",{className:"flex items-center justify-center h-full text-gray-500",children:"No photo available"})})]})]}),e.jsx("div",{className:"flex justify-center gap-2",children:Array.from({length:Math.max(o.length,d.length)}).map((R,m)=>e.jsx("button",{onClick:()=>B(m),className:`w-3 h-3 rounded-full transition ${m===F?"bg-blue-600":"bg-gray-300 hover:bg-gray-400"}`},m))}),e.jsxs("div",{className:"bg-gray-50 dark:bg-gray-800 p-4 rounded-xl",children:[e.jsx("h4",{className:"font-bold text-sm dark:text-white mb-2",children:"ðŸ“‹ Listing Description"}),e.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-300",children:I||"No description provided"})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("p",{className:"text-sm font-bold dark:text-white text-center",children:"Does the item match the photos and description?"}),e.jsxs("div",{className:"grid grid-cols-3 gap-3",children:[e.jsxs("button",{onClick:()=>D("match"),disabled:c,className:"p-4 bg-green-100 dark:bg-green-900/30 border-2 border-green-500 rounded-xl flex flex-col items-center gap-2 hover:bg-green-200 dark:hover:bg-green-900/50 transition",children:[e.jsx(V,{className:"text-green-600",size:32}),e.jsx("span",{className:"font-bold text-green-700 dark:text-green-400",children:"Yes, Matches"})]}),e.jsxs("button",{onClick:()=>D("unsure"),disabled:c,className:"p-4 bg-yellow-100 dark:bg-yellow-900/30 border-2 border-yellow-500 rounded-xl flex flex-col items-center gap-2 hover:bg-yellow-200 dark:hover:bg-yellow-900/50 transition",children:[e.jsx(xt,{className:"text-yellow-600",size:32}),e.jsx("span",{className:"font-bold text-yellow-700 dark:text-yellow-400",children:"Unsure"})]}),e.jsxs("button",{onClick:()=>D("mismatch"),disabled:c,className:"p-4 bg-red-100 dark:bg-red-900/30 border-2 border-red-500 rounded-xl flex flex-col items-center gap-2 hover:bg-red-200 dark:hover:bg-red-900/50 transition",children:[e.jsx(gt,{className:"text-red-600",size:32}),e.jsx("span",{className:"font-bold text-red-700 dark:text-red-400",children:"No, Different"})]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-bold text-gray-500 uppercase mb-2 block",children:"Describe Any Concerns"}),e.jsx("textarea",{value:M,onChange:R=>p(R.target.value),placeholder:"Note any differences, damage, or concerns...",className:"w-full p-3 border rounded-xl dark:bg-gray-800 dark:border-gray-600 dark:text-white resize-none",rows:3})]})]});return e.jsxs("div",{className:"max-w-2xl mx-auto",children:[t==="capture"&&i(),t==="compare"&&W()]})}function It({transactionId:t,user:a,userData:d,onClose:o,onComplete:I,onMessage:w}){var _e,Se,Ee,Ce,Pe,Ie;const[s,C]=l.useState(null),[N,j]=l.useState(!0),[_,v]=l.useState(!1),[b,$]=l.useState(null),[S,F]=l.useState(""),[B,G]=l.useState(""),[y,M]=l.useState(!1),[p,n]=l.useState([]),[A,c]=l.useState(null),L=(a==null?void 0:a.id)||(a==null?void 0:a.uid),O=(s==null?void 0:s.sellerId)===L,z=(s==null?void 0:s.buyerId)===L,U=O?"seller":"buyer",{currentPosition:P,isInSafeZone:Z,nearestSafeZone:E,isWithinProximity:r,startWatching:h,findNearbySafeZones:x}=Pt(t,a==null?void 0:a.uid);l.useEffect(()=>{if(!t||!g)return;const k=g.channel(`safe-exchange-${t}`).on("postgres_changes",{event:"*",schema:"public",table:"safe_exchange_transactions",filter:`id=eq.${t}`},()=>{T()}).subscribe();return T(),()=>{g.removeChannel(k)}},[t]);const T=async()=>{if(g){j(!0);try{const{data:k,error:H}=await g.from("safe_exchange_transactions").select("*").eq("id",t).single();if(H)throw H;k&&C({id:k.id,...k,buyerId:k.buyer_id,sellerId:k.seller_id,listingId:k.listing_id})}catch(k){console.error("Error loading transaction:",k)}j(!1)}};l.useEffect(()=>{if(!s||!P||!g)return;(async()=>{try{const H=U==="seller"?"seller_location":"buyer_location";await g.from("safe_exchange_transactions").update({[H]:{lat:P.lat,lng:P.lng,updated_at:Date.now()},updated_at:new Date().toISOString()}).eq("id",t)}catch(H){console.error("Failed to update position:",H)}})()},[P,s,t,U]),l.useEffect(()=>{y&&P&&x().then(k=>n(k))},[y,P,x]);const u=l.useCallback(async(k,H={})=>{if(!t||!g)return;v(!0);const de=(a==null?void 0:a.id)||(a==null?void 0:a.uid);try{const ae=(s==null?void 0:s.status_history)||{};ae[k]={timestamp:Date.now(),userId:de};const ge=Object.keys(H).reduce((Oe,Te)=>{const nt=Te.replace(/([A-Z])/g,"_$1").toLowerCase();return Oe[nt]=H[Te],Oe},{});await g.from("safe_exchange_transactions").update({status:k,status_history:ae,updated_at:new Date().toISOString(),...ge}).eq("id",t),await D(k,H)}catch(ae){console.error("Failed to update status:",ae),alert("Failed to update transaction. Please try again.")}v(!1)},[t,s,a==null?void 0:a.id,a==null?void 0:a.uid]),D=async(k,H={})=>{if(!g||!s)return;const de=O?s.buyerId:s.sellerId,ae={[f.MEETUP_SCHEDULED]:`Meetup scheduled for ${H.meetupDate||s.meetup_date} at ${H.meetupTime||s.meetup_time}`,[f.SELLER_EN_ROUTE]:"Seller is on their way to the exchange location",[f.BUYER_EN_ROUTE]:"Buyer is on their way to the exchange location",[f.AT_SAFE_ZONE]:`${O?"Seller":"Buyer"} has arrived at the safe zone`,[f.SELLER_PHOTOS_UPLOADED]:"Seller has uploaded pre-departure photos",[f.BUYER_APPROVED]:"Buyer has approved the exchange",[f.SELLER_APPROVED]:"Seller has approved the exchange",[f.COMPLETED]:"ðŸŽ‰ Exchange completed! Funds have been released.",[f.DISPUTED]:"âš ï¸ A dispute has been raised on the transaction"};await g.from("notifications").insert({user_id:de,type:"safe_exchange",transaction_id:t,message:ae[k]||`Transaction status updated: ${k}`,item_title:s.item_title,read:!1,created_at:new Date().toISOString()})},i=async()=>{if(!b||!S||!B){alert("Please select a safe zone and set a date/time.");return}await u(f.MEETUP_SCHEDULED,{meetupLocation:b,meetupDate:S,meetupTime:B}),M(!1)},W=()=>{c("seller_depart"),h()},R=async(k,H)=>{await u(f.SELLER_PHOTOS_UPLOADED,{sellerDeparturePhotos:k,sellerDepartureNotes:H}),c(null),await u(f.SELLER_EN_ROUTE)},m=()=>{h(),u(f.BUYER_EN_ROUTE)},q=async k=>{await u(f.BUYER_PHOTOS_UPLOADED,{buyerInspectionResult:k.result,buyerInspectionPhotos:k.buyerPhotos,buyerInspectionNotes:k.notes}),k.result==="mismatch"?await u(f.DISPUTED):await u(f.PENDING_DUAL_APPROVAL),c(null)},ee=async()=>{const k=O?"sellerApproved":"buyerApproved",H=O?f.SELLER_APPROVED:f.BUYER_APPROVED;await u(H,{[k]:!0,[`${k}At`]:Date.now()}),(O?s.buyerApproved:s.sellerApproved)&&await J()},J=async()=>{g&&(a!=null&&a.id||(a==null||a.uid),await u(f.COMPLETED,{completedAt:new Date().toISOString()}),await g.from("safe_exchange_transactions").update({funds_released:!0,funds_released_at:new Date().toISOString(),updated_at:new Date().toISOString()}).eq("id",t),I==null||I())},te=async()=>{if(!confirm("Are you sure you want to cancel this transaction? This may affect your seller rating."))return;const k=(a==null?void 0:a.id)||(a==null?void 0:a.uid);await u(f.CANCELLED,{cancelledBy:k,cancelledAt:new Date().toISOString()}),o==null||o()},ce=async k=>{const H=(a==null?void 0:a.id)||(a==null?void 0:a.uid);await u(f.DISPUTED,{disputeReason:k,disputeRaisedBy:H,disputeRaisedAt:new Date().toISOString()})},X=()=>({[f.INTENT_CREATED]:0,[f.HOLD_PLACED]:1,[f.SELLER_NOTIFIED]:1,[f.MEETUP_SCHEDULED]:2,[f.SELLER_EN_ROUTE]:3,[f.SELLER_PHOTOS_UPLOADED]:3,[f.BUYER_EN_ROUTE]:4,[f.AT_SAFE_ZONE]:4,[f.BUYER_INSPECTING]:5,[f.BUYER_PHOTOS_UPLOADED]:5,[f.PENDING_DUAL_APPROVAL]:6,[f.SELLER_APPROVED]:6,[f.BUYER_APPROVED]:6,[f.COMPLETED]:7})[s==null?void 0:s.status]||0;return N?e.jsx("div",{className:"fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-[80]",children:e.jsxs("div",{className:"bg-white dark:bg-gray-900 p-8 rounded-2xl flex flex-col items-center gap-4",children:[e.jsx(ne,{className:"animate-spin text-orange-500",size:48}),e.jsx("p",{className:"text-gray-600 dark:text-gray-300",children:"Loading transaction..."})]})}):A==="seller_depart"?e.jsx("div",{className:"fixed inset-0 bg-black/90 z-[80] overflow-y-auto",children:e.jsx("div",{className:"min-h-screen p-4",children:e.jsxs("div",{className:"max-w-2xl mx-auto py-8",children:[e.jsxs("button",{onClick:()=>c(null),className:"mb-4 text-white flex items-center gap-2 hover:underline",children:[e.jsx(Q,{size:20})," Cancel"]}),e.jsx(Me,{mode:"capture",role:"seller",listingPhotos:s.itemPhotos||[],itemDescription:s.itemDescription,onPhotosSubmitted:R,requiredPhotoCount:3,userId:a.uid})]})})}):A==="buyer_inspect"?e.jsx("div",{className:"fixed inset-0 bg-black/90 z-[80] overflow-y-auto",children:e.jsx("div",{className:"min-h-screen p-4",children:e.jsxs("div",{className:"max-w-2xl mx-auto py-8",children:[e.jsxs("button",{onClick:()=>c(null),className:"mb-4 text-white flex items-center gap-2 hover:underline",children:[e.jsx(Q,{size:20})," Cancel"]}),e.jsx(Me,{mode:"compare",role:"buyer",listingPhotos:s.itemPhotos||[],sellerDeparturePhotos:s.sellerDeparturePhotos||[],itemDescription:s.itemDescription,onVerificationComplete:q,requiredPhotoCount:2,userId:a.uid})]})})}):e.jsxs("div",{className:"fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-[70] p-4 overflow-y-auto",children:[e.jsxs("div",{className:"bg-white dark:bg-[#1f2128] w-full max-w-4xl rounded-2xl shadow-2xl overflow-hidden my-8",children:[e.jsxs("div",{className:"bg-gradient-to-r from-orange-600 to-red-600 p-6 text-white relative overflow-hidden",children:[e.jsx("button",{onClick:o,className:"absolute top-4 right-4 p-2 hover:bg-white/20 rounded-full transition",children:e.jsx(Q,{size:20})}),e.jsxs("div",{className:"flex items-center gap-2 text-orange-200 text-xs font-bold uppercase tracking-widest mb-2",children:[e.jsx(se,{size:14})," Safe Exchange"]}),e.jsx("h2",{className:"text-2xl font-bold mb-1",children:s==null?void 0:s.itemTitle}),e.jsxs("div",{className:"flex items-center gap-4 text-sm",children:[e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(ke,{size:16})," $",(_e=s==null?void 0:s.price)==null?void 0:_e.toLocaleString(),(s==null?void 0:s.serviceFee)&&e.jsx("span",{className:"text-orange-200 text-xs ml-1",children:"(1% mutual service fee)"})]}),e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(we,{size:16})," ",s==null?void 0:s.itemBrand]})]}),e.jsx(se,{size:150,className:"absolute -right-10 -bottom-10 text-white opacity-10 rotate-12"})]}),e.jsxs("div",{className:"p-6 border-b dark:border-gray-700",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h3",{className:"font-bold dark:text-white",children:"Transaction Progress"}),e.jsx("span",{className:`px-3 py-1 rounded-full text-xs font-bold ${(s==null?void 0:s.status)===f.COMPLETED?"bg-green-100 text-green-700":(s==null?void 0:s.status)===f.DISPUTED?"bg-red-100 text-red-700":"bg-orange-100 text-orange-700"}`,children:(Se=s==null?void 0:s.status)==null?void 0:Se.replace(/_/g," ").toUpperCase()})]}),e.jsx("div",{className:"flex items-center gap-1 overflow-x-auto pb-2",children:$e.map((k,H)=>{const de=X(),ae=H<de,ge=H===de;return e.jsxs(He.Fragment,{children:[e.jsxs("div",{className:"flex flex-col items-center shrink-0",children:[e.jsx("div",{className:`w-8 h-8 rounded-full flex items-center justify-center ${ae?"bg-green-500 text-white":ge?"bg-orange-500 text-white animate-pulse":"bg-gray-200 dark:bg-gray-700 text-gray-500"}`,children:ae?e.jsx(qe,{size:16}):H+1}),e.jsx("span",{className:`text-[10px] mt-1 whitespace-nowrap ${ge?"font-bold text-orange-600":"text-gray-500"}`,children:k.label})]}),H<$e.length-1&&e.jsx("div",{className:`flex-1 h-1 min-w-[20px] rounded ${ae?"bg-green-500":"bg-gray-200 dark:bg-gray-700"}`})]},k.key)})})]}),e.jsxs("div",{className:"p-6 space-y-6 max-h-[60vh] overflow-y-auto",children:[e.jsx("div",{className:"bg-gradient-to-r from-green-50 to-emerald-50 dark:from-green-900/20 dark:to-emerald-900/20 p-4 rounded-xl border border-green-200 dark:border-green-800",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 bg-green-500 rounded-full",children:e.jsx(ye,{className:"text-white",size:20})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h4",{className:"font-bold text-green-800 dark:text-green-300",children:"Escrow Protected"}),e.jsx("p",{className:"text-sm text-green-600 dark:text-green-400",children:z?e.jsxs(e.Fragment,{children:["$",((Ee=s==null?void 0:s.buyerTotal)==null?void 0:Ee.toFixed(2))||((Ce=s==null?void 0:s.price)==null?void 0:Ce.toLocaleString())," held securely",(s==null?void 0:s.serviceFee)&&e.jsxs("span",{className:"text-green-500 text-xs",children:[" (includes 1% service fee: $",s.serviceFee.toFixed(2),")"]})]}):e.jsxs(e.Fragment,{children:["You'll receive $",((Pe=s==null?void 0:s.sellerPayout)==null?void 0:Pe.toFixed(2))||((Ie=s==null?void 0:s.price)==null?void 0:Ie.toLocaleString())," on completion",(s==null?void 0:s.serviceFee)&&e.jsxs("span",{className:"text-green-500 text-xs",children:[" (after 1% service fee: $",s.serviceFee.toFixed(2),")"]})]})})]})]})}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:`p-4 rounded-xl border ${O?"bg-orange-50 dark:bg-orange-900/20 border-orange-200 dark:border-orange-800":"dark:border-gray-700"}`,children:[e.jsxs("div",{className:"text-xs font-bold text-gray-500 uppercase mb-2",children:["Seller ",O&&"(You)"]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(Re,{src:s==null?void 0:s.sellerPhoto,name:s==null?void 0:s.sellerName,size:"md"}),e.jsxs("div",{children:[e.jsx("div",{className:"font-bold dark:text-white",children:s==null?void 0:s.sellerName}),(s==null?void 0:s.sellerApproved)&&e.jsxs("span",{className:"text-xs text-green-600 flex items-center gap-1",children:[e.jsx(V,{size:12})," Approved"]})]})]})]}),e.jsxs("div",{className:`p-4 rounded-xl border ${z?"bg-blue-50 dark:bg-blue-900/20 border-blue-200 dark:border-blue-800":"dark:border-gray-700"}`,children:[e.jsxs("div",{className:"text-xs font-bold text-gray-500 uppercase mb-2",children:["Buyer ",z&&"(You)"]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(Re,{src:s==null?void 0:s.buyerPhoto,name:s==null?void 0:s.buyerName,size:"md"}),e.jsxs("div",{children:[e.jsx("div",{className:"font-bold dark:text-white",children:s==null?void 0:s.buyerName}),(s==null?void 0:s.buyerApproved)&&e.jsxs("span",{className:"text-xs text-green-600 flex items-center gap-1",children:[e.jsx(V,{size:12})," Approved"]})]})]})]})]}),(s==null?void 0:s.meetupLocation)&&e.jsxs("div",{className:"bg-blue-50 dark:bg-blue-900/20 p-4 rounded-xl border border-blue-200 dark:border-blue-800",children:[e.jsxs("h4",{className:"font-bold text-blue-800 dark:text-blue-300 flex items-center gap-2 mb-3",children:[e.jsx(oe,{size:18})," Exchange Location"]}),e.jsxs("div",{className:"space-y-2 text-sm",children:[e.jsxs("div",{className:"flex items-center gap-2 text-blue-700 dark:text-blue-300",children:[e.jsx(se,{size:16}),e.jsx("span",{className:"font-bold",children:s.meetupLocation.name}),e.jsx("span",{className:"bg-blue-200 dark:bg-blue-800 text-blue-800 dark:text-blue-200 text-xs px-2 py-0.5 rounded",children:s.meetupLocation.typeLabel})]}),e.jsx("p",{className:"text-blue-600 dark:text-blue-400",children:s.meetupLocation.address}),e.jsxs("div",{className:"flex items-center gap-4 mt-2",children:[e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(Le,{size:14})," ",s.meetupDate]}),e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(xe,{size:14})," ",s.meetupTime]})]})]})]}),P&&e.jsxs("div",{className:"bg-gray-50 dark:bg-gray-800 p-4 rounded-xl",children:[e.jsxs("h4",{className:"font-bold dark:text-white text-sm mb-3 flex items-center gap-2",children:[e.jsx(Ae,{size:16,className:"text-blue-500"})," Live Location"]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500",children:"Your Position:"}),e.jsxs("div",{className:"flex items-center gap-1 font-mono text-xs dark:text-white",children:[P.lat.toFixed(6),", ",P.lng.toFixed(6)]})]}),E&&e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500",children:"Safe Zone:"}),e.jsx("div",{className:"flex items-center gap-1",children:Z?e.jsxs("span",{className:"text-green-600 font-bold flex items-center gap-1",children:[e.jsx(V,{size:14})," In Zone"]}):e.jsxs("span",{className:"text-orange-600",children:[Math.round(E.distance),"m away"]})})]})]})]}),e.jsxs("div",{className:"space-y-3",children:[O&&(s==null?void 0:s.status)===f.SELLER_NOTIFIED&&e.jsxs("button",{onClick:()=>M(!0),className:"w-full bg-orange-600 text-white py-4 rounded-xl font-bold flex items-center justify-center gap-2 hover:bg-orange-700 transition",children:[e.jsx(Le,{size:20})," Schedule Safe Exchange"]}),O&&(s==null?void 0:s.status)===f.MEETUP_SCHEDULED&&e.jsxs("button",{onClick:W,className:"w-full bg-orange-600 text-white py-4 rounded-xl font-bold flex items-center justify-center gap-2 hover:bg-orange-700 transition",children:[e.jsx(re,{size:20})," Take Pre-Departure Photos"]}),z&&(s==null?void 0:s.status)===f.SELLER_PHOTOS_UPLOADED&&e.jsxs("button",{onClick:m,className:"w-full bg-blue-600 text-white py-4 rounded-xl font-bold flex items-center justify-center gap-2 hover:bg-blue-700 transition",children:[e.jsx(Ae,{size:20})," I'm On My Way"]}),z&&((s==null?void 0:s.status)===f.BUYER_EN_ROUTE||(s==null?void 0:s.status)===f.AT_SAFE_ZONE)&&Z&&r&&e.jsxs("button",{onClick:()=>c("buyer_inspect"),className:"w-full bg-blue-600 text-white py-4 rounded-xl font-bold flex items-center justify-center gap-2 hover:bg-blue-700 transition",children:[e.jsx(re,{size:20})," Start Item Inspection"]}),(s==null?void 0:s.status)===f.PENDING_DUAL_APPROVAL&&e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"bg-yellow-50 dark:bg-yellow-900/20 p-4 rounded-xl border border-yellow-200 dark:border-yellow-800",children:[e.jsx("h4",{className:"font-bold text-yellow-800 dark:text-yellow-300 mb-2",children:"Final Approval Required"}),e.jsx("p",{className:"text-sm text-yellow-700 dark:text-yellow-400",children:"Both parties must approve to release funds."})]}),(O&&!s.sellerApproved||z&&!s.buyerApproved)&&e.jsx("button",{onClick:ee,disabled:_,className:"w-full bg-green-600 text-white py-4 rounded-xl font-bold flex items-center justify-center gap-2 hover:bg-green-700 transition disabled:opacity-50",children:_?e.jsx(ne,{className:"animate-spin"}):e.jsxs(e.Fragment,{children:[e.jsx(V,{size:20})," Approve & Release Funds"]})}),(O&&s.sellerApproved||z&&s.buyerApproved)&&e.jsxs("div",{className:"text-center text-green-600 font-bold py-4",children:[e.jsx(V,{className:"inline mr-2"}),"You have approved. Waiting for other party..."]})]}),(s==null?void 0:s.status)===f.COMPLETED&&e.jsxs("div",{className:"bg-green-50 dark:bg-green-900/20 p-6 rounded-xl border border-green-200 dark:border-green-800 text-center",children:[e.jsx(V,{className:"text-green-500 mx-auto mb-4",size:48}),e.jsx("h4",{className:"text-xl font-bold text-green-700 dark:text-green-300 mb-2",children:"Exchange Completed!"}),e.jsx("p",{className:"text-green-600 dark:text-green-400",children:O?"Funds have been released to your account.":"Thank you for your purchase!"})]}),(s==null?void 0:s.status)===f.DISPUTED&&e.jsxs("div",{className:"bg-red-50 dark:bg-red-900/20 p-6 rounded-xl border border-red-200 dark:border-red-800 text-center",children:[e.jsx(Ye,{className:"text-red-500 mx-auto mb-4",size:48}),e.jsx("h4",{className:"text-xl font-bold text-red-700 dark:text-red-300 mb-2",children:"Dispute Raised"}),e.jsx("p",{className:"text-red-600 dark:text-red-400 mb-4",children:"Our support team will review this transaction."}),e.jsx("button",{className:"bg-red-600 text-white px-6 py-2 rounded-lg font-bold",children:"Contact Support"})]}),(s==null?void 0:s.status)!==f.COMPLETED&&e.jsxs("button",{onClick:()=>w==null?void 0:w(O?s.buyerId:s.sellerId),className:"w-full border-2 border-gray-300 dark:border-gray-600 py-3 rounded-xl font-bold flex items-center justify-center gap-2 hover:bg-gray-50 dark:hover:bg-gray-800 transition dark:text-white",children:[e.jsx(le,{size:18})," Message ",O?"Buyer":"Seller"]})]})]}),e.jsx("div",{className:"p-4 border-t dark:border-gray-700 bg-gray-50 dark:bg-gray-800/50 flex justify-between",children:(s==null?void 0:s.status)!==f.COMPLETED&&(s==null?void 0:s.status)!==f.CANCELLED&&e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:te,className:"text-red-600 font-bold text-sm hover:underline",children:"Cancel Transaction"}),(s==null?void 0:s.status)!==f.DISPUTED&&e.jsx("button",{onClick:()=>ce("Item not as described"),className:"text-orange-600 font-bold text-sm hover:underline",children:"Raise Dispute"})]})})]}),y&&e.jsx("div",{className:"fixed inset-0 bg-black/70 flex items-center justify-center z-[75] p-4",children:e.jsxs("div",{className:"bg-white dark:bg-gray-900 w-full max-w-lg rounded-2xl overflow-hidden",children:[e.jsxs("div",{className:"p-6 border-b dark:border-gray-700",children:[e.jsx("h3",{className:"text-xl font-bold dark:text-white",children:"Select Safe Exchange Zone"}),e.jsx("p",{className:"text-sm text-gray-500 mt-1",children:"Choose a verified safe location for the exchange"})]}),e.jsx("div",{className:"p-4 max-h-[400px] overflow-y-auto space-y-2",children:p.length>0?p.map(k=>e.jsx("button",{onClick:()=>$(k),className:`w-full p-4 rounded-xl border text-left transition ${(b==null?void 0:b.id)===k.id?"border-orange-500 bg-orange-50 dark:bg-orange-900/20":"border-gray-200 dark:border-gray-700 hover:border-gray-400"}`,children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:`p-2 rounded-lg ${(b==null?void 0:b.id)===k.id?"bg-orange-500 text-white":"bg-gray-100 dark:bg-gray-800 text-gray-500"}`,children:e.jsx(se,{size:20})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:"font-bold dark:text-white",children:k.name}),e.jsx("div",{className:"text-xs text-gray-500 truncate",children:k.address}),e.jsxs("div",{className:"flex items-center gap-2 mt-1",children:[e.jsx("span",{className:"text-xs bg-blue-100 dark:bg-blue-900/50 text-blue-700 dark:text-blue-300 px-2 py-0.5 rounded",children:k.typeLabel}),e.jsxs("span",{className:"text-xs text-gray-500",children:[(k.distance/1e3).toFixed(1)," km away"]})]})]}),(b==null?void 0:b.id)===k.id&&e.jsx(V,{className:"text-orange-500",size:20})]})},k.id)):e.jsxs("div",{className:"text-center py-8 text-gray-500",children:[e.jsx(oe,{size:32,className:"mx-auto mb-2 opacity-50"}),e.jsx("p",{children:"Loading nearby safe zones..."})]})}),b&&e.jsxs("div",{className:"p-4 border-t dark:border-gray-700 space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-bold text-gray-500 uppercase mb-1 block",children:"Date"}),e.jsx("input",{type:"date",value:S,onChange:k=>F(k.target.value),min:new Date().toISOString().split("T")[0],className:"w-full p-3 border rounded-lg dark:bg-gray-800 dark:border-gray-600 dark:text-white"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-bold text-gray-500 uppercase mb-1 block",children:"Time"}),e.jsx("input",{type:"time",value:B,onChange:k=>G(k.target.value),className:"w-full p-3 border rounded-lg dark:bg-gray-800 dark:border-gray-600 dark:text-white"})]})]}),e.jsx("button",{onClick:i,disabled:!S||!B||_,className:"w-full bg-orange-600 text-white py-3 rounded-xl font-bold disabled:opacity-50 hover:bg-orange-700 transition",children:_?"Scheduling...":"Confirm & Notify Buyer"})]}),e.jsx("div",{className:"p-4 border-t dark:border-gray-700",children:e.jsx("button",{onClick:()=>M(!1),className:"w-full text-gray-500 font-bold hover:text-gray-700 dark:hover:text-gray-300",children:"Cancel"})})]})})]})}const Ot=["Mint","Excellent","Good","Fair","Non-Functioning"],Y={PENDING:"pending",CONFIRMED:"confirmed",SHIPPED:"shipped",DELIVERED:"delivered",COMPLETED:"completed",CANCELLED:"cancelled",REFUNDED:"refunded"},fe={[Y.PENDING]:{label:"Pending",color:"bg-yellow-100 text-yellow-700 dark:bg-yellow-900/30 dark:text-yellow-400",icon:xe},[Y.CONFIRMED]:{label:"Confirmed",color:"bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-400",icon:V},[Y.SHIPPED]:{label:"Shipped",color:"bg-purple-100 text-purple-700 dark:bg-purple-900/30 dark:text-purple-400",icon:ie},[Y.DELIVERED]:{label:"Delivered",color:"bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400",icon:we},[Y.COMPLETED]:{label:"Completed",color:"bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400",icon:V},[Y.CANCELLED]:{label:"Cancelled",color:"bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-400",icon:Q},[Y.REFUNDED]:{label:"Refunded",color:"bg-gray-100 text-gray-700 dark:bg-gray-800 dark:text-gray-400",icon:Qe}},De=.01,Ne=t=>{const a=parseFloat(t)||0,d=Math.round(a*De*100)/100,o=Math.round((a+d)*100)/100,I=Math.round((a-d)*100)/100;return{itemPrice:a,serviceFee:d,serviceFeeRate:De,buyerTotal:o,sellerPayout:I}},lt=({rating:t,reviewCount:a,size:d="sm"})=>{if(!t&&!a)return null;const I={sm:{star:12,text:"text-xs"},md:{star:14,text:"text-sm"},lg:{star:16,text:"text-base"}}[d];return e.jsxs("div",{className:`flex items-center gap-1 ${I.text}`,children:[e.jsx(ht,{size:I.star,className:"text-yellow-500 fill-yellow-500"}),e.jsx("span",{className:"font-bold text-yellow-600 dark:text-yellow-400",children:(t==null?void 0:t.toFixed(1))||"â€”"}),a>0&&e.jsxs("span",{className:"text-gray-400",children:["(",a," sale",a!==1?"s":"",")"]})]})},Tt=({status:t})=>{const a={pending:{label:"Pending",color:"bg-yellow-100 text-yellow-700 dark:bg-yellow-900/30 dark:text-yellow-400"},accepted:{label:"Accepted",color:"bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400"},declined:{label:"Declined",color:"bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-400"},countered:{label:"Countered",color:"bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-400"},expired:{label:"Expired",color:"bg-gray-100 text-gray-500 dark:bg-gray-800 dark:text-gray-400"}},d=a[t]||a.pending;return e.jsx("span",{className:`px-2 py-0.5 rounded-full text-xs font-bold ${d.color}`,children:d.label})},it=t=>t>=me;function Lt({user:t,userData:a,setActiveTab:d,openChat:o}){const[I,w]=l.useState("browse"),[s,C]=l.useState([]),[N,j]=l.useState("All"),[_,v]=l.useState(""),[b,$]=l.useState(null),[S,F]=l.useState(null),[B,G]=l.useState([]),[y,M]=l.useState([]),[p,n]=l.useState(null);l.useEffect(()=>{if(!g)return;const r=g.channel("gear-listings").on("postgres_changes",{event:"*",schema:"public",table:"gear_listings"},()=>{A()}).subscribe();return A(),()=>{g.removeChannel(r)}},[t==null?void 0:t.id,t==null?void 0:t.uid]);const A=async()=>{if(g)try{const{data:r,error:h}=await g.from("gear_listings").select("*").order("timestamp",{ascending:!1});if(h)throw h;C((r||[]).map(x=>({id:x.id,...x,sellerId:x.seller_id,sellerName:x.seller_name,sellerPhoto:x.seller_photo,sellerRating:x.seller_rating,sellerSalesCount:x.seller_sales_count,sellerVerified:x.seller_verified,sellerResponseTime:x.seller_response_time,minimumOffer:x.minimum_offer,conditionReport:x.condition_report,timestamp:x.timestamp})))}catch(r){console.error("Error loading listings:",r)}};l.useEffect(()=>{if(!(t!=null&&t.id)&&!(t!=null&&t.uid)||!g)return;const r=(t==null?void 0:t.id)||(t==null?void 0:t.uid),h=g.channel("safe-exchange-transactions").on("postgres_changes",{event:"*",schema:"public",table:"safe_exchange_transactions",filter:`buyer_id=eq.${r}`},()=>{c()}).on("postgres_changes",{event:"*",schema:"public",table:"safe_exchange_transactions",filter:`seller_id=eq.${r}`},()=>{c()}).subscribe();return c(),()=>{g.removeChannel(h)}},[t==null?void 0:t.id,t==null?void 0:t.uid]);const c=async()=>{if(!g)return;const r=(t==null?void 0:t.id)||(t==null?void 0:t.uid);try{const{data:h,error:x}=await g.from("safe_exchange_transactions").select("*").eq("buyer_id",r),{data:T,error:u}=await g.from("safe_exchange_transactions").select("*").eq("seller_id",r);if(x||u)throw x||u;const D=[...(h||[]).map(i=>({id:i.id,...i,buyerId:i.buyer_id,sellerId:i.seller_id,listingId:i.listing_id,role:"buyer"})),...(T||[]).map(i=>({id:i.id,...i,buyerId:i.buyer_id,sellerId:i.seller_id,listingId:i.listing_id,role:"seller"}))];G(D)}catch(h){console.error("Error loading transactions:",h)}};l.useEffect(()=>{if(!(t!=null&&t.id)&&!(t!=null&&t.uid)||!g)return;const r=(t==null?void 0:t.id)||(t==null?void 0:t.uid),h=g.channel("gear-orders").on("postgres_changes",{event:"*",schema:"public",table:"gear_orders",filter:`buyer_id=eq.${r}`},()=>{L()}).on("postgres_changes",{event:"*",schema:"public",table:"gear_orders",filter:`seller_id=eq.${r}`},()=>{L()}).subscribe();return L(),()=>{g.removeChannel(h)}},[t==null?void 0:t.id,t==null?void 0:t.uid]);const L=async()=>{if(!g)return;const r=(t==null?void 0:t.id)||(t==null?void 0:t.uid);try{const{data:h,error:x}=await g.from("gear_orders").select("*").eq("buyer_id",r),{data:T,error:u}=await g.from("gear_orders").select("*").eq("seller_id",r);if(x||u)throw x||u;const D=[...(h||[]).map(i=>({id:i.id,...i,buyerId:i.buyer_id,sellerId:i.seller_id,listingId:i.listing_id,itemTitle:i.item_title,itemBrand:i.item_brand,itemDescription:i.item_description,itemPhotos:i.item_photos,itemCondition:i.item_condition,itemPrice:i.item_price,serviceFee:i.service_fee,serviceFeeRate:i.service_fee_rate,buyerTotal:i.buyer_total,sellerPayout:i.seller_payout,buyerName:i.buyer_name,buyerPhoto:i.buyer_photo,sellerName:i.seller_name,sellerPhoto:i.seller_photo,fulfillmentMethod:i.fulfillment_method,shippingAddress:i.shipping_address,shippingPhone:i.shipping_phone,shippingNotes:i.shipping_notes,statusHistory:i.status_history,createdAt:i.created_at,updatedAt:i.updated_at,role:"buyer"})),...(T||[]).map(i=>({id:i.id,...i,buyerId:i.buyer_id,sellerId:i.seller_id,listingId:i.listing_id,itemTitle:i.item_title,itemBrand:i.item_brand,itemDescription:i.item_description,itemPhotos:i.item_photos,itemCondition:i.item_condition,itemPrice:i.item_price,serviceFee:i.service_fee,serviceFeeRate:i.service_fee_rate,buyerTotal:i.buyer_total,sellerPayout:i.seller_payout,buyerName:i.buyer_name,buyerPhoto:i.buyer_photo,sellerName:i.seller_name,sellerPhoto:i.seller_photo,fulfillmentMethod:i.fulfillment_method,shippingAddress:i.shipping_address,shippingPhone:i.shipping_phone,shippingNotes:i.shipping_notes,statusHistory:i.status_history,createdAt:i.created_at,updatedAt:i.updated_at,role:"seller"}))].sort((i,W)=>{const R=i.createdAt?new Date(i.createdAt).getTime():0;return(W.createdAt?new Date(W.createdAt).getTime():0)-R});M(D)}catch(h){console.error("Error loading orders:",h)}},O=async r=>{if(!g)return;const h=Ne(r.price),x=(t==null?void 0:t.id)||(t==null?void 0:t.uid),T=new Date().toISOString();try{const u={[f.INTENT_CREATED]:{timestamp:Date.now(),userId:x}},{data:D,error:i}=await g.from("safe_exchange_transactions").insert({listing_id:r.id,item_title:r.title,item_brand:r.brand,item_description:r.description||null,item_photos:r.images||[],item_condition:r.condition,price:r.price,item_price:h.itemPrice,service_fee:h.serviceFee,service_fee_rate:h.serviceFeeRate,buyer_total:h.buyerTotal,seller_payout:h.sellerPayout,seller_id:r.sellerId,seller_name:r.sellerName,seller_photo:r.sellerPhoto,buyer_id:x,buyer_name:a&&`${a.firstName||""} ${a.lastName||""}`.trim()||"Buyer",buyer_photo:a.photoURL||null,status:f.INTENT_CREATED,status_history:u,escrow_amount:h.buyerTotal,escrow_status:"pending",seller_approved:!1,buyer_approved:!1,created_at:T,updated_at:T}).select().single();if(i)throw i;u[f.HOLD_PLACED]={timestamp:Date.now(),userId:x},await g.from("safe_exchange_transactions").update({status:f.HOLD_PLACED,status_history:u,escrow_status:"held",updated_at:new Date().toISOString()}).eq("id",D.id),u[f.SELLER_NOTIFIED]={timestamp:Date.now(),userId:x},await g.from("safe_exchange_transactions").update({status:f.SELLER_NOTIFIED,status_history:u,updated_at:new Date().toISOString()}).eq("id",D.id),await g.from("notifications").insert({user_id:r.sellerId,type:"safe_exchange_intent",transaction_id:D.id,message:`${(a==null?void 0:a.firstName)||"A user"} wants to purchase your ${r.title} - You'll receive $${h.sellerPayout.toFixed(2)}`,buyer_name:a&&`${a.firstName||""} ${a.lastName||""}`.trim()||"Buyer",item_title:r.title,price:r.price,seller_payout:h.sellerPayout,service_fee:h.serviceFee,read:!1,created_at:new Date().toISOString()}),F(D.id),$(null)}catch(u){console.error("Failed to create safe exchange:",u),alert("Failed to initiate purchase. Please try again.")}},z=async(r,h)=>{if(!g)return;const x=K.loading("Processing your order..."),T=Ne(r.price),u=(t==null?void 0:t.id)||(t==null?void 0:t.uid),D=new Date().toISOString();try{const{data:i,error:W}=await g.from("gear_orders").insert({listing_id:r.id,item_title:r.title,item_brand:r.brand,item_description:r.description||null,item_photos:r.images||[],item_condition:r.condition,price:r.price,item_price:T.itemPrice,service_fee:T.serviceFee,service_fee_rate:T.serviceFeeRate,buyer_total:T.buyerTotal,seller_payout:T.sellerPayout,seller_id:r.sellerId,seller_name:r.sellerName,seller_photo:r.sellerPhoto,buyer_id:u,buyer_name:a&&`${a.firstName||""} ${a.lastName||""}`.trim()||"Buyer",buyer_photo:a.photoURL||null,fulfillment_method:h.method,shipping_address:h.method==="shipping"?h.address:null,shipping_phone:h.phone||null,shipping_notes:h.notes||null,tracking_number:null,tracking_carrier:null,status:Y.PENDING,status_history:[{status:Y.PENDING,timestamp:Date.now(),note:"Order placed by buyer"}],payment_status:"pending",payment_intent_id:null,created_at:D,updated_at:D}).select().single();if(W)throw W;return await g.from("notifications").insert({user_id:r.sellerId,type:"gear_order",order_id:i.id,listing_id:r.id,message:`${(a==null?void 0:a.firstName)||"A user"} purchased your ${r.title} - You'll receive $${T.sellerPayout.toFixed(2)}`,buyer_name:a&&`${a.firstName||""} ${a.lastName||""}`.trim()||"Buyer",item_title:r.title,price:r.price,seller_payout:T.sellerPayout,service_fee:T.serviceFee,fulfillment_method:h.method,read:!1,created_at:new Date().toISOString()}),await g.from("gear_listings").update({status:"Pending Sale",pending_order_id:i.id,updated_at:new Date().toISOString()}).eq("id",r.id),K.success("Order placed successfully!",{id:x}),$(null),w("orders"),i.id}catch(i){return console.error("Failed to create order:",i),K.error("Failed to place order. Please try again.",{id:x}),null}},U=async(r,h,x=null)=>{if(!g)return;const T=K.loading("Updating order...");try{const{data:u,error:D}=await g.from("gear_orders").select("*").eq("id",r).single();if(D||!u){K.error("Order not found",{id:T});return}const i=u.status_history||[],W={status:h,status_history:[...i,{status:h,timestamp:Date.now(),note:`Status updated to ${h}`}],updated_at:new Date().toISOString()};x&&(W.tracking_number=x.trackingNumber,W.tracking_carrier=x.carrier),await g.from("gear_orders").update(W).eq("id",r);const R=h===Y.SHIPPED?`Your order "${u.item_title}" has been shipped!`:`Your order "${u.item_title}" status updated to ${h}`;await g.from("notifications").insert({user_id:u.buyer_id,type:"order_update",order_id:r,message:R,item_title:u.item_title,new_status:h,tracking_number:(x==null?void 0:x.trackingNumber)||null,read:!1,created_at:new Date().toISOString()}),h===Y.COMPLETED&&await g.from("gear_listings").update({status:"Sold",updated_at:new Date().toISOString()}).eq("id",u.listing_id),K.success("Order updated!",{id:T})}catch(u){console.error("Failed to update order:",u),K.error("Failed to update order",{id:T})}},P=y.filter(r=>r.status!==Y.COMPLETED&&r.status!==Y.CANCELLED&&r.status!==Y.REFUNDED),Z=s.filter(r=>(N==="All"||r.category===N)&&(r.title.toLowerCase().includes(_.toLowerCase())||r.brand.toLowerCase().includes(_.toLowerCase()))),E=B.filter(r=>r.status!==f.COMPLETED&&r.status!==f.CANCELLED);return e.jsxs("div",{className:"max-w-7xl mx-auto pb-24 animate-in fade-in",children:[S&&e.jsx(It,{transactionId:S,user:t,userData:a,onClose:()=>F(null),onComplete:()=>{F(null)},onMessage:r=>{o==null||o(r)}}),I==="browse"&&e.jsxs(e.Fragment,{children:[E.length>0&&e.jsxs("div",{className:"mb-6 bg-gradient-to-r from-orange-50 to-red-50 dark:from-orange-900/20 dark:to-red-900/20 p-4 rounded-xl border border-orange-200 dark:border-orange-800",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-3",children:[e.jsx(se,{className:"text-orange-600",size:24}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-bold text-orange-800 dark:text-orange-300",children:"Active Safe Exchanges"}),e.jsxs("p",{className:"text-sm text-orange-600 dark:text-orange-400",children:["You have ",E.length," pending transaction",E.length>1?"s":""]})]})]}),e.jsx("div",{className:"space-y-2",children:E.map(r=>e.jsxs("button",{onClick:()=>F(r.id),className:"w-full flex items-center justify-between p-3 bg-white dark:bg-gray-800 rounded-lg hover:shadow-md transition",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:`p-2 rounded-full ${r.role==="buyer"?"bg-blue-100 text-blue-600":"bg-green-100 text-green-600"}`,children:r.role==="buyer"?e.jsx(Ge,{size:16}):e.jsx(ke,{size:16})}),e.jsxs("div",{className:"text-left",children:[e.jsx("div",{className:"font-bold text-sm dark:text-white",children:r.itemTitle}),e.jsxs("div",{className:"text-xs text-gray-500",children:[r.role==="buyer"?"Buying":"Selling"," â€¢ $",r.price]})]})]}),e.jsx("span",{className:"text-xs bg-orange-100 text-orange-700 px-2 py-1 rounded-full font-bold",children:r.status.replace(/_/g," ")})]},r.id))})]}),e.jsxs("div",{className:"flex flex-col md:flex-row justify-between items-end gap-4 mb-6",children:[e.jsxs("div",{children:[e.jsxs("h2",{className:"text-2xl font-bold dark:text-white flex items-center gap-2",children:[e.jsx(Ve,{className:"text-orange-500"})," Gear Exchange"]}),e.jsx("p",{className:"text-gray-500 dark:text-gray-400 mt-1",children:"Buy and sell verified studio equipment."})]}),e.jsxs("div",{className:"flex gap-2 w-full md:w-auto",children:[e.jsxs("div",{className:"relative flex-1 md:w-64",children:[e.jsx(Ze,{className:"absolute left-3 top-2.5 text-gray-400",size:16}),e.jsx("input",{className:"w-full pl-9 pr-4 py-2 rounded-xl border border-gray-200 dark:border-gray-700 bg-white dark:bg-[#2c2e36] text-sm dark:text-white focus:outline-none focus:ring-2 focus:ring-orange-500",placeholder:"Search gear...",value:_,onChange:r=>v(r.target.value)})]}),e.jsxs("button",{onClick:()=>w("orders"),className:"relative bg-white dark:bg-[#2c2e36] border border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-800 text-gray-700 dark:text-gray-300 px-4 py-2 rounded-xl font-bold text-sm flex items-center gap-2 transition",children:[e.jsx(We,{size:16})," Orders",P.length>0&&e.jsx("span",{className:"absolute -top-1 -right-1 bg-orange-500 text-white text-[10px] font-bold w-5 h-5 rounded-full flex items-center justify-center",children:P.length})]}),e.jsxs("button",{onClick:()=>w("create"),className:"bg-orange-600 hover:bg-orange-700 text-white px-4 py-2 rounded-xl font-bold text-sm flex items-center gap-2 shadow-lg transition",children:[e.jsx(Ue,{size:16})," Sell Gear"]})]})]}),e.jsxs("div",{className:"flex gap-2 overflow-x-auto pb-4 scrollbar-hide mb-2",children:[e.jsx("button",{onClick:()=>j("All"),className:`px-4 py-2 rounded-lg text-xs font-bold whitespace-nowrap transition ${N==="All"?"bg-white dark:bg-white text-black shadow":"bg-gray-100 dark:bg-gray-800 text-gray-500"}`,children:"All Gear"}),je.map(r=>e.jsx("button",{onClick:()=>j(r.id),className:`px-4 py-2 rounded-lg text-xs font-bold whitespace-nowrap transition ${N===r.id?"bg-white dark:bg-white text-black shadow":"bg-gray-100 dark:bg-gray-800 text-gray-500"}`,children:r.label},r.id))]}),e.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6",children:Z.map(r=>{var x;const h=it(r.price);return e.jsxs("div",{onClick:()=>$(r),className:"bg-white dark:bg-[#2c2e36] rounded-xl border dark:border-gray-700 overflow-hidden hover:shadow-xl transition cursor-pointer group flex flex-col",children:[e.jsxs("div",{className:"aspect-square bg-gray-100 dark:bg-black/40 relative flex items-center justify-center overflow-hidden",children:[(x=r.images)!=null&&x[0]?e.jsx("img",{src:r.images[0],className:"w-full h-full object-cover group-hover:scale-105 transition duration-500"}):e.jsx(re,{size:32,className:"text-gray-400"}),e.jsxs("div",{className:"absolute top-2 right-2 bg-black/60 text-white text-xs font-bold px-2 py-1 rounded backdrop-blur-md",children:["$",r.price]}),h&&e.jsxs("div",{className:"absolute top-2 left-2 bg-orange-500/90 text-white text-[10px] font-bold px-2 py-0.5 rounded flex items-center gap-1",children:[e.jsx(se,{size:10})," Safe Exchange"]}),r.conditionReport&&e.jsxs("div",{className:"absolute bottom-2 left-2 bg-green-500/90 text-white text-[10px] font-bold px-2 py-0.5 rounded flex items-center gap-1",children:[e.jsx(V,{size:10})," Inspected"]}),r.acceptsOffers&&e.jsxs("div",{className:"absolute bottom-2 right-2 bg-blue-500/90 text-white text-[10px] font-bold px-2 py-0.5 rounded flex items-center gap-1",children:[e.jsx(le,{size:10})," Offers"]})]}),e.jsxs("div",{className:"p-4 flex-1 flex flex-col",children:[e.jsx("div",{className:"text-[10px] font-bold text-gray-400 uppercase mb-1",children:r.brand}),e.jsx("h4",{className:"font-bold dark:text-white text-sm mb-1 line-clamp-1",children:r.title}),e.jsxs("div",{className:"text-xs text-gray-500 mb-2",children:[r.condition," Condition"]}),r.sellerRating&&e.jsx("div",{className:"mb-2",children:e.jsx(lt,{rating:r.sellerRating,reviewCount:r.sellerSalesCount,size:"sm"})}),e.jsxs("div",{className:"mt-auto pt-3 border-t dark:border-gray-700 flex justify-between items-center text-xs text-gray-400",children:[e.jsx("span",{className:"flex items-center gap-1",children:h?e.jsxs(e.Fragment,{children:[e.jsx(oe,{size:10})," Local Pickup"]}):e.jsxs(e.Fragment,{children:[e.jsx(ie,{size:10})," ",r.location||"Ships"]})}),r.sellerVerified&&e.jsx(Xe,{size:14,className:"text-blue-500"})]})]})]},r.id)})})]}),I==="create"&&e.jsx(At,{user:t,userData:a,onCancel:()=>w("browse"),onSuccess:()=>w("browse")}),I==="orders"&&e.jsx(Ft,{orders:y,user:t,userData:a,onBack:()=>w("browse"),onUpdateStatus:U,openChat:o}),b&&e.jsx(zt,{item:b,onClose:()=>$(null),currentUser:t,currentUserData:a,onSafeExchangePurchase:O,onStandardPurchase:z})]})}function At({user:t,userData:a,onCancel:d,onSuccess:o}){const[I,w]=l.useState(1),[s,C]=l.useState({title:"",brand:"",category:je[0].id,condition:"Good",price:"",description:"",location:a.city||"",weight:"",length:"",width:"",height:"",acceptsOffers:!0,minimumOffer:""}),[N,j]=l.useState([]),[_,v]=l.useState(null),[b,$]=l.useState(!1),{uploadMedia:S,uploading:F}=pe(),B=async y=>{const M=y.target.files[0];if(!M)return;const p=await S(M,`gear/${t.uid}`);p!=null&&p.url&&j([...N,p.url])},G=async()=>{if(!s.title||!s.price||!g){(!s.title||!s.price)&&alert("Title and Price required.");return}$(!0);const y=(t==null?void 0:t.id)||(t==null?void 0:t.uid);try{await g.from("gear_listings").insert({title:s.title,brand:s.brand,category:s.category,condition:s.condition,price:parseInt(s.price),description:s.description||null,location:s.location||null,weight:s.weight||null,length:s.length||null,width:s.width||null,height:s.height||null,accepts_offers:s.acceptsOffers||!1,minimum_offer:s.minimumOffer?parseInt(s.minimumOffer):null,images:N||[],condition_report:_,seller_id:y,seller_name:a&&`${a.firstName||""} ${a.lastName||""}`.trim()||"Seller",seller_photo:(a==null?void 0:a.photoURL)||null,seller_rating:(a==null?void 0:a.sellerRating)||null,seller_sales_count:(a==null?void 0:a.sellerSalesCount)||0,seller_verified:(a==null?void 0:a.verified)||!1,seller_response_time:(a==null?void 0:a.avgResponseTime)||null,timestamp:new Date().toISOString(),status:"Active"}),K.success("Listing posted!"),o()}catch(M){console.error(M),K.error("Failed to post listing.")}$(!1)};return I==="inspection"?e.jsx("div",{className:"h-[600px]",children:e.jsx(Ct,{type:"Pre",onSave:y=>{v(y),w(1)},onCancel:()=>w(1)})}):e.jsxs("div",{className:"max-w-2xl mx-auto bg-white dark:bg-[#2c2e36] p-8 rounded-2xl border dark:border-gray-700 shadow-xl",children:[e.jsxs("div",{className:"flex justify-between items-center mb-6",children:[e.jsx("h3",{className:"text-xl font-bold dark:text-white",children:"List Gear for Sale"}),e.jsx("button",{onClick:d,children:e.jsx(Q,{className:"text-gray-400"})})]}),e.jsxs("div",{className:"space-y-5",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-bold text-gray-500 uppercase mb-1 block",children:"Brand"}),e.jsx("input",{className:"w-full p-2.5 border rounded-lg dark:bg-black/20 dark:border-gray-600 dark:text-white",value:s.brand,onChange:y=>C({...s,brand:y.target.value}),placeholder:"e.g. Fender"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-bold text-gray-500 uppercase mb-1 block",children:"Model / Title"}),e.jsx("input",{className:"w-full p-2.5 border rounded-lg dark:bg-black/20 dark:border-gray-600 dark:text-white",value:s.title,onChange:y=>C({...s,title:y.target.value}),placeholder:"e.g. Stratocaster"})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-bold text-gray-500 uppercase mb-1 block",children:"Category"}),e.jsx("select",{className:"w-full p-2.5 border rounded-lg dark:bg-black/20 dark:border-gray-600 dark:text-white text-sm",value:s.category,onChange:y=>C({...s,category:y.target.value}),children:je.map(y=>e.jsx("option",{value:y.id,children:y.label},y.id))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-bold text-gray-500 uppercase mb-1 block",children:"Condition"}),e.jsx("select",{className:"w-full p-2.5 border rounded-lg dark:bg-black/20 dark:border-gray-600 dark:text-white text-sm",value:s.condition,onChange:y=>C({...s,condition:y.target.value}),children:Ot.map(y=>e.jsx("option",{value:y,children:y},y))})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-bold text-gray-500 uppercase mb-1 block",children:"Price ($)"}),e.jsx("input",{type:"number",className:"w-full p-2.5 border rounded-lg dark:bg-black/20 dark:border-gray-600 dark:text-white font-bold",value:s.price,onChange:y=>C({...s,price:y.target.value})}),s.price&&parseInt(s.price)>=me&&e.jsx("div",{className:"mt-3 bg-gradient-to-r from-orange-50 to-red-50 dark:from-orange-900/20 dark:to-red-900/20 p-4 rounded-lg border border-orange-200 dark:border-orange-800",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(se,{className:"text-orange-500 shrink-0 mt-0.5",size:20}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-bold text-orange-800 dark:text-orange-300 text-sm",children:"Safe Exchange Required"}),e.jsxs("p",{className:"text-xs text-orange-700 dark:text-orange-400 mt-1",children:["Items priced at $",me,"+ require in-person exchange at a verified safe location (police station, bank, etc.). Buyers will initiate a Safe Exchange with payment held in escrow until both parties approve."]}),e.jsxs("ul",{className:"text-xs text-orange-600 dark:text-orange-400 mt-2 space-y-1",children:[e.jsxs("li",{className:"flex items-center gap-1",children:[e.jsx(Ke,{size:10})," No shipping available for high-value items"]}),e.jsxs("li",{className:"flex items-center gap-1",children:[e.jsx(re,{size:10})," You must upload pre-departure photos"]}),e.jsxs("li",{className:"flex items-center gap-1",children:[e.jsx(oe,{size:10})," GPS verification at exchange location"]})]})]})]})})]}),e.jsxs("div",{className:"bg-blue-50 dark:bg-blue-900/10 p-4 rounded-xl border border-blue-100 dark:border-blue-800",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs("h4",{className:"font-bold text-blue-800 dark:text-blue-400 text-sm flex items-center gap-2",children:[e.jsx(le,{size:16}),"Accept Offers"]}),e.jsx("p",{className:"text-xs text-blue-600 dark:text-blue-300 mt-1",children:"Allow buyers to negotiate on price"})]}),e.jsx("button",{type:"button",onClick:()=>C({...s,acceptsOffers:!s.acceptsOffers}),className:"p-1",children:s.acceptsOffers?e.jsx(bt,{size:32,className:"text-blue-600"}):e.jsx(mt,{size:32,className:"text-gray-400"})})]}),s.acceptsOffers&&s.price&&e.jsxs("div",{className:"mt-3 pt-3 border-t border-blue-200 dark:border-blue-800",children:[e.jsx("label",{className:"text-xs font-bold text-gray-500 uppercase mb-1 block",children:"Minimum Acceptable Offer (Optional)"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"number",placeholder:`e.g., ${Math.round(parseInt(s.price)*.8)}`,value:s.minimumOffer,onChange:y=>C({...s,minimumOffer:y.target.value}),className:"flex-1 p-2 border rounded-lg dark:bg-black/20 dark:border-gray-600 dark:text-white text-sm"}),e.jsx("span",{className:"text-sm text-gray-500",children:s.minimumOffer&&s.price?`(${Math.round(parseInt(s.minimumOffer)/parseInt(s.price)*100)}%)`:""})]}),e.jsx("p",{className:"text-[10px] text-gray-500 mt-1",children:'Offers below this will be flagged as "Low Offer" to buyers'})]})]}),e.jsxs("div",{className:"grid grid-cols-4 gap-2",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-bold text-gray-500 uppercase mb-1 block",children:"Weight (lb)"}),e.jsx("input",{type:"number",className:"w-full p-2.5 border rounded-lg dark:bg-black/20 dark:border-gray-600 dark:text-white text-sm",placeholder:"lbs",value:s.weight,onChange:y=>C({...s,weight:y.target.value})})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-bold text-gray-500 uppercase mb-1 block",children:"L (in)"}),e.jsx("input",{type:"number",className:"w-full p-2.5 border rounded-lg dark:bg-black/20 dark:border-gray-600 dark:text-white text-sm",placeholder:"Len",value:s.length,onChange:y=>C({...s,length:y.target.value})})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-bold text-gray-500 uppercase mb-1 block",children:"W (in)"}),e.jsx("input",{type:"number",className:"w-full p-2.5 border rounded-lg dark:bg-black/20 dark:border-gray-600 dark:text-white text-sm",placeholder:"Wid",value:s.width,onChange:y=>C({...s,width:y.target.value})})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-bold text-gray-500 uppercase mb-1 block",children:"H (in)"}),e.jsx("input",{type:"number",className:"w-full p-2.5 border rounded-lg dark:bg-black/20 dark:border-gray-600 dark:text-white text-sm",placeholder:"Hgt",value:s.height,onChange:y=>C({...s,height:y.target.value})})]})]}),e.jsxs("div",{className:"bg-orange-50 dark:bg-orange-900/10 p-4 rounded-xl border border-orange-100 dark:border-orange-800 flex justify-between items-center",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-bold text-orange-800 dark:text-orange-400 text-sm mb-1",children:"Tech Inspection Report"}),e.jsx("div",{className:"text-xs text-orange-600 dark:text-orange-300",children:_?e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(V,{size:12})," Report Attached (",_.markers.length," points)"]}):"Mark scratches, dents, or issues on a diagram to build trust."})]}),e.jsx("button",{onClick:()=>w("inspection"),className:`text-xs font-bold px-3 py-2 rounded-lg border transition ${_?"bg-white text-green-600 border-green-200":"bg-orange-100 text-orange-700 border-orange-200 hover:bg-orange-200"}`,children:_?"Edit Report":"Create Report"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-bold text-gray-500 uppercase mb-2 block",children:"Photos"}),e.jsxs("div",{className:"flex gap-2",children:[N.map((y,M)=>e.jsx("img",{src:y,className:"w-16 h-16 rounded-lg object-cover border dark:border-gray-600"},M)),e.jsxs("label",{className:"w-16 h-16 rounded-lg border-2 border-dashed border-gray-300 dark:border-gray-600 flex items-center justify-center cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-800",children:[F?e.jsx(ne,{className:"animate-spin text-gray-400"}):e.jsx(Ue,{className:"text-gray-400"}),e.jsx("input",{type:"file",className:"hidden",onChange:B,disabled:F})]})]})]}),e.jsxs("div",{className:"flex gap-3 pt-4",children:[e.jsx("button",{onClick:d,className:"flex-1 py-3 text-gray-500 font-bold hover:bg-gray-100 dark:hover:bg-gray-700 rounded-xl transition",children:"Cancel"}),e.jsx("button",{onClick:G,disabled:b||F,className:"flex-1 bg-orange-600 text-white py-3 rounded-xl font-bold hover:bg-orange-700 transition shadow-lg flex items-center justify-center gap-2",children:b?e.jsx(ne,{className:"animate-spin"}):"Post Listing"})]})]})]})}function zt({item:t,onClose:a,currentUser:d,currentUserData:o,onSafeExchangePurchase:I,onStandardPurchase:w}){var D,i,W,R;const[s,C]=l.useState(!1),[N,j]=l.useState(!1),[_,v]=l.useState(!1),[b,$]=l.useState(!1),[S,F]=l.useState(""),[B,G]=l.useState(""),[y,M]=l.useState(!1),[p,n]=l.useState([]),[A,c]=l.useState(!0),[L,O]=l.useState(1),[z,U]=l.useState("shipping"),[P,Z]=l.useState({street:((D=o==null?void 0:o.address)==null?void 0:D.street)||"",city:(o==null?void 0:o.city)||"",state:(o==null?void 0:o.state)||"",zip:(o==null?void 0:o.zip)||"",phone:(o==null?void 0:o.phone)||"",notes:""}),E=it(t.price);l.useEffect(()=>{if(!t.id||!(d!=null&&d.uid)){c(!1);return}if(!g)return;d!=null&&d.id||(d==null||d.uid);const m=g.channel(`gear-offers-${t.id}`).on("postgres_changes",{event:"*",schema:"public",table:"gear_offers",filter:`listing_id=eq.${t.id}`},()=>{q()}).subscribe();return q(),()=>{g.removeChannel(m)};async function q(){if(!g)return;const ee=(d==null?void 0:d.id)||(d==null?void 0:d.uid);c(!0);try{const{data:J,error:te}=await g.from("gear_offers").select("*").eq("listing_id",t.id).eq("buyer_id",ee).order("created_at",{ascending:!1});if(te)throw te;const ce=(J||[]).map(X=>({id:X.id,...X,listingId:X.listing_id,buyerId:X.buyer_id,sellerId:X.seller_id,itemTitle:X.item_title,itemBrand:X.item_brand,askingPrice:X.asking_price,offerAmount:X.offer_amount,buyerName:X.buyer_name,buyerPhoto:X.buyer_photo,sellerName:X.seller_name,createdAt:X.created_at?new Date(X.created_at):new Date,expiresAt:X.expires_at}));n(ce)}catch(J){console.error("Error fetching offers:",J)}c(!1)}},[t.id,d==null?void 0:d.uid]);const r=async()=>{E?(j(!0),await I(t),j(!1)):($(!0),O(1))},h=async()=>{j(!0);const m={method:z,address:z==="shipping"?{street:P.street,city:P.city,state:P.state,zip:P.zip}:null,phone:P.phone,notes:P.notes};await w(t,m)&&($(!1),a()),j(!1)},x=()=>z==="shipping"?P.street&&P.city&&P.state&&P.zip:!0,T=async()=>{if(!S||parseFloat(S)<=0){K.error("Please enter a valid offer amount");return}const m=parseFloat(S);if(m>=t.price){K.error("Offer must be less than the asking price");return}M(!0);const q=K.loading("Submitting offer...");if(!g)return;const ee=(d==null?void 0:d.id)||(d==null?void 0:d.uid);try{const{data:J,error:te}=await g.from("gear_offers").insert({listing_id:t.id,item_title:t.title,item_brand:t.brand,asking_price:t.price,offer_amount:m,message:B||null,buyer_id:ee,buyer_name:`${o.firstName} ${o.lastName}`,buyer_photo:o.photoURL||null,seller_id:t.sellerId,seller_name:t.sellerName,status:"pending",created_at:new Date().toISOString(),expires_at:new Date(Date.now()+1728e5).toISOString()}).select().single();if(te)throw te;await g.from("notifications").insert({user_id:t.sellerId,type:"gear_offer",offer_id:J.id,listing_id:t.id,message:`${o.firstName} made an offer of $${m} on your ${t.title}`,buyer_name:`${o.firstName} ${o.lastName}`,item_title:t.title,offer_amount:m,asking_price:t.price,read:!1,created_at:new Date().toISOString()}),K.success("Offer submitted!",{id:q}),v(!1),F(""),G("")}catch(J){console.error("Failed to submit offer:",J),K.error("Failed to submit offer",{id:q})}M(!1)},u=m=>Math.round(m/t.price*100);return e.jsx("div",{className:"fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-[70] p-4",children:e.jsxs("div",{className:"bg-white dark:bg-[#2c2e36] w-full max-w-4xl h-[90vh] rounded-2xl shadow-2xl flex flex-col md:flex-row overflow-hidden border dark:border-gray-700",children:[e.jsxs("div",{className:"md:w-1/2 bg-black relative flex flex-col",children:[e.jsxs("div",{className:"flex-1 flex items-center justify-center p-4 relative",children:[s&&t.conditionReport?e.jsxs("div",{className:"w-full h-full bg-white rounded-xl overflow-hidden",children:[e.jsx(rt,{type:t.conditionReport.gearType,view:"front",markers:t.conditionReport.markers,onClick:()=>{}}),e.jsx("div",{className:"absolute bottom-4 left-1/2 -translate-x-1/2 bg-black/80 text-white px-3 py-1 rounded-full text-xs",children:"Inspection View"})]}):(i=t.images)!=null&&i[0]?e.jsx("img",{src:t.images[0],className:"max-h-full max-w-full object-contain"}):e.jsx(re,{size:48,className:"text-gray-600"}),e.jsx("button",{onClick:a,className:"absolute top-4 left-4 p-2 bg-black/50 text-white rounded-full hover:bg-black/70",children:e.jsx(Q,{size:20})}),E&&e.jsxs("div",{className:"absolute top-4 right-4 bg-orange-500 text-white px-3 py-1.5 rounded-lg text-xs font-bold flex items-center gap-1.5 shadow-lg",children:[e.jsx(se,{size:14})," Safe Exchange Required"]})]}),t.conditionReport&&e.jsxs("div",{className:"p-4 bg-[#1f2128] border-t border-gray-800 flex gap-2 justify-center",children:[e.jsx("button",{onClick:()=>C(!1),className:`px-4 py-2 rounded text-xs font-bold ${s?"bg-gray-800 text-gray-400":"bg-orange-600 text-white"}`,children:"Photos"}),e.jsxs("button",{onClick:()=>C(!0),className:`px-4 py-2 rounded text-xs font-bold flex items-center gap-1 ${s?"bg-orange-600 text-white":"bg-gray-800 text-gray-400"}`,children:[e.jsx(Ye,{size:12})," Condition Map"]})]})]}),e.jsxs("div",{className:"md:w-1/2 p-8 overflow-y-auto bg-white dark:bg-[#2c2e36]",children:[e.jsxs("div",{className:"mb-6",children:[e.jsx("div",{className:"text-sm font-bold text-gray-400 uppercase tracking-wider mb-1",children:t.brand}),e.jsx("h2",{className:"text-3xl font-extrabold dark:text-white mb-2",children:t.title}),e.jsxs("div",{className:"flex items-center gap-3 flex-wrap",children:[e.jsxs("span",{className:"text-xl font-bold text-green-600",children:["$",t.price]}),e.jsx("span",{className:"bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300 px-2 py-1 rounded text-xs font-bold",children:t.condition}),t.acceptsOffers&&e.jsxs("span",{className:"bg-blue-100 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 px-2 py-1 rounded text-xs font-bold flex items-center gap-1",children:[e.jsx(le,{size:12})," Open to Offers"]})]})]}),e.jsxs("div",{className:"space-y-6",children:[E&&e.jsx("div",{className:"bg-gradient-to-r from-orange-50 to-red-50 dark:from-orange-900/20 dark:to-red-900/20 p-4 rounded-xl border border-orange-200 dark:border-orange-800",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"p-2 bg-orange-500 rounded-lg",children:e.jsx(se,{className:"text-white",size:20})}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-bold text-orange-800 dark:text-orange-300 mb-1",children:"Safe Exchange Protection"}),e.jsxs("p",{className:"text-sm text-orange-700 dark:text-orange-400 mb-3",children:["High-value items ($",me,"+) require in-person exchange at a verified safe location."]}),e.jsxs("ul",{className:"text-xs text-orange-600 dark:text-orange-400 space-y-1",children:[e.jsxs("li",{className:"flex items-center gap-1",children:[e.jsx(ye,{size:12})," Payment held in escrow until exchange"]}),e.jsxs("li",{className:"flex items-center gap-1",children:[e.jsx(oe,{size:12})," Meet at police station or safe zone"]}),e.jsxs("li",{className:"flex items-center gap-1",children:[e.jsx(re,{size:12})," Photo verification required"]}),e.jsxs("li",{className:"flex items-center gap-1",children:[e.jsx(V,{size:12})," Both parties must approve"]})]})]})]})}),e.jsx("div",{className:"p-4 bg-gray-50 dark:bg-gray-800 rounded-xl border dark:border-gray-700",children:e.jsxs("div",{className:"flex items-center gap-3",children:[t.sellerPhoto?e.jsx("img",{src:t.sellerPhoto,className:"w-12 h-12 rounded-full bg-gray-300 object-cover"}):e.jsx("div",{className:"w-12 h-12 rounded-full bg-orange-100 flex items-center justify-center text-orange-600 font-bold text-lg",children:(W=t.sellerName)==null?void 0:W[0]}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"font-bold dark:text-white",children:t.sellerName}),t.sellerVerified&&e.jsx(Xe,{size:16,className:"text-blue-500"})]}),e.jsxs("div",{className:"flex items-center gap-3 mt-1",children:[e.jsx(lt,{rating:t.sellerRating,reviewCount:t.sellerSalesCount,size:"md"}),t.sellerResponseTime&&e.jsxs("span",{className:"text-xs text-gray-500 flex items-center gap-1",children:[e.jsx(xe,{size:12}),"Responds in ",t.sellerResponseTime]})]})]})]})}),p.length>0&&e.jsxs("div",{className:"bg-blue-50 dark:bg-blue-900/20 p-4 rounded-xl border border-blue-200 dark:border-blue-800",children:[e.jsxs("h4",{className:"font-bold text-blue-800 dark:text-blue-300 text-sm mb-3 flex items-center gap-2",children:[e.jsx(le,{size:16}),"Your Offers"]}),e.jsx("div",{className:"space-y-2",children:p.map(m=>e.jsxs("div",{className:"flex items-center justify-between p-3 bg-white dark:bg-gray-800 rounded-lg",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("span",{className:"font-bold dark:text-white",children:["$",m.offerAmount]}),e.jsxs("span",{className:"text-xs text-gray-500",children:["(",u(m.offerAmount),"% of asking)"]})]}),e.jsx("div",{className:"text-xs text-gray-500 mt-0.5",children:m.createdAt.toLocaleDateString()})]}),e.jsx(Tt,{status:m.status})]},m.id))})]}),e.jsxs("div",{className:`p-3 rounded-xl border ${E?"bg-orange-50 dark:bg-orange-900/10 border-orange-200 dark:border-orange-800":"bg-green-50 dark:bg-green-900/10 border-green-200 dark:border-green-800"}`,children:[e.jsx("div",{className:"flex items-center gap-2",children:E?e.jsxs(e.Fragment,{children:[e.jsx(oe,{className:"text-orange-600",size:18}),e.jsx("span",{className:"font-bold text-orange-700 dark:text-orange-400",children:"Local Pickup Only"})]}):e.jsxs(e.Fragment,{children:[e.jsx(ie,{className:"text-green-600",size:18}),e.jsx("span",{className:"font-bold text-green-700 dark:text-green-400",children:"Shipping Available"})]})}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:E?"You will coordinate a meetup at a verified safe exchange zone":t.location||"Contact seller for shipping details"})]}),((R=t.conditionReport)==null?void 0:R.notes)&&e.jsxs("div",{className:"bg-orange-50 dark:bg-orange-900/10 p-4 rounded-xl border border-orange-100 dark:border-orange-800/50",children:[e.jsxs("h4",{className:"font-bold text-orange-800 dark:text-orange-400 text-sm mb-2 flex items-center gap-2",children:[e.jsx(Ve,{size:16})," Tech Notes"]}),e.jsxs("p",{className:"text-sm text-orange-900 dark:text-orange-200 italic",children:['"',t.conditionReport.notes,'"']})]}),e.jsxs("div",{className:"prose dark:prose-invert text-sm text-gray-600 dark:text-gray-300",children:[e.jsx("h4",{className:"font-bold dark:text-white text-sm uppercase",children:"Description"}),e.jsx("p",{children:t.description||"No description provided."})]})]}),_&&e.jsxs("div",{className:"bg-blue-50 dark:bg-blue-900/20 p-4 rounded-xl border border-blue-200 dark:border-blue-800",children:[e.jsxs("h4",{className:"font-bold text-blue-800 dark:text-blue-300 text-sm mb-3 flex items-center gap-2",children:[e.jsx(le,{size:16}),"Make an Offer"]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-bold text-gray-500 uppercase mb-1 block",children:"Your Offer ($)"}),e.jsxs("div",{className:"relative",children:[e.jsx(ke,{className:"absolute left-3 top-1/2 -translate-y-1/2 text-gray-400",size:16}),e.jsx("input",{type:"number",value:S,onChange:m=>F(m.target.value),placeholder:`Asking: $${t.price}`,className:"w-full pl-9 pr-4 py-2.5 border rounded-lg dark:bg-[#1f2128] dark:border-gray-600 dark:text-white"})]}),S&&e.jsxs("div",{className:"text-xs text-gray-500 mt-1",children:[u(parseFloat(S)),"% of asking price",parseFloat(S)<t.price*.7&&e.jsx("span",{className:"text-amber-600 ml-1",children:"(Low offer)"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-bold text-gray-500 uppercase mb-1 block",children:"Message (Optional)"}),e.jsx("textarea",{value:B,onChange:m=>G(m.target.value),placeholder:"Add a message to the seller...",rows:2,className:"w-full p-2.5 border rounded-lg dark:bg-[#1f2128] dark:border-gray-600 dark:text-white text-sm resize-none"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:()=>v(!1),className:"flex-1 py-2 text-gray-600 dark:text-gray-400 font-medium hover:bg-gray-100 dark:hover:bg-gray-800 rounded-lg transition",children:"Cancel"}),e.jsx("button",{onClick:T,disabled:y||!S,className:"flex-1 py-2 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 transition flex items-center justify-center gap-2 disabled:opacity-50",children:y?e.jsx(ne,{className:"animate-spin",size:16}):e.jsxs(e.Fragment,{children:[e.jsx(pt,{size:16})," Submit Offer"]})})]}),e.jsxs("p",{className:"text-[10px] text-gray-500 flex items-center gap-1",children:[e.jsx(xe,{size:10}),"Offers expire after 48 hours if not responded to"]})]})]}),e.jsx(at,{children:b&&e.jsxs(be.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},exit:{opacity:0,y:-20},className:"mt-6 bg-gradient-to-br from-green-50 to-emerald-50 dark:from-green-900/20 dark:to-emerald-900/20 p-5 rounded-xl border border-green-200 dark:border-green-800",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("h4",{className:"font-bold text-green-800 dark:text-green-300 flex items-center gap-2",children:[e.jsx(ze,{size:18}),"Checkout"]}),e.jsx("button",{onClick:()=>$(!1),className:"text-gray-400 hover:text-gray-600",children:e.jsx(Q,{size:18})})]}),e.jsx("div",{className:"flex items-center gap-2 mb-6",children:[1,2,3].map(m=>e.jsxs(He.Fragment,{children:[e.jsx("div",{className:`w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold transition-all ${L>=m?"bg-green-500 text-white":"bg-gray-200 dark:bg-gray-700 text-gray-500"}`,children:L>m?e.jsx(V,{size:16}):m}),m<3&&e.jsx("div",{className:`flex-1 h-1 rounded ${L>m?"bg-green-500":"bg-gray-200 dark:bg-gray-700"}`})]},m))}),L===1&&e.jsxs("div",{className:"space-y-4",children:[e.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-400",children:"How would you like to receive this item?"}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("button",{onClick:()=>U("shipping"),className:`p-4 rounded-xl border-2 transition-all ${z==="shipping"?"border-green-500 bg-green-50 dark:bg-green-900/20":"border-gray-200 dark:border-gray-700 hover:border-gray-300"}`,children:[e.jsx(ie,{size:24,className:z==="shipping"?"text-green-600 mx-auto mb-2":"text-gray-400 mx-auto mb-2"}),e.jsx("div",{className:"font-bold text-sm dark:text-white",children:"Ship to Me"}),e.jsx("div",{className:"text-xs text-gray-500",children:"Delivered to your door"})]}),e.jsxs("button",{onClick:()=>U("pickup"),className:`p-4 rounded-xl border-2 transition-all ${z==="pickup"?"border-green-500 bg-green-50 dark:bg-green-900/20":"border-gray-200 dark:border-gray-700 hover:border-gray-300"}`,children:[e.jsx(Je,{size:24,className:z==="pickup"?"text-green-600 mx-auto mb-2":"text-gray-400 mx-auto mb-2"}),e.jsx("div",{className:"font-bold text-sm dark:text-white",children:"Local Pickup"}),e.jsx("div",{className:"text-xs text-gray-500",children:"Meet the seller"})]})]}),e.jsxs("button",{onClick:()=>O(2),className:"w-full py-3 bg-green-600 text-white font-bold rounded-xl hover:bg-green-700 transition flex items-center justify-center gap-2",children:["Continue ",e.jsx(Fe,{size:16})]})]}),L===2&&e.jsxs("div",{className:"space-y-4",children:[e.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-400",children:z==="shipping"?"Enter your shipping address":"Add your contact details"}),z==="shipping"&&e.jsxs(e.Fragment,{children:[e.jsx("input",{type:"text",placeholder:"Street Address",value:P.street,onChange:m=>Z({...P,street:m.target.value}),className:"w-full p-3 border rounded-lg dark:bg-[#1f2128] dark:border-gray-600 dark:text-white"}),e.jsxs("div",{className:"grid grid-cols-3 gap-2",children:[e.jsx("input",{type:"text",placeholder:"City",value:P.city,onChange:m=>Z({...P,city:m.target.value}),className:"p-3 border rounded-lg dark:bg-[#1f2128] dark:border-gray-600 dark:text-white"}),e.jsx("input",{type:"text",placeholder:"State",value:P.state,onChange:m=>Z({...P,state:m.target.value}),className:"p-3 border rounded-lg dark:bg-[#1f2128] dark:border-gray-600 dark:text-white"}),e.jsx("input",{type:"text",placeholder:"ZIP",value:P.zip,onChange:m=>Z({...P,zip:m.target.value}),className:"p-3 border rounded-lg dark:bg-[#1f2128] dark:border-gray-600 dark:text-white"})]})]}),e.jsx("input",{type:"tel",placeholder:"Phone Number",value:P.phone,onChange:m=>Z({...P,phone:m.target.value}),className:"w-full p-3 border rounded-lg dark:bg-[#1f2128] dark:border-gray-600 dark:text-white"}),e.jsx("textarea",{placeholder:"Notes for seller (optional)",value:P.notes,onChange:m=>Z({...P,notes:m.target.value}),rows:2,className:"w-full p-3 border rounded-lg dark:bg-[#1f2128] dark:border-gray-600 dark:text-white resize-none"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:()=>O(1),className:"flex-1 py-3 border border-gray-300 dark:border-gray-600 text-gray-600 dark:text-gray-400 font-bold rounded-xl hover:bg-gray-50 dark:hover:bg-gray-800 transition",children:"Back"}),e.jsxs("button",{onClick:()=>O(3),disabled:!x(),className:"flex-1 py-3 bg-green-600 text-white font-bold rounded-xl hover:bg-green-700 transition flex items-center justify-center gap-2 disabled:opacity-50",children:["Review Order ",e.jsx(Fe,{size:16})]})]})]}),L===3&&(()=>{var q;const m=Ne(t.price);return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"bg-white dark:bg-gray-800 p-4 rounded-xl border dark:border-gray-700",children:[e.jsx("h5",{className:"font-bold text-sm dark:text-white mb-3",children:"Order Summary"}),e.jsxs("div",{className:"flex items-center gap-3 pb-3 border-b dark:border-gray-700",children:[((q=t.images)==null?void 0:q[0])&&e.jsx("img",{src:t.images[0],className:"w-16 h-16 rounded-lg object-cover"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"font-bold dark:text-white",children:t.title}),e.jsxs("div",{className:"text-xs text-gray-500",children:[t.brand," â€¢ ",t.condition]})]})]}),e.jsxs("div",{className:"pt-3 space-y-2 text-sm",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-500",children:"Item Price"}),e.jsxs("span",{className:"dark:text-white",children:["$",m.itemPrice.toFixed(2)]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsxs("span",{className:"text-gray-500 flex items-center gap-1",children:["Service Fee",e.jsx("span",{className:"text-[10px] text-gray-400",children:"(1% buyer fee)"})]}),e.jsxs("span",{className:"dark:text-white",children:["$",m.serviceFee.toFixed(2)]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-500",children:"Fulfillment"}),e.jsx("span",{className:"dark:text-white capitalize",children:z})]}),z==="shipping"&&e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-500",children:"Ship to"}),e.jsxs("span",{className:"dark:text-white text-right text-xs",children:[P.city,", ",P.state," ",P.zip]})]}),e.jsxs("div",{className:"flex justify-between pt-2 border-t dark:border-gray-700 font-bold",children:[e.jsx("span",{className:"dark:text-white",children:"Total"}),e.jsxs("span",{className:"text-green-600",children:["$",m.buyerTotal.toFixed(2)]})]})]})]}),e.jsxs("div",{className:"bg-blue-50 dark:bg-blue-900/20 p-3 rounded-lg text-xs text-blue-700 dark:text-blue-300 flex items-start gap-2",children:[e.jsx(se,{size:14,className:"shrink-0 mt-0.5"}),e.jsx("span",{children:"Your purchase is protected by SeshNx Buyer Protection. If there's an issue with your order, we've got your back."})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:()=>O(2),className:"flex-1 py-3 border border-gray-300 dark:border-gray-600 text-gray-600 dark:text-gray-400 font-bold rounded-xl hover:bg-gray-50 dark:hover:bg-gray-800 transition",children:"Back"}),e.jsx("button",{onClick:h,disabled:N,className:"flex-1 py-3 bg-gradient-to-r from-green-600 to-emerald-600 text-white font-bold rounded-xl hover:from-green-700 hover:to-emerald-700 transition flex items-center justify-center gap-2 disabled:opacity-50",children:N?e.jsx(ne,{className:"animate-spin",size:18}):e.jsxs(e.Fragment,{children:[e.jsx(Ge,{size:18})," Place Order"]})})]})]})})()]})}),!b&&e.jsxs("div",{className:"mt-8 pt-6 border-t dark:border-gray-700",children:[t.sellerId===d.uid?e.jsx("button",{className:"w-full bg-gray-100 dark:bg-gray-700 text-gray-500 font-bold py-3 rounded-xl cursor-not-allowed",children:"You own this listing"}):e.jsxs("div",{className:"space-y-3",children:[e.jsx("button",{onClick:r,disabled:N,className:`w-full font-bold py-4 rounded-xl shadow-lg flex items-center justify-center gap-2 transition transform hover:scale-[1.02] disabled:opacity-50 disabled:cursor-not-allowed ${E?"bg-gradient-to-r from-orange-600 to-red-600 hover:from-orange-700 hover:to-red-700 text-white":"bg-orange-600 hover:bg-orange-700 text-white"}`,children:N?e.jsx(ne,{className:"animate-spin",size:20}):E?e.jsxs(e.Fragment,{children:[e.jsx(se,{size:20})," Initiate Safe Exchange"]}):e.jsxs(e.Fragment,{children:[e.jsx(ze,{size:20})," Buy Now - $",t.price]})}),!_&&t.acceptsOffers!==!1&&e.jsxs("button",{onClick:()=>v(!0),className:"w-full py-3 border-2 border-blue-500 text-blue-600 dark:text-blue-400 font-bold rounded-xl hover:bg-blue-50 dark:hover:bg-blue-900/20 transition flex items-center justify-center gap-2",children:[e.jsx(le,{size:18}),"Make an Offer"]})]}),e.jsx("p",{className:"text-center text-[10px] text-gray-400 mt-3 flex items-center justify-center gap-1",children:E?e.jsxs(e.Fragment,{children:[e.jsx(ye,{size:10})," Funds held in escrow â€¢ GPS verified exchange â€¢ Dual approval release"]}):e.jsxs(e.Fragment,{children:[e.jsx(V,{size:10})," Purchases covered by SeshNx Buyer Protection"]})})]})]})]})})}function Ft({orders:t,user:a,userData:d,onBack:o,onUpdateStatus:I,openChat:w}){const[s,C]=l.useState(null),[N,j]=l.useState(!1),[_,v]=l.useState(""),[b,$]=l.useState("usps"),[S,F]=l.useState("all"),B=[{id:"usps",label:"USPS"},{id:"ups",label:"UPS"},{id:"fedex",label:"FedEx"},{id:"dhl",label:"DHL"},{id:"other",label:"Other"}],G=t.filter(n=>S==="buying"?n.role==="buyer":S==="selling"?n.role==="seller":!0),y=async()=>{if(!_){K.error("Please enter a tracking number");return}await I(s.id,Y.SHIPPED,{trackingNumber:_,carrier:b}),j(!1),v(""),C(null)},M=async n=>{await I(n.id,Y.COMPLETED)},p=n=>{const A=fe[n];if(A){const c=A.icon;return e.jsx(c,{size:16})}return e.jsx(xe,{size:16})};return e.jsxs("div",{className:"animate-in fade-in",children:[e.jsx("div",{className:"flex items-center justify-between mb-6",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("button",{onClick:o,className:"p-2 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-lg transition",children:e.jsx(Be,{className:"rotate-180 text-gray-500",size:20})}),e.jsxs("div",{children:[e.jsxs("h2",{className:"text-2xl font-bold dark:text-white flex items-center gap-2",children:[e.jsx(Qe,{className:"text-orange-500"})," My Orders"]}),e.jsx("p",{className:"text-gray-500 dark:text-gray-400 text-sm",children:"Track your purchases and sales"})]})]})}),e.jsx("div",{className:"flex gap-2 mb-6",children:[{id:"all",label:"All Orders"},{id:"buying",label:"Buying"},{id:"selling",label:"Selling"}].map(n=>e.jsx("button",{onClick:()=>F(n.id),className:`px-4 py-2 rounded-lg text-sm font-bold transition ${S===n.id?"bg-orange-600 text-white shadow":"bg-gray-100 dark:bg-gray-800 text-gray-600 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-700"}`,children:n.label},n.id))}),G.length===0?e.jsxs("div",{className:"text-center py-16 bg-white dark:bg-[#2c2e36] rounded-2xl border dark:border-gray-700",children:[e.jsx(We,{size:48,className:"mx-auto text-gray-300 dark:text-gray-600 mb-4"}),e.jsx("h3",{className:"text-lg font-bold dark:text-white mb-2",children:"No orders yet"}),e.jsx("p",{className:"text-gray-500 dark:text-gray-400 mb-4",children:S==="buying"?"You haven't purchased anything yet":S==="selling"?"You haven't received any orders yet":"Start shopping or selling to see your orders here"}),e.jsx("button",{onClick:o,className:"px-6 py-2 bg-orange-600 text-white rounded-lg font-bold hover:bg-orange-700 transition",children:"Browse Gear"})]}):e.jsx("div",{className:"space-y-4",children:G.map(n=>{var O,z,U,P,Z,E,r,h,x,T;const A=fe[n.status]||fe[Y.PENDING],c=n.role==="seller",L=n.role==="buyer";return e.jsx(be.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},className:"bg-white dark:bg-[#2c2e36] rounded-xl border dark:border-gray-700 overflow-hidden hover:shadow-lg transition",children:e.jsxs("div",{className:"p-5",children:[e.jsxs("div",{className:"flex items-start gap-4",children:[e.jsx("div",{className:"w-20 h-20 rounded-lg bg-gray-100 dark:bg-gray-800 overflow-hidden shrink-0",children:(O=n.itemPhotos)!=null&&O[0]?e.jsx("img",{src:n.itemPhotos[0],className:"w-full h-full object-cover"}):e.jsx("div",{className:"w-full h-full flex items-center justify-center",children:e.jsx(we,{className:"text-gray-400",size:24})})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-start justify-between gap-3",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"font-bold dark:text-white truncate",children:n.itemTitle}),e.jsx("p",{className:"text-sm text-gray-500",children:n.itemBrand})]}),e.jsxs("span",{className:`px-3 py-1 rounded-full text-xs font-bold flex items-center gap-1.5 ${A.color}`,children:[p(n.status),A.label]})]}),e.jsxs("div",{className:"flex items-center gap-4 mt-3 text-sm flex-wrap",children:[L?e.jsxs("span",{className:"font-bold text-green-600",children:["$",((z=n.buyerTotal)==null?void 0:z.toFixed(2))||n.price,n.serviceFee&&e.jsxs("span",{className:"text-[10px] text-gray-400 font-normal ml-1",children:["(incl. $",(U=n.serviceFee)==null?void 0:U.toFixed(2)," fee)"]})]}):e.jsxs("span",{className:"font-bold text-green-600",children:["$",((P=n.sellerPayout)==null?void 0:P.toFixed(2))||n.price,n.serviceFee&&e.jsxs("span",{className:"text-[10px] text-gray-400 font-normal ml-1",children:["(after $",(Z=n.serviceFee)==null?void 0:Z.toFixed(2)," fee)"]})]}),e.jsx("span",{className:`px-2 py-0.5 rounded text-xs font-bold ${L?"bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-400":"bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400"}`,children:L?"Purchasing":"Selling"}),e.jsx("span",{className:"text-gray-400 text-xs",children:((r=(E=n.createdAt)==null?void 0:E.toDate)==null?void 0:r.call(E).toLocaleDateString())||"Recently"})]}),e.jsx("div",{className:"flex items-center gap-2 mt-2 text-xs text-gray-500",children:n.fulfillmentMethod==="shipping"?e.jsxs(e.Fragment,{children:[e.jsx(ie,{size:12}),e.jsxs("span",{children:["Shipping to ",(h=n.shippingAddress)==null?void 0:h.city,", ",(x=n.shippingAddress)==null?void 0:x.state]})]}):e.jsxs(e.Fragment,{children:[e.jsx(Je,{size:12}),e.jsx("span",{children:"Local Pickup"})]})}),n.trackingNumber&&e.jsx("div",{className:"mt-2 p-2 bg-purple-50 dark:bg-purple-900/20 rounded-lg text-xs",children:e.jsxs("span",{className:"text-purple-700 dark:text-purple-400 font-bold",children:["Tracking: ",(T=n.trackingCarrier)==null?void 0:T.toUpperCase()," - ",n.trackingNumber]})})]})]}),e.jsxs("div",{className:"flex gap-2 mt-4 pt-4 border-t dark:border-gray-700",children:[c&&n.status===Y.PENDING&&e.jsxs("button",{onClick:()=>I(n.id,Y.CONFIRMED),className:"flex-1 py-2 bg-blue-600 text-white text-sm font-bold rounded-lg hover:bg-blue-700 transition flex items-center justify-center gap-2",children:[e.jsx(V,{size:16})," Confirm Order"]}),c&&n.status===Y.CONFIRMED&&n.fulfillmentMethod==="shipping"&&e.jsxs("button",{onClick:()=>{C(n),j(!0)},className:"flex-1 py-2 bg-purple-600 text-white text-sm font-bold rounded-lg hover:bg-purple-700 transition flex items-center justify-center gap-2",children:[e.jsx(ie,{size:16})," Mark as Shipped"]}),c&&n.status===Y.CONFIRMED&&n.fulfillmentMethod==="pickup"&&e.jsxs("button",{onClick:()=>I(n.id,Y.COMPLETED),className:"flex-1 py-2 bg-green-600 text-white text-sm font-bold rounded-lg hover:bg-green-700 transition flex items-center justify-center gap-2",children:[e.jsx(V,{size:16})," Mark as Picked Up"]}),L&&(n.status===Y.SHIPPED||n.status===Y.DELIVERED)&&e.jsxs("button",{onClick:()=>M(n),className:"flex-1 py-2 bg-green-600 text-white text-sm font-bold rounded-lg hover:bg-green-700 transition flex items-center justify-center gap-2",children:[e.jsx(V,{size:16})," Confirm Receipt"]}),e.jsxs("button",{onClick:()=>w==null?void 0:w(L?n.sellerId:n.buyerId),className:"px-4 py-2 border border-gray-200 dark:border-gray-600 text-gray-600 dark:text-gray-400 text-sm font-bold rounded-lg hover:bg-gray-50 dark:hover:bg-gray-800 transition flex items-center gap-2",children:[e.jsx(le,{size:16}),"Contact ",L?"Seller":"Buyer"]})]})]})},n.id)})}),e.jsx(at,{children:N&&s&&e.jsx(be.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-[70] p-4",onClick:()=>j(!1),children:e.jsxs(be.div,{initial:{scale:.9,y:20},animate:{scale:1,y:0},exit:{scale:.9,y:20},onClick:n=>n.stopPropagation(),className:"bg-white dark:bg-[#2c2e36] rounded-2xl p-6 w-full max-w-md shadow-2xl",children:[e.jsxs("h3",{className:"text-xl font-bold dark:text-white mb-4 flex items-center gap-2",children:[e.jsx(ie,{className:"text-purple-600"})," Add Shipping Info"]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-bold text-gray-500 uppercase mb-1 block",children:"Carrier"}),e.jsx("select",{value:b,onChange:n=>$(n.target.value),className:"w-full p-3 border rounded-lg dark:bg-[#1f2128] dark:border-gray-600 dark:text-white",children:B.map(n=>e.jsx("option",{value:n.id,children:n.label},n.id))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-bold text-gray-500 uppercase mb-1 block",children:"Tracking Number"}),e.jsx("input",{type:"text",value:_,onChange:n=>v(n.target.value),placeholder:"Enter tracking number",className:"w-full p-3 border rounded-lg dark:bg-[#1f2128] dark:border-gray-600 dark:text-white"})]}),e.jsxs("div",{className:"bg-blue-50 dark:bg-blue-900/20 p-3 rounded-lg text-xs text-blue-700 dark:text-blue-300",children:[e.jsx(Ke,{size:12,className:"inline mr-1"}),"The buyer will be notified with the tracking information"]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:()=>j(!1),className:"flex-1 py-3 border border-gray-300 dark:border-gray-600 text-gray-600 dark:text-gray-400 font-bold rounded-xl hover:bg-gray-50 dark:hover:bg-gray-800 transition",children:"Cancel"}),e.jsxs("button",{onClick:y,className:"flex-1 py-3 bg-purple-600 text-white font-bold rounded-xl hover:bg-purple-700 transition flex items-center justify-center gap-2",children:[e.jsx(ie,{size:16})," Confirm Shipment"]})]})]})]})})})]})}function Rt({user:t,userData:a,tokenBalance:d,refreshWallet:o}){const[I,w]=l.useState([]),[s,C]=l.useState("All"),[N,j]=l.useState(""),[_,v]=l.useState(new Set),[b,$]=l.useState(!1),[S,F]=l.useState(null),[B,G]=l.useState(null);l.useEffect(()=>{if(!(t!=null&&t.id)&&!(t!=null&&t.uid)||!g)return;t.id||t.uid,g.from("market_items").select("*").order("created_at",{ascending:!1}).then(({data:n,error:A})=>{if(A){console.error("Error fetching market items:",A);return}w((n||[]).map(c=>({id:c.id,...c,timestamp:c.created_at})))});const p=g.channel("market-items").on("postgres_changes",{event:"*",schema:"public",table:"market_items"},async()=>{const{data:n}=await g.from("market_items").select("*").order("created_at",{ascending:!1});n&&w(n.map(A=>({id:A.id,...A,timestamp:A.created_at})))}).subscribe();return()=>{g.removeChannel(p)}},[t==null?void 0:t.id,t==null?void 0:t.uid]),l.useEffect(()=>{if(!(t!=null&&t.id)&&!(t!=null&&t.uid)||!g)return;const p=t.id||t.uid;g.from("user_library").select("item_id").eq("user_id",p).then(({data:A,error:c})=>{if(c){console.error("Error fetching owned items:",c);return}v(new Set((A||[]).map(L=>L.item_id)))});const n=g.channel(`user-library-${p}`).on("postgres_changes",{event:"*",schema:"public",table:"user_library",filter:`user_id=eq.${p}`},async()=>{const{data:A}=await g.from("user_library").select("item_id").eq("user_id",p);A&&v(new Set(A.map(c=>c.item_id)))}).subscribe();return()=>{g.removeChannel(n)}},[t==null?void 0:t.id,t==null?void 0:t.uid]);const y=async p=>{if(d<p.price){alert("Insufficient tokens! Please top up.");return}if(!window.confirm(`Purchase ${p.title} for ${p.price} Tokens?`))return;if(!g){alert("Transaction failed. Database unavailable.");return}const n=(t==null?void 0:t.id)||(t==null?void 0:t.uid);try{const{data:A,error:c}=await g.from("wallets").select("balance").eq("user_id",n).single();if(c)throw c;await g.from("wallets").update({balance:(A.balance||0)-p.price}).eq("user_id",n),await g.from("user_library").insert({user_id:n,item_id:p.id,title:p.title,type:p.type,price_paid:p.price,purchase_date:new Date().toISOString(),download_url:p.download_url||p.downloadUrl}),o&&o(),alert("Purchased successfully!")}catch(A){console.error(A),alert("Transaction failed.")}},M=I.filter(p=>(s==="All"||p.type===s)&&p.title.toLowerCase().includes(N.toLowerCase()));return e.jsxs("div",{className:"pb-32",children:[e.jsxs("div",{className:"flex flex-col md:flex-row gap-4 mb-6",children:[e.jsx("div",{className:"flex gap-2 overflow-x-auto pb-2 md:pb-0 scrollbar-hide",children:["All","Presets","Samples","Beats"].map(p=>e.jsx("button",{onClick:()=>C(p),className:`px-4 py-2 rounded-lg text-xs font-bold whitespace-nowrap transition-all ${s===p?"bg-brand-blue text-white":"bg-gray-100 dark:bg-gray-800 text-gray-600 dark:text-gray-300"}`,children:p},p))}),e.jsxs("div",{className:"ml-auto flex gap-2 w-full md:w-auto",children:[e.jsxs("div",{className:"relative flex-1 md:w-64",children:[e.jsx(Ze,{className:"absolute left-3 top-2.5 text-gray-400",size:16}),e.jsx("input",{className:"w-full pl-9 pr-4 py-2 rounded-lg border border-gray-200 dark:border-gray-700 bg-white dark:bg-dark-card text-sm dark:text-white focus:outline-none",placeholder:"Search...",value:N,onChange:p=>j(p.target.value)})]}),e.jsxs("button",{onClick:()=>$(!0),className:"bg-green-600 text-white px-4 py-2 rounded-lg font-bold text-xs flex items-center gap-2 hover:bg-green-700",children:[e.jsx(ve,{size:16})," Upload"]})]})]}),e.jsx("div",{className:"grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4",children:M.map(p=>{const n=_.has(p.id);return e.jsxs("div",{className:"bg-white dark:bg-dark-card rounded-xl border dark:border-gray-700 overflow-hidden hover:shadow-lg transition flex flex-col group",children:[e.jsxs("div",{className:"aspect-square relative bg-gray-100 dark:bg-gray-800 flex items-center justify-center cursor-pointer",onClick:()=>F(p),children:[p.type==="Presets"?e.jsx(et,{size:40,className:"text-gray-400"}):e.jsx(tt,{size:40,className:"text-gray-400"}),n&&e.jsxs("div",{className:"absolute top-2 right-2 bg-green-500 text-white text-[9px] font-bold px-1.5 py-0.5 rounded flex items-center gap-1",children:[e.jsx(V,{size:8})," OWNED"]})]}),e.jsxs("div",{className:"p-3 flex flex-col flex-1",children:[e.jsx("div",{className:"text-[10px] font-bold text-brand-blue uppercase mb-1",children:p.type}),e.jsx("h4",{className:"font-bold text-sm dark:text-white truncate mb-1",title:p.title,children:p.title}),e.jsxs("div",{className:"flex items-center justify-between mt-auto",children:[e.jsxs("span",{className:"text-xs font-bold text-yellow-600 dark:text-yellow-400 flex items-center gap-1",children:[e.jsx(st,{size:10,fill:"currentColor"})," ",p.price]}),!n&&e.jsx("button",{onClick:()=>y(p),className:"bg-gray-900 dark:bg-white dark:text-black text-white px-3 py-1 rounded text-[10px] font-bold hover:opacity-80",children:"Buy"})]})]})]},p.id)})}),b&&e.jsx($t,{user:t,userData:a,onClose:()=>$(!1)}),S&&e.jsx(Mt,{item:S,isOwned:_.has(S.id),user:t,onClose:()=>F(null),onBuy:()=>y(S),onDownload:()=>handleDownload(S),onReport:()=>G({id:S.id,type:"market_item",summary:S.title})}),B&&e.jsx(_t,{user:t,target:B,onClose:()=>G(null)})]})}function $t({user:t,userData:a,onClose:d}){const[o,I]=l.useState({title:"",price:"",type:"Presets",tags:"",description:""}),[w,s]=l.useState(null),[C,N]=l.useState(""),{uploadMedia:j,uploading:_}=pe(),v=async()=>{if(!o.title||!o.price||!w||!g)return alert("Title, Price, and Audio File are required.");const b=(t==null?void 0:t.id)||(t==null?void 0:t.uid);try{N("Uploading Audio Asset...");const $=await j(w,`market-assets/${b}`);N("Listing Item..."),await g.from("market_items").insert({title:o.title,price:parseInt(o.price),type:o.type,tags:o.tags.split(",").map(S=>S.trim()).filter(S=>S),description:o.description||null,author:`${(a==null?void 0:a.firstName)||""} ${(a==null?void 0:a.lastName)||""}`.trim(),author_id:b,download_url:$,created_at:new Date().toISOString()}),N("Success!"),setTimeout(d,1e3)}catch($){console.error($),N("Error listing item."),alert("Failed to submit item to market. Check console.")}};return e.jsx("div",{className:"fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-[60] p-4",children:e.jsxs("div",{className:"bg-white dark:bg-[#2c2e36] rounded-2xl p-8 w-full max-w-2xl max-h-[90vh] overflow-y-auto shadow-2xl border dark:border-gray-700",children:[e.jsxs("div",{className:"flex justify-between items-center mb-6",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-bold dark:text-white",children:"Creator Studio"}),e.jsx("p",{className:"text-gray-500 text-sm",children:"List a new sound for sale"})]}),e.jsx("button",{onClick:d,children:e.jsx(Q,{})})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-bold text-gray-500 uppercase",children:"Title"}),e.jsx("input",{className:"w-full p-3 border rounded-xl dark:bg-[#1f2128] dark:border-gray-600 dark:text-white",value:o.title,onChange:b=>I({...o,title:b.target.value}),placeholder:"e.g. Midnight Lofi"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-bold text-gray-500 uppercase",children:"Type"}),e.jsxs("select",{className:"w-full p-3 border rounded-xl dark:bg-[#1f2128] dark:border-gray-600 dark:text-white",value:o.type,onChange:b=>I({...o,type:b.target.value}),children:[e.jsx("option",{children:"Presets"}),e.jsx("option",{children:"Samples"}),e.jsx("option",{children:"Beats"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-bold text-gray-500 uppercase",children:"Price (TK)"}),e.jsx("input",{type:"number",className:"w-full p-3 border rounded-xl dark:bg-[#1f2128] dark:border-gray-600 dark:text-white",value:o.price,onChange:b=>I({...o,price:b.target.value})})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-bold text-gray-500 uppercase",children:"Description"}),e.jsx("textarea",{className:"w-full p-3 border rounded-xl dark:bg-[#1f2128] dark:border-gray-600 dark:text-white",rows:"3",value:o.description,onChange:b=>I({...o,description:b.target.value})})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-bold text-gray-500 uppercase",children:"Tags (Comma Separated)"}),e.jsx("input",{className:"w-full p-3 border rounded-xl dark:bg-[#1f2128] dark:border-gray-600 dark:text-white",value:o.tags,onChange:b=>I({...o,tags:b.target.value}),placeholder:"lofi, hiphop, boom-bap"})]})]}),e.jsx("div",{className:"space-y-4",children:e.jsxs("div",{className:"border-2 border-dashed dark:border-gray-600 rounded-xl p-6 text-center hover:bg-gray-50 dark:hover:bg-gray-800 transition relative bg-blue-50/50 dark:bg-blue-900/10 h-full flex flex-col justify-center items-center",children:[e.jsx("input",{type:"file",className:"absolute inset-0 opacity-0 cursor-pointer",accept:"audio/*",onChange:b=>s(b.target.files[0])}),e.jsx(ut,{size:48,className:"mx-auto text-blue-500 mb-2"}),e.jsx("div",{className:"text-lg font-bold text-blue-600 dark:text-blue-400",children:w?w.name:"Upload Audio File (Product Asset)"}),e.jsx("div",{className:"text-xs text-gray-500 mt-2",children:"MP3/WAV (Max 50MB)"}),w&&e.jsx("div",{className:"mt-2 text-xs bg-green-100 text-green-800 px-2 py-1 rounded",children:"Selected"})]})})]}),e.jsx("div",{className:"mt-8",children:e.jsx("button",{onClick:v,disabled:_||!o.title||!o.price||!w,className:"w-full bg-brand-blue text-white py-4 rounded-xl font-bold text-lg hover:bg-blue-600 transition flex items-center justify-center gap-2 disabled:opacity-50",children:_?e.jsxs(e.Fragment,{children:[e.jsx(ne,{className:"animate-spin"})," ",C]}):"List Item for Sale"})})]})})}function Mt({item:t,isOwned:a,onClose:d,onBuy:o,onDownload:I,onReport:w}){return e.jsx("div",{className:"fixed inset-0 bg-black/70 backdrop-blur-md flex items-center justify-center z-[60] p-4",children:e.jsxs("div",{className:"bg-white dark:bg-dark-card rounded-2xl overflow-hidden w-full max-w-4xl shadow-2xl flex flex-col md:flex-row h-[80vh] md:h-[600px]",children:[e.jsxs("div",{className:"md:w-5/12 bg-gray-100 dark:bg-black/40 relative p-8 flex flex-col justify-center items-center text-center",children:[e.jsx("div",{className:"w-64 h-64 bg-gradient-to-br from-brand-blue to-purple-600 rounded-lg shadow-2xl mb-6 flex items-center justify-center text-white",children:t.type==="Presets"?e.jsx(et,{size:80}):e.jsx(tt,{size:80})}),e.jsx("h2",{className:"text-2xl font-bold dark:text-white mb-2",children:t.title}),e.jsxs("div",{className:"text-brand-blue font-medium mb-6",children:["by ",t.author]}),t.downloadUrl&&e.jsx("div",{className:"w-full",children:e.jsx(St,{audioUrl:t.downloadUrl,fileName:"Preview Track",previewMode:!a})})]}),e.jsxs("div",{className:"md:w-7/12 p-8 overflow-y-auto flex flex-col",children:[e.jsxs("div",{className:"flex justify-between items-start mb-6",children:[e.jsxs("div",{children:[e.jsx("span",{className:"bg-blue-100 text-blue-800 text-xs font-bold px-2 py-1 rounded uppercase tracking-wide",children:t.type}),e.jsx("h1",{className:"text-3xl font-extrabold dark:text-white mt-2",children:t.title})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:w,className:"p-2 hover:bg-red-50 dark:hover:bg-red-900/20 text-gray-400 hover:text-red-500 rounded-full transition",title:"Report Violation",children:e.jsx(ft,{size:20})}),e.jsx("button",{onClick:d,className:"p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-full",children:e.jsx(Q,{size:20})})]})]}),e.jsxs("div",{className:"prose dark:prose-invert text-sm text-gray-600 dark:text-gray-300 mb-8",children:[e.jsx("p",{children:t.description||"No description provided by the creator."}),!a&&e.jsxs("div",{className:"mt-4 bg-yellow-50 dark:bg-yellow-900/20 p-3 rounded text-yellow-800 dark:text-yellow-200 text-xs flex items-center gap-2",children:[e.jsx(Info,{size:14})," Audio preview is truncated to 15 seconds. Purchase to unlock full track."]})]}),e.jsx("div",{className:"mt-auto",children:a?e.jsxs("button",{onClick:I,className:"w-full bg-green-600 hover:bg-green-700 text-white py-4 rounded-xl font-bold text-lg flex items-center justify-center gap-2 shadow-lg transition-transform hover:scale-[1.02]",children:[e.jsx(yt,{size:24})," Download Now"]}):e.jsxs("button",{onClick:o,className:"w-full bg-gray-900 dark:bg-white dark:text-black text-white py-4 rounded-xl font-bold text-lg flex items-center justify-center gap-3 shadow-lg transition-transform hover:scale-[1.02]",children:[e.jsx("span",{children:"Buy for"}),e.jsxs("span",{className:"bg-yellow-400 text-black px-2 py-0.5 rounded text-sm flex items-center gap-1",children:[e.jsx(st,{size:12,fill:"black"})," ",t.price]})]})})]})]})})}function Vt({user:t,userData:a,tokenBalance:d}){const o=jt(),I=Nt(),{t:w}=vt(),s=v=>{const b=v.split("/").filter(Boolean);return b[0]==="marketplace"&&b[1]?b[1]:"gear"},[C,N]=l.useState(()=>s(o.pathname));l.useEffect(()=>{const v=s(o.pathname);v!==C&&N(v)},[o.pathname]);const j=v=>{N(v),I(`/marketplace/${v}`,{replace:!0})},_=[{id:"gear",label:w("gearExchange")},{id:"fx",label:w("seshFxStore")}];return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("h1",{className:"text-2xl font-bold dark:text-white",children:w("marketplace")}),e.jsx("div",{className:"bg-white dark:bg-gray-800 p-1 rounded-lg border dark:border-gray-700 flex gap-1",children:_.map(v=>e.jsx("button",{onClick:()=>j(v.id),className:`px-4 py-2 text-sm font-bold rounded-md transition-all ${C===v.id?"bg-brand-blue text-white shadow-md":"text-gray-500 hover:bg-gray-100 dark:hover:bg-gray-700"}`,children:v.label},v.id))})]}),e.jsxs("div",{className:"tab-content-wrapper",children:[C==="gear"&&e.jsx("div",{className:"tab-content",children:e.jsx(Lt,{user:t,userData:a})},"gear"),C==="fx"&&e.jsx("div",{className:"tab-content",children:e.jsx(Rt,{user:t,tokenBalance:d})},"fx")]})]})}export{Vt as default};
