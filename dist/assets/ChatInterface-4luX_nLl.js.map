{"version":3,"file":"ChatInterface-4luX_nLl.js","sources":["../../src/components/ChatInterface.jsx"],"sourcesContent":["import React, { useState, useEffect, useMemo } from 'react';\r\nimport { useLocation, useNavigate } from 'react-router-dom';\r\nimport { useQuery } from \"convex/react\";\r\nimport { api } from \"../../convex/_generated/api\";\r\nimport { isConvexAvailable } from '../config/convex';\r\nimport ChatSidebar from './chat/ChatSidebar';\r\nimport ChatWindow from './chat/ChatWindow';\r\nimport ChatDetailsPane from './chat/ChatDetailsPane';\r\nimport { usePresence } from '../hooks/usePresence';\r\nimport { motion, AnimatePresence } from 'framer-motion';\r\nimport { useLanguage } from '../contexts/LanguageContext';\r\n\r\nexport default function ChatInterface({ user, userData, subProfiles = {}, openPublicProfile, pendingChatTarget, clearPendingChatTarget }) {\r\n    const location = useLocation();\r\n    const navigate = useNavigate();\r\n    const { t } = useLanguage();\r\n    const [activeChat, setActiveChat] = useState(null);\r\n    const [showDetails, setShowDetails] = useState(false);\r\n    const [profilePhotos, setProfilePhotos] = useState({});\r\n\r\n    // Normalize user ID for backward compatibility\r\n    const userId = user?.id || user?.uid;\r\n\r\n    // Initialize presence tracking for current user\r\n    usePresence(userId);\r\n\r\n    // Handle pending chat target - auto-open conversation when navigating from another page\r\n    useEffect(() => {\r\n        if (pendingChatTarget && userId) {\r\n            const chatId = [userId, pendingChatTarget.uid].sort().join('_');\r\n            handleChatSelect({\r\n                id: chatId,\r\n                uid: pendingChatTarget.uid,\r\n                name: pendingChatTarget.name,\r\n                type: 'direct'\r\n            });\r\n            // Clear the pending target so it doesn't re-trigger\r\n            clearPendingChatTarget?.();\r\n        }\r\n    }, [pendingChatTarget, userId, clearPendingChatTarget]);\r\n\r\n    // FIX: Calculate Convex availability directly. \r\n    // Do NOT use useMemo here, as it causes the \"Cannot access before initialization\" error.\r\n    const convexAvailable = isConvexAvailable();\r\n\r\n    const conversationsQuery = useMemo(() => {\r\n        return userId && convexAvailable ? { userId } : \"skip\";\r\n    }, [userId, convexAvailable]);\r\n\r\n    // Fetch Conversations from Convex (automatically reactive)\r\n    // Hook must always be called (React rules), but we skip if Convex not available\r\n    const conversationsData = useQuery(\r\n        api.conversations.getConversations,\r\n        conversationsQuery\r\n    );\r\n\r\n    // Fetch fresh profile photos for direct chat users\r\n    useEffect(() => {\r\n        const fetchProfilePhotos = async () => {\r\n            if (!conversationsData || !supabase) return;\r\n\r\n            // Get unique other user IDs from direct chats\r\n            const otherUserIds = conversationsData\r\n                .filter(c => c.chatType === 'direct' && c.otherUserId)\r\n                .map(c => c.otherUserId)\r\n                .filter((id, index, arr) => arr.indexOf(id) === index);\r\n\r\n            if (otherUserIds.length === 0) return;\r\n\r\n            const { data: profiles } = await supabase\r\n                .from('profiles')\r\n                .select('id, avatar_url')\r\n                .in('id', otherUserIds);\r\n\r\n            if (profiles) {\r\n                const photosMap = {};\r\n                profiles.forEach(p => {\r\n                    photosMap[p.id] = p.avatar_url;\r\n                });\r\n                setProfilePhotos(photosMap);\r\n            }\r\n        };\r\n\r\n        fetchProfilePhotos();\r\n    }, [conversationsData]);\r\n\r\n    // Transform Convex data to match existing format, using fresh profile photos\r\n    const conversations = useMemo(() => {\r\n        if (!conversationsData) return [];\r\n\r\n        return conversationsData.map(conv => ({\r\n            id: conv.chatId,\r\n            uid: conv.otherUserId || conv.chatId,\r\n            name: conv.chatName || 'Unknown',\r\n            n: conv.chatName || 'Unknown',\r\n            // Use fresh profile photo for direct chats, fall back to stored photo\r\n            photo: (conv.chatType === 'direct' && conv.otherUserId && profilePhotos[conv.otherUserId])\r\n                ? profilePhotos[conv.otherUserId]\r\n                : (conv.chatPhoto || ''),\r\n            type: conv.chatType || 'direct',\r\n            lm: conv.lastMessage || '',\r\n            lmt: conv.lastMessageTime || 0,\r\n            ls: conv.lastSenderId || '',\r\n            uc: conv.unreadCount || 0,\r\n        })).sort((a, b) => (b.lmt || 0) - (a.lmt || 0));\r\n    }, [conversationsData, profilePhotos]);\r\n\r\n    // Update URL when chat changes\r\n    const handleChatSelect = (chat) => {\r\n        setActiveChat(chat);\r\n        if (chat?.id) {\r\n            navigate(`/messages/chat/${chat.id}`, { replace: true });\r\n        } else {\r\n            navigate('/messages', { replace: true });\r\n        }\r\n    };\r\n\r\n    // Sync activeChat with URL (e.g., /messages/chat/chatId)\r\n    useEffect(() => {\r\n        const pathParts = location.pathname.split('/').filter(Boolean);\r\n        if (pathParts[0] === 'messages' && pathParts[1] === 'chat' && pathParts[2]) {\r\n            const chatIdFromUrl = pathParts[2];\r\n            // Find conversation matching the chat ID\r\n            const conversation = conversations.find(c => c.id === chatIdFromUrl);\r\n            if (conversation) {\r\n                // Only update if different from current\r\n                setActiveChat(prev => {\r\n                    if (prev?.id === chatIdFromUrl) return prev;\r\n                    return {\r\n                        id: conversation.id,\r\n                        uid: conversation.uid,\r\n                        name: conversation.name,\r\n                        type: conversation.type\r\n                    };\r\n                });\r\n            }\r\n        } else if (pathParts[0] === 'messages' && (!pathParts[1] || pathParts[1] !== 'chat')) {\r\n            // If we're on /messages without a chat ID, clear active chat\r\n            setActiveChat(prev => prev ? null : prev);\r\n        }\r\n    }, [location.pathname, conversations]);\r\n\r\n    // Check if Convex is available\r\n    useEffect(() => {\r\n        if (!isConvexAvailable()) {\r\n            console.warn('Convex is not available. Chat functionality is disabled.');\r\n        }\r\n    }, []);\r\n\r\n    return (\r\n        <div className=\"flex h-[calc(100vh-100px)] bg-white dark:bg-[#1f2128] rounded-2xl overflow-hidden border dark:border-gray-800 shadow-xl\">\r\n\r\n            {/* Sidebar (Always visible on Desktop, toggles on Mobile) */}\r\n            <motion.div\r\n                initial={{ x: -20, opacity: 0 }} animate={{ x: 0, opacity: 1 }}\r\n                className={`w-full md:w-80 border-r dark:border-gray-800 flex flex-col ${activeChat ? 'hidden md:flex' : 'flex'}`}\r\n            >\r\n                <ChatSidebar\r\n                    user={user}\r\n                    userData={userData}\r\n                    subProfiles={subProfiles}\r\n                    conversations={conversations}\r\n                    activeChat={activeChat}\r\n                    onSelectChat={handleChatSelect}\r\n                />\r\n            </motion.div>\r\n\r\n            {/* Main Chat Window */}\r\n            {/* Always render ChatWindow to maintain consistent hook calls (React rules) */}\r\n            <div className={`flex-1 flex flex-col relative ${!activeChat ? 'hidden md:flex' : 'flex'}`}>\r\n                <ChatWindow\r\n                    activeChat={activeChat}\r\n                    user={user}\r\n                    userData={userData}\r\n                    conversations={conversations}\r\n                    onBack={() => handleChatSelect(null)}\r\n                    toggleDetails={() => setShowDetails(!showDetails)}\r\n                    openPublicProfile={openPublicProfile}\r\n                />\r\n\r\n                {/* Slide-out Details Pane */}\r\n                <AnimatePresence>\r\n                    {showDetails && activeChat && (\r\n                        <motion.div\r\n                            initial={{ width: 0, opacity: 0 }}\r\n                            animate={{ width: 300, opacity: 1 }}\r\n                            exit={{ width: 0, opacity: 0 }}\r\n                            className=\"border-l dark:border-gray-800 bg-gray-50 dark:bg-[#23262f] overflow-hidden relative z-20\"\r\n                        >\r\n                            <ChatDetailsPane\r\n                                activeChat={activeChat}\r\n                                currentUser={userData}\r\n                                onClose={() => setShowDetails(false)}\r\n                            />\r\n                        </motion.div>\r\n                    )}\r\n                </AnimatePresence>\r\n            </div>\r\n        </div>\r\n    );\r\n}\r\n"],"names":["ChatInterface","user","userData","subProfiles","openPublicProfile","pendingChatTarget","clearPendingChatTarget","location","useLocation","navigate","useNavigate","t","useLanguage","activeChat","setActiveChat","useState","showDetails","setShowDetails","profilePhotos","setProfilePhotos","userId","usePresence","useEffect","chatId","handleChatSelect","convexAvailable","isConvexAvailable","conversationsQuery","useMemo","conversationsData","useQuery","api","otherUserIds","c","id","index","arr","profiles","photosMap","p","conversations","conv","a","b","chat","pathParts","chatIdFromUrl","conversation","prev","jsxs","jsx","motion","ChatSidebar","ChatWindow","AnimatePresence","ChatDetailsPane"],"mappings":"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"}