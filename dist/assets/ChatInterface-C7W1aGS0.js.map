{"version":3,"file":"ChatInterface-C7W1aGS0.js","sources":["../../src/components/ChatInterface.jsx"],"sourcesContent":["import React, { useState, useEffect, useMemo } from 'react';\r\nimport { useLocation, useNavigate } from 'react-router-dom';\r\nimport { useQuery } from \"convex/react\";\r\nimport { api } from \"../../convex/_generated/api\";\r\nimport { isConvexAvailable } from '../config/convex';\r\nimport ChatSidebar from './chat/ChatSidebar';\r\nimport ChatWindow from './chat/ChatWindow';\r\nimport ChatDetailsPane from './chat/ChatDetailsPane';\r\nimport { usePresence } from '../hooks/usePresence';\r\nimport { motion, AnimatePresence } from 'framer-motion';\r\n\r\nexport default function ChatInterface({ user, userData, openPublicProfile, pendingChatTarget, clearPendingChatTarget }) {\r\n    const location = useLocation();\r\n    const navigate = useNavigate();\r\n    const [activeChat, setActiveChat] = useState(null);\r\n    const [showDetails, setShowDetails] = useState(false);\r\n\r\n    // Initialize presence tracking for current user\r\n    usePresence(user?.uid);\r\n\r\n    // Handle pending chat target - auto-open conversation when navigating from another page\r\n    useEffect(() => {\r\n        if (pendingChatTarget && user?.uid) {\r\n            const chatId = [user.uid, pendingChatTarget.uid].sort().join('_');\r\n            handleChatSelect({\r\n                id: chatId,\r\n                uid: pendingChatTarget.uid,\r\n                name: pendingChatTarget.name,\r\n                type: 'direct'\r\n            });\r\n            // Clear the pending target so it doesn't re-trigger\r\n            clearPendingChatTarget?.();\r\n        }\r\n    }, [pendingChatTarget, user?.uid, clearPendingChatTarget]);\r\n\r\n    // FIX: Calculate Convex availability directly. \r\n    // Do NOT use useMemo here, as it causes the \"Cannot access before initialization\" error.\r\n    const convexAvailable = isConvexAvailable();\r\n\r\n    const conversationsQuery = useMemo(() => {\r\n        return user?.uid && convexAvailable ? { userId: user.uid } : \"skip\";\r\n    }, [user?.uid, convexAvailable]);\r\n\r\n    // Fetch Conversations from Convex (automatically reactive)\r\n    // Hook must always be called (React rules), but we skip if Convex not available\r\n    const conversationsData = useQuery(\r\n        api.conversations.getConversations,\r\n        conversationsQuery\r\n    );\r\n\r\n    // Transform Convex data to match existing format\r\n    const conversations = useMemo(() => {\r\n        if (!conversationsData) return [];\r\n        \r\n        return conversationsData.map(conv => ({\r\n            id: conv.chatId,\r\n            uid: conv.otherUserId || conv.chatId,\r\n            name: conv.chatName || 'Unknown',\r\n            n: conv.chatName || 'Unknown',\r\n            photo: conv.chatPhoto || '',\r\n            type: conv.chatType || 'direct',\r\n            lm: conv.lastMessage || '',\r\n            lmt: conv.lastMessageTime || 0,\r\n            ls: conv.lastSenderId || '',\r\n            uc: conv.unreadCount || 0,\r\n        })).sort((a, b) => (b.lmt || 0) - (a.lmt || 0));\r\n    }, [conversationsData]);\r\n    \r\n    // Sync activeChat with URL (e.g., /messages/chat/chatId)\r\n    useEffect(() => {\r\n        const pathParts = location.pathname.split('/').filter(Boolean);\r\n        if (pathParts[0] === 'messages' && pathParts[1] === 'chat' && pathParts[2]) {\r\n            const chatIdFromUrl = pathParts[2];\r\n            // Find conversation matching the chat ID\r\n            const conversation = conversations.find(c => c.id === chatIdFromUrl);\r\n            if (conversation && (!activeChat || activeChat.id !== chatIdFromUrl)) {\r\n                setActiveChat({\r\n                    id: conversation.id,\r\n                    uid: conversation.uid,\r\n                    name: conversation.name,\r\n                    type: conversation.type\r\n                });\r\n            }\r\n        } else if (pathParts[0] === 'messages' && (!pathParts[1] || pathParts[1] !== 'chat')) {\r\n            // If we're on /messages without a chat ID, clear active chat\r\n            if (activeChat) {\r\n                setActiveChat(null);\r\n            }\r\n        }\r\n    }, [location.pathname, conversations]);\r\n    \r\n    // Update URL when chat changes\r\n    const handleChatSelect = (chat) => {\r\n        setActiveChat(chat);\r\n        if (chat?.id) {\r\n            navigate(`/messages/chat/${chat.id}`, { replace: true });\r\n        } else {\r\n            navigate('/messages', { replace: true });\r\n        }\r\n    };\r\n\r\n    // Check if Convex is available\r\n    useEffect(() => {\r\n        if (!isConvexAvailable()) {\r\n            console.warn('Convex is not available. Chat functionality is disabled.');\r\n        }\r\n    }, []);\r\n\r\n    return (\r\n        <div className=\"flex h-[calc(100vh-100px)] bg-white dark:bg-[#1f2128] rounded-2xl overflow-hidden border dark:border-gray-800 shadow-xl\">\r\n            \r\n            {/* Sidebar (Always visible on Desktop, toggles on Mobile) */}\r\n            <motion.div \r\n                initial={{ x: -20, opacity: 0 }} animate={{ x: 0, opacity: 1 }}\r\n                className={`w-full md:w-80 border-r dark:border-gray-800 flex flex-col ${activeChat ? 'hidden md:flex' : 'flex'}`}\r\n            >\r\n                <ChatSidebar \r\n                    user={user} \r\n                    userData={userData}\r\n                    conversations={conversations}\r\n                    activeChat={activeChat} \r\n                    onSelectChat={handleChatSelect}\r\n                />\r\n            </motion.div>\r\n\r\n            {/* Main Chat Window */}\r\n            {/* Always render ChatWindow to maintain consistent hook calls (React rules) */}\r\n            <div className={`flex-1 flex flex-col relative ${!activeChat ? 'hidden md:flex' : 'flex'}`}>\r\n                <ChatWindow \r\n                    activeChat={activeChat} \r\n                    user={user} \r\n                    userData={userData}\r\n                    conversations={conversations}\r\n                    onBack={() => handleChatSelect(null)}\r\n                    toggleDetails={() => setShowDetails(!showDetails)}\r\n                    openPublicProfile={openPublicProfile}\r\n                />\r\n                \r\n                {/* Slide-out Details Pane */}\r\n                <AnimatePresence>\r\n                    {showDetails && activeChat && (\r\n                        <motion.div \r\n                            initial={{ width: 0, opacity: 0 }} \r\n                            animate={{ width: 300, opacity: 1 }} \r\n                            exit={{ width: 0, opacity: 0 }}\r\n                            className=\"border-l dark:border-gray-800 bg-gray-50 dark:bg-[#23262f] overflow-hidden relative z-20\"\r\n                        >\r\n                            <ChatDetailsPane \r\n                                activeChat={activeChat} \r\n                                currentUser={userData} \r\n                                onClose={() => setShowDetails(false)} \r\n                            />\r\n                        </motion.div>\r\n                    )}\r\n                </AnimatePresence>\r\n            </div>\r\n        </div>\r\n    );\r\n}\r\n"],"names":["ChatInterface","user","userData","openPublicProfile","pendingChatTarget","clearPendingChatTarget","location","useLocation","navigate","useNavigate","activeChat","setActiveChat","useState","showDetails","setShowDetails","usePresence","useEffect","chatId","handleChatSelect","convexAvailable","isConvexAvailable","conversationsQuery","useMemo","conversationsData","useQuery","api","conversations","conv","a","b","pathParts","chatIdFromUrl","conversation","c","chat","jsxs","jsx","motion","ChatSidebar","ChatWindow","AnimatePresence","ChatDetailsPane"],"mappings":"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"}