import{r as l,t as et,c as De,j as e,U as be,a as tt,b as wt,d as jt,C as Nt,u as Y,e as ue,f as Ve,T as _e,P as Te,A as st,X as K,L as fe,g as rt,S as Ae,h as Oe,i as vt,k as kt,V as $e,l as at,m as Re,n as St,o as nt,p as it,q as lt,s as ot,M as qe,F as ye,v as _t,I as Rt,w as Mt,x as At,y as $t,R as It,E as zt,z as We,D as Be,B as Et,G as Le,H as Tt,J as Ft,K as Ct,N as He,O as Pe,Q as Dt,W as Qe,Y as Ye,Z as Lt,_ as Pt,$ as Gt}from"./vendor-BQZCuluI.js";import{m as D,A as ne}from"./vendor-framer-DGSPH0U8.js";console.warn("âš ï¸ Supabase credentials not found. Authentication will not work."),console.warn("   Please set VITE_SUPABASE_URL and VITE_SUPABASE_ANON_KEY in your environment.");const Q=null,xe="documents",ct=Symbol("serverTimestamp"),dt=Symbol("deleteField");class Ge{constructor(s){this._date=s instanceof Date?s:new Date(s)}static now(){return new Ge(new Date)}static fromMillis(s){return new Ge(new Date(s))}toMillis(){return this._date.getTime()}toDate(){return new Date(this._date)}}function le(){throw new Error("Supabase is not configured (missing VITE_SUPABASE_URL / VITE_SUPABASE_ANON_KEY).")}function ut(t){return t.flat().filter(s=>s!=null&&String(s).length>0).map(s=>String(s)).join("/")}function Ut(t){const s=String(t).split("/").filter(Boolean);if(s.length<2)throw new Error(`Invalid document path: ${t}`);const r=s.pop();return{collection_path:s.join("/"),id:r}}function Ot(t={},s={}){return{...t,...s}}function ge(t,s,r){const a=String(s).split(".").filter(Boolean);if(a.length===0)return t;const n=Array.isArray(t)?[...t]:{...t||{}};let i=n;for(let u=0;u<a.length-1;u++){const c=a[u],x=i[c];i[c]=x&&typeof x=="object"?Array.isArray(x)?[...x]:{...x}:{},i=i[c]}return i[a[a.length-1]]=r,n}function Bt(t,s){const r=String(s).split(".").filter(Boolean);if(r.length===0)return t;const a=Array.isArray(t)?[...t]:{...t||{}};let n=a;for(let i=0;i<r.length-1;i++){const u=r[i];if(!n[u]||typeof n[u]!="object")return a;n[u]=Array.isArray(n[u])?[...n[u]]:{...n[u]},n=n[u]}return delete n[r[r.length-1]],a}function Ts(){return ct}function Fs(){return dt}function Cs(t=1){return{__op:"increment",n:t}}function Vt(...t){return{__op:"arrayUnion",values:t}}function Ds(...t){return{__op:"arrayRemove",values:t}}function Je(t,...s){const r=s.length===1?String(s[0]):ut(s),{collection_path:a,id:n}=Ut(r);return{__type:"doc",collection_path:a,id:n}}function qt(t,...s){return{__type:"collection",collection_path:s.length===1?String(s[0]):ut(s)}}function Ke(t,s){return{__type:"collectionGroup",groupId:String(s).split("/").filter(Boolean).pop()}}function ie(t,s,r){return{__type:"where",field:t,op:s,value:r}}function Ls(t,s="asc"){return{__type:"orderBy",field:t,direction:s}}function Ps(t){return{__type:"limit",n:t}}function Ue(t,...s){return{__type:"query",ref:t,constraints:s}}function ft(t,s){const r=String(t).split("/").filter(Boolean),a=r[r.length-1]||"",n=r[r.length-2]||"";return{id:s,parent:{id:a,parent:{id:n}}}}function Wt(t){const s=!!t,r=(t==null?void 0:t.data)??null,a=(t==null?void 0:t.id)??void 0,n=(t==null?void 0:t.collection_path)??void 0;return{id:a,ref:s?ft(n,a):void 0,exists:()=>s,data:()=>s?r:void 0}}function Ht(t){const s=(t||[]).map(r=>({id:r.id,ref:ft(r.collection_path,r.id),data:()=>r.data}));return{docs:s,empty:s.length===0,size:s.length,forEach:r=>s.forEach(r)}}function mt(t,s){let r=t&&typeof t=="object"?{...t}:{};for(const[a,n]of Object.entries(s||{})){if(n===dt){r=Bt(r,a);continue}if(n===ct){r=ge(r,a,Date.now());continue}if(n&&typeof n=="object"&&n.__op==="increment"){const i=a.split(".").reduce((c,x)=>c&&typeof c=="object"?c[x]:void 0,r),u=(Number(i)||0)+Number(n.n||0);r=ge(r,a,u);continue}if(n&&typeof n=="object"&&n.__op==="arrayUnion"){const i=a.split(".").reduce((x,g)=>x&&typeof x=="object"?x[g]:void 0,r),c=[...Array.isArray(i)?i:[]];for(const x of n.values||[])c.some(g=>JSON.stringify(g)===JSON.stringify(x))||c.push(x);r=ge(r,a,c);continue}if(n&&typeof n=="object"&&n.__op==="arrayRemove"){const i=a.split(".").reduce((x,g)=>x&&typeof x=="object"?x[g]:void 0,r),c=(Array.isArray(i)?i:[]).filter(x=>!(n.values||[]).some(g=>JSON.stringify(x)===JSON.stringify(g)));r=ge(r,a,c);continue}r=ge(r,a,n)}return r}async function Ie(t){le();const{data:s,error:r}=await Q.from(xe).select("collection_path,id,data").eq("collection_path",t.collection_path).eq("id",t.id).maybeSingle();if(r)throw r;return Wt(s||null)}async function xt(t,s,r={}){le();const a=!!r.merge;let n=s;if(a){const u=await Ie(t);n=Ot(u.exists()?u.data():{},s||{})}const{error:i}=await Q.from(xe).upsert({collection_path:t.collection_path,id:t.id,data:n||{},updated_at:new Date().toISOString()},{onConflict:"collection_path,id"});if(i)throw i}async function ht(t,s){le();const r=await Ie(t);if(!r.exists())throw new Error(`Document does not exist: ${t.collection_path}/${t.id}`);const a=mt(r.data(),s);await xt(t,a,{merge:!1})}function Qt(){var t,s;return((s=(t=globalThis.crypto)==null?void 0:t.randomUUID)==null?void 0:s.call(t))||`id_${Math.random().toString(16).slice(2)}${Date.now().toString(16)}`}async function Gs(t,s){le();const r=Qt(),a={__type:"doc",collection_path:t.collection_path,id:r},n=mt(s||{},{}),{error:i}=await Q.from(xe).insert({collection_path:a.collection_path,id:a.id,data:n,created_at:new Date().toISOString(),updated_at:new Date().toISOString()});if(i)throw i;return{id:a.id,...a}}async function Yt(t){le();const{error:s}=await Q.from(xe).delete().eq("collection_path",t.collection_path).eq("id",t.id);if(s)throw s}function Jt(t,s){let r=[...t||[]];const a=s.filter(c=>(c==null?void 0:c.__type)==="where"),n=s.find(c=>(c==null?void 0:c.__type)==="orderBy"),i=s.find(c=>(c==null?void 0:c.__type)==="limit"),u=(c,x)=>{const g=String(x).split(".").filter(Boolean);let p=c==null?void 0:c.data;for(const N of g){if(!p||typeof p!="object")return;p=p[N]}return p};for(const c of a){const{field:x,op:g,value:p}=c;r=r.filter(N=>{const o=u(N,x);switch(g){case"==":return o===p;case"!=":return o!==p;case">":return o>p;case">=":return o>=p;case"<":return o<p;case"<=":return o<=p;case"in":return Array.isArray(p)?p.includes(o):!1;case"array-contains":return Array.isArray(o)?o.includes(p):!1;case"array-contains-any":return Array.isArray(o)&&Array.isArray(p)?p.some(b=>o.includes(b)):!1;default:return!0}})}if(n){const c=n.direction==="desc"?-1:1,x=n.field;r.sort((g,p)=>{const N=u(g,x),o=u(p,x);return N===o?0:N===void 0?1:o===void 0?-1:N>o?c:-c})}return i&&(r=r.slice(0,Math.max(0,Number(i.n)||0))),r}async function Me(t){le();const s=t&&t.__type==="query",r=s?t.ref:t,a=s?t.constraints||[]:[];let n=Q.from(xe).select("collection_path,id,data");if(r.__type==="collection")n=n.eq("collection_path",r.collection_path);else if(r.__type==="collectionGroup")n=n.like("collection_path",`%/${r.groupId}`);else throw new Error("getDocs expected a collection, collectionGroup, or query");const{data:i,error:u}=await n.limit(1e3);if(u)throw u;const c=Jt(i||[],a);return Ht(c)}async function Kt(t){const s=await Me(t);return{data:()=>({count:s.size})}}function Us(t){const s=[];return{set:(r,a,n)=>s.push({type:"set",docRef:r,data:a,options:n}),update:(r,a)=>s.push({type:"update",docRef:r,data:a}),delete:r=>s.push({type:"delete",docRef:r}),commit:async()=>{for(const r of s)r.type==="set"&&await xt(r.docRef,r.data,r.options),r.type==="update"&&await ht(r.docRef,r.data),r.type==="delete"&&await Yt(r.docRef)}}}function Os(t,s,r){try{le()}catch(u){return r==null||r(u),()=>{}}let a=!1;const n=async()=>{try{if((t==null?void 0:t.__type)==="doc"){const c=await Ie(t);a||s==null||s(c)}else{const c=await Me(t);a||s==null||s(c)}}catch(u){a||r==null||r(u)}};n();let i=null;try{return i=Q.channel(`documents-watch:${Math.random().toString(16).slice(2)}`).on("postgres_changes",{event:"*",schema:"public",table:xe},()=>n()).subscribe(),()=>{a=!0,i&&Q.removeChannel(i)}}catch{const c=setInterval(n,4e3);return()=>{a=!0,clearInterval(c)}}}function oe(){throw new Error("Supabase is not configured (missing VITE_SUPABASE_URL / VITE_SUPABASE_ANON_KEY).")}function Xt(t,s){oe();const{data:r}=Q.auth.onAuthStateChange((a,n)=>{const i=n!=null&&n.user?{...n.user,uid:n.user.id}:null;s(i)});return()=>r.subscription.unsubscribe()}class Bs{constructor(){this.providerId="google",this.params={}}setCustomParameters(s){this.params={...this.params,...s||{}}}}const Vs={credential:(t,s)=>({email:t,password:s})};async function qs(t,s){oe();const{error:r}=await Q.auth.signInWithPassword({email:s.email,password:s.password});if(r)throw r}async function Ws(t,s){oe();const{error:r}=await Q.auth.updateUser({email:s});if(r)throw r}async function Hs(t,s){oe();const{error:r}=await Q.auth.updateUser({password:s});if(r)throw r}async function Qs(t){throw Object.assign(new Error("Account deletion requires a server-side admin endpoint in Supabase."),{code:"auth/admin-required"})}async function Ys(t,s,r){var i;oe();const{data:a,error:n}=await Q.auth.signInWithPassword({email:s,password:r});if(n){const u=(i=n.message)!=null&&i.toLowerCase().includes("invalid")?"auth/wrong-password":"auth/unknown";throw Object.assign(new Error(n.message),{code:u})}return{user:a.user?{...a.user,uid:a.user.id}:null}}async function Js(t,s){oe();const r=(s==null?void 0:s.providerId)||"google",{data:a,error:n}=await Q.auth.signInWithOAuth({provider:r,options:{queryParams:(s==null?void 0:s.params)||{}}});if(n)throw Object.assign(new Error(n.message),{code:"auth/popup"});return{user:a!=null&&a.user?{...a.user,uid:a.user.id}:null}}async function Ks(t){oe();const{error:s}=await Q.auth.signOut();if(s)throw s}const gt={onAuthStateChanged:t=>Xt(gt,t)},O="seshnx-70c04",Zt={id:O},pe={__type:"supabase-firestore-compat"},Xs={bucket:"public"},Zs=gt,es=t=>t?{userProfile:`artifacts/${O}/users/${t}/profiles/main`,userPublicProfile:`artifacts/${O}/users/${t}/public_profile/main`,userWallet:`artifacts/${O}/users/${t}/wallet/account`,followers:`artifacts/${O}/users/${t}/followers`,following:`artifacts/${O}/users/${t}/following`,savedPosts:`artifacts/${O}/users/${t}/saved_posts`,notifications:`artifacts/${O}/users/${t}/notifications`,studentRecord:(s,r)=>`schools/${s}/students/${r}`,labelRoster:()=>`artifacts/${O}/users/${t}/label_roster`,marketplaceItems:`artifacts/${O}/users/${t}/marketplace_items`,userLibrary:`artifacts/${O}/users/${t}/library`,marketAssets:`users/${t}/market_assets`,gearListings:`artifacts/${O}/users/${t}/gear_listings`,distributionReleases:`artifacts/${O}/users/${t}/distribution_releases`,royaltyReports:`artifacts/${O}/users/${t}/royalty_reports`,distributionStats:`artifacts/${O}/distribution/stats/${t}`,equipmentSubmissions:`artifacts/${O}/users/${t}/equipment_submissions`,userSubProfile:s=>`artifacts/${O}/users/${t}/profiles/${s}`,publicProfileCollectionGroup:"public_profile"}:{publicProfileCollectionGroup:"public_profile"},ts=t=>{var r,a;if(!t)return"";const s=t.trim().split(" ").filter(Boolean);return s.length>=2?(s[0][0]+s[1][0]).toUpperCase():s.length===1&&s[0].length>=2?s[0].substring(0,2).toUpperCase():((a=(r=s[0])==null?void 0:r[0])==null?void 0:a.toUpperCase())||""},ss=t=>{if(!t)return"from-brand-blue to-purple-600";const s=["from-brand-blue to-purple-600","from-emerald-500 to-teal-600","from-orange-500 to-red-600","from-pink-500 to-rose-600","from-indigo-500 to-blue-600","from-amber-500 to-orange-600","from-cyan-500 to-blue-600","from-violet-500 to-purple-600"],r=t.split("").reduce((a,n)=>a+n.charCodeAt(0),0);return s[r%s.length]};function me({src:t,name:s,size:r="md",className:a,onClick:n,status:i,isGroup:u=!1,square:c=!1}){const[x,g]=l.useState(!1),N=et(De("relative overflow-hidden flex items-center justify-center shrink-0 bg-gray-200 dark:bg-gray-700 border border-transparent transition-all select-none",c?"rounded-xl":"rounded-full",{xs:"h-6 w-6 text-[10px]",sm:"h-8 w-8 text-xs",md:"h-10 w-10 text-sm",lg:"h-12 w-12 text-base",xl:"h-14 w-14 text-lg","2xl":"h-24 w-24 text-2xl","3xl":"h-32 w-32 text-4xl"}[r],n&&"cursor-pointer hover:opacity-90",a)),o=!t||x,b=ts(s),h=ss(s);return e.jsxs("div",{className:N,onClick:n,role:n?"button":void 0,tabIndex:n?0:void 0,"aria-label":s?`${s}'s avatar`:"User avatar",children:[o?e.jsx("div",{className:`h-full w-full flex items-center justify-center bg-gradient-to-br ${h} text-white font-bold`,children:u?e.jsx(be,{className:"w-1/2 h-1/2","aria-hidden":"true"}):b?e.jsx("span",{"aria-hidden":"true",children:b}):e.jsx(tt,{className:"w-1/2 h-1/2","aria-hidden":"true"})}):e.jsx("img",{src:t,alt:s||"Avatar",className:"h-full w-full object-cover",onError:()=>g(!0),loading:"lazy"}),i&&e.jsx("span",{className:De("absolute bottom-0 right-0 rounded-full border-2 border-white dark:border-gray-900",i==="online"?"bg-green-500":"bg-gray-400",r==="xs"||r==="sm"?"h-2 w-2":"h-3.5 w-3.5"),"aria-label":i==="online"?"Online":"Offline"})]})}const L=jt;wt();const rs=void 0,as="https://placeholder.convex.cloud",er=new Nt(as),J=()=>!!rs,ns="http://localhost:3000",is=()=>{const[t,s]=l.useState(!1),[r,a]=l.useState(null);return{uploadMedia:async(i,u="general")=>{if(!i)return null;s(!0),a(null);try{const c=new FormData;c.append("mediaFile",i),c.append("uploadType",u);const x=await fetch(`${ns}/api/v1/upload-asset`,{method:"POST",body:c});if(!x.ok){const p=await x.json();throw new Error(p.message||`Upload failed with status ${x.status}`)}const g=await x.json();return s(!1),{url:g.url,previewUrl:g.previewUrl,storageRef:g.storageRef,type:i.type.startsWith("video/")?"video":i.type.startsWith("audio/")?"audio":"image",name:i.name}}catch(c){return console.error("Upload failed:",c),a(c.message||"An unknown error occurred during upload."),s(!1),null}},uploading:t,error:r}};function tr(t){const s=l.useRef(!1),r=Y(L.presence.updatePresence);l.useEffect(()=>{if(!t||!J())return;r({userId:t,online:!0,lastSeen:Date.now()}).then(()=>{s.current=!0}).catch(n=>{console.error("Presence online error:",n)});const a=setInterval(()=>{s.current&&r({userId:t,online:!0,lastSeen:Date.now()}).catch(console.error)},3e4);return()=>{clearInterval(a),s.current&&(r({userId:t,online:!1,lastSeen:Date.now()}).catch(console.error),s.current=!1)}},[t])}function pt(t){const s=J(),r=l.useMemo(()=>t&&s?{userId:t}:"skip",[t,s]),a=ue(L.presence.getPresence,r);return a?{online:a.online===!0,lastSeen:a.lastSeen,loading:!1}:{online:!1,lastSeen:null,loading:!J()}}function ls(t){if(!t)return"Never";const s=t,a=Date.now()-s,n=Math.floor(a/6e4),i=Math.floor(n/60),u=Math.floor(i/24);return n<1?"Just now":n<60?`${n}m ago`:i<24?`${i}h ago`:u<7?`${u}d ago`:new Date(s).toLocaleDateString()}function bt({online:t,lastSeen:s,showText:r=!1,size:a="sm"}){const n={xs:"w-1.5 h-1.5",sm:"w-2 h-2",md:"w-2.5 h-2.5"},i={xs:"text-[10px]",sm:"text-xs",md:"text-sm"};return e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsxs("div",{className:"relative",children:[e.jsx(Ve,{className:`${n[a]} ${t?"fill-green-500 text-green-500":"fill-gray-400 text-gray-400"}`}),t&&e.jsx("div",{className:"absolute inset-0 animate-ping",children:e.jsx(Ve,{className:`${n[a]} fill-green-500 opacity-75`})})]}),r&&e.jsx("span",{className:`${i[a]} ${t?"text-green-500":"text-gray-400"} font-medium`,children:t?"Online":ls(s)})]})}function os({conversation:t,activeChat:s,currentUserId:r,onSelect:a,onDelete:n}){const i=t.type==="direct"?t.uid||(t.id.includes("_")?t.id.split("_").find(x=>x!==r):null):null,{online:u,lastSeen:c}=pt(i||"");return e.jsxs("div",{onClick:()=>a(t),className:`group relative flex gap-3 p-4 cursor-pointer transition border-b dark:border-gray-800 hover:bg-gray-50 dark:hover:bg-white/5 ${(s==null?void 0:s.id)===t.id?"bg-blue-50 dark:bg-blue-900/10 border-l-4 border-l-brand-blue":""}`,children:[e.jsxs("div",{className:"relative shrink-0",children:[e.jsx(me,{src:t.photo,name:t.n,size:"lg",isGroup:t.type==="group"}),t.type==="direct"&&i&&e.jsx("div",{className:"absolute -bottom-0.5 -right-0.5",children:e.jsx(bt,{online:u,lastSeen:c,size:"xs"})}),t.uc>0&&e.jsx("div",{className:"absolute -top-1 -right-1 h-5 w-5 bg-brand-blue text-white text-[10px] font-bold flex items-center justify-center rounded-full border-2 border-white dark:border-[#2c2e36]",children:t.uc>99?"99+":t.uc})]}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex justify-between items-baseline mb-1",children:[e.jsx("h4",{className:`text-sm truncate ${t.uc>0?"font-extrabold text-gray-900 dark:text-white":"font-bold text-gray-700 dark:text-gray-300"}`,children:t.n}),e.jsx("span",{className:"text-[10px] text-gray-400 shrink-0 ml-2",children:t.lmt?new Date(t.lmt).toLocaleDateString():""})]}),e.jsxs("p",{className:`text-xs truncate ${t.uc>0?"text-gray-800 dark:text-gray-200 font-medium":"text-gray-500"}`,children:[t.ls===r?"You: ":"",t.lm]})]}),e.jsx("button",{onClick:x=>{x.stopPropagation(),n==null||n(t.id)},className:"absolute right-2 top-1/2 -translate-y-1/2 p-2 bg-white dark:bg-gray-800 shadow-md rounded-full text-gray-400 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-all z-10",children:e.jsx(_e,{size:16})})]})}function sr({user:t,conversations:s=[],activeChat:r,onSelectChat:a}){const[n,i]=l.useState(!1),[u,c]=l.useState(!1),[x,g]=l.useState("direct"),[p,N]=l.useState(!1),[o,b]=l.useState(""),[h,f]=l.useState([]),[k,y]=l.useState(""),[d,S]=l.useState([]),$=Y(L.conversations.createGroupChat),I=Y(L.conversations.deleteConversation),T=async v=>{y(v);const R=v.trim();if(R.length>1){const P=R.toLowerCase(),X=P.charAt(0).toUpperCase()+P.slice(1),ee=Ue(Ke(pe,"public_profile"),ie("firstName",">=",X),ie("firstName","<=",X+"ï£¿")),W=Ue(Ke(pe,"public_profile"),ie("lastName",">=",X),ie("lastName","<=",X+"ï£¿"));try{const[H,G]=await Promise.all([Me(ee),Me(W)]),Z=new Map,te=E=>{const U=E.ref.parent.parent.id;U!==t.uid&&Z.set(U,{id:U,...E.data()})};H.forEach(te),G.forEach(te),S(Array.from(Z.values()))}catch(H){console.error("Search error:",H),S([])}}else S([])},C=v=>{if(x==="direct"){const R=[t.uid,v.id].sort().join("_");a({id:R,uid:v.id,name:`${v.firstName} ${v.lastName}`,type:"direct"}),B()}else x==="add_member"&&(h.find(R=>R.id===v.id)||f(R=>[...R,v]),B())},B=()=>{i(!1),y(""),S([])},z=()=>{b(""),f([]),c(!0)},V=()=>{g("add_member"),i(!0)},q=async()=>{if(!o||h.length===0)return alert("Name and members required.");if(!J()){alert("Chat functionality is not available. Convex is not configured.");return}N(!0);try{const v=h.map(P=>P.id),{chatId:R}=await $({creatorId:t.uid,chatName:o,memberIds:v});c(!1),a({id:R,name:o,type:"group"})}catch(v){console.error("Group creation failed",v),alert("Group creation failed: "+v.message)}finally{N(!1)}},ae=async(v,R)=>{if(window.confirm("Delete this conversation?")){if(!J()){alert("Chat functionality is not available. Convex is not configured.");return}try{await I({userId:t.uid,chatId:R}),(r==null?void 0:r.id)===R&&a(null)}catch(P){console.error(P)}}};return e.jsxs("div",{className:"flex flex-col h-full relative overflow-hidden bg-white dark:bg-[#1f2128]",children:[e.jsxs("div",{className:"p-4 border-b dark:border-gray-700 flex justify-between items-center bg-gray-50 dark:bg-[#23262f] shrink-0",children:[e.jsx("h2",{className:"font-extrabold text-lg dark:text-white tracking-tight",children:"Messages"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:z,className:"p-2 bg-white dark:bg-gray-700 rounded-full shadow-sm hover:text-brand-blue transition",title:"New Group",children:e.jsx(be,{size:18})}),e.jsx("button",{onClick:()=>{g("direct"),i(!0)},className:"p-2 bg-white dark:bg-gray-700 rounded-full shadow-sm hover:text-brand-blue transition",title:"New Chat",children:e.jsx(Te,{size:18})})]})]}),e.jsx("div",{className:"flex-1 overflow-y-auto",children:s.map(v=>e.jsx(os,{conversation:v,activeChat:r,currentUserId:t.uid,onSelect:a,onDelete:R=>{window.confirm("Delete this conversation?")&&ae({},R)}},v.id))}),u&&e.jsxs("div",{className:"absolute inset-0 bg-white dark:bg-[#1f2128] z-20 flex flex-col animate-in slide-in-from-right-10 duration-200",children:[e.jsxs("div",{className:"p-4 border-b dark:border-gray-700 flex items-center gap-3 bg-gray-50 dark:bg-[#23262f]",children:[e.jsx("button",{onClick:()=>c(!1),className:"hover:bg-gray-200 dark:hover:bg-gray-700 p-1 rounded-full",children:e.jsx(st,{size:20})}),e.jsx("h3",{className:"font-bold dark:text-white",children:"New Group"})]}),e.jsxs("div",{className:"p-4 flex-1 overflow-y-auto",children:[e.jsxs("div",{className:"mb-6",children:[e.jsx("label",{className:"text-xs font-bold text-gray-500 uppercase mb-2 block",children:"1. Group Name"}),e.jsx("input",{className:"w-full p-3 border rounded-xl dark:bg-black/20 dark:border-gray-600 dark:text-white focus:ring-2 focus:ring-brand-blue outline-none",placeholder:"Enter group name...",value:o,onChange:v=>b(v.target.value),autoFocus:!0})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex justify-between items-center mb-2",children:[e.jsxs("label",{className:"text-xs font-bold text-gray-500 uppercase",children:["2. Members (",h.length,")"]}),e.jsxs("button",{onClick:V,className:"text-xs font-bold text-brand-blue flex items-center gap-1 hover:underline",children:[e.jsx(Te,{size:14})," Add Member"]})]}),e.jsx("div",{className:"space-y-2",children:h.length===0?e.jsx("div",{className:"text-center py-8 border-2 border-dashed dark:border-gray-700 rounded-xl text-gray-400 text-sm",children:"No members selected"}):h.map(v=>e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 dark:bg-white/5 rounded-lg border dark:border-gray-700",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(me,{src:v.photoURL,name:v.firstName,size:"sm"}),e.jsxs("span",{className:"text-sm font-bold dark:text-white",children:[v.firstName," ",v.lastName]})]}),e.jsx("button",{onClick:()=>f(R=>R.filter(P=>P.id!==v.id)),className:"text-gray-400 hover:text-red-500",children:e.jsx(K,{size:16})})]},v.id))})]})]}),e.jsx("div",{className:"p-4 border-t dark:border-gray-700",children:e.jsx("button",{onClick:q,disabled:!o||h.length===0||p,className:"w-full bg-brand-blue text-white py-3.5 rounded-xl font-bold hover:bg-blue-600 disabled:opacity-50 disabled:cursor-not-allowed transition shadow-lg flex justify-center items-center gap-2",children:p?e.jsx(fe,{className:"animate-spin",size:20}):e.jsxs(e.Fragment,{children:["Create Group ",e.jsx(rt,{size:18})]})})})]}),n&&e.jsxs("div",{className:"absolute inset-0 bg-white dark:bg-[#1f2128] z-30 flex flex-col animate-in fade-in duration-200",children:[e.jsxs("div",{className:"p-3 border-b dark:border-gray-700 flex items-center gap-2 bg-white dark:bg-[#1f2128]",children:[e.jsx(Ae,{size:18,className:"text-gray-400 ml-2"}),e.jsx("input",{autoFocus:!0,className:"flex-1 p-2 bg-transparent outline-none dark:text-white placeholder-gray-400",placeholder:"Search...",value:k,onChange:v=>T(v.target.value)}),e.jsx("button",{onClick:B,className:"p-2 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-full",children:e.jsx(K,{size:20,className:"text-gray-500"})})]}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-2",children:[d.length===0&&k.length>1&&e.jsx("div",{className:"text-center py-10 text-gray-400 text-sm",children:"No users found."}),d.map(v=>{const R=x==="add_member"&&h.find(P=>P.id===v.id);return e.jsxs("div",{onClick:()=>C(v),className:`flex items-center gap-3 p-3 hover:bg-gray-50 dark:hover:bg-gray-800 rounded-xl cursor-pointer transition mb-1 ${R?"opacity-50 pointer-events-none":""}`,children:[e.jsx(me,{src:v.photoURL,name:v.firstName,size:"md"}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"text-sm font-bold dark:text-white",children:[v.firstName," ",v.lastName]}),e.jsx("div",{className:"text-xs text-gray-500",children:v.role||"User"})]}),x==="add_member"&&e.jsx(Te,{size:18,className:"text-brand-blue"})]},v.id)})]})]})]})}const ke={Recent:["ðŸ‘","â¤ï¸","ðŸ˜‚","ðŸ˜®","ðŸ˜¢","ðŸ”¥","ðŸŽ‰","ðŸ‘"],Smileys:["ðŸ˜€","ðŸ˜ƒ","ðŸ˜„","ðŸ˜","ðŸ˜†","ðŸ˜…","ðŸ¤£","ðŸ˜‚","ðŸ™‚","ðŸ™ƒ","ðŸ˜‰","ðŸ˜Š","ðŸ˜‡","ðŸ¥°","ðŸ˜","ðŸ¤©","ðŸ˜˜","ðŸ˜—","ðŸ˜š","ðŸ˜™","ðŸ˜‹","ðŸ˜›","ðŸ˜œ","ðŸ¤ª","ðŸ˜","ðŸ¤‘","ðŸ¤—","ðŸ¤­","ðŸ¤«","ðŸ¤”","ðŸ¤","ðŸ¤¨","ðŸ˜","ðŸ˜‘","ðŸ˜¶","ðŸ˜","ðŸ˜’","ðŸ™„","ðŸ˜¬","ðŸ¤¥","ðŸ˜Œ","ðŸ˜”","ðŸ˜ª","ðŸ¤¤","ðŸ˜´","ðŸ˜·","ðŸ¤’","ðŸ¤•","ðŸ¤¢","ðŸ¤®"],Gestures:["ðŸ‘‹","ðŸ¤š","ðŸ–ï¸","âœ‹","ðŸ––","ðŸ‘Œ","ðŸ¤Œ","ðŸ¤","âœŒï¸","ðŸ¤ž","ðŸ¤Ÿ","ðŸ¤˜","ðŸ¤™","ðŸ‘ˆ","ðŸ‘‰","ðŸ‘†","ðŸ–•","ðŸ‘‡","â˜ï¸","ðŸ‘","ðŸ‘Ž","âœŠ","ðŸ‘Š","ðŸ¤›","ðŸ¤œ","ðŸ‘","ðŸ™Œ","ðŸ‘","ðŸ¤²","ðŸ¤","ðŸ™"],Hearts:["â¤ï¸","ðŸ§¡","ðŸ’›","ðŸ’š","ðŸ’™","ðŸ’œ","ðŸ–¤","ðŸ¤","ðŸ¤Ž","ðŸ’”","â¤ï¸â€ðŸ”¥","â¤ï¸â€ðŸ©¹","ðŸ’•","ðŸ’ž","ðŸ’“","ðŸ’—","ðŸ’–","ðŸ’˜","ðŸ’","ðŸ’Ÿ"],Objects:["ðŸ’Ž","ðŸ””","ðŸ”•","ðŸŽµ","ðŸŽ¶","ðŸŽ¤","ðŸŽ§","ðŸ“»","ðŸŽ·","ðŸŽº","ðŸŽ¸","ðŸŽ¹","ðŸŽ®","ðŸ•¹ï¸","ðŸŽ¯","ðŸŽ²","ðŸŽ³","ðŸŽ´","ðŸƒ","ðŸ€„","ðŸŽ°","ðŸ“±","ðŸ“ž","â˜Žï¸","ðŸ“Ÿ","ðŸ“ ","ðŸ’»","ðŸ–¥ï¸","ðŸ–¨ï¸","âŒ¨ï¸","ðŸ–±ï¸","ðŸ–²ï¸","ðŸ•¹ï¸","ðŸ—œï¸","ðŸ’¾","ðŸ’¿","ðŸ“€"],Flags:["ðŸ³ï¸","ðŸ´","ðŸ","ðŸš©","ðŸ³ï¸â€ðŸŒˆ","ðŸ³ï¸â€âš§ï¸","ðŸ‡ºðŸ‡¸","ðŸ‡¬ðŸ‡§","ðŸ‡¨ðŸ‡¦","ðŸ‡¦ðŸ‡º","ðŸ‡«ðŸ‡·","ðŸ‡©ðŸ‡ª","ðŸ‡®ðŸ‡¹","ðŸ‡ªðŸ‡¸","ðŸ‡¯ðŸ‡µ","ðŸ‡°ðŸ‡·","ðŸ‡¨ðŸ‡³","ðŸ‡®ðŸ‡³","ðŸ‡§ðŸ‡·","ðŸ‡²ðŸ‡½"],Music:["ðŸŽµ","ðŸŽ¶","ðŸŽ¤","ðŸŽ§","ðŸ“»","ðŸŽ·","ðŸŽº","ðŸŽ¸","ðŸŽ¹","ðŸ¥","ðŸª˜","ðŸŽ»","ðŸŽª","ðŸŽ­","ðŸŽ¨","ðŸŽ¬","ðŸŽ¤","ðŸŽ§","ðŸŽ¼","ðŸŽ¹"],Reactions:["ðŸ‘","ðŸ‘Ž","â¤ï¸","ðŸ”¥","ðŸ˜‚","ðŸ˜®","ðŸ˜¢","ðŸ‘","ðŸ™Œ","ðŸ¤","ðŸ¤—","ðŸ¤”","ðŸ¤¦","ðŸ¤·","ðŸ™","ðŸ‘€","ðŸ’ª","ðŸ¤˜","âœŒï¸","ðŸ¤ž"]},cs=Object.values(ke).flat();function ds({onSelect:t,onClose:s,position:r="bottom"}){const[a,n]=l.useState("Recent"),[i,u]=l.useState(""),[c,x]=l.useState(()=>{const o=localStorage.getItem("recentEmojis");return o?JSON.parse(o):ke.Recent}),g=l.useMemo(()=>i.trim()?cs.filter(o=>o.includes(i)||i.includes(o)):a==="Recent"?c:ke[a]||[],[i,a,c]),p=o=>{const b=[o,...c.filter(h=>h!==o)].slice(0,8);x(b),localStorage.setItem("recentEmojis",JSON.stringify(b)),t(o),s&&s()},N=Object.keys(ke);return e.jsxs(D.div,{initial:{opacity:0,scale:.95,y:r==="bottom"?-10:10},animate:{opacity:1,scale:1,y:0},exit:{opacity:0,scale:.95},className:`
                absolute ${r==="bottom"?"bottom-full mb-2":"top-full mt-2"} 
                left-0
                w-[340px] bg-white dark:bg-gray-800 
                rounded-2xl shadow-2xl border dark:border-gray-700
                z-50 overflow-hidden
            `,children:[e.jsxs("div",{className:"p-3 border-b dark:border-gray-700",children:[e.jsxs("div",{className:"relative mb-3",children:[e.jsx(Ae,{size:16,className:"absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"}),e.jsx("input",{type:"text",placeholder:"Search emojis...",value:i,onChange:o=>u(o.target.value),className:"w-full pl-9 pr-3 py-2 bg-gray-100 dark:bg-gray-700 rounded-lg text-sm outline-none focus:ring-2 focus:ring-brand-blue dark:text-white"}),i&&e.jsx("button",{onClick:()=>u(""),className:"absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600",children:e.jsx(K,{size:16})})]}),e.jsx("div",{className:"flex gap-1 overflow-x-auto scrollbar-hide",children:N.map(o=>e.jsxs("button",{onClick:()=>n(o),className:`
                                px-3 py-1.5 rounded-lg text-xs font-semibold whitespace-nowrap transition
                                ${a===o?"bg-brand-blue text-white":"bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600"}
                            `,children:[o==="Recent"?e.jsx(Oe,{size:12,className:"inline mr-1"}):null,o]},o))})]}),e.jsx("div",{className:"h-[280px] overflow-y-auto custom-scrollbar p-3",children:g.length===0?e.jsx("div",{className:"flex flex-col items-center justify-center h-full text-gray-400",children:e.jsx("p",{className:"text-sm",children:"No emojis found"})}):e.jsx("div",{className:"grid grid-cols-8 gap-1",children:g.map((o,b)=>e.jsx(D.button,{whileHover:{scale:1.2},whileTap:{scale:.9},onClick:()=>p(o),className:"w-10 h-10 flex items-center justify-center text-xl rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition",children:o},`${o}-${b}`))})})]})}const Xe="demo_key",Ze="https://api.giphy.com/v1/gifs";function us({onSelect:t,onClose:s,position:r="bottom"}){const[a,n]=l.useState(""),[i,u]=l.useState([]),[c,x]=l.useState([]),[g,p]=l.useState(!1),[N,o]=l.useState("trending"),b=l.useRef(null);l.useEffect(()=>{h()},[]),l.useEffect(()=>(a.trim()?(o("search"),b.current&&clearTimeout(b.current),b.current=setTimeout(()=>{f(a)},500)):(o("trending"),u([])),()=>{b.current&&clearTimeout(b.current)}),[a]);const h=async()=>{p(!0);try{const S=await(await fetch(`${Ze}/trending?api_key=${Xe}&limit=24&rating=g`)).json();S.data&&x(S.data)}catch(d){console.error("Giphy trending error:",d)}p(!1)},f=async d=>{if(d.trim()){p(!0);try{const $=await(await fetch(`${Ze}/search?api_key=${Xe}&q=${encodeURIComponent(d)}&limit=24&rating=g`)).json();$.data&&u($.data)}catch(S){console.error("Giphy search error:",S)}p(!1)}},k=d=>{t==null||t({url:d.images.fixed_height.url||d.images.original.url,previewUrl:d.images.preview_gif.url||d.images.fixed_height_small.url,width:d.images.fixed_height.width,height:d.images.fixed_height.height,title:d.title||"GIF"}),s&&s()},y=N==="trending"?c:i;return e.jsxs(D.div,{initial:{opacity:0,scale:.95,y:r==="bottom"?-10:10},animate:{opacity:1,scale:1,y:0},exit:{opacity:0,scale:.95},className:`
                absolute ${r==="bottom"?"bottom-full mb-2":"top-full mt-2"} 
                left-0
                w-[380px] bg-white dark:bg-gray-800 
                rounded-2xl shadow-2xl border dark:border-gray-700
                z-50 overflow-hidden
            `,children:[e.jsx("div",{className:"p-3 border-b dark:border-gray-700",children:e.jsxs("div",{className:"relative",children:[e.jsx(Ae,{size:16,className:"absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"}),e.jsx("input",{type:"text",placeholder:"Search GIFs...",value:a,onChange:d=>n(d.target.value),className:"w-full pl-9 pr-10 py-2 bg-gray-100 dark:bg-gray-700 rounded-lg text-sm outline-none focus:ring-2 focus:ring-brand-blue dark:text-white"}),a&&e.jsx("button",{onClick:()=>n(""),className:"absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600",children:e.jsx(K,{size:16})})]})}),e.jsx("div",{className:"h-[320px] overflow-y-auto custom-scrollbar p-3",children:g?e.jsxs("div",{className:"flex flex-col items-center justify-center h-full",children:[e.jsx(fe,{className:"animate-spin text-brand-blue mb-2",size:24}),e.jsx("p",{className:"text-sm text-gray-500",children:"Loading GIFs..."})]}):y.length===0?e.jsxs("div",{className:"flex flex-col items-center justify-center h-full text-gray-400",children:[e.jsx(vt,{size:32,className:"mb-2 opacity-50"}),e.jsx("p",{className:"text-sm",children:N==="search"?"No GIFs found. Try a different search.":"Loading trending GIFs..."})]}):e.jsx("div",{className:"grid grid-cols-2 gap-2",children:y.map(d=>e.jsxs(D.div,{whileHover:{scale:1.02},whileTap:{scale:.98},onClick:()=>k(d),className:"relative aspect-square rounded-lg overflow-hidden cursor-pointer bg-gray-100 dark:bg-gray-700 group",children:[e.jsx("img",{src:d.images.fixed_height_small.url||d.images.preview_gif.url,alt:d.title,className:"w-full h-full object-cover",loading:"lazy"}),e.jsx("div",{className:"absolute inset-0 bg-black/0 group-hover:bg-black/10 transition"})]},d.id))})}),e.jsx("div",{className:"p-2 border-t dark:border-gray-700 bg-gray-50 dark:bg-gray-900 text-center",children:e.jsxs("p",{className:"text-[10px] text-gray-400",children:["Powered by ",e.jsx("span",{className:"font-bold",children:"GIPHY"})]})})]})}function fs({onRecorded:t,onClose:s,maxDuration:r=60}){const[a,n]=l.useState(!1),[i,u]=l.useState(null),[c,x]=l.useState(0),[g,p]=l.useState(null),[N,o]=l.useState(null),b=l.useRef(null),h=l.useRef(null),f=l.useRef(null),k=l.useRef([]),y=l.useRef(null);l.useEffect(()=>(d(),()=>{S()}),[]);const d=async()=>{try{const z=await navigator.mediaDevices.getUserMedia({video:{facingMode:"user"},audio:!0});h.current=z,b.current&&(b.current.srcObject=z),p(!0),o(null)}catch(z){console.error("Permission error:",z),p(!1),o("Camera/microphone access denied")}},S=()=>{h.current&&(h.current.getTracks().forEach(z=>z.stop()),h.current=null),y.current&&clearInterval(y.current)},$=async()=>{if(!h.current){await d();return}try{k.current=[];const z={mimeType:"video/webm;codecs=vp9,opus",videoBitsPerSecond:25e5};f.current=new MediaRecorder(h.current,z),f.current.ondataavailable=V=>{V.data.size>0&&k.current.push(V.data)},f.current.onstop=()=>{const V=new Blob(k.current,{type:"video/webm"});u(V),n(!1),x(0),y.current&&clearInterval(y.current)},f.current.start(),n(!0),x(0),y.current=setInterval(()=>{x(V=>{const q=V+1;return q>=r&&I(),q})},1e3)}catch(z){console.error("Recording error:",z),o("Failed to start recording")}},I=()=>{f.current&&a&&f.current.stop()},T=()=>{u(null),x(0),n(!1)},C=()=>{if(i){const z=new File([i],`video_${Date.now()}.webm`,{type:"video/webm"});t==null||t(z),S(),s==null||s()}},B=z=>{const V=Math.floor(z/60),q=z%60;return`${V}:${q.toString().padStart(2,"0")}`};return!g&&g!==null?e.jsx("div",{className:"fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-[80] p-4",children:e.jsx(D.div,{initial:{opacity:0,scale:.95},animate:{opacity:1,scale:1},className:"bg-white dark:bg-[#2c2e36] rounded-2xl p-6 max-w-sm",children:e.jsxs("div",{className:"text-center",children:[e.jsx(kt,{size:48,className:"text-red-500 mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-bold dark:text-white mb-2",children:"Camera Access Required"}),e.jsx("p",{className:"text-sm text-gray-500 mb-4",children:"Please allow camera and microphone access to record video messages."}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:s,className:"flex-1 px-4 py-2 bg-gray-100 dark:bg-gray-700 rounded-lg text-sm font-semibold hover:bg-gray-200 transition",children:"Cancel"}),e.jsx("button",{onClick:d,className:"flex-1 px-4 py-2 bg-brand-blue text-white rounded-lg text-sm font-semibold hover:bg-blue-600 transition",children:"Allow Access"})]})]})})}):e.jsx("div",{className:"fixed inset-0 bg-black/90 backdrop-blur-sm flex items-center justify-center z-[80]",children:e.jsxs(D.div,{initial:{opacity:0,scale:.95},animate:{opacity:1,scale:1},className:"relative w-full max-w-2xl aspect-video bg-black rounded-2xl overflow-hidden",children:[e.jsx("video",{ref:b,autoPlay:!0,muted:!0,playsInline:!0,className:"w-full h-full object-cover"}),a&&e.jsxs("div",{className:"absolute top-4 left-1/2 -translate-x-1/2 flex items-center gap-2 bg-red-500 text-white px-4 py-2 rounded-full",children:[e.jsx("div",{className:"w-2 h-2 bg-white rounded-full animate-pulse"}),e.jsx("span",{className:"text-sm font-bold",children:B(c)})]}),e.jsx("div",{className:"absolute bottom-0 left-0 right-0 p-6 bg-gradient-to-t from-black/80 to-transparent",children:e.jsx("div",{className:"flex items-center justify-center gap-4",children:i?e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:T,className:"p-3 bg-white/20 hover:bg-white/30 rounded-full text-white transition",children:e.jsx(K,{size:24})}),e.jsx("button",{onClick:C,className:"p-4 bg-green-500 hover:bg-green-600 rounded-full text-white transition shadow-lg",children:e.jsx(Re,{size:28})}),e.jsx("div",{className:"w-12"})," "]}):e.jsx(e.Fragment,{children:a?e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:T,className:"p-3 bg-white/20 hover:bg-white/30 rounded-full text-white transition",children:e.jsx(K,{size:24})}),e.jsx("button",{onClick:I,className:"p-4 bg-red-500 hover:bg-red-600 rounded-full text-white transition shadow-lg animate-pulse",children:e.jsx(at,{size:28})}),e.jsx("div",{className:"w-12"})," "]}):e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:s,className:"p-3 bg-white/20 hover:bg-white/30 rounded-full text-white transition",children:e.jsx(K,{size:24})}),e.jsx("button",{onClick:$,className:"p-4 bg-red-500 hover:bg-red-600 rounded-full text-white transition shadow-lg",children:e.jsx($e,{size:28})}),e.jsx("div",{className:"w-12"})," "]})})})}),N&&e.jsx("div",{className:"absolute top-4 left-4 bg-red-500 text-white px-4 py-2 rounded-lg text-sm",children:N})]})})}function ms(t,s,r){const a=l.useRef(null),n=l.useRef(!1),i=J(),u=l.useMemo(()=>t&&i?{chatId:t}:"skip",[t,i]),c=ue(L.presence.getTypingIndicators,u),x=Y(L.presence.updateTypingIndicator),g=Y(L.presence.clearTypingIndicator),p=l.useMemo(()=>c?c.filter(b=>b.userId!==s&&b.isTyping).map(b=>({id:b.userId,name:b.userName})):[],[c,s]),N=l.useCallback(()=>{!t||!s||!i||(n.current||(n.current=!0,x({chatId:t,userId:s,userName:r,isTyping:!0}).catch(console.error)),a.current&&clearTimeout(a.current),a.current=setTimeout(()=>{n.current&&(n.current=!1,g({chatId:t,userId:s}).catch(console.error))},3e3))},[t,s,r,i,x,g]),o=l.useCallback(()=>{!t||!s||!i||(a.current&&clearTimeout(a.current),n.current&&(n.current=!1,g({chatId:t,userId:s}).catch(console.error)))},[t,s,i,g]);return l.useEffect(()=>()=>{a.current&&clearTimeout(a.current),t&&s&&n.current&&i&&g({chatId:t,userId:s}).catch(console.error)},[t,s,i,g]),{typingUsers:p,setTyping:N,clearTyping:o}}function xs(t){return!t||t.length===0?"":t.length===1?`${t[0].name} is typing...`:t.length===2?`${t[0].name} and ${t[1].name} are typing...`:`${t[0].name} and ${t.length-1} others are typing...`}function hs({activeChatId:t,uid:s,onSend:r,replyingTo:a,editingMessage:n,onCancelReply:i,onCancelEdit:u,typingUsers:c=[],onTyping:x,onStopTyping:g}){const[p,N]=l.useState(""),[o,b]=l.useState(null),[h,f]=l.useState(!1),[k,y]=l.useState(0),[d,S]=l.useState(!1),[$,I]=l.useState(!1),[T,C]=l.useState(!1),[B,z]=l.useState(!1),[V,q]=l.useState(!1),ae=l.useRef(null),v=l.useRef(null),R=l.useRef(null),P=l.useRef([]),X=l.useRef(null),ee=l.useRef(null),W=l.useRef(null),H=l.useRef(null),{uploadMedia:G,uploading:Z}=is();l.useEffect(()=>{var m;n&&(N(n.b||""),(m=v.current)==null||m.focus())},[n]),l.useEffect(()=>{var m;a&&((m=v.current)==null||m.focus())},[a]),l.useEffect(()=>{const m=j=>{X.current&&!X.current.contains(j.target)&&I(!1),ee.current&&!ee.current.contains(j.target)&&C(!1)};return document.addEventListener("mousedown",m),()=>document.removeEventListener("mousedown",m)},[]);const te=async m=>{try{const _=await(await fetch(m.url)).blob(),M=new File([_],`gif_${Date.now()}.gif`,{type:"image/gif"}),F=await G(M,`chat_media/${t}`);if(F){const se={url:F.url,type:"image",name:m.title||"GIF",gif:!0};r("",se)}}catch(j){console.error("GIF upload error:",j),alert("Failed to send GIF")}C(!1)},E=async m=>{try{const j=await G(m,`chat_media/${t}`);if(j){const _={url:j.url,type:"video",name:m.name};r("",_)}}catch(j){console.error("Video upload error:",j),alert("Failed to send video")}z(!1)},U=m=>{N(m.target.value),x&&m.target.value.trim()&&x()},ce=m=>{const j=v.current;if(j){const _=j.selectionStart,M=j.selectionEnd,F=p.substring(0,_)+m+p.substring(M);N(F),setTimeout(()=>{j.selectionStart=j.selectionEnd=_+m.length,j.focus()},0)}else N(_=>_+m)},re=async()=>{try{const m=await navigator.mediaDevices.getUserMedia({audio:!0});R.current=new MediaRecorder(m),P.current=[],y(0),R.current.ondataavailable=j=>P.current.push(j.data),R.current.onstop=()=>{const j=new Blob(P.current,{type:"audio/webm"}),_=new File([j],`voice_note_${Date.now()}.webm`,{type:"audio/webm"});b({file:_,type:"audio",previewUrl:URL.createObjectURL(j),duration:k}),m.getTracks().forEach(M=>M.stop()),W.current&&clearInterval(W.current)},R.current.start(),f(!0),W.current=setInterval(()=>{y(j=>j+1)},1e3)}catch{alert("Microphone access denied. Please allow microphone permissions.")}},de=()=>{R.current&&h&&(R.current.stop(),f(!1),W.current&&clearInterval(W.current))},we=()=>{var m;R.current&&h&&(R.current.stop(),P.current=[],f(!1),y(0),W.current&&clearInterval(W.current),(m=R.current.stream)==null||m.getTracks().forEach(j=>j.stop()))},je=m=>{const j=Math.floor(m/60),_=m%60;return`${j}:${_.toString().padStart(2,"0")}`},ze=()=>{!H.current||!(o!=null&&o.previewUrl)||(V?(H.current.pause(),q(!1)):(H.current.play(),q(!0)))};l.useEffect(()=>()=>{W.current&&clearInterval(W.current),R.current&&h&&R.current.stop()},[]);const he=m=>{m.preventDefault(),m.stopPropagation(),m.type==="dragenter"||m.type==="dragover"?S(!0):S(!1)},Ee=m=>{m.preventDefault(),m.stopPropagation(),S(!1),m.dataTransfer.files&&m.dataTransfer.files[0]&&Ne(m.dataTransfer.files[0])},Ne=m=>{const j=m.type.startsWith("image/")?"image":m.type.startsWith("video/")?"video":m.type.startsWith("audio/")?"audio":"file";b({file:m,type:j,previewUrl:URL.createObjectURL(m)})},ve=async m=>{if(m.preventDefault(),!p.trim()&&!o||Z)return;let j=null;if(o){const _=await G(o.file,`chat_media/${t}`);_&&(j={url:_.url,type:_.type,name:_.name,duration:o.duration})}r(p,j),N(""),b(null),q(!1),g&&g()},w=()=>{n?(N(""),u==null||u()):i==null||i()},A=()=>{var m,j;return n?((m=n.b)==null?void 0:m.substring(0,50))||"Message":a?((j=a.b)==null?void 0:j.substring(0,50))||"Media":""};return e.jsxs("div",{className:`p-3 bg-white dark:bg-[#2c2e36] border-t dark:border-gray-700 shrink-0 transition-colors ${d?"bg-blue-50 dark:bg-blue-900/20 border-blue-400":""}`,onDragEnter:he,onDragLeave:he,onDragOver:he,onDrop:Ee,children:[e.jsx(ne,{children:c.length>0&&e.jsxs(D.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},exit:{opacity:0,y:10},className:"mb-2 px-2 flex items-center gap-2",children:[e.jsxs("div",{className:"flex gap-1",children:[e.jsx("span",{className:"w-1.5 h-1.5 bg-brand-blue rounded-full animate-bounce"}),e.jsx("span",{className:"w-1.5 h-1.5 bg-brand-blue rounded-full animate-bounce",style:{animationDelay:"0.1s"}}),e.jsx("span",{className:"w-1.5 h-1.5 bg-brand-blue rounded-full animate-bounce",style:{animationDelay:"0.2s"}})]}),e.jsx("span",{className:"text-xs text-gray-500 dark:text-gray-400",children:xs(c)})]})}),e.jsx(ne,{children:h&&e.jsx(D.div,{initial:{opacity:0,height:0},animate:{opacity:1,height:"auto"},exit:{opacity:0,height:0},className:"mb-2 p-3 bg-red-50 dark:bg-red-900/20 rounded-xl border border-red-200 dark:border-red-800",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-3 h-3 bg-red-500 rounded-full animate-pulse"}),e.jsx("span",{className:"font-medium text-red-700 dark:text-red-400",children:"Recording..."}),e.jsx("span",{className:"font-mono text-red-600 dark:text-red-300 text-sm",children:je(k)})]}),e.jsx("div",{className:"flex items-center gap-0.5 mx-4",children:[...Array(20)].map((m,j)=>e.jsx(D.div,{className:"w-1 bg-red-400 rounded-full",animate:{height:[8,Math.random()*20+8,8]},transition:{duration:.5,repeat:1/0,delay:j*.05}},j))}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{type:"button",onClick:we,className:"p-2 text-red-600 hover:bg-red-100 dark:hover:bg-red-900/40 rounded-full transition",title:"Cancel recording",children:e.jsx(_e,{size:18})}),e.jsx("button",{type:"button",onClick:de,className:"p-2 bg-red-500 text-white rounded-full hover:bg-red-600 transition",title:"Stop recording",children:e.jsx(St,{size:16,fill:"white"})})]})]})})}),e.jsx(ne,{children:(a||n)&&e.jsxs(D.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},exit:{opacity:0,y:-10},className:"flex justify-between items-center bg-gray-100 dark:bg-gray-800 p-2.5 px-4 rounded-xl border-l-4 border-brand-blue mb-2",children:[e.jsxs("div",{className:"flex items-center gap-3 flex-1 min-w-0",children:[n?e.jsx(nt,{size:16,className:"text-brand-blue shrink-0"}):e.jsx(it,{size:16,className:"text-brand-blue shrink-0"}),e.jsxs("div",{className:"min-w-0",children:[e.jsx("span",{className:"text-xs font-bold text-brand-blue block",children:n?"Editing Message":`Replying to ${(a==null?void 0:a.n)||"User"}`}),e.jsx("span",{className:"text-xs text-gray-500 dark:text-gray-400 truncate block",children:A()})]})]}),e.jsx("button",{onClick:w,className:"p-1 hover:bg-gray-200 dark:hover:bg-gray-700 rounded-full transition",children:e.jsx(K,{size:16,className:"text-gray-400 hover:text-red-500"})})]})}),e.jsx(ne,{children:o&&e.jsxs(D.div,{initial:{opacity:0,scale:.95},animate:{opacity:1,scale:1},exit:{opacity:0,scale:.95},className:"flex items-center gap-3 p-3 bg-gray-100 dark:bg-gray-800 rounded-xl mb-2 border dark:border-gray-700",children:[o.type==="image"?e.jsx("img",{src:o.previewUrl,className:"h-14 w-14 object-cover rounded-lg"}):o.type==="video"?e.jsx("video",{src:o.previewUrl,className:"h-14 w-14 object-cover rounded-lg"}):o.type==="audio"?e.jsxs("div",{className:"flex items-center gap-3 flex-1",children:[e.jsx("button",{type:"button",onClick:ze,className:"h-12 w-12 bg-purple-500 text-white flex items-center justify-center rounded-full hover:bg-purple-600 transition shrink-0",children:V?e.jsx(lt,{size:20}):e.jsx(ot,{size:20,className:"ml-0.5"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(qe,{size:14,className:"text-purple-500"}),e.jsx("span",{className:"text-sm font-bold dark:text-white",children:"Voice Message"})]}),e.jsxs("div",{className:"flex items-center gap-2 mt-1",children:[e.jsx("div",{className:"flex items-center gap-0.5 flex-1",children:[...Array(30)].map((m,j)=>e.jsx("div",{className:"w-1 bg-purple-300 dark:bg-purple-700 rounded-full",style:{height:`${Math.random()*12+4}px`}},j))}),e.jsx("span",{className:"text-xs text-gray-500 font-mono",children:o.duration?je(o.duration):"0:00"})]})]}),e.jsx("audio",{ref:H,src:o.previewUrl,onEnded:()=>q(!1),className:"hidden"})]}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"h-14 w-14 bg-gray-200 dark:bg-gray-700 text-gray-500 flex items-center justify-center rounded-lg",children:e.jsx(ye,{size:24})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:"text-sm font-bold dark:text-white truncate",children:o.file.name}),e.jsxs("div",{className:"text-xs text-gray-500",children:[(o.file.size/1024).toFixed(1)," KB"]})]})]}),e.jsx("button",{onClick:()=>{b(null),q(!1)},className:"p-2 hover:bg-gray-200 dark:hover:bg-gray-700 rounded-full transition shrink-0",children:e.jsx(K,{size:18,className:"text-gray-400 hover:text-red-500"})})]})}),e.jsxs("form",{onSubmit:ve,className:"flex items-end gap-2",children:[e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:"file",ref:ae,className:"hidden",accept:"image/*,audio/*,video/*,.pdf,.doc,.docx,.txt,.zip",onChange:m=>Ne(m.target.files[0])}),e.jsx("button",{type:"button",onClick:()=>{var m;return(m=ae.current)==null?void 0:m.click()},className:"p-2.5 text-gray-500 hover:text-brand-blue hover:bg-gray-100 dark:hover:bg-gray-700 rounded-full transition shrink-0",title:"Attach file",children:e.jsx(_t,{size:20})})]}),e.jsxs("div",{className:"flex items-center gap-1 border-r dark:border-gray-700 pr-2",children:[e.jsx("button",{type:"button",onClick:()=>{z(!0),I(!1),C(!1)},className:"p-2 text-gray-500 hover:text-red-500 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-full transition",title:"Record video",children:e.jsx($e,{size:18})}),e.jsxs("button",{type:"button",onClick:()=>{C(!T),I(!1)},className:"p-2 text-gray-500 hover:text-purple-500 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-full transition relative",title:"GIF",ref:ee,children:[e.jsx(Rt,{size:18}),T&&e.jsx(us,{onSelect:te,onClose:()=>C(!1),position:"bottom"})]})]}),e.jsxs("div",{className:"flex-1 bg-gray-100 dark:bg-[#1f2128] rounded-2xl border dark:border-gray-700 focus-within:ring-2 focus-within:ring-brand-blue transition-all flex items-end relative",children:[e.jsx("textarea",{ref:v,className:"w-full bg-transparent p-3 max-h-32 min-h-[44px] text-sm resize-none outline-none dark:text-white custom-scrollbar pr-20",placeholder:n?"Update message...":d?"Drop files here...":"Type a message...",value:p,onChange:U,onKeyDown:m=>{m.key==="Enter"&&!m.shiftKey&&(m.preventDefault(),ve(m))},rows:1}),e.jsxs("div",{className:"absolute right-2 bottom-1.5 flex items-center gap-1",children:[e.jsxs("div",{className:"relative",ref:X,children:[e.jsx("button",{type:"button",onClick:()=>{I(!$),C(!1)},className:`p-1.5 rounded-full transition ${$?"bg-brand-blue/20 text-brand-blue":"text-gray-400 hover:text-gray-600 dark:hover:text-gray-300"}`,title:"Emoji",children:e.jsx(Mt,{size:18})}),e.jsx(ne,{children:$&&e.jsx(ds,{onSelect:ce,onClose:()=>I(!1),position:"bottom"})})]}),e.jsx("button",{type:"button",onClick:h?de:re,className:`p-1.5 rounded-full transition ${h?"bg-red-500 text-white animate-pulse":"text-gray-400 hover:text-gray-600 dark:hover:text-gray-300"}`,children:h?e.jsx(at,{size:18}):e.jsx(qe,{size:18})})]})]}),e.jsx("button",{type:"submit",disabled:!p.trim()&&!o||Z,className:`p-2.5 text-white rounded-full shadow-lg disabled:opacity-50 disabled:cursor-not-allowed transition-all shrink-0 ${n?"bg-green-600 hover:bg-green-700":"bg-brand-blue hover:bg-blue-600"}`,children:Z?e.jsx(fe,{size:20,className:"animate-spin"}):n?e.jsx(At,{size:20}):e.jsx($t,{size:20})})]}),B&&e.jsx(fs,{onRecorded:E,onClose:()=>z(!1),maxDuration:60})]})}function gs(...t){return et(De(t))}const Se=It.forwardRef(({className:t,variant:s="default",size:r="default",...a},n)=>{const i={default:"bg-blue-600 text-white hover:bg-blue-700 shadow-sm",destructive:"bg-red-500 text-white hover:bg-red-600 shadow-sm",outline:"border border-gray-200 bg-transparent hover:bg-gray-100 text-gray-900",secondary:"bg-gray-100 text-gray-900 hover:bg-gray-200",ghost:"hover:bg-gray-100 hover:text-gray-900 text-gray-600",link:"text-blue-600 underline-offset-4 hover:underline"},u={default:"h-9 px-4 py-2",sm:"h-8 rounded-md px-3 text-xs",lg:"h-10 rounded-md px-8",icon:"h-9 w-9"};return e.jsx("button",{ref:n,className:gs("inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-gray-950 disabled:pointer-events-none disabled:opacity-50",i[s],u[r],t),...a})});Se.displayName="Button";function ps({url:t,isOpen:s,onClose:r,previewData:a}){if(!s||!t)return null;const n=new URL(t).pathname;let i="Content";n.startsWith("/profile/")?i="User Profile":n.startsWith("/session/")?i="Session Details":n.startsWith("/studio/")&&(i="Studio Listing");const u=(a==null?void 0:a.title)||`${i} Preview`;return e.jsx("div",{className:"fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black bg-opacity-70 backdrop-blur-sm",onClick:r,children:e.jsxs("div",{className:"bg-gray-900 rounded-xl shadow-2xl w-full max-w-2xl h-3/4 max-h-[800px] flex flex-col transform transition-all duration-300 scale-100 opacity-100",onClick:c=>c.stopPropagation(),children:[e.jsxs("div",{className:"flex items-center justify-between p-4 border-b border-gray-700 bg-gray-800 rounded-t-xl sticky top-0",children:[e.jsx("h3",{className:"text-xl font-bold text-white truncate max-w-[80%]",children:u}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("a",{href:t,target:"_blank",rel:"noopener noreferrer",children:e.jsx(Se,{variant:"ghost",size:"icon",className:"text-blue-400 hover:text-blue-300",children:e.jsx(zt,{className:"w-5 h-5"})})}),e.jsx(Se,{onClick:r,variant:"ghost",size:"icon",className:"text-white hover:bg-gray-700",children:e.jsx(K,{className:"w-5 h-5"})})]})]}),e.jsxs("div",{className:"flex-1 p-4 overflow-y-auto custom-scrollbar text-gray-400 flex flex-col items-center justify-center text-center",children:[e.jsx("p",{className:"mb-4 text-lg font-medium text-white",children:"Embedded Content Simulation"}),e.jsx("p",{className:"mb-2",children:"This is where the actual SeshNx content (e.g., profile card, session details) would be rendered, based on the URL:"}),e.jsx("a",{href:t,target:"_blank",rel:"noopener noreferrer",className:"text-blue-400 hover:underline break-all p-2 bg-gray-700 rounded-lg text-sm",children:t}),e.jsx("p",{className:"mt-4 text-sm",children:'In a real implementation, you would use a dedicated component (e.g., `ProfileCard id="..."`) here instead of an iframe to display the content securely and natively.'})]}),e.jsx("div",{className:"p-3 border-t border-gray-700 bg-gray-800 rounded-b-xl flex justify-end",children:e.jsx(Se,{onClick:r,variant:"secondary",children:"Done"})})]})})}function bs({status:t="sent",size:s=12,className:r=""}){const a={sending:{icon:Oe,color:"text-gray-400",animate:!0},sent:{icon:Re,color:"text-gray-400",animate:!1},delivered:{icon:We,color:"text-gray-400",animate:!1},read:{icon:We,color:"text-brand-blue",animate:!1}},n=a[t]||a.sent,i=n.icon;return e.jsx(D.div,{animate:n.animate?{rotate:[0,360]}:{},transition:n.animate?{duration:2,repeat:1/0,ease:"linear"}:{},className:`inline-flex items-center ${n.color} ${r}`,children:e.jsx(i,{size:s,className:t==="read"?"fill-current":""})})}function ys({audioUrl:t,color:s="brand-blue",height:r=40}){const a=l.useRef(null),n=l.useRef(null),i=l.useRef(null),u=l.useRef(null),c=l.useRef(null),[x,g]=l.useState(!1);l.useEffect(()=>{if(!t||!a.current)return;const o=a.current,b=o.getContext("2d"),h=new Audio(t);n.current=h,o.width=o.offsetWidth,o.height=r;const f=new(window.AudioContext||window.webkitAudioContext),k=f.createAnalyser(),y=f.createMediaElementSource(h);k.fftSize=256,y.connect(k),k.connect(f.destination),u.current=f,c.current=k;const d=k.frequencyBinCount,S=new Uint8Array(d),$=()=>{if(h.paused){p(b,o.width,o.height);return}i.current=requestAnimationFrame($),k.getByteFrequencyData(S),b.clearRect(0,0,o.width,o.height);const I=o.width/d*2;let T=0;for(let C=0;C<d;C++){const B=S[C]/255*o.height,z=b.createLinearGradient(0,0,0,o.height);z.addColorStop(0,"#3b82f6"),z.addColorStop(1,"#8b5cf6"),b.fillStyle=z,b.fillRect(T,o.height-B,I-1,B),T+=I}};return h.addEventListener("play",()=>{g(!0),$()}),h.addEventListener("pause",()=>{g(!1),i.current&&cancelAnimationFrame(i.current),p(b,o.width,o.height)}),h.addEventListener("ended",()=>{g(!1),i.current&&cancelAnimationFrame(i.current),p(b,o.width,o.height)}),p(b,o.width,o.height),()=>{var I;i.current&&cancelAnimationFrame(i.current),h.pause(),(I=u.current)==null||I.close()}},[t,r,x]);const p=(o,b,h)=>{o.clearRect(0,0,b,h),o.fillStyle="#3b82f6";const f=50,k=b/f,y=2;for(let d=0;d<f;d++){const S=Math.random()*h*.3+h*.1,$=d*k;o.fillRect($,h-S,k-y,S)}},N=()=>{n.current&&(x?n.current.pause():n.current.play())};return e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("button",{onClick:N,className:"w-10 h-10 flex items-center justify-center bg-brand-blue text-white rounded-full hover:bg-blue-600 transition shrink-0",children:x?e.jsx(lt,{size:16}):e.jsx(ot,{size:16,className:"ml-0.5"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("canvas",{ref:a,className:"w-full rounded",style:{height:`${r}px`}}),e.jsx("audio",{ref:n,src:t})]})]})}const ws=["ðŸ‘","â¤ï¸","ðŸ˜‚","ðŸ˜®","ðŸ˜¢","ðŸ”¥"];function js({message:t,isCurrentUser:s,previousMessage:r,currentUserId:a,chatId:n,linkPreviewData:i,messageStatus:u="sent",onReaction:c,onReply:x,onEdit:g,onDelete:p,onForward:N,onSeshNxLinkClick:o,onUserClick:b}){var te;const[h,f]=l.useState(!1),[k,y]=l.useState(!1),[d,S]=l.useState(!1),$=l.useRef(null),I=l.useRef(null),T=!r||r.s!==t.s,C=r&&new Date(t.t).toDateString()===new Date(r.t).toDateString(),B=t.t||Date.now(),z=(r==null?void 0:r.t)||0,V=r&&B-z>3e5,q=!C||!r,ae=T||V,v=!s&&T,R=new Date(t.t||Date.now());l.useEffect(()=>{const E=U=>{$.current&&!$.current.contains(U.target)&&(f(!1),y(!1))};return document.addEventListener("mousedown",E),()=>document.removeEventListener("mousedown",E)},[]);const P=()=>{navigator.clipboard.writeText(t.b||""),S(!0),setTimeout(()=>S(!1),2e3),f(!1)},X=E=>{c==null||c(t.id,E),y(!1),f(!1)},ee=t.reactions?Object.entries(t.reactions).reduce((E,[U,ce])=>{const re=typeof ce=="object"?Object.keys(ce).length:0;return re>0&&(E[U]=re),E},{}):{},W=Object.keys(ee).length>0,H=t.reactions?(te=Object.entries(t.reactions).find(([E,U])=>typeof U=="object"&&U[a]))==null?void 0:te[0]:null,G=s?"bg-brand-blue text-white rounded-br-sm":"bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-white rounded-bl-sm";if(t.deleted||t.deletedForAll)return e.jsx("div",{className:`flex ${s?"justify-end":"justify-start"} ${T?"mt-3":"mt-0.5"}`,children:e.jsx("div",{className:"px-4 py-2 rounded-2xl bg-gray-100 dark:bg-gray-800 text-gray-400 italic text-sm",children:"ðŸš« This message was deleted"})});if(t.deletedFor&&t.deletedFor[a])return null;const Z=()=>{var U;if(!i)return null;const E=(U=i.url)==null?void 0:U.includes("app.seshnx.com");return e.jsx("div",{className:"mt-2 block border border-gray-300 dark:border-gray-600 rounded-lg overflow-hidden bg-white dark:bg-gray-800 max-w-[280px]",children:E?e.jsxs("button",{onClick:()=>o==null?void 0:o(i),className:"w-full text-left",children:[i.image&&e.jsx("div",{className:"h-28 w-full bg-cover bg-center",style:{backgroundImage:`url(${i.image})`}}),e.jsxs("div",{className:"p-2",children:[e.jsxs("p",{className:"font-semibold text-xs text-brand-blue truncate flex items-center",children:[e.jsx(Tt,{className:"w-3 h-3 mr-1"}),i.title||"SeshNx Link"]}),i.description&&e.jsx("p",{className:"text-[10px] text-gray-500 mt-0.5 line-clamp-2",children:i.description})]})]}):e.jsxs("a",{href:i.url,target:"_blank",rel:"noopener noreferrer",children:[i.image&&e.jsx("div",{className:"h-28 w-full bg-cover bg-center",style:{backgroundImage:`url(${i.image})`}}),e.jsxs("div",{className:"p-2",children:[e.jsx("p",{className:"font-semibold text-xs text-brand-blue truncate",children:i.title||i.url}),i.description&&e.jsx("p",{className:"text-[10px] text-gray-500 mt-0.5 line-clamp-2",children:i.description}),e.jsxs("p",{className:"text-[10px] text-gray-400 mt-1 flex items-center",children:[e.jsx(Ft,{className:"w-2.5 h-2.5 mr-1"}),new URL(i.url).hostname]})]})]})})};return e.jsxs(e.Fragment,{children:[q&&e.jsx("div",{className:"text-center my-4",children:e.jsx("span",{className:"text-[10px] text-gray-400 dark:text-gray-500 font-bold uppercase tracking-wider bg-gray-100 dark:bg-gray-800 px-3 py-1 rounded-full",children:R.toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric"})})}),e.jsxs("div",{className:`group flex items-end gap-2 ${s?"flex-row-reverse":"flex-row"} ${T?"mt-3":"mt-0.5"}`,ref:I,children:[!s&&e.jsx("div",{className:"w-8 shrink-0",children:v&&e.jsx(me,{src:t.photo,name:t.n,size:"xs",className:"cursor-pointer",onClick:()=>b==null?void 0:b(t.s)})}),e.jsxs("div",{className:`relative max-w-[75%] ${s?"items-end":"items-start"}`,children:[!s&&T&&t.n&&e.jsx("p",{className:"text-[10px] font-bold text-gray-500 dark:text-gray-400 mb-1 ml-1",children:t.n}),t.replyTo&&e.jsxs("div",{className:`mb-1 px-3 py-1.5 rounded-lg text-xs border-l-2 border-brand-blue ${s?"bg-blue-400/30 text-blue-100":"bg-gray-200 dark:bg-gray-600 text-gray-600 dark:text-gray-300"}`,children:[e.jsx("p",{className:"font-bold text-[10px] mb-0.5",children:t.replyTo.sender}),e.jsx("p",{className:"truncate opacity-80",children:t.replyTo.text})]}),e.jsxs("div",{className:`relative px-3 py-2 rounded-2xl shadow-sm ${G} cursor-pointer transition-all hover:shadow-md`,onClick:()=>f(!h),children:[t.media&&e.jsxs("div",{className:"mb-2",children:[t.media.type==="image"&&e.jsxs("div",{className:"relative rounded-lg overflow-hidden",children:[t.media.gif&&e.jsx("span",{className:"absolute top-2 left-2 bg-black/60 text-white text-xs px-2 py-0.5 rounded-full font-bold",children:"GIF"}),e.jsx("img",{src:t.media.url,alt:"Shared",className:"max-w-full h-auto rounded-lg max-h-60 object-cover"})]}),t.media.type==="video"&&e.jsx("video",{controls:!0,src:t.media.url,className:"max-w-full h-auto rounded-lg max-h-60"}),t.media.type==="audio"&&e.jsx("div",{className:"bg-gray-50 dark:bg-gray-800 rounded-lg p-3 max-w-[280px]",children:e.jsx(ys,{audioUrl:t.media.url,height:50})}),t.media.type==="file"&&e.jsxs("a",{href:t.media.url,target:"_blank",rel:"noopener noreferrer",download:t.media.name,className:"flex items-center gap-3 p-3 bg-gray-50 dark:bg-gray-800 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition group",children:[e.jsx("div",{className:"w-10 h-10 bg-blue-100 dark:bg-blue-900/30 rounded-lg flex items-center justify-center shrink-0",children:e.jsx(ye,{size:20,className:"text-blue-600 dark:text-blue-400"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"text-sm font-semibold dark:text-white truncate",children:t.media.name||"File"}),e.jsx("p",{className:"text-xs text-gray-500",children:"Click to download"})]}),e.jsx(Be,{size:18,className:"text-gray-400 group-hover:text-brand-blue transition shrink-0"})]})]}),t.b&&e.jsx("p",{className:"text-sm break-words whitespace-pre-wrap leading-relaxed",children:t.b}),t.b&&Z(),t.edited&&e.jsx("span",{className:`text-[9px] ${s?"text-blue-200":"text-gray-400"} ml-1`,children:"(edited)"})]}),W&&e.jsx("div",{className:`flex flex-wrap gap-1 mt-1 ${s?"justify-end":"justify-start"}`,children:Object.entries(ee).map(([E,U])=>e.jsxs(D.button,{initial:{scale:0},animate:{scale:1},onClick:()=>X(E),className:`flex items-center gap-0.5 px-1.5 py-0.5 rounded-full text-xs border transition-all ${H===E?"bg-brand-blue/20 border-brand-blue text-brand-blue":"bg-gray-100 dark:bg-gray-700 border-gray-200 dark:border-gray-600 hover:border-gray-300"}`,children:[e.jsx("span",{children:E}),e.jsx("span",{className:"text-[10px] font-bold",children:U})]},E))}),ae&&e.jsxs("div",{className:`flex items-center gap-1 mt-1 ${s?"justify-end":"justify-start"}`,children:[e.jsx("span",{className:"text-[10px] text-gray-400",children:R.toLocaleTimeString("en-US",{hour:"numeric",minute:"2-digit"})}),s&&e.jsx(bs,{status:u,size:10,className:"ml-0.5"})]}),e.jsx(ne,{children:h&&e.jsxs(D.div,{ref:$,initial:{opacity:0,scale:.9,y:-10},animate:{opacity:1,scale:1,y:0},exit:{opacity:0,scale:.9,y:-10},className:`absolute z-50 ${s?"right-0":"left-0"} bottom-full mb-2 bg-white dark:bg-gray-800 rounded-xl shadow-xl border dark:border-gray-700 overflow-hidden min-w-[180px]`,children:[e.jsx("div",{className:"flex justify-center gap-1 p-2 border-b dark:border-gray-700 bg-gray-50 dark:bg-gray-900",children:ws.map(E=>e.jsx(D.button,{whileHover:{scale:1.2},whileTap:{scale:.9},onClick:()=>X(E),className:`text-lg p-1 rounded-full transition ${H===E?"bg-brand-blue/20":"hover:bg-gray-200 dark:hover:bg-gray-700"}`,children:E},E))}),e.jsxs("div",{className:"p-1",children:[e.jsxs("button",{onClick:()=>{x==null||x(t),f(!1)},className:"w-full flex items-center gap-3 px-3 py-2 text-sm text-left hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition",children:[e.jsx(it,{size:16,className:"text-gray-400"}),e.jsx("span",{className:"dark:text-gray-200",children:"Reply"})]}),e.jsxs("button",{onClick:P,className:"w-full flex items-center gap-3 px-3 py-2 text-sm text-left hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition",children:[e.jsx(Et,{size:16,className:"text-gray-400"}),e.jsx("span",{className:"dark:text-gray-200",children:d?"Copied!":"Copy"})]}),e.jsxs("button",{onClick:()=>{N==null||N(t),f(!1)},className:"w-full flex items-center gap-3 px-3 py-2 text-sm text-left hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition",children:[e.jsx(Le,{size:16,className:"text-gray-400"}),e.jsx("span",{className:"dark:text-gray-200",children:"Forward"})]}),s&&e.jsxs(e.Fragment,{children:[e.jsxs("button",{onClick:()=>{g==null||g(t),f(!1)},className:"w-full flex items-center gap-3 px-3 py-2 text-sm text-left hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition",children:[e.jsx(nt,{size:16,className:"text-gray-400"}),e.jsx("span",{className:"dark:text-gray-200",children:"Edit"})]}),e.jsxs("button",{onClick:()=>{p==null||p(t,"everyone"),f(!1)},className:"w-full flex items-center gap-3 px-3 py-2 text-sm text-left hover:bg-red-50 dark:hover:bg-red-900/20 rounded-lg transition text-red-500",children:[e.jsx(_e,{size:16}),e.jsx("span",{children:"Delete for Everyone"})]})]}),e.jsxs("button",{onClick:()=>{p==null||p(t,"me"),f(!1)},className:"w-full flex items-center gap-3 px-3 py-2 text-sm text-left hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition text-gray-500",children:[e.jsx(_e,{size:16}),e.jsx("span",{children:"Delete for Me"})]})]})]})})]}),s&&e.jsx("div",{className:"w-8 shrink-0"})]})]})}function Ns({message:t,conversations:s,currentUserId:r,onForward:a,onClose:n}){const[i,u]=l.useState(""),[c,x]=l.useState([]),[g,p]=l.useState(!1),N=i.trim()?s.filter(f=>{var k;return(k=f.n)==null?void 0:k.toLowerCase().includes(i.toLowerCase())}):s,o=f=>{x(k=>k.includes(f)?k.filter(y=>y!==f):[...k,f])},b=async()=>{if(c.length!==0){p(!0);try{await a(t,c),n()}catch(f){console.error("Forward error:",f),alert("Failed to forward message")}p(!1)}},h=()=>{var f;return t.media?t.media.type==="image"?"ðŸ“· Image":t.media.type==="video"?"ðŸŽ¥ Video":t.media.type==="audio"?"ðŸŽµ Audio":"ðŸ“Ž File":((f=t.b)==null?void 0:f.substring(0,100))||"Message"};return e.jsx("div",{className:"fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-[80] p-4",children:e.jsxs(D.div,{initial:{opacity:0,scale:.95,y:20},animate:{opacity:1,scale:1,y:0},exit:{opacity:0,scale:.95,y:20},className:"bg-white dark:bg-[#2c2e36] rounded-2xl shadow-2xl w-full max-w-md max-h-[80vh] flex flex-col overflow-hidden",children:[e.jsxs("div",{className:"p-4 border-b dark:border-gray-700 flex items-center justify-between shrink-0",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(Le,{className:"text-brand-blue",size:20}),e.jsx("h3",{className:"font-bold text-lg dark:text-white",children:"Forward Message"})]}),e.jsx("button",{onClick:n,className:"p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-500 transition",children:e.jsx(K,{size:20})})]}),e.jsxs("div",{className:"px-4 py-3 bg-gray-50 dark:bg-gray-800 border-b dark:border-gray-700 shrink-0",children:[e.jsx("p",{className:"text-xs text-gray-500 mb-1",children:"Forwarding:"}),e.jsx("div",{className:"bg-white dark:bg-gray-700 p-3 rounded-lg border dark:border-gray-600",children:e.jsx("p",{className:"text-sm dark:text-gray-200 line-clamp-2",children:h()})})]}),e.jsx("div",{className:"px-4 py-3 border-b dark:border-gray-700 shrink-0",children:e.jsxs("div",{className:"relative",children:[e.jsx(Ae,{size:16,className:"absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"}),e.jsx("input",{type:"text",placeholder:"Search conversations...",value:i,onChange:f=>u(f.target.value),className:"w-full pl-9 pr-4 py-2 bg-gray-100 dark:bg-gray-800 rounded-lg text-sm outline-none focus:ring-2 focus:ring-brand-blue dark:text-white transition"})]})}),e.jsx("div",{className:"flex-1 overflow-y-auto custom-scrollbar",children:N.length===0?e.jsx("div",{className:"flex flex-col items-center justify-center py-12 text-gray-500",children:e.jsx("p",{className:"text-sm",children:"No conversations found"})}):N.map(f=>{const k=c.includes(f.id);return e.jsxs(D.div,{whileTap:{scale:.98},onClick:()=>o(f.id),className:`
                                        flex items-center gap-3 p-4 cursor-pointer transition
                                        border-b dark:border-gray-700/50
                                        ${k?"bg-brand-blue/10 dark:bg-brand-blue/20":"hover:bg-gray-50 dark:hover:bg-gray-800"}
                                    `,children:[e.jsxs("div",{className:"relative",children:[e.jsx(me,{src:f.photo,name:f.n,size:"md",isGroup:f.type==="group"}),k&&e.jsx(D.div,{initial:{scale:0},animate:{scale:1},className:"absolute -bottom-1 -right-1 w-5 h-5 bg-brand-blue rounded-full flex items-center justify-center",children:e.jsx(Re,{size:12,className:"text-white"})})]}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("h4",{className:"font-semibold text-sm dark:text-white truncate",children:f.n}),e.jsx("p",{className:"text-xs text-gray-500 truncate",children:f.type==="group"?"Group":"Direct message"})]}),e.jsx("div",{className:`
                                        w-5 h-5 rounded-full border-2 transition
                                        ${k?"border-brand-blue bg-brand-blue":"border-gray-300 dark:border-gray-600"}
                                    `,children:k&&e.jsx(Re,{size:12,className:"text-white m-auto"})})]},f.id)})}),e.jsxs("div",{className:"p-4 border-t dark:border-gray-700 bg-gray-50 dark:bg-[#23262f] shrink-0",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsxs("span",{className:"text-sm text-gray-500",children:[c.length," conversation",c.length!==1?"s":""," selected"]}),c.length>0&&e.jsx("button",{onClick:()=>x([]),className:"text-xs text-brand-blue hover:underline",children:"Clear all"})]}),e.jsx("button",{onClick:b,disabled:c.length===0||g,className:"w-full bg-brand-blue text-white py-3 rounded-xl font-bold hover:bg-blue-600 disabled:opacity-50 disabled:cursor-not-allowed transition flex items-center justify-center gap-2",children:g?e.jsxs(e.Fragment,{children:[e.jsx(fe,{className:"animate-spin",size:18}),"Forwarding..."]}):e.jsxs(e.Fragment,{children:[e.jsx(Le,{size:18}),"Forward"]})})]})]})})}function vs(t,s){var b;const r=l.useMemo(()=>J(),[]),a=l.useMemo(()=>t&&s&&r?{chatId:t}:"skip",[t,s,r]),n=ue(L.readReceipts.getReadReceipts,a),i=Y(L.readReceipts.markAsRead),u=Y(L.readReceipts.markMultipleAsRead),c=l.useMemo(()=>{if(!n)return{};const h={};return n.forEach(f=>{h[f.userId]?f.readAt>h[f.userId].readAt&&(h[f.userId]={lastReadMessageId:f.messageId,readAt:f.readAt}):h[f.userId]={lastReadMessageId:f.messageId,readAt:f.readAt}}),h},[n]),x=((b=c[s])==null?void 0:b.lastReadMessageId)||null,g=l.useCallback(async h=>{if(!(!t||!s||!h||!J()||!i||!u))try{const f=Array.isArray(h)?h:[h];f.length===1?await i({chatId:t,messageId:f[0],userId:s}):await u({chatId:t,messageIds:f,userId:s})}catch(f){console.error("Mark as read error:",f)}},[t,s,i,u]),p=l.useCallback((h,f,k=null)=>{if(!h||!f)return!1;const y=c[f];if(!y||!y.lastReadMessageId)return!1;const d=y.lastReadMessageId;if(d===h)return!0;if(k&&Array.isArray(k)){const S=k.find(I=>I.id===h),$=k.find(I=>I.id===d);if(S&&$&&S.t&&$.t)return S.t<=$.t}return d>=h},[c]),N=l.useCallback(h=>{var f;return((f=c[h])==null?void 0:f.lastReadMessageId)||null},[c]),o=l.useCallback(h=>x===h||x&&x>=h,[x]);return{readReceipts:c,myLastRead:x,markAsRead:g,isMessageRead:p,getLastReadMessage:N,hasCurrentUserRead:o}}function ks(){throw new Error("Supabase is not configured (missing VITE_SUPABASE_URL / VITE_SUPABASE_ANON_KEY).")}function Ss(t){return{__type:"supabase-functions"}}function _s(t,s){return async r=>{ks();const{data:a,error:n}=await Q.functions.invoke(String(s),{body:r||{}});if(n)throw n;return{data:a}}}const Fe=new Map,Rs=5*60*1e3;async function Ms(t){const s=t.match(/(https?:\/\/[^\s]+)/);if(!s)return null;const r=s[0],a=Fe.get(r);if(a&&Date.now()-a.timestamp<Rs)return a.data;try{const i=Ss(Zt),c=await _s(i,"getLinkPreview")({url:r});if(c.data)return Fe.set(r,{data:c.data,timestamp:Date.now()}),c.data}catch(i){console.warn("Firebase getLinkPreview unavailable, using fallback:",i.message)}const n=await As(r);return Fe.set(r,{data:n,timestamp:Date.now()}),n}async function As(t){const s={url:t,title:null,description:null,image:null,siteName:null};try{const r=new URL(t),a=r.hostname.toLowerCase();if(a.includes("youtube.com")||a.includes("youtu.be")){let n=null;a.includes("youtu.be")?n=r.pathname.slice(1):n=r.searchParams.get("v"),s.siteName="YouTube",s.title="YouTube Video",s.description="Watch this video on YouTube",n&&(s.image=`https://img.youtube.com/vi/${n}/mqdefault.jpg`)}else if(a.includes("spotify.com"))s.siteName="Spotify",s.title="Spotify Content",s.description="Listen on Spotify",s.image="https://storage.googleapis.com/pr-newsroom-wp/1/2018/11/Spotify_Logo_RGB_Green.png";else if(a.includes("soundcloud.com"))s.siteName="SoundCloud",s.title="SoundCloud Track",s.description="Listen on SoundCloud",s.image="https://soundcloud.com/press/assets/press-kit/soundcloud-logo.png";else if(a.includes("github.com")){const n=r.pathname.split("/").filter(i=>i);s.siteName="GitHub",s.title=n.length>=2?`${n[0]}/${n[1]}`:"GitHub Repository",s.description="View on GitHub",n.length>=2&&(s.image=`https://opengraph.githubassets.com/1/${n[0]}/${n[1]}`)}else if(a.includes("twitter.com")||a.includes("x.com"))s.siteName="X (Twitter)",s.title="Tweet",s.description="View on X";else if(a.includes("instagram.com"))s.siteName="Instagram",s.title="Instagram Post",s.description="View on Instagram";else if(a.includes("app.seshnx.com")||a.includes("seshnx.com"))s.siteName="SeshNx",s.title="SeshNx Link",s.description="View on SeshNx platform",s.image="https://app.seshnx.com/pwa-512x512.png";else if(a.includes("linkedin.com"))s.siteName="LinkedIn",s.title="LinkedIn Post",s.description="View on LinkedIn";else if(a.includes("music.apple.com"))s.siteName="Apple Music",s.title="Apple Music",s.description="Listen on Apple Music";else if(a.includes("tiktok.com"))s.siteName="TikTok",s.title="TikTok Video",s.description="Watch on TikTok";else if(a.includes("vimeo.com"))s.siteName="Vimeo",s.title="Vimeo Video",s.description="Watch on Vimeo";else if(a.includes("bandcamp.com")){const n=a.split(".")[0];s.siteName="Bandcamp",s.title=n!=="bandcamp"?`${n} on Bandcamp`:"Bandcamp",s.description="Listen on Bandcamp"}else s.siteName=a.replace("www.",""),s.title=a.replace("www.",""),s.description=`Visit ${a}`;return s}catch(r){return console.warn("Link preview parsing error:",r),{url:t,title:t,description:null,image:null}}}function rr({user:t,userData:s,activeChat:r,conversations:a,onBack:n,toggleDetails:i,openPublicProfile:u}){const[c,x]=l.useState({}),[g,p]=l.useState({isOpen:!1,url:"",previewData:null}),[N,o]=l.useState(null),[b,h]=l.useState(null),[f,k]=l.useState(null),y=l.useRef(null),d=r==null?void 0:r.id,S=(r==null?void 0:r.name)||(r==null?void 0:r.n)||"Unknown User",$=l.useMemo(()=>(r==null?void 0:r.type)==="group"?null:r!=null&&r.uid?r.uid:d&&d.includes("_")?d.split("_").find(A=>A!==(t==null?void 0:t.uid)):null,[r,d,t==null?void 0:t.uid]),{online:I,lastSeen:T,loading:C}=pt($),{markAsRead:B,hasCurrentUserRead:z,isMessageRead:V}=vs(d,t==null?void 0:t.uid),{typingUsers:q,setTyping:ae,clearTyping:v}=ms(d,t==null?void 0:t.uid,(s==null?void 0:s.firstName)||"User"),R=J(),P=l.useMemo(()=>d&&R?{chatId:d,limit:100}:"skip",[d,R]),X=l.useMemo(()=>d&&R&&(r==null?void 0:r.type)==="group"?{chatId:d}:"skip",[d,R,r==null?void 0:r.type]),ee=ue(L.conversations.getChatMembers,X),W=l.useMemo(()=>ee?ee.map(w=>w.userId):[],[ee]),H=ue(L.messages.getMessages,P),G=l.useMemo(()=>H?H.map(w=>({id:w._id,b:w.content||"",s:w.senderId,n:w.senderName,photo:w.senderPhoto||"",t:w.timestamp,edited:w.edited||!1,editedAt:w.editedAt,deleted:w.deleted||!1,deletedForAll:w.deletedForAll||!1,media:w.media,replyTo:w.replyTo,reactions:w.reactions||{}})):[],[H]),Z=Y(L.messages.sendMessage),te=Y(L.messages.editMessage),E=Y(L.messages.deleteMessage),U=Y(L.messages.addReaction),ce=Y(L.messages.removeReaction),re=Y(L.conversations.updateConversation),de=Y(L.conversations.updateUnreadCount);l.useEffect(()=>{y.current&&G.length>0&&y.current.scrollIntoView({behavior:"smooth"})},[G]);const we=l.useRef(0);l.useEffect(()=>{if(d&&(t!=null&&t.uid)&&G.length>0){const w=G.map(m=>m.id),A=w.length;A!==we.current&&(we.current=A,B(w))}},[d,t==null?void 0:t.uid,G.length,B]),l.useEffect(()=>{G.forEach(w=>{if(w.b){const A=w.b.match(/(https?:\/\/[^\s]+)/);if(A){const m=A[0];c[w.id]||Ms(m).then(j=>x(_=>({..._,[w.id]:j}))).catch(j=>console.error(j))}}})},[G]);const je=async(w,A)=>{var m,j;if(!(!d||!(t!=null&&t.uid)||!J()))try{const _=G.find(F=>F.id===w);if(!_)return;((j=(m=_.reactions)==null?void 0:m[A])==null?void 0:j.includes(t.uid))?await ce({messageId:w,userId:t.uid,emoji:A}):await U({messageId:w,userId:t.uid,emoji:A})}catch(_){console.error("Reaction error:",_)}},ze=async(w,A)=>{if(!J()||!Z||!re){alert("Chat functionality is not available. Convex is not configured.");return}const m=w.b||"",j=w.media||null;for(const _ of A)try{await Z({chatId:_,senderId:t.uid,senderName:s.firstName||"User",senderPhoto:s.photoURL||void 0,content:`ç«Šï½ª Forwarded: ${m}`,media:j||void 0});const M=a==null?void 0:a.find(se=>se.id===_),F=m||(j?`Forwarded ${j.type}`:"Forwarded message");await re({userId:t.uid,chatId:_,lastMessage:`ç«Šï½ª ${F}`,lastMessageTime:Date.now(),lastSenderId:t.uid,chatName:(M==null?void 0:M.name)||(M==null?void 0:M.n),chatPhoto:(M==null?void 0:M.photo)||"",chatType:(M==null?void 0:M.type)||"direct",otherUserId:M==null?void 0:M.uid})}catch(M){console.error("Forward error for chat:",_,M)}},he=async(w,A)=>{var j;if(!d||!(w!=null&&w.trim())&&!A||!J()||!Z||!te||!re||!de)return;let m=w?w.trim():"";if(m.length===0&&A&&(m=A.type==="image"?"ðŸ“· Image":A.type==="video"?"ðŸŽ¥ Video":A.type==="audio"?"ðŸŽµ Audio":"ðŸ“Ž File"),b)try{await te({messageId:b.id,content:m,senderId:t.uid}),h(null);return}catch(_){console.error("Edit error:",_);return}try{await Z({chatId:d,senderId:t.uid,senderName:s.firstName||"User",senderPhoto:s.photoURL||void 0,content:m||void 0,media:A||void 0,replyTo:N?{messageId:N.id,text:((j=N.b)==null?void 0:j.substring(0,100))||"Media",sender:N.n||"User"}:void 0});const _=m||(A?`Sent ${A.type}`:"Message");let M=[],F=r.uid;!F&&r.type!=="group"&&d&&d.includes("_")&&(F=d.split("_").find(yt=>yt!==t.uid)),r.type==="group"?M=W.length>0?[...new Set([t.uid,...W])]:[t.uid]:F?M=[t.uid,F]:M=[t.uid];for(const se of M)await re({userId:se,chatId:d,lastMessage:_,lastMessageTime:Date.now(),lastSenderId:t.uid,chatName:r.type==="group"?S:r.name||r.n,chatPhoto:r.photo||"",chatType:r.type||"direct",otherUserId:r.type==="direct"?se===t.uid?F:t.uid:void 0}),se===t.uid?await de({userId:se,chatId:d,setTo:0}):await de({userId:se,chatId:d,increment:1});o(null)}catch(_){console.error("Send message error:",_)}},Ee=async(w,A=!1)=>{if(!(!d||!(t!=null&&t.uid)||!J()||!E))try{await E({messageId:w,senderId:t.uid,forEveryone:A})}catch(m){console.error("Delete error:",m)}},Ne=l.useMemo(()=>{var w;return e.jsxs("div",{className:"flex items-center justify-between p-4 border-b dark:border-gray-800 bg-white dark:bg-[#1f2128]",children:[e.jsxs("div",{className:"flex items-center gap-3 flex-1 min-w-0",children:[e.jsx("button",{onClick:n,className:"md:hidden p-2 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-lg transition-colors",children:e.jsx(st,{className:"w-5 h-5"})}),e.jsxs("div",{className:"flex items-center gap-3 flex-1 min-w-0 cursor-pointer",onClick:()=>u==null?void 0:u($?{uid:$}:null),children:[e.jsx(me,{src:(r==null?void 0:r.photo)||((w=r==null?void 0:r.n)==null?void 0:w.photo)||"",name:S,size:"md"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("h3",{className:"font-semibold text-gray-900 dark:text-white truncate",children:S}),(r==null?void 0:r.type)!=="group"&&e.jsx(bt,{online:I,lastSeen:T,loading:C})]}),(r==null?void 0:r.type)!=="group"&&e.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400",children:I?"Online":T?`Last seen ${ve(T)}`:"Offline"})]})]})]}),e.jsx("button",{onClick:i,className:"p-2 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-lg transition-colors",children:e.jsx(Ct,{className:"w-5 h-5 text-gray-600 dark:text-gray-400"})})]})},[r,S,I,T,C,$,n,i,u]),ve=w=>{if(!w)return"Never";const A=w,j=Date.now()-A,_=Math.floor(j/6e4),M=Math.floor(_/60),F=Math.floor(M/24);return _<1?"Just now":_<60?`${_}m ago`:M<24?`${M}h ago`:F<7?`${F}d ago`:new Date(A).toLocaleDateString()};return!r||!d?e.jsxs("div",{className:"flex flex-col h-full bg-white dark:bg-[#1f2128] items-center justify-center text-gray-400",children:[e.jsx("div",{className:"w-20 h-20 bg-gray-100 dark:bg-gray-800 rounded-full flex items-center justify-center mb-4",children:e.jsx(be,{size:64,className:"text-gray-200 dark:text-gray-700 mb-2"})}),e.jsx("p",{children:"Select a conversation to start chatting"})]}):e.jsxs("div",{className:"flex flex-col h-full bg-white dark:bg-[#1f2128]",children:[Ne,e.jsxs("div",{className:"flex-1 overflow-y-auto p-4 space-y-4 scrollbar-hide",children:[G.length===0?e.jsx("div",{className:"flex items-center justify-center h-full text-gray-400",children:e.jsx("p",{children:"No messages yet. Start the conversation!"})}):G.map((w,A)=>{const m=A>0?G[A-1]:null,j=w.s===(t==null?void 0:t.uid),_=V(w.id),M=z(w.id);return e.jsx(js,{message:w,isCurrentUser:j,previousMessage:m,currentUserId:t==null?void 0:t.uid,chatId:d,linkPreviewData:c[w.id],messageStatus:_?"read":M?"delivered":"sent",onReaction:F=>je(w.id,F),onReply:()=>o(w),onEdit:()=>h(w),onDelete:F=>Ee(w.id,F),onForward:()=>k(w),onSeshNxLinkClick:F=>p({isOpen:!0,url:F,previewData:null}),onUserClick:()=>u==null?void 0:u({uid:w.s})},w.id)}),e.jsx("div",{ref:y})]}),e.jsx(hs,{activeChatId:d,uid:t==null?void 0:t.uid,onSend:he,replyingTo:N,editingMessage:b,onCancelReply:()=>o(null),onCancelEdit:()=>h(null),typingUsers:q,onTyping:ae,onStopTyping:v}),f&&e.jsx(Ns,{message:f,conversations:a,onClose:()=>k(null),onForward:ze}),g.isOpen&&e.jsx(ps,{url:g.url,previewData:g.previewData,onClose:()=>p({isOpen:!1,url:"",previewData:null})})]})}function Ce({title:t,value:s,icon:r,sub:a,bg:n="bg-white dark:bg-[#2c2e36]",text:i="text-gray-900 dark:text-white"}){return e.jsxs("div",{className:`${n} p-5 rounded-xl border border-gray-100 dark:border-gray-700 shadow-sm flex flex-col justify-between h-28`,children:[e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{children:[e.jsx("div",{className:`text-sm font-medium ${i==="text-white"?"text-blue-100":"text-gray-500"}`,children:t}),e.jsx("div",{className:`text-2xl font-extrabold ${i}`,children:s})]}),e.jsx("div",{className:"opacity-80",children:r})]}),a&&e.jsx("div",{className:"text-xs mt-auto opacity-75",children:a})]})}function $s({chatId:t,onClose:s,onMediaSelect:r}){const[a,n]=l.useState([]),[i,u]=l.useState(!0),[c,x]=l.useState(null),[g,p]=l.useState("all"),N=J(),o=t&&N?{chatId:t,limit:500}:"skip",b=ue(L.messages.getMediaMessages,o);l.useEffect(()=>{if(!t||!N){n([]),u(!1);return}if(!b)return;const y=(b||[]).filter(d=>d.media&&!d.deleted&&!d.deletedForAll).map(d=>({id:d._id,...d.media||{},messageId:d._id,timestamp:d.timestamp,sender:d.senderName})).sort((d,S)=>(d.timestamp||0)-(S.timestamp||0));n(y),u(!1)},[t,N,b]);const h=g==="all"?a:a.filter(y=>g==="images"?y.type==="image":g==="videos"?y.type==="video":g==="audio"?y.type==="audio":g==="files"?y.type==="file":!0),f=y=>{x(y),r&&r(y)},k=y=>{const d=document.createElement("a");d.href=y.url,d.download=y.name||"download",d.target="_blank",document.body.appendChild(d),d.click(),document.body.removeChild(d)};return e.jsxs("div",{className:"fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-[80] p-4",children:[e.jsxs(D.div,{initial:{opacity:0,scale:.95},animate:{opacity:1,scale:1},exit:{opacity:0,scale:.95},className:"bg-white dark:bg-[#2c2e36] rounded-2xl shadow-2xl w-full max-w-4xl max-h-[90vh] flex flex-col overflow-hidden",children:[e.jsxs("div",{className:"p-4 border-b dark:border-gray-700 flex items-center justify-between shrink-0",children:[e.jsx("h3",{className:"font-bold text-lg dark:text-white",children:"Media Gallery"}),e.jsx("button",{onClick:s,className:"p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-500 transition",children:e.jsx(K,{size:20})})]}),e.jsx("div",{className:"p-3 border-b dark:border-gray-700 flex gap-2 overflow-x-auto scrollbar-hide shrink-0",children:[{key:"all",label:"All",icon:null},{key:"images",label:"Images",icon:He},{key:"videos",label:"Videos",icon:$e},{key:"audio",label:"Audio",icon:Pe},{key:"files",label:"Files",icon:ye}].map(y=>e.jsxs("button",{onClick:()=>p(y.key),className:`flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-semibold whitespace-nowrap transition ${g===y.key?"bg-brand-blue text-white":"bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300 hover:bg-gray-200"}`,children:[y.icon&&e.jsx(y.icon,{size:16}),y.label,e.jsxs("span",{className:"text-xs opacity-70",children:["(",h.filter(d=>y.key==="all"||d.type===y.key).length,")"]})]},y.key))}),e.jsx("div",{className:"flex-1 overflow-y-auto custom-scrollbar p-4",children:i?e.jsxs("div",{className:"flex flex-col items-center justify-center h-full",children:[e.jsx("div",{className:"w-8 h-8 border-2 border-brand-blue border-t-transparent rounded-full animate-spin mb-2"}),e.jsx("p",{className:"text-sm text-gray-500",children:"Loading media..."})]}):h.length===0?e.jsxs("div",{className:"flex flex-col items-center justify-center h-full text-gray-400",children:[e.jsx(He,{size:48,className:"mb-4 opacity-30"}),e.jsx("p",{className:"text-sm",children:"No media found"})]}):e.jsx("div",{className:"grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 gap-3",children:h.map(y=>e.jsxs(D.div,{initial:{opacity:0,scale:.9},animate:{opacity:1,scale:1},whileHover:{scale:1.05},whileTap:{scale:.95},onClick:()=>f(y),className:"relative aspect-square rounded-lg overflow-hidden bg-gray-100 dark:bg-gray-800 cursor-pointer group",children:[y.type==="image"?e.jsx("img",{src:y.url,alt:"Media",className:"w-full h-full object-cover"}):y.type==="video"?e.jsx("video",{src:y.url,className:"w-full h-full object-cover"}):y.type==="audio"?e.jsx("div",{className:"w-full h-full flex items-center justify-center bg-purple-100 dark:bg-purple-900/30",children:e.jsx(Pe,{size:32,className:"text-purple-600 dark:text-purple-400"})}):e.jsx("div",{className:"w-full h-full flex items-center justify-center bg-blue-100 dark:bg-blue-900/30",children:e.jsx(ye,{size:32,className:"text-blue-600 dark:text-blue-400"})}),e.jsx("div",{className:"absolute inset-0 bg-black/0 group-hover:bg-black/30 transition flex items-center justify-center",children:e.jsx(Be,{size:20,className:"text-white opacity-0 group-hover:opacity-100 transition"})})]},y.id))})})]}),e.jsx(ne,{children:c&&e.jsx(Is,{media:c,onClose:()=>x(null),onDownload:k})})]})}function Is({media:t,onClose:s,onDownload:r}){const[a,n]=l.useState([]),[i,u]=l.useState(0);l.useEffect(()=>{n([t]),u(0)},[t]);const c=()=>{i<a.length-1&&u(i+1)},x=()=>{i>0&&u(i-1)},g=a[i]||t;return e.jsx(D.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"fixed inset-0 bg-black/95 z-[90] flex items-center justify-center",onClick:s,children:e.jsxs("div",{className:"relative max-w-7xl max-h-[90vh] w-full h-full flex items-center justify-center p-4",onClick:p=>p.stopPropagation(),children:[e.jsx("button",{onClick:s,className:"absolute top-4 right-4 p-2 bg-black/50 text-white rounded-full hover:bg-black/70 transition z-10",children:e.jsx(K,{size:24})}),g.type==="image"&&e.jsx("img",{src:g.url,alt:"Media",className:"max-w-full max-h-full object-contain rounded-lg"}),g.type==="video"&&e.jsx("video",{src:g.url,controls:!0,className:"max-w-full max-h-full rounded-lg",autoPlay:!0}),g.type==="audio"&&e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-xl p-8 max-w-md",children:[e.jsx("div",{className:"w-32 h-32 bg-purple-100 dark:bg-purple-900/30 rounded-full flex items-center justify-center mx-auto mb-6",children:e.jsx(Pe,{size:48,className:"text-purple-600 dark:text-purple-400"})}),e.jsx("audio",{src:g.url,controls:!0,className:"w-full",autoPlay:!0}),e.jsx("p",{className:"text-center mt-4 text-sm text-gray-500",children:g.name})]}),g.type==="file"&&e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-xl p-8 max-w-md text-center",children:[e.jsx(ye,{size:64,className:"text-blue-600 dark:text-blue-400 mx-auto mb-4"}),e.jsx("h4",{className:"text-lg font-bold dark:text-white mb-2",children:g.name}),e.jsx("a",{href:g.url,target:"_blank",rel:"noopener noreferrer",className:"inline-block mt-4 px-6 py-2 bg-brand-blue text-white rounded-lg hover:bg-blue-600 transition",children:"Open File"})]}),a.length>1&&e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:x,disabled:i===0,className:"absolute left-4 top-1/2 -translate-y-1/2 p-3 bg-black/50 text-white rounded-full hover:bg-black/70 disabled:opacity-30 transition",children:e.jsx(Dt,{size:24})}),e.jsx("button",{onClick:c,disabled:i===a.length-1,className:"absolute right-4 top-1/2 -translate-y-1/2 p-3 bg-black/50 text-white rounded-full hover:bg-black/70 disabled:opacity-30 transition",children:e.jsx(rt,{size:24})})]}),e.jsx("button",{onClick:()=>r(g),className:"absolute bottom-4 left-1/2 -translate-x-1/2 p-3 bg-black/50 text-white rounded-full hover:bg-black/70 transition",children:e.jsx(Be,{size:20})})]})})}function ar({activeChat:t,onClose:s,currentUser:r}){const[a,n]=l.useState([]),[i,u]=l.useState({sessions:0,rating:0,responseTime:"N/A"}),[c,x]=l.useState(!0),[g,p]=l.useState(!1),[N,o]=l.useState(!1),b=t.type==="group",h=t.uid,f=t.name||t.n||"Unknown";l.useEffect(()=>{const d=async()=>{x(!0);try{if(n([]),!b&&h){const S=Je(pe,`artifacts/${O}/users/${h}/public_profile/main`),$=await Ie(S),I=$.exists()?$.data():{},T=qt(pe,`artifacts/${O}/public/data/bookings`),C=Ue(T,ie("senderId","==",r.uid||""),ie("targetId","==",h),ie("status","==","Completed")),B=await Kt(C);u({sessions:B.data().count,rating:I.rating||"New",responseTime:I.responseTime||"~1hr"})}}catch(S){console.error("Failed to load details:",S)}x(!1)};t!=null&&t.id&&d()},[t.id,h,b,r==null?void 0:r.uid]);const k=async()=>{if(!(b||!h||!r)&&confirm(`Are you sure you want to block ${f}?`)){p(!0);try{const d=Je(pe,es(r.uid).userProfile);await ht(d,{"settings.social.blockedUsers":Vt(h)}),alert("User blocked."),s()}catch(d){console.error("Block failed:",d),alert("Failed to block user.")}p(!1)}},y=()=>{alert("Please use the report option on their profile page for full moderation tools.")};return e.jsxs("div",{className:"absolute right-0 top-0 h-full w-full md:w-80 bg-gray-800 shadow-xl z-20 flex flex-col transition-transform duration-300 ease-in-out border-l border-gray-700",children:[e.jsxs("div",{className:"flex items-center justify-between p-4 border-b border-gray-700 bg-gray-900",children:[e.jsx("h3",{className:"text-lg font-semibold text-white",children:"Details"}),e.jsx("button",{onClick:s,className:"p-2 text-gray-400 hover:text-white hover:bg-gray-700 rounded-full transition duration-150","aria-label":"Close details",children:e.jsx(K,{className:"w-5 h-5"})})]}),e.jsxs("div",{className:"p-6 flex flex-col items-center border-b border-gray-700 bg-gray-800",children:[e.jsxs("div",{className:"relative w-24 h-24 rounded-full overflow-hidden mb-4 bg-gray-700 flex items-center justify-center shadow-lg border-4 border-gray-600",children:[e.jsx("img",{src:t.photo,className:"w-full h-full object-cover",onError:d=>d.target.src="",alt:f}),!t.photo&&(b?e.jsx(be,{className:"w-10 h-10 text-gray-500"}):e.jsx(tt,{className:"w-10 h-10 text-gray-500"}))]}),e.jsx("h4",{className:"text-xl font-bold text-white text-center leading-tight",children:f}),e.jsxs("p",{className:"text-xs text-gray-400 mt-2 flex items-center px-3 py-1 bg-gray-700 rounded-full",children:[b?e.jsx(be,{className:"w-3 h-3 mr-1"}):e.jsx(Qe,{className:"w-3 h-3 mr-1"}),b?"Group Chat":t.role||"Creative"]})]}),e.jsxs("div",{className:"flex-1 overflow-y-auto custom-scrollbar",children:[!b&&e.jsxs("div",{className:"p-4 border-b border-gray-700",children:[e.jsx("h5",{className:"text-xs font-bold text-gray-500 uppercase mb-3 tracking-wider",children:"Performance"}),c?e.jsx("div",{className:"flex justify-center py-4",children:e.jsx(fe,{className:"animate-spin text-brand-blue"})}):e.jsxs("div",{className:"grid grid-cols-3 gap-2",children:[e.jsx(Ce,{title:"Sessions",value:i.sessions,icon:Qe,color:"text-blue-400"}),e.jsx(Ce,{title:"Rating",value:i.rating,icon:Ye,color:"text-yellow-400"}),e.jsx(Ce,{title:"Reply Time",value:i.responseTime,icon:Oe,color:"text-green-400"})]})]}),e.jsxs("div",{className:"p-4 border-b border-gray-700",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("h5",{className:"text-xs font-bold text-gray-500 uppercase tracking-wider",children:"Shared Media"}),e.jsx("button",{onClick:()=>o(!0),className:"text-xs text-brand-blue hover:underline font-medium",children:"View All"})]}),a.length>0?e.jsx("div",{className:"grid grid-cols-3 gap-2",children:a.slice(0,6).map((d,S)=>e.jsxs("div",{className:"aspect-square rounded-lg overflow-hidden bg-gray-700 cursor-pointer hover:opacity-80 transition",children:[d.type==="image"&&e.jsx("img",{src:d.url,className:"w-full h-full object-cover",alt:"Media"}),d.type==="video"&&e.jsx("div",{className:"w-full h-full flex items-center justify-center",children:e.jsx($e,{size:20,className:"text-gray-400"})})]},S))}):e.jsx("p",{className:"text-xs text-gray-500 text-center py-4",children:"No shared media yet"})]}),e.jsxs("div",{className:"p-4 space-y-2",children:[e.jsxs("button",{className:"w-full flex items-center gap-3 px-4 py-2.5 text-left text-gray-300 hover:bg-gray-700 hover:text-white rounded-lg transition",children:[e.jsx(Lt,{className:"w-4 h-4 text-yellow-500"}),e.jsx("span",{children:"Mute Notifications"})]}),e.jsxs("button",{onClick:()=>o(!0),className:"w-full flex items-center gap-3 px-4 py-2.5 text-left text-gray-300 hover:bg-gray-700 hover:text-white rounded-lg transition",children:[e.jsx(Pt,{className:"w-4 h-4 text-purple-500"}),e.jsx("span",{children:"Media Gallery"})]}),!b&&e.jsxs(e.Fragment,{children:[e.jsxs("button",{onClick:k,disabled:g,className:"w-full flex items-center gap-3 px-4 py-2.5 text-left text-red-400 hover:bg-red-900/20 hover:text-red-300 rounded-lg transition disabled:opacity-50",children:[g?e.jsx(fe,{className:"w-4 h-4 animate-spin"}):e.jsx(Gt,{className:"w-4 h-4"}),e.jsx("span",{children:"Block User"})]}),e.jsxs("button",{onClick:y,className:"w-full flex items-center gap-3 px-4 py-2.5 text-left text-red-400 hover:bg-red-900/20 hover:text-red-300 rounded-lg transition",children:[e.jsx(Ye,{className:"w-4 h-4"}),e.jsx("span",{children:"Report User"})]})]})]})]}),N&&e.jsx($s,{chatId:t.id,onClose:()=>o(!1)})]})}export{Ks as A,J as B,L as C,Fs as D,Cs as E,xt as F,Bs as G,is as H,tr as I,sr as J,rr as K,ar as L,Vs as M,qs as N,Ws as O,Hs as P,Qs as Q,er as R,Ce as S,Ge as T,me as U,pe as a,es as b,qt as c,Je as d,Me as e,Gs as f,Ie as g,Q as h,Xs as i,O as j,Vt as k,Ds as l,Kt as m,Ls as n,Os as o,Ps as p,Ue as q,Yt as r,Ts as s,Ke as t,ht as u,Zs as v,ie as w,Ys as x,Js as y,Us as z};
