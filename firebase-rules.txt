================================================================================
FIREBASE SECURITY RULES
Last Updated: 2025-12-08
================================================================================

This file contains all Firebase security rules for:
- Firestore Database
- Realtime Database (RTDB)
- Cloud Storage

================================================================================
FIRESTORE DATABASE RULES
================================================================================

rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- HELPER FUNCTIONS ---
    function isAuthenticated() {
      return request.auth != null;
    }
    function isOwner(userId) {
      return request.auth.uid == userId;
    }
    // Helper to fetch user profile safely
    function getUserData() {
      return get(/databases/$(database)/documents/artifacts/seshnx-70c04/users/$(request.auth.uid)/profiles/main).data;
    }
    function isStaff() {
      return isAuthenticated() && 
             exists(/databases/$(database)/documents/artifacts/seshnx-70c04/users/$(request.auth.uid)/profiles/main) &&
             getUserData().accountTypes.hasAny(['Instructor', 'Admin', 'Studio']);
    }
    function isGlobalAdmin() {
      return isAuthenticated() && 
             exists(/databases/$(database)/documents/artifacts/seshnx-70c04/users/$(request.auth.uid)/profiles/main) &&
             getUserData().accountTypes.hasAny(['Admin']);
    }

    // --- SCHOOLS & EDU MANAGEMENT (Role-Based Access Control) ---
    // Updated 2025-12-08: Enforces role-based access for EDU features
    // - ADMIN: Full control of assigned school
    // - STAFF: View/access based on permissions set by school admin
    // - STUDENT: View student-specific items (grades, calendar, cohort messaging, announcements, resources)
    // - INTERN: View internship info and submit internship hours
    match /schools/{schoolId} {
      // School document: Admin full control, Staff/Students read if they belong to school
      allow read: if isAuthenticated() && hasSchoolAccess(schoolId);
      allow create, delete: if isEduAdmin();
      allow update: if isEduAdmin() || (isEduStaff() && hasSchoolAccess(schoolId));
      
      // Roles: Staff can read, Admin can manage
      match /roles/{roleId} {
        allow read: if isAuthenticated() && hasSchoolAccess(schoolId);
        allow write: if isEduAdmin() && hasSchoolAccess(schoolId);
      }
      
      // Staff: Staff can read, Admin can manage
      match /staff/{staffId} {
        allow read: if isAuthenticated() && hasSchoolAccess(schoolId);
        allow write: if isEduAdmin() && hasSchoolAccess(schoolId);
      }
      
      // Students: Students can read their own, Staff can read all, Admin can manage
      match /students/{studentId} {
        allow read: if isAuthenticated() && hasSchoolAccess(schoolId) && (
          request.auth.uid == studentId || // Own record
          isEduStaff() || // Staff can read all
          isEduAdmin() // Admin can read all
        );
        allow create: if isEduAdmin() && hasSchoolAccess(schoolId);
        allow update: if (isEduAdmin() && hasSchoolAccess(schoolId)) || 
                      (isEduStaff() && hasSchoolAccess(schoolId)) ||
                      (request.auth.uid == studentId && isEduStudent()); // Students can update their own
        allow delete: if isEduAdmin() && hasSchoolAccess(schoolId);
      }
      
      // Internship Logs: Students/Interns can create/update their own, Staff can read/approve
      match /internship_logs/{logId} {
        allow read: if isAuthenticated() && hasSchoolAccess(schoolId);
        allow create: if isEduStudent() && hasSchoolAccess(schoolId) && 
                      request.resource.data.studentId == request.auth.uid;
        allow update: if (isEduStudent() && hasSchoolAccess(schoolId) && 
                         resource.data.studentId == request.auth.uid) ||
                       (isEduStaff() && hasSchoolAccess(schoolId)); // Staff can approve
        allow delete: if isEduAdmin() && hasSchoolAccess(schoolId);
      }
      
      // Announcements: All authenticated school members can read, Staff can write
      match /announcements/{announcementId} {
        allow read: if isAuthenticated() && hasSchoolAccess(schoolId);
        allow write: if isEduStaff() && hasSchoolAccess(schoolId);
      }
      
      // Resources: All authenticated school members can read, Staff can manage
      match /rules/{ruleId} {
        allow read: if isAuthenticated() && hasSchoolAccess(schoolId);
        allow write: if isEduStaff() && hasSchoolAccess(schoolId);
      }
      
      // Partners: All authenticated school members can read, Staff can manage
      match /partners/{partnerId} {
        allow read: if isAuthenticated() && hasSchoolAccess(schoolId);
        allow write: if isEduStaff() && hasSchoolAccess(schoolId);
      }
      
      // Evaluations (Grades): Students can read their own, Staff can read/write
      match /students/{studentId}/evaluations/{evalId} {
        allow read: if isAuthenticated() && hasSchoolAccess(schoolId) && (
          request.auth.uid == studentId || isEduStaff()
        );
        allow write: if isEduStaff() && hasSchoolAccess(schoolId);
      }
      
      // Audit Logs: Staff can read, authenticated users can create
      match /audit_logs/{logId} {
        allow read: if isEduStaff() && hasSchoolAccess(schoolId);
        allow create: if isAuthenticated() && hasSchoolAccess(schoolId);
      }
    }

    // --- USERS & ARTIFACTS ---
    match /artifacts/{appId}/users/{userId} {
      
      // 1. Profiles
      match /profiles/main {
        allow read: if isAuthenticated();
        allow write: if isOwner(userId) || isStaff();
      }
      match /public_profile/main {
        // Public profiles are public
        allow read: if true;
        allow write: if isOwner(userId) || isStaff();
      }
      match /profiles/{role} {
        allow read: if isAuthenticated();
        allow write: if isOwner(userId);
      }

      // 2. Wallet
      match /wallet/account {
        allow read, write: if isOwner(userId);
      }

      // 3. General Subcollections (Notifications, etc.)
      match /{collectionName}/{docId} {
        allow read, write: if isOwner(userId);
      }
      
      // 4. Assets
      match /postImages/{imageId} { allow read, write: if isAuthenticated(); }
      match /postAudio/{audioId} { allow read, write: if isAuthenticated(); }
      match /postVideos/{videoId} { allow read, write: if isAuthenticated(); }
      
      // --- SOCIAL GRAPH (Phase 1 - Added 2024-12) ---
      // Following/Followers: Users can read their own, write to their own
      // Others can read (to show follower counts) but not write
      match /followers/{followerId} {
        allow read: if isAuthenticated();
        allow write: if isAuthenticated() && (isOwner(userId) || isOwner(followerId));
      }
      match /following/{followingId} {
        allow read: if isAuthenticated();
        allow write: if isAuthenticated() && (isOwner(userId) || isOwner(followingId));
      }
      match /stats/social {
        allow read: if isAuthenticated(); // Public read for follower counts
        allow write: if isOwner(userId); // Only user can update their own stats
      }
      
      // Notifications: Users can read/write their own
      match /notifications/{notificationId} {
        allow read, write: if isOwner(userId);
      }
      
      // Saved Posts: Users can read/write their own
      match /savedPosts/{postId} {
        allow read, write: if isOwner(userId);
      }
    }

    // --- PUBLIC DATA ---
    match /artifacts/{appId}/public {
      
      match /data/posts/{postId} {
        allow read: if isAuthenticated();                 // Auth required (reverted)
        allow create: if isAuthenticated();
        allow update, delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
      }
      
      // Post replies/comments
      match /data/posts/{postId}/replies/{replyId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated();
        allow update, delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
      }
      
      match /data/market_items/{itemId} { allow read: if isAuthenticated(); allow write: if isAuthenticated(); }
      match /data/bookings/{bookingId} { allow read: if isAuthenticated(); allow write: if isAuthenticated(); }
      match /data/reviews/{reviewId} { allow read: if isAuthenticated(); allow write: if isAuthenticated(); }
      match /data/service_requests/{requestId} { allow read: if isAuthenticated(); allow write: if isAuthenticated(); }
      match /data/gear_listings/{listingId} { allow read: if isAuthenticated(); allow write: if isAuthenticated(); }
      match /data/equipment_submissions/{submissionId} { allow read: if isAuthenticated(); allow write: if isAuthenticated(); }
      
      match /config/{document=**} { allow read: if isAuthenticated(); }

      // --- EQUIPMENT DATABASE ACCESS ---
      match /data/equipment_database/{document=**} {
        allow read: if isAuthenticated();
        // Only Admins (or Staff) should write to the static DB
        allow write: if isGlobalAdmin(); 
      }
      
      // --- MODERATION QUEUE ---
      match /moderation_queue/{ticketId} {
        allow read: if isGlobalAdmin(); // Only admins can read
        allow create: if isAuthenticated(); // Users can submit reports
        allow update: if isGlobalAdmin(); // Only admins can update status
      }
    }
    
    // --- PUBLIC DIRECTORIES & EDU LEADS (updated 2025-12-08) ---
    match /{path=**}/public_profile/{docId} { allow read: if isAuthenticated(); }
    match /{path=**}/profiles/{docId} { allow read: if isAuthenticated(); }
    match /{path=**}/internship_logs/{docId} { allow read: if isAuthenticated(); }
    match /schools/{docId} { allow read: if isAuthenticated(); }                       
    match /edu_petitions/{docId} { allow read: if isAuthenticated(); allow write: if isAuthenticated(); }
    match /edu_verifications/{docId} { allow create: if isAuthenticated(); allow read, update, delete: if false; } // Submit-only
  }
}


================================================================================
CLOUD STORAGE RULES
================================================================================

rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {
    
    // 1. User Artifacts & Public Profile Data
    match /artifacts/{userId}/{allPaths=**} {
      allow read: if true;
      allow write: if request.auth != null && request.auth.uid == userId;
    }
    
    // 2. User Personal Folder (Avatars, etc.) - FIXES 403 ERROR
    match /users/{userId}/{allPaths=**} {
      allow read: if true;
      allow write: if request.auth != null && request.auth.uid == userId;
    }

    // 3. School Assets
    match /schools/{schoolId}/{allPaths=**} {
      allow read: if true;
      allow write: if request.auth != null;
    }

    // 4. Chat Attachments (Images/Audio) - Phase 1
    match /chat_media/{chatId}/{allPaths=**} {
       allow read, write: if request.auth != null;
    }
    
    // 5. Chat Files (Documents) - Phase 1
    match /chat_files/{chatId}/{allPaths=**} {
       allow read, write: if request.auth != null;
    }

    // Default Deny
    match /{allPaths=**} {
      allow read, write: if false; 
    }
  }
}


================================================================================
CHANGELOG
================================================================================

2024-12-XX - Initial Rules File Setup
  ✅ Created comprehensive rules file tracking Firestore, RTDB, and Storage rules
  ✅ Updated with actual production rules from Firebase Console
  ✅ Added Phase 1 enhancements (social graph, chat features)

2024-12-XX - Phase 1: Social Graph & Chat Enhancements
  ✅ Added followers/following collections with read/write rules
  ✅ Added social stats document with public read
  ✅ Added notifications collection (user-owned)
  ✅ Added savedPosts collection (user-owned)
  ✅ Added post replies/comments subcollection
  ✅ Added moderation_queue for content reporting
  ✅ Enhanced RTDB message structure with:
     - Reactions (emoji reactions per user)
     - Reply references (replyTo field)
     - Edit indicators (edited, editedAt)
     - Delete flags (deleted, deletedForAll, deletedFor)
     - Forward indicators (forwarded, forwardedFrom)
  ✅ Added chat media storage rules
  ✅ Added read receipts structure (for future Phase 2)

2024-12-XX - Phase 2: Read Receipts & Presence
  ✅ Implemented user presence system (online/offline/last seen)
  ✅ Added read receipts tracking (delivered/read indicators)
  ✅ Message status indicators (✓ sent, ✓✓ delivered, ✓✓ read)
  ✅ Real-time online status in chat headers and sidebar
  ✅ Automatic message marking as read when viewed
  ✅ Presence persistence on disconnect/reconnect
  ✅ Last seen timestamps for offline users

2024-12-XX - Phase 3: Enhanced Media & Content
  ✅ Full emoji picker with categories and search
  ✅ Recent emojis saved to localStorage
  ✅ Giphy GIF integration with search
  ✅ Video message recording (webcam + mic)
  ✅ Audio waveform visualization for voice messages
  ✅ Document preview and download support
  ✅ Media gallery with filtering (images/videos/audio/files)
  ✅ Full-screen media viewer with navigation
  ✅ Enhanced file sharing with preview cards
2025-12-08 - Public preview & EDU petition access
  ✅ Firestore: public read for feed/profiles/marketplace/service_requests
  ✅ Firestore: public read for schools; public create/read for edu_petitions; submit-only for edu_verifications
  ✅ RTDB rules removed (no RTDB usage)

================================================================================
NOTES
================================================================================

- All new paths follow Firestore odd/even segment rules:
  * Collections = odd segments (1, 3, 5...)
  * Documents = even segments (2, 4, 6...)

- Storage paths:
  * artifacts/{userId}/** - User artifacts and public profile data (public read, owner write)
  * users/{userId}/** - User personal folder (avatars, etc.) - public read, owner write
  * schools/{schoolId}/** - School assets (public read, authenticated write)
  * chat_media/{chatId}/** - Chat attachments (images/audio) - authenticated read/write
  * chat_files/{chatId}/** - Chat documents - authenticated read/write

================================================================================

