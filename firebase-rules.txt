================================================================================
FIREBASE SECURITY RULES
Last Updated: 2024-12-XX
================================================================================

This file contains all Firebase security rules for:
- Firestore Database
- Realtime Database (RTDB)
- Cloud Storage

================================================================================
FIRESTORE DATABASE RULES
================================================================================

rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- HELPER FUNCTIONS ---
    function isAuthenticated() {
      return request.auth != null;
    }
    function isOwner(userId) {
      return request.auth.uid == userId;
    }
    // Helper to fetch user profile safely
    function getUserData() {
      return get(/databases/$(database)/documents/artifacts/seshnx-70c04/users/$(request.auth.uid)/profiles/main).data;
    }
    function isStaff() {
      return isAuthenticated() && 
             exists(/databases/$(database)/documents/artifacts/seshnx-70c04/users/$(request.auth.uid)/profiles/main) &&
             getUserData().accountTypes.hasAny(['Instructor', 'Admin', 'Studio']);
    }
    function isGlobalAdmin() {
      return isAuthenticated() && 
             exists(/databases/$(database)/documents/artifacts/seshnx-70c04/users/$(request.auth.uid)/profiles/main) &&
             getUserData().accountTypes.hasAny(['Admin']);
    }

    // --- SCHOOLS & EDU MANAGEMENT ---
    match /schools/{schoolId} {
      // UPDATED: Public read allowed for AuthWizard School Search
      allow read: if true;
      
      allow create, delete: if isGlobalAdmin();
      allow update: if isStaff();

      match /roles/{roleId} { allow read: if true; allow write: if isStaff(); }
      match /staff/{staffId} { allow read: if true; allow write: if isStaff(); }
      
      match /students/{studentId} {
        // UPDATED: Public read allowed for AuthWizard ID Verification
        allow read: if true;
        
        // UPDATED: Allow claiming profiles during signup
        allow create: if isAuthenticated();
        allow delete: if isAuthenticated();
        
        // Standard management
        allow write: if isStaff(); 
        allow update: if isStaff() || isOwner(studentId);
        
        match /evaluations/{evalId} { allow read: if isAuthenticated(); allow write: if isStaff(); }
      }

      match /internship_logs/{logId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated() && request.resource.data.studentId == request.auth.uid;
        allow update: if (isAuthenticated() && resource.data.studentId == request.auth.uid) || isStaff();
      }

      match /rules/{ruleId} { allow read: if isAuthenticated(); allow write: if isStaff(); }
      match /partners/{partnerId} { allow read: if isAuthenticated(); allow write: if isStaff(); }
      match /announcements/{newsId} { allow read: if isAuthenticated(); allow write: if isStaff(); }
      match /audit_logs/{logId} { allow read: if isStaff(); allow create: if isAuthenticated(); }
    }

    // --- USERS & ARTIFACTS ---
    match /artifacts/{appId}/users/{userId} {
      
      // 1. Profiles
      match /profiles/main {
        allow read: if isAuthenticated();
        allow write: if isOwner(userId) || isStaff();
      }
      match /public_profile/main {
        // Public profiles are public
        allow read: if true;
        allow write: if isOwner(userId) || isStaff();
      }
      match /profiles/{role} {
        allow read: if isAuthenticated();
        allow write: if isOwner(userId);
      }

      // 2. Wallet
      match /wallet/account {
        allow read, write: if isOwner(userId);
      }

      // 3. General Subcollections (Notifications, etc.)
      match /{collectionName}/{docId} {
        allow read, write: if isOwner(userId);
      }
      
      // 4. Assets
      match /postImages/{imageId} { allow read, write: if isAuthenticated(); }
      match /postAudio/{audioId} { allow read, write: if isAuthenticated(); }
      match /postVideos/{videoId} { allow read, write: if isAuthenticated(); }
      
      // --- SOCIAL GRAPH (Phase 1 - Added 2024-12) ---
      // Following/Followers: Users can read their own, write to their own
      // Others can read (to show follower counts) but not write
      match /followers/{followerId} {
        allow read: if isAuthenticated();
        allow write: if isAuthenticated() && (isOwner(userId) || isOwner(followerId));
      }
      match /following/{followingId} {
        allow read: if isAuthenticated();
        allow write: if isAuthenticated() && (isOwner(userId) || isOwner(followingId));
      }
      match /stats/social {
        allow read: if isAuthenticated(); // Public read for follower counts
        allow write: if isOwner(userId); // Only user can update their own stats
      }
      
      // Notifications: Users can read/write their own
      match /notifications/{notificationId} {
        allow read, write: if isOwner(userId);
      }
      
      // Saved Posts: Users can read/write their own
      match /savedPosts/{postId} {
        allow read, write: if isOwner(userId);
      }
    }

    // --- PUBLIC DATA ---
    match /artifacts/{appId}/public {
      
      match /data/posts/{postId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated();
        allow update, delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
      }
      
      // Post replies/comments
      match /data/posts/{postId}/replies/{replyId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated();
        allow update, delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
      }
      
      match /data/market_items/{itemId} { allow read: if isAuthenticated(); allow write: if isAuthenticated(); }
      match /data/bookings/{bookingId} { allow read: if isAuthenticated(); allow write: if isAuthenticated(); }
      match /data/reviews/{reviewId} { allow read: if isAuthenticated(); allow write: if isAuthenticated(); }
      match /data/service_requests/{requestId} { allow read: if isAuthenticated(); allow write: if isAuthenticated(); }
      match /data/gear_listings/{listingId} { allow read: if isAuthenticated(); allow write: if isAuthenticated(); }
      match /data/equipment_submissions/{submissionId} { allow read: if isAuthenticated(); allow write: if isAuthenticated(); }
      
      match /config/{document=**} { allow read: if isAuthenticated(); }

      // --- EQUIPMENT DATABASE ACCESS ---
      match /data/equipment_database/{document=**} {
        allow read: if isAuthenticated();
        // Only Admins (or Staff) should write to the static DB
        allow write: if isGlobalAdmin(); 
      }
      
      // --- MODERATION QUEUE ---
      match /moderation_queue/{ticketId} {
        allow read: if isGlobalAdmin(); // Only admins can read
        allow create: if isAuthenticated(); // Users can submit reports
        allow update: if isGlobalAdmin(); // Only admins can update status
      }
    }
    
    // --- COLLECTION GROUPS ---
    match /{path=**}/public_profile/{docId} { allow read: if true; }
    match /{path=**}/profiles/{docId} { allow read: if true; }
    match /{path=**}/internship_logs/{docId} { allow read: if isAuthenticated(); }
  }
}


================================================================================
REALTIME DATABASE (RTDB) RULES
================================================================================

{
  "rules": {
    
    // --- CONVERSATIONS ---
    "conversations": {
      "$uid": {
        ".indexOn": "lmt",
        ".read": "auth !== null && auth.uid === $uid",
        "$convId": {
          // FIX: Allow write if it's MY inbox OR if I am the sender ('ls') of the update
          ".write": "auth !== null && ($uid === auth.uid || newData.child('ls').val() === auth.uid)",
          
          // Schema Validation
          ".validate": "newData.hasChildren(['uid', 'n', 'lm', 'lmt'])",
          "uid": { ".validate": "newData.isString()" },
          "n": { ".validate": "newData.isString()" },
          "lm": { ".validate": "newData.isString()" },
          "lmt": { ".validate": "newData.isNumber()" },
          "ls": { ".validate": "newData.isString()" },
          "uc": { ".validate": "newData.isNumber()" },
          "ip": { ".validate": "newData.isBoolean()" },  // isPinned flag
          "type": { ".validate": "newData.isString()" },
          "photo": { ".validate": "newData.isString()" },
          "$other": { ".validate": false }
        }
      }
    },
    
    // --- MESSAGES ---
    "messages": {
      "$convId": {
        // Simplified for reliability - relies on Chat ID obscurity + App logic
        ".read": "auth !== null",
        ".write": "auth !== null",
        "$msgId": {
          ".validate": "newData.hasChildren(['b', 's', 't'])",
          "b": { ".validate": "newData.isString()" },
          "s": { ".validate": "newData.val() === auth.uid" },
          "t": { ".validate": "newData.isNumber() && newData.val() <= now" },
          "n": { ".validate": "newData.isString()" },
          
          // Media attachments
          "media": { 
            ".validate": "newData.hasChildren(['url', 'type'])",
            "url": { ".validate": "newData.isString()" },
            "type": { ".validate": "newData.isString()" },
            "name": { ".validate": "newData.isString() || !newData.exists()" }
          },
          
          // Reply/Quote (Phase 1 - Chat Enhancements)
          // Note: Your existing rules use "quote", but our code uses "replyTo"
          // Keeping both for backward compatibility
          "quote": { 
            ".validate": "newData.hasChildren(['id', 'text']) || !newData.exists()",
            "id": { ".validate": "newData.isString()" },
            "text": { ".validate": "newData.isString()" },
            "sender": { ".validate": "newData.isString() || !newData.exists()" }
          },
          "replyTo": {
            ".validate": "newData.hasChildren(['id', 'text']) || !newData.exists()",
            "id": { ".validate": "newData.isString()" },
            "text": { ".validate": "newData.isString()" },
            "sender": { ".validate": "newData.isString() || !newData.exists()" }
          },
          
          // Edit indicator (Phase 1)
          "edited": { ".validate": "newData.isBoolean() || !newData.exists()" },
          "editedAt": { ".validate": "newData.isNumber() || !newData.exists()" },
          
          // Delete (Phase 1)
          "deleted": { ".validate": "newData.isBoolean() || !newData.exists()" },
          "deletedForAll": { ".validate": "newData.isBoolean() || !newData.exists()" },
          "deletedAt": { ".validate": "newData.isNumber() || !newData.exists()" },
          "deletedFor": {
            "$uid": {
              ".validate": "newData.isBoolean() || !newData.exists()"
            }
          },
          
          // Forward (Phase 1)
          "forwarded": { ".validate": "newData.isBoolean() || !newData.exists()" },
          "forwardedFrom": { ".validate": "newData.isString() || !newData.exists()" },
          
          // Reactions (Phase 1 - Chat Enhancements)
          "reactions": { 
            ".validate": true,
            "$emoji": {
              "$uid": {
                ".validate": "newData.val() === true || newData.val() === null"
              }
            }
          },
          
          "photo": { ".validate": "newData.isString() || !newData.exists()" },
          "$other": { ".validate": false }
        }
      }
    },
    
    // --- GROUP CHATS ---
    "chats": {
      "$chatId": {
        ".read": "auth !== null",
        ".write": "auth !== null",
        
        // Chat metadata (optional, for future use)
        "meta": {
          "name": { ".validate": "newData.isString()" },
          "createdBy": { ".validate": "newData.isString()" },
          "createdAt": { ".validate": "newData.isNumber() || !newData.exists()" }
        },
        
        // Members list
        "members": {
          "$uid": {
            ".validate": "newData.val() === true || newData.val() === null"
          }
        },
        
        // Typing indicators (Phase 1)
        "typing": {
          "$uid": {
            ".validate": "newData.isBoolean() || newData.val() === null"
          }
        },
        
        // Read receipts (Future Phase 2)
        "readBy": {
          "$uid": {
            "lastReadMessageId": { ".validate": "newData.isString()" },
            "readAt": { ".validate": "newData.isNumber() || !newData.exists()" }
          }
        }
      }
    },
    
    // --- USER PRESENCE (Future Phase 2) ---
    "presence": {
      "$uid": {
        ".read": "auth !== null",
        ".write": "$uid === auth.uid",
        "online": { ".validate": "newData.isBoolean() || !newData.exists()" },
        "lastSeen": { ".validate": "newData.isNumber() || !newData.exists()" }
      }
    }
  }
}


================================================================================
CLOUD STORAGE RULES
================================================================================

rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {
    
    // 1. User Artifacts & Public Profile Data
    match /artifacts/{userId}/{allPaths=**} {
      allow read: if true;
      allow write: if request.auth != null && request.auth.uid == userId;
    }
    
    // 2. User Personal Folder (Avatars, etc.) - FIXES 403 ERROR
    match /users/{userId}/{allPaths=**} {
      allow read: if true;
      allow write: if request.auth != null && request.auth.uid == userId;
    }

    // 3. School Assets
    match /schools/{schoolId}/{allPaths=**} {
      allow read: if true;
      allow write: if request.auth != null;
    }

    // 4. Chat Attachments (Images/Audio) - Phase 1
    match /chat_media/{chatId}/{allPaths=**} {
       allow read, write: if request.auth != null;
    }
    
    // 5. Chat Files (Documents) - Phase 1
    match /chat_files/{chatId}/{allPaths=**} {
       allow read, write: if request.auth != null;
    }

    // Default Deny
    match /{allPaths=**} {
      allow read, write: if false; 
    }
  }
}


================================================================================
CHANGELOG
================================================================================

2024-12-XX - Initial Rules File Setup
  ✅ Created comprehensive rules file tracking Firestore, RTDB, and Storage rules
  ✅ Updated with actual production rules from Firebase Console
  ✅ Added Phase 1 enhancements (social graph, chat features)

2024-12-XX - Phase 1: Social Graph & Chat Enhancements
  ✅ Added followers/following collections with read/write rules
  ✅ Added social stats document with public read
  ✅ Added notifications collection (user-owned)
  ✅ Added savedPosts collection (user-owned)
  ✅ Added post replies/comments subcollection
  ✅ Added moderation_queue for content reporting
  ✅ Enhanced RTDB message structure with:
     - Reactions (emoji reactions per user)
     - Reply references (replyTo field)
     - Edit indicators (edited, editedAt)
     - Delete flags (deleted, deletedForAll, deletedFor)
     - Forward indicators (forwarded, forwardedFrom)
  ✅ Added chat media storage rules
  ✅ Added read receipts structure (for future Phase 2)

2024-12-XX - Phase 2: Read Receipts & Presence
  ✅ Implemented user presence system (online/offline/last seen)
  ✅ Added read receipts tracking (delivered/read indicators)
  ✅ Message status indicators (✓ sent, ✓✓ delivered, ✓✓ read)
  ✅ Real-time online status in chat headers and sidebar
  ✅ Automatic message marking as read when viewed
  ✅ Presence persistence on disconnect/reconnect
  ✅ Last seen timestamps for offline users

2024-12-XX - Phase 3: Enhanced Media & Content
  ✅ Full emoji picker with categories and search
  ✅ Recent emojis saved to localStorage
  ✅ Giphy GIF integration with search
  ✅ Video message recording (webcam + mic)
  ✅ Audio waveform visualization for voice messages
  ✅ Document preview and download support
  ✅ Media gallery with filtering (images/videos/audio/files)
  ✅ Full-screen media viewer with navigation
  ✅ Enhanced file sharing with preview cards

================================================================================
NOTES
================================================================================

- All new paths follow Firestore odd/even segment rules:
  * Collections = odd segments (1, 3, 5...)
  * Documents = even segments (2, 4, 6...)

- RTDB paths:
  * conversations/{uid}/{chatId} - User's conversation list
  * messages/{chatId}/{messageId} - Actual messages
  * chats/{chatId} - Group chat metadata
  * presence/{uid} - User online status

- Storage paths:
  * artifacts/{userId}/** - User artifacts and public profile data (public read, owner write)
  * users/{userId}/** - User personal folder (avatars, etc.) - public read, owner write
  * schools/{schoolId}/** - School assets (public read, authenticated write)
  * chat_media/{chatId}/** - Chat attachments (images/audio) - authenticated read/write
  * chat_files/{chatId}/** - Chat documents - authenticated read/write

================================================================================

